<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <title>Dashboard Administrativo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        header {
            background: #0a2342;
            color: #fff;
            padding: 16px;
        }

        nav {
            background: #f4f4f4;
            padding: 10px;
            display: flex;
            gap: 10px;
        }

        nav button {
            border: 1px solid #999;
            background: #ddd;
            padding: 8px 12px;
            cursor: pointer;
        }

        nav button.active {
            background: #bbb;
            font-weight: bold;
        }

        main {
            padding: 16px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
        }

        table th,
        table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }

        .btn {
            background: #007bff;
            color: #fff;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            margin-right: 5px;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-secondary {
            background: #6c757d;
        }
    </style>
</head>

<body>
    <header>
        <h1>Admin Dashboard</h1>
        <p>Bem-vindo(a), Administrador!</p>
    </header>
    <nav>
        <button class="tab-btn active" data-tab="tab-users">Usuários</button>
        <button class="tab-btn" data-tab="tab-fornecedores">Fornecedores</button>
        <button class="tab-btn" data-tab="tab-permissoes">Permissões</button>
        <button class="tab-btn" data-tab="tab-frota">Frota</button>
        <button class="tab-btn" data-tab="tab-logout" onclick="logout()">Sair</button>
    </nav>
    <main>
        <!-- Aba de Usuários -->
        <div id="tab-users" class="tab-content active">
            <h2>Gerenciar Usuários</h2>
            <button onclick="carregarUsuarios()">Carregar Lista de Usuários</button>
            <div id="listaUsuarios"></div>
        </div>
        <!-- Aba de Fornecedores -->
        <div id="tab-fornecedores" class="tab-content">
            <h2>Fornecedores</h2>
            <button onclick="carregarFornecedores()">Carregar Fornecedores</button>
            <div id="listaFornecedores"></div>
        </div>
        <!-- Aba de Permissões -->
        <div id="tab-permissoes" class="tab-content">
            <h2>Permissões do Sistema</h2>
            <p>
                Aqui você pode configurar permissões adicionais, como
                "GerenciarFornecedores", "GerenciarFrota", "Financeiro", "Relatorios", etc.
                e atribuir a cada usuário.
            </p>
            <div>
                <label>Permissão Nova:
                    <input type="text" id="novaPermissaoTxt" />
                </label>
                <button onclick="adicionarPermissao()">Adicionar Permissão</button>
            </div>
            <div id="listaPermissoesGlobais"></div>
            <hr />
            <h4>Atribuir permissão a um usuário</h4>
            <label>ID User:
                <input type="number" id="permUserId" />
            </label>
            <label>Permissão:
                <input type="text" id="permPermissionName" />
            </label>
            <button onclick="atribuirPermissao()">Atribuir</button>
            <p id="atribuirMsg"></p>
        </div>
        <!-- Aba de Frota -->
        <div id="tab-frota" class="tab-content">
            <h2>Frota</h2>
            <button onclick="carregarFrota()">Carregar Frota</button>
            <div id="listaFrota"></div>
        </div>
    </main>
    <script>
        // Troca de Abas
        const tabs = document.querySelectorAll(".tab-btn");
        const contents = document.querySelectorAll(".tab-content");
        tabs.forEach((btn) => {
            btn.addEventListener("click", () => {
                tabs.forEach((b) => b.classList.remove("active"));
                btn.classList.add("active");
                const tabId = btn.dataset.tab;
                contents.forEach((ct) => {
                    if (ct.id === tabId) {
                        ct.classList.add("active");
                    } else {
                        ct.classList.remove("active");
                    }
                });
            });
        });
        // USUÁRIOS
        function carregarUsuarios() {
            fetch("/api/admin/users")
                .then((res) => res.json())
                .then((data) => {
                    if (!data.success) {
                        alert("Erro: " + data.message);
                        return;
                    }
                    const container = document.getElementById("listaUsuarios");
                    container.innerHTML = "<h3>Usuários Cadastrados</h3>";
                    if (!data.data || !data.data.length) {
                        container.innerHTML += "<p>Nenhum usuário encontrado.</p>";
                        return;
                    }
                    let html =
                        "<table><tr><th>ID</th><th>Nome</th><th>E-mail</th><th>Init</th><th>Permissões</th><th>Ações</th></tr>";
                    data.data.forEach((u) => {
                        html += `
              <tr>
                <td>${u.id}</td>
                <td>${u.nome_completo}</td>
                <td>${u.email}</td>
                <td>${u.init}</td>
                <td>${u.permissoes || ""}</td>
                <td>
                  <button class="btn" onclick="toggleInit(${u.id}, ${u.init})">Toggle Init</button>
                  <button class="btn" onclick="darMaster(${u.id})">Dar Master</button>
                  <button class="btn btn-danger" onclick="excluirUsuario(${u.id})">Excluir</button>
                </td>
              </tr>
            `;
                    });
                    html += "</table>";
                    container.innerHTML += html;
                })
                .catch((err) => console.error("Erro fetch users:", err));
        }
        function toggleInit(userId, currentInit) {
            const novoInit = !currentInit;
            fetch(`/api/admin/users/${userId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ init: novoInit }),
            })
                .then((r) => r.json())
                .then((resp) => {
                    if (resp.success) {
                        alert("Usuário atualizado com sucesso!");
                        carregarUsuarios();
                    } else {
                        alert("Erro: " + resp.message);
                    }
                })
                .catch((err) => console.error(err));
        }
        function darMaster(userId) {
            fetch(`/api/admin/users/${userId}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ permissoes: "Master" }),
            })
                .then((r) => r.json())
                .then((resp) => {
                    if (resp.success) {
                        alert("Permissão MASTER atribuída!");
                        carregarUsuarios();
                    } else {
                        alert("Erro: " + resp.message);
                    }
                })
                .catch((err) => console.error(err));
        }
        function excluirUsuario(userId) {
            if (!confirm("Tem certeza que deseja excluir este usuário?")) return;
            fetch(`/api/admin/users/${userId}`, { method: "DELETE" })
                .then((r) => r.json())
                .then((resp) => {
                    if (resp.success) {
                        alert("Usuário excluído.");
                        carregarUsuarios();
                    } else {
                        alert("Erro: " + resp.message);
                    }
                })
                .catch((err) => console.error(err));
        }
        // FORNECEDORES
        function carregarFornecedores() {
            fetch("/api/fornecedores")
                .then((res) => res.json())
                .then((data) => {
                    const container = document.getElementById("listaFornecedores");
                    container.innerHTML = "<h3>Fornecedores</h3>";
                    if (!data || !data.length) {
                        container.innerHTML += "<p>Nenhum fornecedor encontrado.</p>";
                        return;
                    }
                    let html =
                        "<table><tr><th>ID</th><th>Nome</th><th>Tipo Contrato</th><th>CNPJ</th><th>Contato</th></tr>";
                    data.forEach((f) => {
                        html += `
              <tr>
                <td>${f.id}</td>
                <td>${f.nome_fornecedor}</td>
                <td>${f.tipo_contrato}</td>
                <td>${f.cnpj}</td>
                <td>${f.contato}</td>
              </tr>
            `;
                    });
                    html += "</table>";
                    container.innerHTML += html;
                })
                .catch((err) => console.error("Erro fetch fornecedores:", err));
        }
        // PERMISSÕES
        let permissaoGlobalLista = [
            "GerenciarFornecedores",
            "GerenciarFrota",
            "Financeiro",
            "Relatorios",
            "GerenciarUsuarios",
            "GerarPdfTermos",
            "CriarSolicitacoesTransporte",
            "ImportarAlunosAtivos",
            "VisualizarAlunosAtivos",
            "ExcluirAlunosAtivos",
            "AtualizarAlunosRecadastro",
            "CriarAlunosAtivosEstadual",
            "AtualizarAlunosAtivosEstadual",
            "AtualizarAlunosAtivos"
        ];
        function renderizarPermissoesGlobais() {
            const div = document.getElementById("listaPermissoesGlobais");
            let html = "<h4>Lista de Permissões Globais</h4><ul>";
            permissaoGlobalLista.forEach((p, idx) => {
                html += `<li>${p} <button onclick="removerPermissaoGlobal(${idx})">X</button></li>`;
            });
            html += "</ul>";
            div.innerHTML = html;
        }
        function adicionarPermissao() {
            const txt = document.getElementById("novaPermissaoTxt");
            const val = txt.value.trim();
            if (!val) return;
            if (!permissaoGlobalLista.includes(val)) {
                permissaoGlobalLista.push(val);
            }
            txt.value = "";
            renderizarPermissoesGlobais();
        }
        function removerPermissaoGlobal(idx) {
            permissaoGlobalLista.splice(idx, 1);
            renderizarPermissoesGlobais();
        }
        function atribuirPermissao() {
            const userId = document.getElementById("permUserId").value;
            const perm = document.getElementById("permPermissionName").value;
            const msg = document.getElementById("atribuirMsg");
            if (!userId || !perm) {
                msg.innerText = "Preencha ID do usuário e permissão.";
                return;
            }
            fetch(`/api/admin/users`)
                .then((r) => r.json())
                .then((full) => {
                    if (!full.success) {
                        msg.innerText = "Erro ao listar usuários.";
                        return;
                    }
                    const found = full.data.find((u) => u.id == userId);
                    if (!found) {
                        msg.innerText = "Usuário não encontrado.";
                        return;
                    }
                    let atual = found.permissoes || "";
                    let arr = atual.split(",").map((x) => x.trim()).filter((x) => x);
                    if (!arr.includes(perm)) {
                        arr.push(perm);
                    }
                    const novo = arr.join(",");
                    fetch(`/api/admin/users/${userId}`, {
                        method: "PUT",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ permissoes: novo }),
                    })
                        .then((r3) => r3.json())
                        .then((resp3) => {
                            if (resp3.success) {
                                msg.innerText = `Permissão "${perm}" atribuída ao usuário ${userId}. Novo: ${resp3.user.permissoes}`;
                                carregarUsuarios();
                            } else {
                                msg.innerText = "Erro: " + resp3.message;
                            }
                        })
                        .catch((err) => {
                            console.error(err);
                            msg.innerText = "Erro ao atualizar usuário.";
                        });
                })
                .catch((err) => {
                    console.error(err);
                    msg.innerText = "Erro ao obter lista de usuários.";
                });
        }
        // FROTA
        function carregarFrota() {
            fetch("/api/frota")
                .then((res) => res.json())
                .then((data) => {
                    const container = document.getElementById("listaFrota");
                    container.innerHTML = "<h3>Frota Cadastrada</h3>";
                    if (!data || !data.length) {
                        container.innerHTML += "<p>Nenhum veículo encontrado.</p>";
                        return;
                    }
                    let html =
                        "<table><tr><th>ID</th><th>Nome</th><th>Placa</th><th>Fornecedor</th></tr>";
                    data.forEach((f) => {
                        html += `
              <tr>
                <td>${f.id}</td>
                <td>${f.nome_veiculo}</td>
                <td>${f.placa}</td>
                <td>${f.fornecedor_nome || ""}</td>
              </tr>
            `;
                    });
                    html += "</table>";
                    container.innerHTML += html;
                })
                .catch((err) => console.error("Erro fetch frota:", err));
        }
        // LOGOUT
        function logout() {
            window.location.href = "/logout";
        }
        // Inicialização
        document.addEventListener("DOMContentLoaded", () => {
            renderizarPermissoesGlobais();
        });
    </script>
</body>

</html>