<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PyDen Express - Dashboard Admin</title>
  <!-- Estilos: mantendo os links de CSS existentes -->
  <link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="/assets/css/datatables.min.css" />
  <link rel="stylesheet" href="/assets/css/style.css" />
  <!-- Biblioteca de gráficos Chart.js (via CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- Barra de navegação (simplificada) com botão de ajuda e logout -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <a class="navbar-brand" href="#">PyDen Express</a>
    <button class="btn btn-outline-info ml-auto" data-toggle="modal" data-target="#helpModal">Ajuda</button>
    <a class="btn btn-danger ml-2" href="/logout">Sair</a>
  </nav>

  <div class="container-fluid mt-4">
    <h1 class="mb-4 text-center">Painel Administrativo</h1>

    <!-- ======================= Painel de Estatísticas ======================= -->
    <section id="stats-section" class="mb-5">
      <h2>Estatísticas Gerais</h2>
      <div class="row">
        <div class="col-md-6 mb-4">
          <h5 class="text-center">Usuários Ativos vs Inativos</h5>
          <canvas id="userChart" width="400" height="300"></canvas>
        </div>
        <div class="col-md-6 mb-4">
          <h5 class="text-center">Dispositivos: Em Uso vs Disponíveis</h5>
          <canvas id="deviceChart" width="400" height="300"></canvas>
        </div>
      </div>
    </section>

    <!-- ======================= Seção de Usuários ======================= -->
    <section id="users-section" class="mb-5">
      <h2>Gerenciamento de Usuários</h2>
      <!-- Filtros de busca e filtros avançados para usuários -->
      <form class="form-inline mb-3">
        <div class="form-group mr-3">
          <label for="userSearch" class="mr-1">Buscar Nome/Email:</label>
          <input type="text" id="userSearch" class="form-control" placeholder="Buscar nome ou email" />
        </div>
        <div class="form-group mr-3">
          <label for="userPhoneSearch" class="mr-1">Telefone:</label>
          <input type="text" id="userPhoneSearch" class="form-control" placeholder="Buscar telefone" />
        </div>
        <div class="form-group mr-3">
          <label for="filterPermission" class="mr-1">Permissão:</label>
          <select id="filterPermission" class="form-control">
            <option value="">Todas</option>
            <option value="master">Master</option>
            <option value="admin">Admin</option>
            <option value="gestor">Gestor</option>
            <!-- Outras permissões específicas de fornecedores podem ser filtradas via busca livre -->
          </select>
        </div>
        <div class="form-group">
          <label for="filterUserStatus" class="mr-1">Status:</label>
          <select id="filterUserStatus" class="form-control">
            <option value="">Todos</option>
            <option value="ativo">Ativos</option>
            <option value="inativo">Restritos</option>
          </select>
        </div>
      </form>

      <!-- Tabela de usuários com resultados filtráveis -->
      <div class="table-responsive">
        <table id="userTable" class="table table-striped table-hover">
          <thead class="thead-dark">
            <tr>
              <th>ID</th>
              <th>Nome</th>
              <th>Telefone</th>
              <th>Email</th>
              <th>Permissões</th>
              <th>Status</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            <!-- Conteúdo preenchido dinamicamente via JavaScript -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- ======================= Seção de Dispositivos ======================= -->
    <section id="devices-section" class="mb-5">
      <h2>Gerenciamento de Dispositivos GPS</h2>
      <!-- Filtros de busca e filtros avançados para dispositivos -->
      <form class="form-inline mb-3">
        <div class="form-group mr-3">
          <label for="deviceSearch" class="mr-1">Buscar Modelo/IMEI:</label>
          <input type="text" id="deviceSearch" class="form-control" placeholder="Buscar modelo ou IMEI" />
        </div>
        <div class="form-group mr-3">
          <label for="devicePhoneSearch" class="mr-1">Telefone SIM:</label>
          <input type="text" id="devicePhoneSearch" class="form-control" placeholder="Buscar telefone do SIM" />
        </div>
        <div class="form-group">
          <label for="filterDeviceStatus" class="mr-1">Status:</label>
          <select id="filterDeviceStatus" class="form-control">
            <option value="">Todos</option>
            <option value="uso">Em uso</option>
            <option value="livre">Disponíveis</option>
          </select>
        </div>
      </form>

      <!-- Botão para abrir modal de cadastro de dispositivo -->
      <button class="btn btn-primary mb-3" data-toggle="modal" data-target="#addDeviceModal">Adicionar Dispositivo</button>

      <!-- Tabela de dispositivos -->
      <div class="table-responsive">
        <table id="deviceTable" class="table table-striped table-hover">
          <thead class="thead-dark">
            <tr>
              <th>ID</th>
              <th>Modelo</th>
              <th>IMEI</th>
              <th>Telefone</th>
              <th>Veículo</th>
              <th>Observação</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            <!-- Conteúdo preenchido dinamicamente via JavaScript -->
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- ======================= Modal de Ajuda (Passo a passo do GPS) ======================= -->
  <div class="modal fade" id="helpModal" tabindex="-1" role="dialog" aria-labelledby="helpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="helpModalLabel">Ajuda - Passo a Passo do GPS</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <!-- Conteúdo explicativo passo a passo -->
          <ol>
            <li>Insira o cartão SIM no dispositivo GPS e verifique se o dispositivo está ligado.</li>
            <li>Instale o dispositivo no veículo em um local com boa cobertura de sinal GPS.</li>
            <li>Aguarde o dispositivo adquirir sinal GPS (pode levar alguns minutos no primeiro uso).</li>
            <li>No sistema, cadastre o dispositivo informando modelo, IMEI e número de telefone do SIM.</li>
            <li>Vincule o dispositivo a um veículo (opcional) e a um fornecedor, se aplicável.</li>
            <li>Monitore a localização e status do dispositivo em tempo real através deste painel.</li>
          </ol>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Fechar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ======================= Modal de Cadastro de Dispositivo ======================= -->
  <div class="modal fade" id="addDeviceModal" tabindex="-1" role="dialog" aria-labelledby="addDeviceModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <form id="deviceForm" novalidate>
          <div class="modal-header">
            <h5 class="modal-title" id="addDeviceModalLabel">Cadastrar Novo Dispositivo</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label for="deviceModelo">Modelo:</label>
              <input type="text" id="deviceModelo" name="modelo" class="form-control" required />
              <div class="invalid-feedback">Por favor, informe o modelo do dispositivo.</div>
            </div>
            <div class="form-group">
              <label for="deviceIMEI">IMEI:</label>
              <input type="text" id="deviceIMEI" name="imei" class="form-control" pattern="\d{15}" required />
              <div class="invalid-feedback">IMEI deve conter 15 dígitos numéricos.</div>
            </div>
            <div class="form-group">
              <label for="deviceICCID">ICCID (SIM):</label>
              <input type="text" id="deviceICCID" name="iccid" class="form-control" required />
              <div class="invalid-feedback">Por favor, informe o código ICCID do chip SIM.</div>
            </div>
            <div class="form-group">
              <label for="devicePhone">Telefone (SIM):</label>
              <input type="text" id="devicePhone" name="telefone" class="form-control" pattern="\d+" required />
              <div class="invalid-feedback">Informe o número de telefone do SIM (somente dígitos).</div>
            </div>
            <div class="form-group">
              <label for="deviceVeiculo">Veículo:</label>
              <select id="deviceVeiculo" name="veiculo_id" class="form-control">
                <option value="" selected>-- Não vincular a veículo --</option>
                <!-- Opções de veículos serão carregadas via JavaScript -->
              </select>
              <div class="invalid-feedback">Selecione um veículo válido ou deixe como "Não vincular".</div>
            </div>
            <div class="form-group">
              <label for="deviceObs">Observação:</label>
              <input type="text" id="deviceObs" name="observacao" class="form-control" />
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Cadastrar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ======================= Modal de Vínculo de Usuário a Fornecedor ======================= -->
  <div class="modal fade" id="linkModal" tabindex="-1" role="dialog" aria-labelledby="linkModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <form id="linkForm">
          <div class="modal-header">
            <h5 class="modal-title" id="linkModalLabel">Vincular Usuário a Fornecedor</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Fechar">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <p id="linkUserInfo">Usuário: <strong id="linkUserName"></strong></p>
            <input type="hidden" id="linkUserId" name="userId" />
            <div class="form-group">
              <label for="fornecedorSelect">Fornecedor:</label>
              <select id="fornecedorSelect" name="fornecedorId" class="form-control" required>
                <option value="" disabled selected>Selecione um fornecedor</option>
                <!-- Lista de fornecedores carregada via JS -->
              </select>
              <div class="invalid-feedback">Por favor, selecione um fornecedor.</div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Vincular</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Scripts JS (jQuery, Bootstrap, DataTables) -->
  <script src="/assets/js/jquery.min.js"></script>
  <script src="/assets/js/bootstrap.bundle.min.js"></script>
  <script src="/assets/js/datatables.min.js"></script>
  <script>
    $(document).ready(function() {
      // Arrays globais para armazenar dados carregados
      let usersData = [];
      let devicesData = [];
      let suppliersData = [];

      // Carrega a lista de usuários via API
      fetch('/api/admin/users')
        .then(response => response.json())
        .then(data => {
          usersData = data;
          populateUserTable(usersData);
          updateUserChart();
        })
        .catch(error => console.error('Erro ao buscar usuários:', error));

      // Carrega a lista de dispositivos via API
      fetch('/api/admin/devices')
        .then(response => response.json())
        .then(data => {
          devicesData = data;
          populateDeviceTable(devicesData);
          updateDeviceChart();
        })
        .catch(error => console.error('Erro ao buscar dispositivos:', error));

      // Carrega a lista de fornecedores para uso no modal de vínculo
      fetch('/api/fornecedores-admin')
        .then(response => response.json())
        .then(data => {
          suppliersData = data;
          const fornecedorSelect = $('#fornecedorSelect');
          data.forEach(f => {
            // adiciona cada fornecedor como opção no select
            fornecedorSelect.append(new Option(f.nome_fornecedor, f.id));
          });
        })
        .catch(error => console.error('Erro ao buscar fornecedores:', error));

      // ========== Preenche tabela de usuários ==========
      function populateUserTable(data) {
        const tbody = $('#userTable tbody');
        tbody.empty();
        data.forEach(user => {
          // Determina o status textual do usuário
          const statusText = user.init ? 'Ativo' : 'Restrito';
          // Formata as permissões para exibição
          let permText = '';
          if (user.permissoes) {
            try {
              const permList = JSON.parse(user.permissoes);
              permText = Array.isArray(permList) ? permList.join(', ') : String(user.permissoes);
            } catch {
              permText = String(user.permissoes);
            }
          }
          // Define texto e classe do botão de ativar/restringir
          const toggleBtnText = user.init ? 'Restringir' : 'Ativar';
          const toggleBtnClass = user.init ? 'btn-warning' : 'btn-success';
          // Monta a linha da tabela
          const tr = $(`
            <tr>
              <td>${user.id}</td>
              <td>${user.nome_completo}</td>
              <td>${user.telefone || ''}</td>
              <td>${user.email}</td>
              <td>${permText}</td>
              <td>${statusText}</td>
              <td>
                <button class="btn ${toggleBtnClass} btn-sm toggle-access-btn">${toggleBtnText}</button>
                <button class="btn btn-info btn-sm link-user-btn" data-toggle="modal" data-target="#linkModal">Vincular</button>
                <button class="btn btn-danger btn-sm delete-user-btn">Excluir</button>
              </td>
            </tr>
          `);
          // Armazena ID e info do usuário nos botões para uso nos handlers
          tr.find('.toggle-access-btn').data('userid', user.id).data('current', user.init);
          tr.find('.link-user-btn').data('userid', user.id).data('username', user.nome_completo);
          tr.find('.delete-user-btn').data('userid', user.id);
          tbody.append(tr);
        });
      }

      // ========== Preenche tabela de dispositivos ==========
      function populateDeviceTable(data) {
        const tbody = $('#deviceTable tbody');
        tbody.empty();
        data.forEach(dev => {
          const veiculoText = dev.veiculo && dev.veiculo.placa ? dev.veiculo.placa : '-';
          const obsText = dev.observacao || '';
          const tr = $(`
            <tr>
              <td>${dev.id}</td>
              <td>${dev.modelo}</td>
              <td>${dev.imei}</td>
              <td>${dev.telefone || ''}</td>
              <td>${veiculoText}</td>
              <td>${obsText}</td>
              <td>
                <button class="btn btn-danger btn-sm delete-device-btn">Excluir</button>
              </td>
            </tr>
          `);
          tr.find('.delete-device-btn').data('deviceid', dev.id);
          tbody.append(tr);
        });
      }

      // ========== Atualiza gráfico de usuários (Chart.js) ==========
      function updateUserChart() {
        if (!usersData.length) return;
        const totalUsers = usersData.length;
        const activeUsers = usersData.filter(u => u.init).length;
        const inactiveUsers = totalUsers - activeUsers;
        const ctx = document.getElementById('userChart').getContext('2d');
        // Destroi gráfico anterior se existir, para poder atualizar
        if (window.userChartInstance) {
          window.userChartInstance.destroy();
        }
        window.userChartInstance = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Ativos', 'Restritos'],
            datasets: [{
              data: [activeUsers, inactiveUsers],
              backgroundColor: ['#4caf50', '#f44336']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' }
            }
          }
        });
      }

      // ========== Atualiza gráfico de dispositivos (Chart.js) ==========
      function updateDeviceChart() {
        if (!devicesData.length) return;
        const totalDevices = devicesData.length;
        const inUse = devicesData.filter(d => d.veiculo && d.veiculo.id).length;
        const available = totalDevices - inUse;
        const ctx = document.getElementById('deviceChart').getContext('2d');
        if (window.deviceChartInstance) {
          window.deviceChartInstance.destroy();
        }
        window.deviceChartInstance = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Em uso', 'Disponíveis'],
            datasets: [{
              data: [inUse, available],
              backgroundColor: ['#42a5f5', '#9e9e9e']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' }
            }
          }
        });
      }

      // ========== Filtros de busca na tabela de usuários ==========
      function filterUsers() {
        let filtered = usersData.slice();  // cópia da lista
        const textQuery = $('#userSearch').val().toLowerCase();
        const phoneQuery = $('#userPhoneSearch').val().toLowerCase();
        const permFilter = $('#filterPermission').val();
        const statusFilter = $('#filterUserStatus').val();
        filtered = filtered.filter(u => {
          // Busca texto em nome ou email
          if (textQuery) {
            const combined = (u.nome_completo + ' ' + u.email).toLowerCase();
            if (!combined.includes(textQuery)) return false;
          }
          // Busca em telefone
          if (phoneQuery) {
            const phoneStr = (u.telefone || '').toLowerCase();
            if (!phoneStr.includes(phoneQuery)) return false;
          }
          // Filtra por permissão (se selecionada)
          if (permFilter) {
            if (!u.permissoes || !u.permissoes.includes(permFilter)) return false;
          }
          // Filtra por status (ativo/inativo)
          if (statusFilter) {
            const isActive = u.init;
            if (statusFilter === 'ativo' && !isActive) return false;
            if (statusFilter === 'inativo' && isActive) return false;
          }
          return true;
        });
        populateUserTable(filtered);
      }

      // ========== Filtros de busca na tabela de dispositivos ==========
      function filterDevices() {
        let filtered = devicesData.slice();
        const textQuery = $('#deviceSearch').val().toLowerCase();
        const phoneQuery = $('#devicePhoneSearch').val().toLowerCase();
        const statusFilter = $('#filterDeviceStatus').val();
        filtered = filtered.filter(d => {
          if (textQuery) {
            const combined = (d.modelo + ' ' + d.imei).toLowerCase();
            if (!combined.includes(textQuery)) return false;
          }
          if (phoneQuery) {
            const phoneStr = (d.telefone || '').toLowerCase();
            if (!phoneStr.includes(phoneQuery)) return false;
          }
          if (statusFilter) {
            const isInUse = d.veiculo && d.veiculo.id;
            if (statusFilter === 'uso' && !isInUse) return false;
            if (statusFilter === 'livre' && isInUse) return false;
          }
          return true;
        });
        populateDeviceTable(filtered);
      }

      // Atrela eventos de filtro nos campos de busca
      $('#userSearch, #userPhoneSearch').on('input', filterUsers);
      $('#filterPermission, #filterUserStatus').on('change', filterUsers);
      $('#deviceSearch, #devicePhoneSearch').on('input', filterDevices);
      $('#filterDeviceStatus').on('change', filterDevices);

      // ========== Evento: Ativar/Restringir usuário ==========
      $('#userTable').on('click', '.toggle-access-btn', function() {
        const userId = $(this).data('userid');
        const currentlyActive = $(this).data('current');  // estado atual (booleano)
        const newInit = !currentlyActive;
        const btn = $(this);
        btn.prop('disabled', true).text('Processando...');
        fetch('/api/admin/toggle-init', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: userId, init: newInit })
        })
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            // Atualiza status no array local
            const user = usersData.find(u => u.id === userId);
            if (user) user.init = newInit;
            // Atualiza tabela filtrada e gráfico
            filterUsers();
            updateUserChart();
          } else {
            console.error('Falha ao alterar status do usuário.');
          }
        })
        .catch(error => console.error('Erro ao alterar status do usuário:', error))
        .finally(() => btn.prop('disabled', false));
      });

      // ========== Evento: Abrir modal de vínculo (preencher dados do usuário) ==========
      $('#linkModal').on('show.bs.modal', function(event) {
        const button = $(event.relatedTarget);
        const userId = button.data('userid');
        const userName = button.data('username');
        $('#linkUserId').val(userId);
        $('#linkUserName').text(userName);
        // Limpa seleção anterior
        $('#fornecedorSelect').val('');
        $('#fornecedorSelect').removeClass('is-invalid');
      });

      // ========== Evento: Vincular usuário a fornecedor ==========
      $('#linkForm').on('submit', function(e) {
        e.preventDefault();
        const userId = $('#linkUserId').val();
        const fornecedorId = $('#fornecedorSelect').val();
        if (!fornecedorId) {
          // validação simples: seleção obrigatória
          $('#fornecedorSelect').addClass('is-invalid');
          return;
        }
        // Desabilita botão para evitar duplo envio
        $('#linkModal .btn-primary').prop('disabled', true).text('Vinculando...');
        fetch('/api/admin/relate-user-fornecedor', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: userId, fornecedorId: fornecedorId })
        })
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            alert('Usuário vinculado com sucesso!');
            $('#linkModal').modal('hide');
            // (Opcional: poderia atualizar a tabela de usuários para indicar vínculo, se exibido)
          } else {
            alert('Falha ao vincular usuário.');
          }
        })
        .catch(error => {
          console.error('Erro ao vincular usuário:', error);
          alert('Erro ao vincular usuário.');
        })
        .finally(() => {
          $('#linkModal .btn-primary').prop('disabled', false).text('Vincular');
        });
      });

      // ========== Evento: Excluir usuário ==========
      $('#userTable').on('click', '.delete-user-btn', function() {
        const userId = $(this).data('userid');
        if (!confirm('Tem certeza que deseja excluir este usuário?')) {
          return;
        }
        const btn = $(this);
        btn.prop('disabled', true).text('Excluindo...');
        fetch(`/api/admin/delete-user/${userId}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            // Remove usuário da lista local e atualiza UI
            usersData = usersData.filter(u => u.id !== userId);
            filterUsers();
            updateUserChart();
          } else {
            alert('Não foi possível excluir o usuário.');
          }
        })
        .catch(error => {
          console.error('Erro ao excluir usuário:', error);
          alert('Erro ao excluir usuário.');
        });
      });

      // ========== Evento: Excluir dispositivo ==========
      $('#deviceTable').on('click', '.delete-device-btn', function() {
        const deviceId = $(this).data('deviceid');
        if (!confirm('Tem certeza que deseja excluir este dispositivo?')) {
          return;
        }
        const btn = $(this);
        btn.prop('disabled', true).text('Excluindo...');
        fetch(`/api/admin/devices/${deviceId}`, { method: 'DELETE' })
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            devicesData = devicesData.filter(d => d.id !== deviceId);
            filterDevices();
            updateDeviceChart();
          } else {
            alert('Não foi possível excluir o dispositivo.');
          }
        })
        .catch(error => {
          console.error('Erro ao excluir dispositivo:', error);
          alert('Erro ao excluir dispositivo.');
        });
      });

      // ========== Validações em tempo real no formulário de dispositivo ==========
      $('#deviceIMEI').on('input', function() {
        const pattern = /^\d{15}$/;
        if (pattern.test(this.value)) {
          this.setCustomValidity('');
          $(this).removeClass('is-invalid');
        } else {
          this.setCustomValidity('IMEI inválido');
          if (this.value !== '') $(this).addClass('is-invalid');
        }
      });
      $('#devicePhone').on('input', function() {
        const pattern = /^\d+$/;
        if (pattern.test(this.value)) {
          this.setCustomValidity('');
          $(this).removeClass('is-invalid');
        } else {
          this.setCustomValidity('Telefone inválido');
          if (this.value !== '') $(this).addClass('is-invalid');
        }
      });
      $('#deviceModelo, #deviceICCID').on('input', function() {
        if ($(this).val().trim() === '') {
          $(this).addClass('is-invalid');
        } else {
          $(this).removeClass('is-invalid');
        }
      });

      // ========== Cadastro de novo dispositivo (submit do formulário) ==========
      $('#deviceForm').on('submit', function(e) {
        e.preventDefault();
        const form = this;
        // Utiliza API HTML5 para verificar validade geral do formulário
        if (!form.checkValidity()) {
          e.stopPropagation();
          $(form).addClass('was-validated');
          return;
        }
        // Prepara os dados do novo dispositivo
        const newDevice = {
          modelo: $('#deviceModelo').val().trim(),
          imei: $('#deviceIMEI').val().trim(),
          iccid: $('#deviceICCID').val().trim(),
          telefone: $('#devicePhone').val().trim(),
          veiculo_id: $('#deviceVeiculo').val() || null,
          observacao: $('#deviceObs').val().trim() || ''
        };
        // Feedback visual: desabilita botão de submit e indica carregamento
        $('#addDeviceModal .btn-primary').prop('disabled', true).text('Cadastrando...');
        fetch('/api/admin/devices', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(newDevice)
        })
        .then(response => response.json())
        .then(result => {
          if (result && result.id) {
            // Adiciona novo dispositivo à lista local e atualiza tabela/gráfico
            devicesData.push(result);
            filterDevices();
            updateDeviceChart();
            alert('Dispositivo cadastrado com sucesso!');
            $('#addDeviceModal').modal('hide');
            form.reset();
          } else {
            alert('Falha ao cadastrar dispositivo.');
          }
        })
        .catch(error => {
          console.error('Erro ao cadastrar dispositivo:', error);
          alert('Erro ao cadastrar dispositivo.');
        })
        .finally(() => {
          $('#addDeviceModal .btn-primary').prop('disabled', false).text('Cadastrar');
        });
      });
    });
  </script>
</body>
</html>
