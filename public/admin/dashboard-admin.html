<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>PyDen Express Admin – Usuários & GPS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- CSS: Bootstrap, DataTables e tema -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link
    href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css"
    rel="stylesheet"
  />
  <link href="../../assets/css/pydenadmin.min.css" rel="stylesheet" />
  <link href="../../assets/css/demo.css" rel="stylesheet" />
</head>
<body>
  <aside class="sidebar bg-dark">
    <!-- SIDEBAR: movido para arquivo parcial se desejar -->
    <nav class="nav flex-column p-3 text-white">
      <a class="nav-link text-white mb-2" href="#dashboard">Dashboard</a>
      <a class="nav-link text-white mb-2" href="#users">Usuários</a>
      <a class="nav-link text-white mb-2" href="#gps">GPS</a>
    </nav>
  </aside>

  <div class="main-panel">
    <header class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">PyDen Admin</a>
        <ul class="navbar-nav ms-auto">
          <li class="nav-item dropdown">
            <a
              class="nav-link dropdown-toggle"
              href="#"
              role="button"
              data-bs-toggle="dropdown"
            >
              <img
                src="../../assets/img/profile.jpg"
                alt="perfil"
                class="rounded-circle"
                width="30"
              />
              <span class="ms-1">Admin</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#">Meu Perfil</a></li>
              <li><hr class="dropdown-divider" /></li>
              <li><a class="dropdown-item text-danger" href="#" id="logoutBtn">Sair</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </header>

    <main class="container-fluid py-4">
      <!-- Dashboard -->
      <section id="dashboard" class="mb-5">
        <div class="card">
          <div class="card-header">Estatísticas</div>
          <div class="card-body">
            <!-- Aqui você pode injetar cards dinâmicos via JS -->
            <div class="row" id="statsContainer"></div>
          </div>
        </div>
      </section>

      <!-- Gerenciamento de Usuários -->
      <section id="users" class="mb-5">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Usuários</h5>
          </div>
          <div class="card-body">
            <table
              id="usersTable"
              class="table table-striped"
              style="width:100%"
            >
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nome</th>
                  <th>Telefone</th>
                  <th>Email</th>
                  <th>Permissões</th>
                  <th>Status</th>
                  <th>Ações</th>
                </tr>
              </thead>
            </table>
          </div>
        </div>
      </section>

      <!-- Gerenciamento de GPS -->
      <section id="gps">
        <div class="d-flex justify-content-between mb-3">
          <h5>Dispositivos GPS</h5>
          <button
            id="newDeviceBtn"
            class="btn btn-primary"
            data-bs-toggle="modal"
            data-bs-target="#deviceModal"
          >
            <i class="fa fa-plus"></i> Cadastrar
          </button>
        </div>
        <table
          id="gpsTable"
          class="table table-striped"
          style="width:100%"
        >
          <thead>
            <tr>
              <th>ID</th>
              <th>Modelo</th>
              <th>IMEI</th>
              <th>ICCID</th>
              <th>Telefone</th>
              <th>Veículo</th>
              <th>Ações</th>
            </tr>
          </thead>
        </table>
      </section>
    </main>

    <footer class="footer bg-light py-3 text-center">
      © 2025 PyDen Express. Todos os direitos reservados.
    </footer>
  </div>

  <!-- Modal genérico para criar/editar GPS -->
  <div
    class="modal fade"
    id="deviceModal"
    tabindex="-1"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="deviceForm">
          <div class="modal-header">
            <h5 class="modal-title" id="deviceModalLabel">Dispositivo GPS</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body row g-3">
            <input type="hidden" id="deviceId" />
            <div class="col-md-4">
              <label class="form-label">Modelo</label>
              <input
                type="text"
                id="deviceModel"
                class="form-control"
                required
              />
            </div>
            <div class="col-md-4">
              <label class="form-label">IMEI</label>
              <input
                type="text"
                id="deviceIMEI"
                class="form-control"
                required
              />
            </div>
            <div class="col-md-4">
              <label class="form-label">ICCID</label>
              <input
                type="text"
                id="deviceICCID"
                class="form-control"
              />
            </div>
            <div class="col-md-4">
              <label class="form-label">Telefone (SIM)</label>
              <input
                type="tel"
                id="devicePhone"
                class="form-control"
              />
            </div>
            <div class="col-md-4">
              <label class="form-label">Veículo</label>
              <select id="deviceVehicle" class="form-select"></select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Observação</label>
              <input
                type="text"
                id="deviceObs"
                class="form-control"
              />
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancelar
            </button>
            <button type="submit" class="btn btn-success">
              Salvar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
    <script src="../../assets/js/core/jquery-3.7.1.min.js"></script>
    <script src="../../assets/js/core/popper.min.js"></script>
    <script src="../../assets/js/core/bootstrap.min.js"></script>
    <script src="../../assets/js/usuario.js"></script>
    <script src="../../assets/js/plugin/bootstrap-notify/bootstrap-notify.min.js"></script>
    <script src="../../assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
    <script src="../../assets/js/plugin/datatables/datatables.min.js"></script>
    <script src="../../assets/js/pydenadmin.min.js"></script>
    <script src="../../assets/js/setting-demo2.js"></script>
    <script>
        const permissoesDisponiveis = [
            "gestor", "admin", "locan", "talisma", "roma", "ctl", "diamond"
        ];

        let table;
        let tableGPS;
        let vehiclesList = [];

        $(document).ready(function () {
            // Tabela de usuários
            table = $("#tableUsers").DataTable({
                ajax: {
                    url: "/api/admin/users",
                    dataSrc: ""
                },
                columns: [
                    { data: "id" },
                    { data: "nome_completo" },
                    { data: "telefone" },
                    { data: "email" },
                    {
                        data: "permissoes",
                        render: function (data, type, row, meta) {
                            const userPerms = data ? data.split(",") : [];
                            let selectHtml = `<select class="form-select form-select-sm permissoes-select" multiple data-user-id="${row.id}">`;
                            permissoesDisponiveis.forEach((perm) => {
                                const selected = userPerms.includes(perm) ? "selected" : "";
                                selectHtml += `<option value="${perm}" ${selected}>${perm}</option>`;
                            });
                            selectHtml += `</select>`;
                            return selectHtml;
                        }
                    },
                    {
                        data: "init",
                        render: function (data, type, row, meta) {
                            return data ? "Ativo" : "Inativo";
                        }
                    },
                    {
                        data: null,
                        render: function (data, type, row) {
                            let btnInit = row.init
                                ? `<button class="btn btn-warning btn-sm toggle-init" data-user-id="${row.id}" data-init="false">Restringir</button>`
                                : `<button class="btn btn-success btn-sm toggle-init" data-user-id="${row.id}" data-init="true">Permitir</button>`;
                            const btnDelete = `<button class="btn btn-danger btn-sm delete-user" data-user-id="${row.id}">Excluir</button>`;
                            const btnFornecedor = `<button class="btn btn-info btn-sm relate-fornecedor" data-user-id="${row.id}"><i class="fas fa-link"></i></button>`;
                            return `${btnInit} ${btnDelete} ${btnFornecedor}`;
                        }
                    }
                ]
            });

            $("#tableUsers").on("change", ".permissoes-select", function () {
                const userId = $(this).data("user-id");
                const selectedOptions = $(this).val() || [];
                const newPerms = selectedOptions.join(",");

                $.ajax({
                    url: "/api/admin/update-user",
                    method: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify({ id: userId, permissoes: newPerms }),
                    success: function (res) {
                        table.ajax.reload(null, false);
                    },
                    error: function (err) {
                        console.error(err);
                        alert("Erro ao atualizar permissões do usuário.");
                    }
                });
            });

            $("#tableUsers").on("click", ".toggle-init", function () {
                const userId = $(this).data("user-id");
                const newInit = $(this).data("init") === true;

                $.ajax({
                    url: "/api/admin/toggle-init",
                    method: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify({ id: userId, init: newInit }),
                    success: function (res) {
                        table.ajax.reload(null, false);
                    },
                    error: function (err) {
                        console.error(err);
                        alert("Erro ao atualizar status do usuário.");
                    }
                });
            });

            $("#tableUsers").on("click", ".delete-user", function () {
                const userId = $(this).data("user-id");
                if (!confirm("Tem certeza que deseja excluir este usuário?")) {
                    return;
                }
                $.ajax({
                    url: `/api/admin/delete-user/${userId}`,
                    method: "DELETE",
                    success: function (res) {
                        table.ajax.reload(null, false);
                    },
                    error: function (err) {
                        console.error(err);
                        alert("Erro ao excluir usuário.");
                    }
                });
            });

            $("#tableUsers").on("click", ".relate-fornecedor", function () {
                const userId = $(this).data("user-id");
                $("#relateUserId").val(userId);
                $.getJSON("/api/fornecedores-admin", function (data) {
                    $("#fornecedorSelect").empty();
                    data.forEach((forn) => {
                        $("#fornecedorSelect").append(`
                            <option value="${forn.id}">${forn.nome_fornecedor}</option>
                        `);
                    });
                    $("#modalRelateFornecedor").modal("show");
                });
            });

            $("#btnVincular").on("click", function () {
                const userId = $("#relateUserId").val();
                const fornecedorId = $("#fornecedorSelect").val();

                $.ajax({
                    url: "/api/admin/relate-user-fornecedor",
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({ userId, fornecedorId }),
                    success: function (res) {
                        alert("Usuário vinculado ao fornecedor com sucesso!");
                        $("#modalRelateFornecedor").modal("hide");
                    },
                    error: function (err) {
                        console.error(err);
                        alert("Erro ao vincular usuário ao fornecedor.");
                    }
                });
            });

            $(".scroll-link").on("click", function (e) {
                e.preventDefault();
                const target = $(this).attr("href");
                $("html, body").animate({ scrollTop: $(target).offset().top - 70 }, 800);
            });

            // GPS
            $.ajax({
                url: "/api/veiculos-simples",
                method: "GET",
                success: function (data) {
                    vehiclesList = data;
                    const veiculoSelect = $("#veiculo_id");
                    data.forEach((veh) => {
                        const text = `${veh.id} - ${veh.placa || ""}`;
                        veiculoSelect.append(`<option value="${veh.id}">${text}</option>`);
                    });
                },
                error: function (err) {
                    console.error(err);
                    alert("Erro ao carregar lista de veículos.");
                }
            });

            tableGPS = $("#tableGPS").DataTable({
                ajax: {
                    url: "/api/admin/devices",
                    dataSrc: ""
                },
                columns: [
                    { data: "id" },
                    { data: "modelo" },
                    { data: "imei" },
                    { data: "iccid" },
                    { data: "telefone" },
                    {
                        data: "veiculo",
                        render: function (data, type, row) {
                            if (!data) return "Nenhum";
                            return data.placa ? data.placa : data.id;
                        }
                    },
                    {
                        data: null,
                        render: function (data, type, row) {
                            const btnDelete = `<button class="btn btn-danger btn-sm delete-device" data-device-id="${row.id}">
                                <i class="fa fa-trash-alt"></i>
                            </button>`;
                            const btnEdit = `<button class="btn btn-warning btn-sm edit-device" data-device-id="${row.id}">
                                <i class="fa fa-edit"></i>
                            </button>`;
                            return `${btnEdit} ${btnDelete}`;
                        }
                    }
                ],
                language: {
                    decimal: ",",
                    thousands: ".",
                    info: "Mostrando _START_ até _END_ de _TOTAL_ registros",
                    infoEmpty: "Mostrando 0 até 0 de 0 registros",
                    infoFiltered: "(filtrado de _MAX_ registros no total)",
                    lengthMenu: "Mostrar _MENU_ registros",
                    loadingRecords: "Carregando...",
                    processing: "Processando...",
                    search: "Pesquisar:",
                    zeroRecords: "Nenhum registro encontrado",
                    paginate: {
                        first: "Primeiro",
                        last: "Último",
                        next: "Próximo",
                        previous: "Anterior"
                    },
                    emptyTable: "Nenhum dispositivo cadastrado"
                }
            });

            $("#gps-form").on("submit", function (e) {
                e.preventDefault();
                const formData = {
                    modelo: $("#modelo").val(),
                    imei: $("#imei").val(),
                    iccid: $("#iccid").val(),
                    telefone: $("#telefone").val(),
                    veiculo_id: $("#veiculo_id").val() || null,
                    observacao: $("#observacao").val()
                };
                $.ajax({
                    url: "/api/admin/devices",
                    method: "POST",
                    contentType: "application/json",
                    data: JSON.stringify(formData),
                    success: function (res) {
                        $("#modalCadastroGPS").modal("hide");
                        $("#gps-form")[0].reset();
                        tableGPS.ajax.reload(null, false);
                    },
                    error: function (err) {
                        console.error(err);
                        alert("Erro ao cadastrar dispositivo.");
                    }
                });
            });

            $("#tableGPS").on("click", ".delete-device", function () {
                const deviceId = $(this).data("device-id");
                if (!confirm("Tem certeza que deseja excluir este dispositivo?")) return;
                $.ajax({
                    url: `/api/admin/devices/${deviceId}`,
                    method: "DELETE",
                    success: function (res) {
                        tableGPS.ajax.reload(null, false);
                    },
                    error: function (err) {
                        console.error(err);
                        alert("Erro ao excluir dispositivo.");
                    }
                });
            });

            $("#tableGPS").on("click", ".edit-device", function () {
                const deviceId = $(this).data("device-id");
                alert("Aqui poderia abrir um modal de edição para ID: " + deviceId + " (Função não implementada).");
            });
        });
    </script>
  <script
    src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-..."
    crossorigin="anonymous"
  ></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="../../assets/js/admin.js" defer></script>
</body>
</html>
