<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Cadastro de Alunos</title>
  <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport" />
  <link rel="icon" href="../../assets/img/pydenadmin/favicon.png" type="image/x-icon" />
  <script src="../../assets/js/plugin/webfont/webfont.min.js"></script>
  <script>
    WebFont.load({
      google: { families: ["Public Sans:300,400,500,600,700"] },
      custom: {
        families: ["Font Awesome 5 Solid", "Font Awesome 5 Regular", "Font Awesome 5 Brands", "simple-line-icons"],
        urls: ["../../assets/css/fonts.min.css"]
      },
      active: function () {
        sessionStorage.fonts = true;
      }
    });
  </script>
  <link rel="stylesheet" href="../../assets/css/bootstrap.min.css">
  <link rel="stylesheet" href="../../assets/css/plugins.min.css">
  <link rel="stylesheet" href="../../assets/css/pydenadmin.min.css">
  <link rel="stylesheet" href="../../assets/css/demo.css">

  <link rel="stylesheet" href="../../assets/css/pydenadmin.min.css" />

  <link rel="stylesheet" href="../../assets/css/notificacoes.css">

  <style>
    /* Reset e base */
    *,
    *::before,
    *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Public Sans", sans-serif;
      background: linear-gradient(135deg, #f0f0f5, #e0e0eb);
      color: #333;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .page-inner {
      padding: 20px;
    }

    .page-header h3 {
      font-size: 2rem;
      margin-bottom: 20px;
      text-align: center;
      font-weight: 600;
      color: #333;
    }

    /* Cartões e Wizard Steps */
    .card {
      background-color: #fff;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    .card:hover {
      transform: translateY(-10px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }

    .wizard-step {
      display: none;
      opacity: 0;
      animation: fadeIn 0.5s forwards;
    }

    .wizard-step.active {
      display: block;
      opacity: 1;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    /* Formulários e Elementos */
    input,
    select,
    textarea {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 8px 12px;
      transition: border-color 0.3s, box-shadow 0.3s;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: #66afe9;
      box-shadow: 0 0 10px rgba(102, 175, 233, 0.6);
      outline: none;
    }

    label {
      font-weight: 500;
      margin-bottom: 5px;
      display: inline-block;
    }

    /* Botões */
    button {
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      cursor: pointer;
      transition: background-color 0.3s, transform 0.2s;
    }

    button:focus {
      outline: none;
    }

    .btn-primary {
      background-color: #007bff;
      color: #fff;
    }

    .btn-primary:hover {
      background-color: #0069d9;
    }

    .btn-success {
      background-color: #28a745;
      color: #fff;
    }

    .btn-success:hover {
      background-color: #218838;
    }

    .btn-danger {
      background-color: #dc3545;
      color: #fff;
    }

    .btn-danger:hover {
      background-color: #c82333;
    }

    .btn-warning {
      background-color: #ffc107;
      color: #333;
    }

    .btn-warning:hover {
      background-color: #e0a800;
    }

    .btn-info {
      background-color: #17a2b8;
      color: #fff;
    }

    .btn-info:hover {
      background-color: #138496;
    }

    .btn-outline-danger {
      background-color: transparent;
      color: #dc3545;
      border: 1px solid #dc3545;
    }

    .btn-outline-danger:hover {
      background-color: #dc3545;
      color: #fff;
    }

    /* Mapa e Medição */
    #mapCriterios {
      width: 100%;
      height: 400px;
      border: 2px solid #ddd;
      border-radius: 15px;
      margin-top: 20px;
      transition: box-shadow 0.3s ease;
    }

    #mapCriterios:hover {
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
    }

    #measureInfo {
      margin-top: 10px;
      font-weight: 600;
      font-size: 0.9rem;
      color: #444;
    }

    /* Badge de idade */
    .badge-idade {
      font-size: 0.85rem;
      padding: 6px 10px;
    }

    .bg-success {
      background-color: #28a745 !important;
      color: #fff !important;
    }

    .bg-danger {
      background-color: #dc3545 !important;
      color: #fff !important;
    }

    .bg-secondary {
      background-color: #6c757d !important;
      color: #fff !important;
    }

    /* Modais */
    .modal-content {
      border-radius: 15px;
      animation: modalFadeIn 0.5s;
    }

    @keyframes modalFadeIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    .modal-header h5 {
      font-weight: 600;
      color: #333;
    }

    .btn-close {
      background: transparent;
      border: none;
    }

    /* Notificações customizadas */
    .notifyjs-corner {
      z-index: 1050;
      top: 20px !important;
      right: 20px !important;
    }

    /* Animações extras */
    .animated {
      animation-duration: 0.5s;
      animation-fill-mode: both;
    }

    .fadeInDown {
      animation-name: fadeInDown;
    }

    .fadeOutUp {
      animation-name: fadeOutUp;
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translate3d(0, -100%, 0);
      }

      to {
        opacity: 1;
        transform: translate3d(0, 0, 0);
      }
    }

    @keyframes fadeOutUp {
      from {
        opacity: 1;
        transform: translate3d(0, 0, 0);
      }

      to {
        opacity: 0;
        transform: translate3d(0, -100%, 0);
      }
    }

    /* Scrollbar customizada */
    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
  </style>

</head>

<body>
  <div class="container my-4">
    <div class="page-inner">
      <div class="page-header">
        <h3 class="fw-bold mb-12 text-center">Cadastro de Alunos</h3>
      </div>

      <div class="card wizard-step active" id="etapaSelecaoFluxo">
        <div class="card-header">
          <div class="card-title">Selecione o tipo de cadastro</div>
        </div>
        <div class="card-body">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="tipoFluxo" id="fluxoMunicipal" value="municipal" />
            <label class="form-check-label" for="fluxoMunicipal">Municipal</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="tipoFluxo" id="fluxoEstadual" value="estadual" />
            <label class="form-check-label" for="fluxoEstadual">Estadual</label>
          </div>
          <div class="mt-4">
            <button class="btn btn-primary" id="btnContinuarFluxo">Continuar</button>
          </div>
        </div>
      </div>

      <div class="card wizard-step" id="etapa1Municipal">
        <div class="card-header">
          <div class="card-title">Etapa 1 (Municipal): Dados do Aluno</div>
        </div>
        <div class="card-body">
          <div class="row justify-content-center">
            <div class="col-md-6 text-center">
              <label for="inputBusca" class="form-label">
                CPF, ID de Matrícula, ID de Pessoa ou Nome completo
              </label>
              <input type="text" class="form-control mx-auto" style="max-width: 300px;" id="inputBusca"
                placeholder="Digite aqui..." />
              <button id="btnBuscar" class="btn btn-primary mt-3">Buscar</button>
            </div>
          </div>
          <div class="row justify-content-center mt-4">
            <div class="col-md-10">
              <div class="d-none" id="dadosAlunoContainerMunicipal">
                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">ID Matrícula</label>
                    <input type="text" class="form-control" id="campoIdMatriculaMunicipal" readonly />
                  </div>
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Nome do Aluno</label>
                    <input type="text" class="form-control" id="campoNomeAlunoMunicipal" readonly />
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Data de Nascimento</label>
                    <input type="date" class="form-control" id="campoDataNascimentoMunicipal" readonly />
                  </div>
                  <div class="col-md-6 mb-2 d-flex align-items-end">
                    <span class="fw-semibold">
                      Idade:
                      <span id="campoIdadeMunicipal" class="badge bg-secondary badge-idade ms-1">--</span>
                    </span>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Escola</label>
                    <input type="text" class="form-control" id="campoEscolaMunicipal" readonly />
                  </div>
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Turma</label>
                    <input type="text" class="form-control" id="campoTurmaMunicipal" readonly />
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">CPF</label>
                    <input type="text" class="form-control" id="campoCpfMunicipal" readonly />
                  </div>
                  <div class="col-md-4 mb-2">
                    <label class="form-label fw-semibold">CEP</label>
                    <input type="text" class="form-control" id="campoCepMunicipal" />
                  </div>
                  <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-info w-100" id="btnConverterCepMunicipal">Converter CEP</button>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Rua</label>
                    <input type="text" class="form-control" id="campoRuaMunicipal" />
                  </div>
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Bairro</label>
                    <input type="text" class="form-control" id="campoBairroMunicipal" />
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Número Endereço</label>
                    <input type="text" class="form-control" id="campoNumeroEnderecoMunicipal" />
                  </div>
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Telefone</label>
                    <input type="text" class="form-control" id="campoTelefoneMunicipal" />
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Filiação 1</label>
                    <input type="text" class="form-control" id="campoFiliacao1Municipal" readonly />
                  </div>
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Filiação 2</label>
                    <input type="text" class="form-control" id="campoFiliacao2Municipal" readonly />
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Responsável</label>
                    <input type="text" class="form-control" id="campoResponsavelMunicipal" readonly />
                  </div>
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Deficiência</label>
                    <input type="text" class="form-control" id="campoDeficienciaMunicipal" />
                  </div>
                </div>
                <div class="d-flex justify-content-between mt-3">
                  <div>
                    <button class="btn btn-success me-2" id="btnSalvarAlteracoesMunicipal" disabled>Salvar
                      Alterações</button>
                    <button class="btn btn-info" id="btnImprimirConfirmacaoMunicipal" disabled>Imprimir
                      Confirmação</button>
                  </div>
                  <div>
                    <button class="btn btn-primary" id="btnProximoMunicipal" disabled>Próximo</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card wizard-step" id="etapa1Estadual">
        <div class="card-header">
          <div class="card-title">Etapa 1 (Estadual): Dados do Aluno</div>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-2">
              <label class="form-label fw-semibold">CPF ou ID Matrícula</label>
              <input type="text" class="form-control" id="inputBuscaEstadual"
                placeholder="Digite CPF ou Matrícula..." />
            </div>
            <div class="col-md-2 d-flex align-items-end mb-2">
              <button class="btn btn-primary w-100" id="btnBuscarEstadual">Buscar</button>
            </div>
          </div>
          <hr />
          <div class="row justify-content-center mt-2">
            <div class="col-md-10">
              <div id="dadosAlunoContainerEstadual">
                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">ID Matrícula</label>
                    <input type="text" class="form-control" id="campoIdMatriculaEstadual" />
                  </div>
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Nome do Aluno</label>
                    <input type="text" class="form-control" id="campoNomeAlunoEstadual" />
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Data Nascimento</label>
                    <input type="date" class="form-control" id="campoDataNascimentoEstadual" />
                  </div>
                  <div class="col-md-6 mb-2 d-flex align-items-end">
                    <span class="fw-semibold">
                      Idade:
                      <span id="campoIdadeEstadual" class="badge bg-secondary badge-idade ms-1">--</span>
                    </span>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Escola</label>
                    <select class="form-control" id="campoEscolaEstadual">
                      <option value="">Selecione a Escola</option>
                    </select>
                  </div>
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Turma</label>
                    <input type="text" class="form-control" id="campoTurmaEstadual" />
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Turno</label>
                    <input type="text" class="form-control" id="campoTurnoEstadual" />
                  </div>
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">CPF</label>
                    <input type="text" class="form-control" id="campoCpfEstadual" />
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-4 mb-2">
                    <label class="form-label fw-semibold">CEP</label>
                    <input type="text" class="form-control" id="campoCepEstadual" />
                  </div>
                  <div class="col-md-4 mb-2">
                    <label class="form-label fw-semibold">Rua</label>
                    <input type="text" class="form-control" id="campoRuaEstadual" />
                  </div>
                  <div class="col-md-4 mb-2">
                    <label class="form-label fw-semibold">Bairro</label>
                    <input type="text" class="form-control" id="campoBairroEstadual" />
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Número Endereço</label>
                    <input type="text" class="form-control" id="campoNumeroEnderecoEstadual" />
                  </div>
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Telefone</label>
                    <input type="text" class="form-control" id="campoTelefoneEstadual" />
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-4 mb-2">
                    <label class="form-label fw-semibold">Filiação 1</label>
                    <input type="text" class="form-control" id="campoFiliacao1Estadual" />
                  </div>
                  <div class="col-md-4 mb-2">
                    <label class="form-label fw-semibold">Filiação 2</label>
                    <input type="text" class="form-control" id="campoFiliacao2Estadual" />
                  </div>
                  <div class="col-md-4 mb-2">
                    <label class="form-label fw-semibold">Responsável</label>
                    <input type="text" class="form-control" id="campoResponsavelEstadual" />
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-12 mb-2">
                    <label class="form-label fw-semibold">Deficiência</label>
                    <input type="text" class="form-control" id="campoDeficienciaEstadual" />
                  </div>
                </div>
                <div class="d-flex justify-content-end mt-3">
                  <button class="btn btn-info" id="btnConverterCepEstadual">Converter CEP</button>
                  <button class="btn btn-primary ms-2" id="btnProximoEstadual">Próximo</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card wizard-step" id="etapa2">
        <div class="card-header">
          <div class="card-title">Etapa 2: Verificar Critérios (Mapa)</div>
        </div>
        <div class="card-body">
          <div class="mb-2">
            <strong>Endereço do Aluno:</strong>
            <span id="infoEndereco"></span>
          </div>
          <div id="mapCriterios"></div>
          <div class="mt-3">
            <strong>Distância (rota):</strong>
            <span id="distanciaRota">--</span>
            <span>km</span>
          </div>
          <div class="mt-2">
            <button id="btnMeasure" class="btn btn-sm btn-warning">Medir Distância Manual</button>
            <div id="measureInfo" class="d-none">
              <span>Medição manual: <span id="measureDistance">0</span> km</span>
              <button id="btnMeasureReset" class="btn btn-sm btn-outline-danger">Reset</button>
            </div>
          </div>
          <div class="row mt-4">
            <div class="col-md-6 mb-2">
              <label class="form-label fw-semibold">Latitude</label>
              <input type="text" class="form-control" id="campoLatitude" readonly />
            </div>
            <div class="col-md-6 mb-2">
              <label class="form-label fw-semibold">Longitude</label>
              <input type="text" class="form-control" id="campoLongitude" readonly />
            </div>
          </div>
          <div class="d-flex align-items-center mt-2">
            <label class="form-label me-2 fw-bold">Nível de Ensino:</label>
            <select id="selectNivelEnsino" class="form-select" style="max-width: 200px;">
              <option value="">Selecione...</option>
              <option value="infantil">Infantil</option>
              <option value="fundamental">Fundamental</option>
            </select>
            <button class="btn btn-warning ms-3" id="btnVerificarCriterios">Verificar Critérios</button>
          </div>
          <div class="d-flex justify-content-between mt-4">
            <button class="btn btn-secondary" id="btnVoltarEtapa1">Voltar</button>
            <div>
              <button class="btn btn-danger d-none" id="btnNaoAprovado">Não Aprovado</button>
              <button class="btn btn-success d-none" id="btnAprovado">Aprovado</button>
            </div>
          </div>
        </div>
      </div>

      <div class="card wizard-step" id="etapa3">
        <div class="card-header">
          <div class="card-title">Etapa 3: Resultado</div>
        </div>
        <div class="card-body">
          <h4 class="text-center" id="resultadoTitulo"></h4>
          <p class="text-center" id="resultadoDescricao"></p>
          <div class="d-flex justify-content-center">
            <button class="btn btn-info" id="btnFinalizar">Concluir</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Menores de 10 anos -->
  <div class="modal fade" id="modalMenores10" tabindex="-1" aria-labelledby="modalMenores10Label" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalMenores10Label">Indicar Responsáveis Extras</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <p>Este aluno possui menos de 10 anos. Gostaria de indicar até 3 responsáveis (maiores de 18 anos) para
            deixá-lo/buscá-lo no ponto?</p>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="radioAcompanhamento" id="radioAcompanhamentoSim"
              value="sim">
            <label class="form-check-label" for="radioAcompanhamentoSim">Sim</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="radioAcompanhamento" id="radioAcompanhamentoNao"
              value="nao" checked>
            <label class="form-check-label" for="radioAcompanhamentoNao">Não</label>
          </div>
          <div class="mt-3 d-none" id="containerResponsaveisExtras">
            <p class="fw-bold mb-1">Responsáveis Adicionais</p>
            <button class="btn btn-sm btn-primary mb-2" id="btnAddResponsavel">+ Adicionar</button>
            <div id="listaResponsaveis"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          <button type="button" class="btn btn-success" id="btnConfirmarMenor10">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Desembarque 10 a 17 anos 11 meses e 31 dias -->
  <div class="modal fade" id="modalDesembarque10a12" tabindex="-1" aria-labelledby="modalDesembarque10a12Label"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalDesembarque10a12Label">O aluno está apto para o transporte</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <p>O aluno está entre 10 e 17 anos 11 meses e 31 dias. Deseja autorizar o desembarque desacompanhado?</p>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="radioDesembarque" id="radioDesembarqueSim" value="sim">
            <label class="form-check-label" for="radioDesembarqueSim">Sim, autorizo</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="radioDesembarque" id="radioDesembarqueNao" value="nao"
              checked>
            <label class="form-check-label" for="radioDesembarqueNao">Não, sempre acompanhado</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          <button type="button" class="btn btn-success" id="btnConfirmar10a12">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Responsáveis não parentes (10 a 17 anos 11 meses e 31 dias) -->
  <div class="modal fade" id="modalOutrosResponsaveis10a12" tabindex="-1"
    aria-labelledby="modalOutrosResponsaveis10a12Label" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalOutrosResponsaveis10a12Label">Indicar Responsáveis Não-Parentes</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <p>Gostaria de indicar até 3 responsáveis (maiores de 18 anos) que não são parentes diretos?</p>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="radioOutrosResp" id="radioOutrosRespSim" value="sim">
            <label class="form-check-label" for="radioOutrosRespSim">Sim</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="radioOutrosResp" id="radioOutrosRespNao" value="nao"
              checked>
            <label class="form-check-label" for="radioOutrosRespNao">Não</label>
          </div>
          <div class="mt-3 d-none" id="containerOutrosResponsaveis10a12">
            <p class="fw-bold mb-1">Responsáveis Indicados</p>
            <button class="btn btn-sm btn-primary mb-2" id="btnAddOutroResponsavel10a12">+ Adicionar</button>
            <div id="listaOutrosResponsaveis10a12"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          <button type="button" class="btn btn-success" id="btnConfirmarOutrosResponsaveis10a12">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Escolher Assinatura -->
  <div class="modal fade" id="modalEscolherAssinatura" tabindex="-1" aria-labelledby="modalEscolherAssinaturaLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalEscolherAssinaturaLabel">Selecione quem assina</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <p>Escolha se quem irá assinar o termo é a Filiação 1, Filiação 2, ou o Responsável.</p>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="radioAssinatura" id="radioAssinaturaFiliacao1"
              value="filiacao1" checked>
            <label class="form-check-label" for="radioAssinaturaFiliacao1">Filiação 1</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="radioAssinatura" id="radioAssinaturaFiliacao2"
              value="filiacao2">
            <label class="form-check-label" for="radioAssinaturaFiliacao2">Filiação 2</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="radioAssinatura" id="radioAssinaturaResponsavel"
              value="responsavel">
            <label class="form-check-label" for="radioAssinaturaResponsavel">Responsável</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          <button type="button" class="btn btn-primary" id="btnConfirmarAssinatura">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Reavaliação para Situações Atenuantes -->
  <div class="modal fade" id="modalReavaliacao" tabindex="-1" aria-labelledby="modalReavaliacaoLabel"
    aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalReavaliacaoLabel">Solicitação de Reavaliação</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>
        <div class="modal-body">
          <p>Selecione as situações atenuantes que se aplicam ao trajeto do aluno:</p>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="chkCalcadasAusentes" />
            <label class="form-check-label" for="chkCalcadasAusentes">Ausência de calçadas</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="chkPavimentacaoAusente" />
            <label class="form-check-label" for="chkPavimentacaoAusente">Rua não pavimentada</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="chkIluminacaoPrecaria" />
            <label class="form-check-label" for="chkIluminacaoPrecaria">Falta de iluminação pública</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="chkAreaDeRisco" />
            <label class="form-check-label" for="chkAreaDeRisco">Área de risco com crimes ou assaltos</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="chkAnimaisPerigosos" />
            <label class="form-check-label" for="chkAnimaisPerigosos">Presença de animais perigosos (rural)</label>
          </div>
          <div class="mb-2">
            <label class="form-label fw-semibold" for="txtOutros">Outros (descreva):</label>
            <textarea class="form-control" id="txtOutros" rows="2" placeholder="Descreva aqui..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
          <button type="button" class="btn btn-success" id="btnConfirmarReavaliacao">Confirmar Reavaliação</button>
        </div>
      </div>
    </div>
  </div>

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCAwvAt4l0Pkb1c52FLUE-ttVxm4YZ9J8M&libraries=places,geometry"></script>
  <script src="../../assets/js/core/jquery-3.7.1.min.js"></script>
  <script src="../../assets/js/core/popper.min.js"></script>
  <script src="../../assets/js/core/bootstrap.min.js"></script>
  <script src="../../assets/js/plugin/bootstrap-notify/bootstrap-notify.min.js"></script>
  <script src="../../assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
  <script src="../../assets/js/pydenadmin.min.js"></script>
  <script>
    function showNotification(message, type) {
      let icon = "";
      if (type === "danger") {
        icon = '<i class="fas fa-times" style="color:#dc3545; margin-right:8px;"></i>';
      } else if (type === "warning") {
        icon = '<i class="fas fa-bell" style="color:#ffc107; margin-right:8px;"></i>';
      } else if (type === "success") {
        icon = '<i class="fas fa-check" style="color:#28a745; margin-right:8px;"></i>';
      }
      $.notify({ message: icon + message }, {
        type: type,
        placement: { from: "top", align: "right" },
        delay: 3000,
        animate: { enter: 'animated fadeInDown', exit: 'animated fadeOutUp' }
      });
    }

    let map, directionsService, directionsRenderer;
    let markerAluno = null, markerEscola = null;
    let escolaPos = null, alunoPos = null;
    let alunoIdMunicipal = null;
    let alunoIdEstadual = null;
    let tipoFluxoSelecionado = null;
    let originalData = null;
    let measureActive = false;
    let measurePoints = [];
    let measurePolyline = null;
    let mapClickListener = null;
    let idadeAlunoAnos = 0;
    let idadeAlunoMeses = 0;
    let idadeAlunoDias = 0;
    let responsaveisExtras = [];
    let menor10_acompanhado = false;
    let desembarqueSozinho10a12 = false;
    let resultadoFinal = null;
    let outrosResponsaveis10a12 = [];
    let signerChoice = null;
    let atenuantesReavaliacao = false;
    let polygonsZone = [];

    const etapaSelecaoFluxo = document.getElementById("etapaSelecaoFluxo");
    const etapa1Municipal = document.getElementById("etapa1Municipal");
    const etapa1Estadual = document.getElementById("etapa1Estadual");
    const etapa2 = document.getElementById("etapa2");
    const etapa3 = document.getElementById("etapa3");
    const fluxoMunicipal = document.getElementById("fluxoMunicipal");
    const fluxoEstadual = document.getElementById("fluxoEstadual");
    const btnContinuarFluxo = document.getElementById("btnContinuarFluxo");
    const btnBuscar = document.getElementById("btnBuscar");
    const inputBusca = document.getElementById("inputBusca");
    const dadosAlunoContainerMunicipal = document.getElementById("dadosAlunoContainerMunicipal");
    const btnConverterCepMunicipal = document.getElementById("btnConverterCepMunicipal");
    const btnProximoMunicipal = document.getElementById("btnProximoMunicipal");
    const btnImprimirConfirmacaoMunicipal = document.getElementById("btnImprimirConfirmacaoMunicipal");
    const btnSalvarAlteracoesMunicipal = document.getElementById("btnSalvarAlteracoesMunicipal");
    const campoIdMatriculaMunicipal = document.getElementById("campoIdMatriculaMunicipal");
    const campoNomeAlunoMunicipal = document.getElementById("campoNomeAlunoMunicipal");
    const campoDataNascimentoMunicipal = document.getElementById("campoDataNascimentoMunicipal");
    const campoIdadeMunicipal = document.getElementById("campoIdadeMunicipal");
    const campoEscolaMunicipal = document.getElementById("campoEscolaMunicipal");
    const campoTurmaMunicipal = document.getElementById("campoTurmaMunicipal");
    const campoCpfMunicipal = document.getElementById("campoCpfMunicipal");
    const campoCepMunicipal = document.getElementById("campoCepMunicipal");
    const campoRuaMunicipal = document.getElementById("campoRuaMunicipal");
    const campoBairroMunicipal = document.getElementById("campoBairroMunicipal");
    const campoNumeroEnderecoMunicipal = document.getElementById("campoNumeroEnderecoMunicipal");
    const campoTelefoneMunicipal = document.getElementById("campoTelefoneMunicipal");
    const campoFiliacao1Municipal = document.getElementById("campoFiliacao1Municipal");
    const campoFiliacao2Municipal = document.getElementById("campoFiliacao2Municipal");
    const campoResponsavelMunicipal = document.getElementById("campoResponsavelMunicipal");
    const campoDeficienciaMunicipal = document.getElementById("campoDeficienciaMunicipal");
    const btnBuscarEstadual = document.getElementById("btnBuscarEstadual");
    const inputBuscaEstadual = document.getElementById("inputBuscaEstadual");
    const btnConverterCepEstadual = document.getElementById("btnConverterCepEstadual");
    const btnProximoEstadual = document.getElementById("btnProximoEstadual");
    const campoIdMatriculaEstadual = document.getElementById("campoIdMatriculaEstadual");
    const campoNomeAlunoEstadual = document.getElementById("campoNomeAlunoEstadual");
    const campoDataNascimentoEstadual = document.getElementById("campoDataNascimentoEstadual");
    const campoIdadeEstadual = document.getElementById("campoIdadeEstadual");
    const campoEscolaEstadual = document.getElementById("campoEscolaEstadual");
    const campoTurmaEstadual = document.getElementById("campoTurmaEstadual");
    const campoTurnoEstadual = document.getElementById("campoTurnoEstadual");
    const campoCpfEstadual = document.getElementById("campoCpfEstadual");
    const campoCepEstadual = document.getElementById("campoCepEstadual");
    const campoRuaEstadual = document.getElementById("campoRuaEstadual");
    const campoBairroEstadual = document.getElementById("campoBairroEstadual");
    const campoNumeroEnderecoEstadual = document.getElementById("campoNumeroEnderecoEstadual");
    const campoTelefoneEstadual = document.getElementById("campoTelefoneEstadual");
    const campoFiliacao1Estadual = document.getElementById("campoFiliacao1Estadual");
    const campoFiliacao2Estadual = document.getElementById("campoFiliacao2Estadual");
    const campoResponsavelEstadual = document.getElementById("campoResponsavelEstadual");
    const campoDeficienciaEstadual = document.getElementById("campoDeficienciaEstadual");
    const btnVoltarEtapa1 = document.getElementById("btnVoltarEtapa1");
    const btnAprovado = document.getElementById("btnAprovado");
    const btnNaoAprovado = document.getElementById("btnNaoAprovado");
    const distanciaRota = document.getElementById("distanciaRota");
    const infoEndereco = document.getElementById("infoEndereco");
    const btnMeasure = document.getElementById("btnMeasure");
    const measureInfoDiv = document.getElementById("measureInfo");
    const measureDistanceSpan = document.getElementById("measureDistance");
    const btnMeasureReset = document.getElementById("btnMeasureReset");
    const campoLatitude = document.getElementById("campoLatitude");
    const campoLongitude = document.getElementById("campoLongitude");
    const selectNivelEnsino = document.getElementById("selectNivelEnsino");
    const btnVerificarCriterios = document.getElementById("btnVerificarCriterios");
    const resultadoTitulo = document.getElementById("resultadoTitulo");
    const resultadoDescricao = document.getElementById("resultadoDescricao");
    const btnFinalizar = document.getElementById("btnFinalizar");
    const modalMenores10 = new bootstrap.Modal(document.getElementById("modalMenores10"), { backdrop: 'static', keyboard: false });
    const modalDesembarque10a12 = new bootstrap.Modal(document.getElementById("modalDesembarque10a12"), { backdrop: 'static', keyboard: false });
    const btnConfirmarMenor10 = document.getElementById("btnConfirmarMenor10");
    const btnAddResponsavel = document.getElementById("btnAddResponsavel");
    const containerResponsaveisExtras = document.getElementById("containerResponsaveisExtras");
    const radioAcompanhamentoSim = document.getElementById("radioAcompanhamentoSim");
    const radioAcompanhamentoNao = document.getElementById("radioAcompanhamentoNao");
    const listaResponsaveisDiv = document.getElementById("listaResponsaveis");
    const modal10a12_radioSim = document.getElementById("radioDesembarqueSim");
    const modal10a12_radioNao = document.getElementById("radioDesembarqueNao");
    const btnConfirmar10a12 = document.getElementById("btnConfirmar10a12");
    const modalOutrosResponsaveis10a12 = new bootstrap.Modal(document.getElementById("modalOutrosResponsaveis10a12"), { backdrop: 'static', keyboard: false });
    const radioOutrosRespSim = document.getElementById("radioOutrosRespSim");
    const radioOutrosRespNao = document.getElementById("radioOutrosRespNao");
    const containerOutrosResponsaveis10a12 = document.getElementById("containerOutrosResponsaveis10a12");
    const btnAddOutroResponsavel10a12 = document.getElementById("btnAddOutroResponsavel10a12");
    const listaOutrosResponsaveis10a12 = document.getElementById("listaOutrosResponsaveis10a12");
    const btnConfirmarOutrosResponsaveis10a12 = document.getElementById("btnConfirmarOutrosResponsaveis10a12");
    const modalEscolherAssinatura = new bootstrap.Modal(document.getElementById("modalEscolherAssinatura"), { backdrop: 'static', keyboard: false });
    const btnConfirmarAssinatura = document.getElementById("btnConfirmarAssinatura");
    const radioAssinaturaFiliacao1 = document.getElementById("radioAssinaturaFiliacao1");
    const radioAssinaturaFiliacao2 = document.getElementById("radioAssinaturaFiliacao2");
    const radioAssinaturaResponsavel = document.getElementById("radioAssinaturaResponsavel");
    const modalReavaliacao = new bootstrap.Modal(document.getElementById("modalReavaliacao"), { backdrop: 'static', keyboard: false });
    const btnConfirmarReavaliacao = document.getElementById("btnConfirmarReavaliacao");
    const chkCalcadasAusentes = document.getElementById("chkCalcadasAusentes");
    const chkPavimentacaoAusente = document.getElementById("chkPavimentacaoAusente");
    const chkIluminacaoPrecaria = document.getElementById("chkIluminacaoPrecaria");
    const chkAreaDeRisco = document.getElementById("chkAreaDeRisco");
    const chkAnimaisPerigosos = document.getElementById("chkAnimaisPerigosos");
    const txtOutros = document.getElementById("txtOutros");

    btnContinuarFluxo.addEventListener("click", async () => {
      if (fluxoMunicipal.checked) {
        tipoFluxoSelecionado = "municipal";
        etapaSelecaoFluxo.classList.remove("active");
        etapa1Municipal.classList.add("active");
      } else if (fluxoEstadual.checked) {
        tipoFluxoSelecionado = "estadual";
        etapaSelecaoFluxo.classList.remove("active");
        etapa1Estadual.classList.add("active");
        await carregarEscolasEstaduais();
      } else {
        showNotification("Selecione o tipo de fluxo (Municipal ou Estadual).", "warning");
      }
    });

    async function carregarEscolasEstaduais() {
      try {
        const response = await fetch("/api/escolas");
        if (!response.ok) throw new Error("Erro ao carregar escolas.");
        const listaEscolas = await response.json();
        campoEscolaEstadual.innerHTML = '<option value="">Selecione a Escola</option>';
        listaEscolas.forEach(e => {
          const option = document.createElement("option");
          option.value = e.id;
          option.textContent = e.nome;
          campoEscolaEstadual.appendChild(option);
        });
      } catch (err) {
        console.error("Erro ao buscar escolas:", err);
        showNotification("Não foi possível carregar a lista de escolas.", "danger");
      }
    }

    btnBuscar.addEventListener("click", async () => {
      const valorBusca = inputBusca.value.trim();
      if (!valorBusca) {
        showNotification(
          "Informe CPF, ID de Matrícula, ID de Pessoa ou Nome completo.",
          "warning"
        );
        return;
      }
      try {
        const resp = await fetch(`/api/alunos_ativos?search=${encodeURIComponent(valorBusca)}`);
        if (!resp.ok) throw new Error("Erro ao buscar aluno (Municipal).");
        const data = await resp.json();
        if (!data || !data.id_matricula) {
          showNotification("Nenhum aluno encontrado.", "danger");
          return;
        }
        originalData = data;
        alunoIdMunicipal = data.id || null;
        campoIdMatriculaMunicipal.value = data.id_matricula || "";
        campoNomeAlunoMunicipal.value = data.pessoa_nome || "";
        campoEscolaMunicipal.value = data.escola_nome || "";
        campoTurmaMunicipal.value = data.turma || "";
        campoCpfMunicipal.value = data.cpf || "";
        campoCepMunicipal.value = data.cep || "";
        campoRuaMunicipal.value = data.rua || "";
        campoBairroMunicipal.value = data.bairro || "";
        campoNumeroEnderecoMunicipal.value = data.numero_pessoa_endereco || "";
        campoFiliacao1Municipal.value = data.filiacao_1 || "";
        campoTelefoneMunicipal.value = data.numero_telefone || "";
        campoFiliacao2Municipal.value = data.filiacao_2 || "";
        campoResponsavelMunicipal.value = data.responsavel || "";
        if (data.data_nascimento) {
          const dt = data.data_nascimento.split("T")[0];
          campoDataNascimentoMunicipal.value = dt;
          calcularIdadeMunicipal(new Date(dt));
        } else {
          campoDataNascimentoMunicipal.value = "";
          campoIdadeMunicipal.textContent = "--";
          campoIdadeMunicipal.classList.remove("bg-danger", "bg-success");
          campoIdadeMunicipal.classList.add("bg-secondary");
        }
        if (Array.isArray(data.deficiencia)) {
          campoDeficienciaMunicipal.value = data.deficiencia[0] || "NADA INFORMADO";
        } else if (typeof data.deficiencia === "string") {
          campoDeficienciaMunicipal.value = data.deficiencia || "NADA INFORMADO";
        } else {
          campoDeficienciaMunicipal.value = "NADA INFORMADO";
        }
        dadosAlunoContainerMunicipal.classList.remove("d-none");
      } catch (err) {
        console.error(err);
        showNotification("Erro ao buscar aluno (Municipal).", "danger");
      }
    });

    function calcularIdadeMunicipal(dataNasc) {
      const hoje = new Date();
      let anos = hoje.getFullYear() - dataNasc.getFullYear();
      let meses = hoje.getMonth() - dataNasc.getMonth();
      let dias = hoje.getDate() - dataNasc.getDate();
      if (dias < 0) {
        meses--;
        dias += 30;
      }
      if (meses < 0) {
        anos--;
        meses += 12;
      }
      idadeAlunoAnos = anos;
      idadeAlunoMeses = meses;
      idadeAlunoDias = dias;
      campoIdadeMunicipal.textContent = `${anos} anos, ${meses} meses e ${dias} dias`;
      const anoAtual = hoje.getFullYear();
      const dataCorte = new Date(anoAtual, 2, 31);
      const data4 = new Date(dataNasc.getFullYear() + 4, dataNasc.getMonth(), dataNasc.getDate());
      if (data4 <= dataCorte) {
        campoIdadeMunicipal.classList.remove("bg-danger", "bg-secondary");
        campoIdadeMunicipal.classList.add("bg-success");
      } else {
        campoIdadeMunicipal.classList.remove("bg-success", "bg-secondary");
        campoIdadeMunicipal.classList.add("bg-danger");
      }
    }

    btnConverterCepMunicipal.addEventListener("click", async () => {
      const cepLimpo = campoCepMunicipal.value.replace(/\D/g, "");
      if (!cepLimpo) {
        showNotification("Informe um CEP válido.", "warning");
        return;
      }
      try {
        const r = await fetch(`https://viacep.com.br/ws/${cepLimpo}/json/`);
        if (r.ok) {
          const viacep = await r.json();
          if (!viacep.erro) {
            campoRuaMunicipal.value = viacep.logradouro || campoRuaMunicipal.value;
            campoBairroMunicipal.value = viacep.bairro || campoBairroMunicipal.value;
          } else {
            showNotification("CEP não encontrado.", "danger");
          }
          btnSalvarAlteracoesMunicipal.disabled = false;
        } else {
          showNotification("Erro ao consultar ViaCEP.", "danger");
        }
      } catch (e) {
        showNotification("Erro ao converter CEP (Municipal).", "danger");
      }
    });

    btnSalvarAlteracoesMunicipal.addEventListener("click", async () => {
      const ok = await salvarAlteracoesMunicipal();
      if (ok) {
        btnImprimirConfirmacaoMunicipal.disabled = false;
        showNotification("Alterações salvas com sucesso (Municipal)!", "success");
      }
    });

    async function salvarAlteracoesMunicipal() {
      if (!alunoIdMunicipal) {
        showNotification("Nenhum aluno carregado (Municipal).", "warning");
        return false;
      }
      const defValue = campoDeficienciaMunicipal.value;
      const defArray = defValue ? [defValue] : null;
      const mergeBody = {
        cep: campoCepMunicipal.value.trim(),
        bairro: campoBairroMunicipal.value.trim(),
        numero_pessoa_endereco: campoNumeroEnderecoMunicipal.value.trim(),
        numero_telefone: campoTelefoneMunicipal.value.trim(),
        deficiencia: defArray,
        latitude: parseFloat(campoLatitude.value) || null,
        longitude: parseFloat(campoLongitude.value) || null,
        rua: campoRuaMunicipal.value.trim()
      };
      try {
        const resp = await fetch(`/api/alunos-recadastro/${alunoIdMunicipal}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(mergeBody)
        });
        const result = await resp.json();
        if (!resp.ok) {
          showNotification(result.message || "Falha ao salvar alterações (municipal).", "danger");
          return false;
        }
        return true;
      } catch (err) {
        console.error(err);
        showNotification("Erro ao atualizar dados do aluno (municipal).", "danger");
        return false;
      }
    }

    btnImprimirConfirmacaoMunicipal.addEventListener("click", () => {
      if (!alunoIdMunicipal) {
        showNotification("Nenhum aluno carregado para gerar termo.", "warning");
        return;
      }
      signerChoice = null;
      modalEscolherAssinatura.show();
    });

    btnConfirmarAssinatura.addEventListener("click", () => {
      if (radioAssinaturaFiliacao1.checked) {
        signerChoice = "filiacao1";
      } else if (radioAssinaturaFiliacao2.checked) {
        signerChoice = "filiacao2";
      } else {
        signerChoice = "responsavel";
      }
      modalEscolherAssinatura.hide();
      if (alunoIdMunicipal) {
        window.open(`/api/termo-cadastro/${alunoIdMunicipal}/gerar-pdf?signer=${signerChoice}`, "_blank");
      }
      btnProximoMunicipal.disabled = false;
    });

    btnProximoMunicipal.addEventListener("click", () => {
      if (!originalData) {
        showNotification("Nenhum aluno carregado.", "warning");
        return;
      }
      etapa1Municipal.classList.remove("active");
      etapa2.classList.add("active");
      setTimeout(() => {
        initMap();
      }, 300);
    });

    btnBuscarEstadual.addEventListener("click", async () => {
      const valorBuscaEst = inputBuscaEstadual.value.trim();
      if (!valorBuscaEst) {
        showNotification("Informe CPF ou ID de Matrícula.", "warning");
        return;
      }
      try {
        const resp = await fetch(`/api/alunos_ativos?search=${encodeURIComponent(valorBuscaEst)}`);
        if (!resp.ok) throw new Error("Erro ao buscar aluno (Estadual).");
        const data = await resp.json();
        if (!data || !data.id_matricula) {
          showNotification("Nenhum aluno encontrado.", "danger");
          return;
        }
        originalData = data;
        alunoIdEstadual = data.id || null;
        campoIdMatriculaEstadual.value = data.id_matricula || "";
        campoNomeAlunoEstadual.value = data.pessoa_nome || "";
        campoEscolaEstadual.value = "";
        campoTurmaEstadual.value = data.turma || "";
        campoTurnoEstadual.value = "";
        campoCpfEstadual.value = data.cpf || "";
        campoCepEstadual.value = data.cep || "";
        campoRuaEstadual.value = data.rua || "";
        campoBairroEstadual.value = data.bairro || "";
        campoNumeroEnderecoEstadual.value = data.numero_pessoa_endereco || "";
        campoTelefoneEstadual.value = data.numero_telefone || "";
        campoFiliacao1Estadual.value = data.filiacao_1 || "";
        campoFiliacao2Estadual.value = data.filiacao_2 || "";
        campoResponsavelEstadual.value = data.responsavel || "";
        if (data.data_nascimento) {
          const dt = data.data_nascimento.split("T")[0];
          campoDataNascimentoEstadual.value = dt;
          calcularIdadeEstadual(new Date(dt));
        } else {
          campoDataNascimentoEstadual.value = "";
          campoIdadeEstadual.textContent = "--";
          campoIdadeEstadual.classList.remove("bg-danger", "bg-success");
          campoIdadeEstadual.classList.add("bg-secondary");
        }
        if (Array.isArray(data.deficiencia)) {
          campoDeficienciaEstadual.value = data.deficiencia[0] || "NADA INFORMADO";
        } else if (typeof data.deficiencia === "string") {
          campoDeficienciaEstadual.value = data.deficiencia || "NADA INFORMADO";
        } else {
          campoDeficienciaEstadual.value = "NADA INFORMADO";
        }
      } catch (err) {
        console.error(err);
        showNotification("Erro ao buscar aluno (Estadual).", "danger");
      }
    });

    campoDataNascimentoEstadual.addEventListener("change", () => {
      if (campoDataNascimentoEstadual.value) {
        calcularIdadeEstadual(new Date(campoDataNascimentoEstadual.value));
      }
    });

    function calcularIdadeEstadual(dataNasc) {
      const hoje = new Date();
      let anos = hoje.getFullYear() - dataNasc.getFullYear();
      let meses = hoje.getMonth() - dataNasc.getMonth();
      let dias = hoje.getDate() - dataNasc.getDate();
      if (dias < 0) {
        meses--;
        dias += 30;
      }
      if (meses < 0) {
        anos--;
        meses += 12;
      }
      idadeAlunoAnos = anos;
      idadeAlunoMeses = meses;
      idadeAlunoDias = dias;
      campoIdadeEstadual.textContent = `${anos} anos, ${meses} meses e ${dias} dias`;
      const anoAtual = hoje.getFullYear();
      const dataCorte = new Date(anoAtual, 2, 31);
      const data4 = new Date(dataNasc.getFullYear() + 4, dataNasc.getMonth(), dataNasc.getDate());
      if (data4 <= dataCorte) {
        campoIdadeEstadual.classList.remove("bg-danger", "bg-secondary");
        campoIdadeEstadual.classList.add("bg-success");
      } else {
        campoIdadeEstadual.classList.remove("bg-success", "bg-secondary");
        campoIdadeEstadual.classList.add("bg-danger");
      }
    }

    btnConverterCepEstadual.addEventListener("click", async () => {
      const cepLimpoEst = campoCepEstadual.value.replace(/\D/g, "");
      if (!cepLimpoEst) {
        showNotification("Informe um CEP válido.", "warning");
        return;
      }
      try {
        const r = await fetch(`https://viacep.com.br/ws/${cepLimpoEst}/json/`);
        if (r.ok) {
          const viacep = await r.json();
          if (!viacep.erro) {
            campoRuaEstadual.value = viacep.logradouro || campoRuaEstadual.value;
            campoBairroEstadual.value = viacep.bairro || campoBairroEstadual.value;
          } else {
            showNotification("CEP não encontrado.", "danger");
          }
        } else {
          showNotification("Erro ao consultar ViaCEP (Estadual).", "danger");
        }
      } catch (e) {
        showNotification("Erro ao converter CEP (Estadual).", "danger");
      }
    });

    btnProximoEstadual.addEventListener("click", async () => {
      const defValueEst = campoDeficienciaEstadual.value;
      const defArrayEst = defValueEst ? [defValueEst] : null;
      const bodyAlunoEstadual = {
        id_matricula: campoIdMatriculaEstadual.value.trim(),
        pessoa_nome: campoNomeAlunoEstadual.value.trim(),
        data_nascimento: campoDataNascimentoEstadual.value || null,
        escola_id: campoEscolaEstadual.value ? parseInt(campoEscolaEstadual.value) : null,
        turma: campoTurmaEstadual.value.trim(),
        turno: campoTurnoEstadual.value.trim(),
        cpf: campoCpfEstadual.value.trim(),
        cep: campoCepEstadual.value.trim(),
        rua: campoRuaEstadual.value.trim(),
        bairro: campoBairroEstadual.value.trim(),
        numero_pessoa_endereco: campoNumeroEnderecoEstadual.value.trim(),
        numero_telefone: campoTelefoneEstadual.value.trim(),
        filiacao_1: campoFiliacao1Estadual.value.trim(),
        filiacao_2: campoFiliacao2Estadual.value.trim(),
        responsavel: campoResponsavelEstadual.value.trim(),
        deficiencia: defArrayEst
      };
      try {
        const resp = await fetch("/api/alunos-ativos-estadual", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(bodyAlunoEstadual)
        });
        if (!resp.ok) {
          const errorData = await resp.json();
          showNotification(errorData.message || "Erro ao salvar aluno estadual.", "danger");
          return;
        }
        const result = await resp.json();
        alunoIdEstadual = result.id;
        etapa1Estadual.classList.remove("active");
        etapa2.classList.add("active");
        originalData = bodyAlunoEstadual;
        setTimeout(() => {
          initMap();
        }, 300);
      } catch (err) {
        showNotification("Falha ao cadastrar aluno estadual.", "danger");
      }
    });

    btnVoltarEtapa1.addEventListener("click", () => {
      etapa2.classList.remove("active");
      if (tipoFluxoSelecionado === "municipal") {
        etapa1Municipal.classList.add("active");
      } else {
        etapa1Estadual.classList.add("active");
      }
    });

    btnMeasure.addEventListener("click", () => {
      measureActive = !measureActive;
      if (measureActive) {
        btnMeasure.textContent = "Desativar Medição";
        measureInfoDiv.classList.remove("d-none");
        startMeasureMode();
      } else {
        btnMeasure.textContent = "Medir Distância Manual";
        measureInfoDiv.classList.add("d-none");
        endMeasureMode();
      }
    });

    btnMeasureReset.addEventListener("click", () => {
      measurePoints = [];
      measureDistanceSpan.textContent = "0";
      if (measurePolyline) {
        measurePolyline.setMap(null);
        measurePolyline = null;
      }
    });

    function startMeasureMode() {
      if (!map) return;
      measurePoints = [];
      measureDistanceSpan.textContent = "0";
      measurePolyline = new google.maps.Polyline({
        map: map,
        path: measurePoints,
        strokeColor: "#FF0000",
        strokeOpacity: 1.0,
        strokeWeight: 3
      });
      mapClickListener = map.addListener("click", (e) => {
        measurePoints.push(e.latLng);
        measurePolyline.setPath(measurePoints);
        let totalDist = 0;
        for (let i = 0; i < measurePoints.length - 1; i++) {
          const segDist = google.maps.geometry.spherical.computeDistanceBetween(
            measurePoints[i],
            measurePoints[i + 1]
          );
          totalDist += segDist;
        }
        measureDistanceSpan.textContent = (totalDist / 1000).toFixed(3);
      });
    }

    function endMeasureMode() {
      if (mapClickListener) {
        google.maps.event.removeListener(mapClickListener);
        mapClickListener = null;
      }
      if (measurePolyline) {
        measurePolyline.setMap(null);
        measurePolyline = null;
      }
    }

    btnVerificarCriterios.addEventListener("click", () => {
      if (!markerAluno) {
        showNotification("Marque a posição do aluno no mapa para continuar.", "warning");
        return;
      }
      let insideZone = false;
      const alunoLatLng = markerAluno.getPosition();
      for (const poly of polygonsZone) {
        if (google.maps.geometry.poly && poly instanceof google.maps.Polygon) {
          if (google.maps.geometry.poly.containsLocation(alunoLatLng, poly)) {
            insideZone = true;
            break;
          }
        }
      }
      if (!insideZone) {
        const continuarForaZoneamento = confirm("O aluno não está dentro do zoneamento desta escola. Deseja continuar mesmo assim?");
        if (!continuarForaZoneamento) return;
      }
      const nivel = selectNivelEnsino.value;
      if (!nivel) {
        showNotification("Selecione o nível de ensino (Infantil ou Fundamental).", "warning");
        return;
      }
      let defValue = "";
      if (tipoFluxoSelecionado === "municipal") {
        defValue = (campoDeficienciaMunicipal.value || "").trim().toUpperCase();
      } else {
        defValue = (campoDeficienciaEstadual.value || "").trim().toUpperCase();
      }
      if (defValue !== "" && defValue !== "NADA INFORMADO") {
        resultadoFinal = "AVALIACAO_MANUAL";
        etapa2.classList.remove("active");
        etapa3.classList.add("active");
        resultadoTitulo.innerText = "Avaliação Manual Necessária";
        resultadoTitulo.className = "text-center text-warning";
        resultadoDescricao.innerText = "O aluno possui algum tipo de deficiência. Avaliação precisa ser feita de forma manual.";
        return;
      }
      let distKm = parseFloat(distanciaRota.textContent) || 0;
      const marginDist = 0.15;
      let idadeMinimaOk = (idadeAlunoAnos >= 4);
      let limPrincipal = (nivel === "fundamental") ? 2.0 : 1.5;
      let limReavaliacao = (nivel === "fundamental") ? 1.3 : 0.8;
      if (!idadeMinimaOk) {
        btnNaoAprovado.click();
        return;
      }
      let distanciaMinimaOk = false;
      let limPrincipalAjustado = limPrincipal - marginDist;
      if (distKm > limPrincipalAjustado) {
        distanciaMinimaOk = true;
      } else {
        if (distKm >= limReavaliacao && distKm <= limPrincipal) {
          modalReavaliacao.show();
          return;
        } else {
          btnNaoAprovado.click();
          return;
        }
      }
      if (!distanciaMinimaOk) {
        btnNaoAprovado.click();
      } else {
        checkFluxoIntermediario();
      }
    });

    btnConfirmarReavaliacao.addEventListener("click", async () => {
      const atenuantesSelecionadas = [
        chkCalcadasAusentes.checked,
        chkPavimentacaoAusente.checked,
        chkIluminacaoPrecaria.checked,
        chkAreaDeRisco.checked,
        chkAnimaisPerigosos.checked
      ].some(x => x === true);
      modalReavaliacao.hide();
      const currentAlunoId = (tipoFluxoSelecionado === "municipal") ? alunoIdMunicipal : alunoIdEstadual;
      if (!currentAlunoId) {
        btnNaoAprovado.click();
        return;
      }
      const reavBody = {
        aluno_id: currentAlunoId,
        tipo_fluxo: tipoFluxoSelecionado,
        nome_aluno: (tipoFluxoSelecionado === "municipal") ? campoNomeAlunoMunicipal.value : campoNomeAlunoEstadual.value,
        cpf_aluno: (tipoFluxoSelecionado === "municipal") ? campoCpfMunicipal.value : campoCpfEstadual.value,
        responsavel_aluno: (tipoFluxoSelecionado === "municipal") ? campoResponsavelMunicipal.value : campoResponsavelEstadual.value,
        latitude: parseFloat(campoLatitude.value) || null,
        longitude: parseFloat(campoLongitude.value) || null,
        calcadas_ausentes: chkCalcadasAusentes.checked,
        pavimentacao_ausente: chkPavimentacaoAusente.checked,
        iluminacao_precaria: chkIluminacaoPrecaria.checked,
        area_de_risco: chkAreaDeRisco.checked,
        animais_perigosos: chkAnimaisPerigosos.checked,
        outros_descricao: txtOutros.value.trim()
      };
      try {
        await fetch("/api/reavaliacoes", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(reavBody)
        });
      } catch (err) {
        console.error("Falha ao salvar reavaliacao:", err);
      }
      if (atenuantesSelecionadas || txtOutros.value.trim() !== "") {
        atenuantesReavaliacao = true;
      }
      btnNaoAprovado.click();
    });

    function checkFluxoIntermediario() {
      if (idadeAlunoAnos < 10) {
        responsaveisExtras = [];
        menor10_acompanhado = false;
        renderListaResponsaveis();
        containerResponsaveisExtras.classList.add("d-none");
        radioAcompanhamentoNao.checked = true;
        modalMenores10.show();
      } else if (idadeAlunoAnos >= 10 && idadeAlunoAnos < 18) {
        desembarqueSozinho10a12 = false;
        modal10a12_radioNao.checked = true;
        modalDesembarque10a12.show();
      } else {
        btnAprovado.click();
      }
    }

    radioAcompanhamentoSim.addEventListener("change", () => {
      containerResponsaveisExtras.classList.remove("d-none");
    });
    radioAcompanhamentoNao.addEventListener("change", () => {
      containerResponsaveisExtras.classList.add("d-none");
    });

    btnAddResponsavel.addEventListener("click", () => {
      if (responsaveisExtras.length >= 3) {
        showNotification("É permitido no máximo 3 responsáveis extras.", "warning");
        return;
      }
      const responsavelObj = { nome: "", rg: "", dataNascimento: "" };
      responsaveisExtras.push(responsavelObj);
      renderListaResponsaveis();
    });

    function renderListaResponsaveis() {
      listaResponsaveisDiv.innerHTML = "";
      responsaveisExtras.forEach((resp, idx) => {
        const div = document.createElement("div");
        div.classList.add("mb-2", "p-2", "border", "rounded");
        const htmlResponsavel = `
          <label class="form-label fw-semibold">Nome</label>
          <input type="text" class="form-control mb-2" data-rindex="${idx}" data-field="nome" placeholder="Nome" value="${resp.nome || ""}">
          <label class="form-label fw-semibold">RG</label>
          <input type="text" class="form-control mb-2" data-rindex="${idx}" data-field="rg" placeholder="RG" value="${resp.rg || ""}">
          <label class="form-label fw-semibold">Data Nasc. (maior 18)</label>
          <input type="date" class="form-control mb-2" data-rindex="${idx}" data-field="dataNascimento" value="${resp.dataNascimento || ""}">
          <button class="btn btn-sm btn-danger" data-action="remove" data-rindex="${idx}">Remover</button>
        `;
        div.innerHTML = htmlResponsavel;
        listaResponsaveisDiv.appendChild(div);
      });
      listaResponsaveisDiv.querySelectorAll("input").forEach(input => {
        input.addEventListener("change", e => {
          const index = parseInt(e.target.dataset.rindex);
          const field = e.target.dataset.field;
          responsaveisExtras[index][field] = e.target.value;
        });
      });
      listaResponsaveisDiv.querySelectorAll("button[data-action='remove']").forEach(btn => {
        btn.addEventListener("click", e => {
          const index = parseInt(e.target.dataset.rindex);
          responsaveisExtras.splice(index, 1);
          renderListaResponsaveis();
        });
      });
    }

    btnConfirmarMenor10.addEventListener("click", async () => {
      if (radioAcompanhamentoSim.checked) {
        menor10_acompanhado = true;
        for (const r of responsaveisExtras) {
          if (!r.nome || !r.rg || !r.dataNascimento) {
            showNotification("Preencha todos os campos dos responsáveis extras.", "warning");
            return;
          }
          const dataResp = new Date(r.dataNascimento);
          const hoje = new Date();
          let anos = hoje.getFullYear() - dataResp.getFullYear();
          let mm = hoje.getMonth() - dataResp.getMonth();
          let dd = hoje.getDate() - dataResp.getDate();
          if (dd < 0) { mm--; dd += 30; }
          if (mm < 0) { anos--; mm += 12; }
          if (anos < 18) {
            showNotification("Todos os responsáveis extras devem ter mais de 18 anos.", "warning");
            return;
          }
        }
        for (const r of responsaveisExtras) {
          fetch(`/api/gerar-pdf-responsavel?nome=${encodeURIComponent(r.nome)}`)
            .catch(err => console.error('Erro ao gerar PDF do responsável:', err));
        }
      } else {
        menor10_acompanhado = false;
        responsaveisExtras = [];
      }
      modalMenores10.hide();
      btnAprovado.click();
    });

    btnConfirmar10a12.addEventListener("click", () => {
      if (modal10a12_radioSim.checked) {
        desembarqueSozinho10a12 = true;
        if (tipoFluxoSelecionado === "municipal") {
          if (!alunoIdMunicipal) return;
          window.open(`/api/termo-desembarque/${alunoIdMunicipal}/gerar-pdf?signer=${signerChoice || 'responsavel'}`, "_blank");
        } else {
          if (!alunoIdEstadual) return;
          window.open(`/api/termo-desembarque-estadual/${alunoIdEstadual}/gerar-pdf?signer=${signerChoice || 'responsavel'}`, "_blank");
        }
        modalDesembarque10a12.hide();
        btnAprovado.click();
      } else {
        desembarqueSozinho10a12 = false;
        modalDesembarque10a12.hide();
        modalOutrosResponsaveis10a12.show();
      }
    });

    radioOutrosRespSim.addEventListener("change", () => {
      containerOutrosResponsaveis10a12.classList.remove("d-none");
    });
    radioOutrosRespNao.addEventListener("change", () => {
      containerOutrosResponsaveis10a12.classList.add("d-none");
    });

    btnAddOutroResponsavel10a12.addEventListener("click", () => {
      if (outrosResponsaveis10a12.length >= 3) {
        showNotification("É permitido no máximo 3 responsáveis extras.", "warning");
        return;
      }
      const obj = { nome: "", rg: "", cpf: "" };
      outrosResponsaveis10a12.push(obj);
      renderListaOutrosResponsaveis10a12();
    });

    function renderListaOutrosResponsaveis10a12() {
      listaOutrosResponsaveis10a12.innerHTML = "";
      outrosResponsaveis10a12.forEach((resp, idx) => {
        const div = document.createElement("div");
        div.classList.add("mb-2", "p-2", "border", "rounded");
        const htmlResp = `
          <label class="form-label fw-semibold">Nome</label>
          <input type="text" class="form-control mb-2" data-oindex="${idx}" data-field="nome" placeholder="Nome" value="${resp.nome || ""}">
          <label class="form-label fw-semibold">RG</label>
          <input type="text" class="form-control mb-2" data-oindex="${idx}" data-field="rg" placeholder="RG" value="${resp.rg || ""}">
          <label class="form-label fw-semibold">CPF</label>
          <input type="text" class="form-control mb-2" data-oindex="${idx}" data-field="cpf" placeholder="CPF" value="${resp.cpf || ""}">
          <button class="btn btn-sm btn-danger" data-action="remove2" data-oindex="${idx}">Remover</button>
        `;
        div.innerHTML = htmlResp;
        listaOutrosResponsaveis10a12.appendChild(div);
      });
      listaOutrosResponsaveis10a12.querySelectorAll("input").forEach(input => {
        input.addEventListener("change", e => {
          const index = parseInt(e.target.dataset.oindex);
          const field = e.target.dataset.field;
          outrosResponsaveis10a12[index][field] = e.target.value;
        });
      });
      listaOutrosResponsaveis10a12.querySelectorAll("button[data-action='remove2']").forEach(btn => {
        btn.addEventListener("click", e => {
          const index = parseInt(e.target.dataset.oindex);
          outrosResponsaveis10a12.splice(index, 1);
          renderListaOutrosResponsaveis10a12();
        });
      });
    }

    btnConfirmarOutrosResponsaveis10a12.addEventListener("click", async () => {
      if (radioOutrosRespSim.checked) {
        if (outrosResponsaveis10a12.length === 0) {
          showNotification("Adicione ao menos um responsável.", "warning");
          return;
        }
        try {
          const currentAlunoId = tipoFluxoSelecionado === "municipal" ? alunoIdMunicipal : alunoIdEstadual;
          await fetch("/api/outros-responsaveis", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              aluno_id: currentAlunoId,
              responsaveis: outrosResponsaveis10a12
            })
          });
        } catch (err) {
          showNotification("Falha ao salvar responsáveis no banco.", "danger");
          return;
        }
        for (const r of outrosResponsaveis10a12) {
          fetch(`/api/gerar-pdf-responsavel?nome=${encodeURIComponent(r.nome)}`)
            .catch(err => console.error('Erro ao gerar PDF do responsável:', err));
        }
        if (tipoFluxoSelecionado === "municipal" && alunoIdMunicipal) {
          window.open(`/api/termo-autorizacao-outros-responsaveis/${alunoIdMunicipal}/gerar-pdf`, "_blank");
        } else if (tipoFluxoSelecionado === "estadual" && alunoIdEstadual) {
          window.open(`/api/termo-autorizacao-outros-responsaveis-estadual/${alunoIdEstadual}/gerar-pdf`, "_blank");
        }
      } else {
        outrosResponsaveis10a12 = [];
      }
      modalOutrosResponsaveis10a12.hide();
      btnAprovado.click();
    });

    btnNaoAprovado.addEventListener("click", () => {
      resultadoFinal = "NAO_APROVADO";
      etapa2.classList.remove("active");
      etapa3.classList.add("active");
      resultadoTitulo.innerText = "Não Aprovado";
      resultadoTitulo.className = "text-center text-danger";
      resultadoDescricao.innerText = "O aluno não atende aos critérios estabelecidos.";
    });

    btnAprovado.addEventListener("click", () => {
      resultadoFinal = "APROVADO";
      etapa2.classList.remove("active");
      etapa3.classList.add("active");
      resultadoTitulo.innerText = "Aluno Aprovado!";
      resultadoTitulo.className = "text-center text-success";
      resultadoDescricao.innerText = "O aluno atende aos critérios e foi aprovado.";
    });

    btnFinalizar.addEventListener("click", async () => {
      if (resultadoFinal === "APROVADO") {
        await salvarLocalizacaoFinal();
        if (tipoFluxoSelecionado === "municipal" && alunoIdMunicipal) {
          await criarSolicitacaoTransporte(
            alunoIdMunicipal,
            "APROVADO",
            null,
            "municipal",
            {
              menor10_acompanhado,
              responsaveisExtras,
              desembarqueSozinho10a12
            }
          );
          window.open(`/api/comprovante-aprovado/${alunoIdMunicipal}/gerar-pdf?signer=${signerChoice || 'filiacao1'}`, "_blank");
        } else if (tipoFluxoSelecionado === "estadual" && alunoIdEstadual) {
          await criarSolicitacaoTransporte(
            alunoIdEstadual,
            "APROVADO",
            null,
            "estadual",
            {
              menor10_acompanhado,
              responsaveisExtras,
              desembarqueSozinho10a12
            }
          );
          window.open(`/api/comprovante-aprovado-estadual/${alunoIdEstadual}/gerar-pdf?signer=${signerChoice || 'filiacao1'}`, "_blank");
        }
      } else if (resultadoFinal === "NAO_APROVADO") {
        if (tipoFluxoSelecionado === "municipal" && alunoIdMunicipal) {
          await criarSolicitacaoTransporte(
            alunoIdMunicipal,
            "NAO_APROVADO",
            "Critérios não atendidos",
            "municipal",
            null
          );
          if (atenuantesReavaliacao) {
            window.open(`/api/comprovante-reavaliacao/${alunoIdMunicipal}/gerar-pdf`, "_blank");
          } else {
            window.open(`/api/comprovante-nao-aprovado/${alunoIdMunicipal}/gerar-pdf`, "_blank");
          }
        } else if (tipoFluxoSelecionado === "estadual" && alunoIdEstadual) {
          await criarSolicitacaoTransporte(
            alunoIdEstadual,
            "NAO_APROVADO",
            "Critérios não atendidos",
            "estadual",
            null
          );
          if (atenuantesReavaliacao) {
            window.open(`/api/comprovante-reavaliacao-estadual/${alunoIdEstadual}/gerar-pdf`, "_blank");
          } else {
            window.open(`/api/comprovante-nao-aprovado-estadual/${alunoIdEstadual}/gerar-pdf`, "_blank");
          }
        }
      } else if (resultadoFinal === "AVALIACAO_MANUAL") {
        await salvarLocalizacaoFinal();
        if (tipoFluxoSelecionado === "municipal" && alunoIdMunicipal) {
          await criarSolicitacaoTransporte(
            alunoIdMunicipal,
            "PENDENTE_AVALIACAO_MANUAL",
            "Aluno com deficiência. Avaliação pessoal necessária.",
            "municipal",
            null
          );
          window.open(`/api/comprovante-avaliacao-manual/${alunoIdMunicipal}/gerar-pdf?signer=${signerChoice || 'filiacao1'}`, "_blank");
        } else if (tipoFluxoSelecionado === "estadual" && alunoIdEstadual) {
          await criarSolicitacaoTransporte(
            alunoIdEstadual,
            "PENDENTE_AVALIACAO_MANUAL",
            "Aluno com deficiência. Avaliação pessoal necessária.",
            "estadual",
            null
          );
          window.open(`/api/comprovante-avaliacao-manual-estadual/${alunoIdEstadual}/gerar-pdf?signer=${signerChoice || 'filiacao1'}`, "_blank");
        }
      }
      showNotification("Atendimento finalizado!", "success");
      location.reload();
    });

    async function salvarLocalizacaoFinal() {
      if (tipoFluxoSelecionado === "municipal" && alunoIdMunicipal) {
        const defValue = campoDeficienciaMunicipal.value;
        const defArray = defValue ? [defValue] : null;
        const mergeBody = {
          cep: campoCepMunicipal.value.trim(),
          bairro: campoBairroMunicipal.value.trim(),
          numero_pessoa_endereco: campoNumeroEnderecoMunicipal.value.trim(),
          numero_telefone: campoTelefoneMunicipal.value.trim(),
          deficiencia: defArray,
          latitude: parseFloat(campoLatitude.value) || null,
          longitude: parseFloat(campoLongitude.value) || null,
          rua: campoRuaMunicipal.value.trim()
        };
        try {
          await fetch(`/api/alunos-recadastro/${alunoIdMunicipal}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(mergeBody)
          });
        } catch (err) {
          console.error("Erro ao salvar localização final (municipal):", err);
        }
      } else if (tipoFluxoSelecionado === "estadual" && alunoIdEstadual) {
        const defValueEst = campoDeficienciaEstadual.value;
        const defArrayEst = defValueEst ? [defValueEst] : null;
        const mergeBodyEst = {
          cep: campoCepEstadual.value.trim(),
          bairro: campoBairroEstadual.value.trim(),
          numero_pessoa_endereco: campoNumeroEnderecoEstadual.value.trim(),
          numero_telefone: campoTelefoneEstadual.value.trim(),
          deficiencia: defArrayEst,
          latitude: parseFloat(campoLatitude.value) || null,
          longitude: parseFloat(campoLongitude.value) || null,
          rua: campoRuaEstadual.value.trim()
        };
        try {
          await fetch(`/api/alunos-recadastro/${alunoIdEstadual}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(mergeBodyEst)
          });
        } catch (err) {
          console.error("Erro ao salvar localização final (estadual):", err);
        }
      }
    }

    async function criarSolicitacaoTransporte(alunoId, status, motivo, fluxo, extraData) {
      try {
        const bodyReq = {
          aluno_id: alunoId,
          status: status,
          motivo: motivo,
          tipo_fluxo: fluxo,
          menor10_acompanhado: extraData ? !!extraData.menor10_acompanhado : false,
          responsaveis_extras: extraData ? extraData.responsaveisExtras : [],
          desembarque_sozinho_10a12: extraData ? !!extraData.desembarqueSozinho10a12 : false
        };
        let endpoint = "/api/solicitacoes-transporte";
        if (status === "PENDENTE_AVALIACAO_MANUAL") {
          endpoint = "/api/solicitacoes-transporte-especial";
        }
        const resp = await fetch(endpoint, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(bodyReq),
        });
        const data = await resp.json();
        if (!resp.ok) {
          showNotification(data.message || "Erro ao salvar solicitação no banco.", "danger");
          return;
        }
      } catch (error) {
        showNotification("Falha ao salvar a solicitação.", "danger");
      }
    }

    async function initMap() {
      if (!map) {
        map = new google.maps.Map(document.getElementById("mapCriterios"), {
          center: { lat: -6.530066, lng: -49.85163 },
          zoom: 14,
          mapTypeId: google.maps.MapTypeId.HYBRID
        });
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
          map: map,
          draggable: true,
          suppressMarkers: true,
          polylineOptions: {
            strokeColor: "#FF0000",
            strokeOpacity: 0.7,
            strokeWeight: 5
          }
        });
        directionsRenderer.addListener('directions_changed', function () {
          const newDirections = directionsRenderer.getDirections();
          if (newDirections && newDirections.routes && newDirections.routes.length > 0) {
            const distanceMeters = newDirections.routes[0].legs[0].distance.value;
            const distanceKm = (distanceMeters / 1000).toFixed(2);
            distanciaRota.textContent = distanceKm;
          }
        });
      }
      distanciaRota.textContent = "--";
      let endAluno = "";
      let latAluno = null;
      let lngAluno = null;
      let escolaNome = "";
      let latEscola = null;
      let lngEscola = null;
      if (tipoFluxoSelecionado === "municipal") {
        latAluno = originalData?.latitude || null;
        lngAluno = originalData?.longitude || null;
        escolaNome = originalData?.escola_nome || "";
        if (campoRuaMunicipal.value.trim()) {
          endAluno = `${campoRuaMunicipal.value}, ${campoNumeroEnderecoMunicipal.value}, Canaã dos Carajás, Pará, Brasil`;
        } else {
          endAluno = `${campoCepMunicipal.value}, ${campoNumeroEnderecoMunicipal.value}, Canaã dos Carajás, Pará, Brasil`;
        }
      } else {
        latAluno = null;
        lngAluno = null;
        const selectedOption = campoEscolaEstadual.options[campoEscolaEstadual.selectedIndex];
        escolaNome = selectedOption ? selectedOption.textContent : "";
        if (campoRuaEstadual.value.trim()) {
          endAluno = `${campoRuaEstadual.value}, ${campoNumeroEnderecoEstadual.value}, Canaã dos Carajás, Pará, Brasil`;
        } else {
          endAluno = `${campoCepEstadual.value}, ${campoNumeroEnderecoEstadual.value}, Canaã dos Carajás, Pará, Brasil`;
        }
      }
      infoEndereco.innerText = endAluno;
      try {
        const escolaResp = await fetch(`/api/escola-coordenadas?nome_escola=${encodeURIComponent(escolaNome)}`);
        const escolaJson = await escolaResp.json();
        if (escolaJson && escolaJson.latitude && escolaJson.longitude) {
          latEscola = parseFloat(escolaJson.latitude);
          lngEscola = parseFloat(escolaJson.longitude);
        } else {
          console.warn("Não foi possível localizar a escola pelo nome informado.");
        }
        if (escolaJson.zoneamentos && Array.isArray(escolaJson.zoneamentos)) {
          escolaJson.zoneamentos.forEach(z => {
            if (z.geojson) {
              if (z.geojson.type === "Polygon") {
                if (z.geojson.coordinates.length > 0) {
                  const coords = z.geojson.coordinates[0].map(coord => ({ lat: coord[1], lng: coord[0] }));
                  const polygon = new google.maps.Polygon({
                    paths: coords,
                    map: map,
                    fillColor: "#0000FF",
                    fillOpacity: 0.1,
                    strokeColor: "#0000FF",
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    clickable: false
                  });
                  polygonsZone.push(polygon);
                }
              } else if (z.geojson.type === "MultiPolygon") {
                z.geojson.coordinates.forEach(polygonCoords => {
                  if (polygonCoords.length > 0) {
                    const coords = polygonCoords[0].map(coord => ({ lat: coord[1], lng: coord[0] }));
                    const polygon = new google.maps.Polygon({
                      paths: coords,
                      map: map,
                      fillColor: "#0000FF",
                      fillOpacity: 0.1,
                      strokeColor: "#0000FF",
                      strokeOpacity: 0.8,
                      strokeWeight: 2,
                      clickable: false
                    });
                    polygonsZone.push(polygon);
                  }
                });
              } else if (z.geojson.type === "LineString") {
                if (z.geojson.coordinates.length > 0) {
                  const lineCoords = z.geojson.coordinates.map(coord => ({ lat: coord[1], lng: coord[0] }));
                  const polyline = new google.maps.Polyline({
                    path: lineCoords,
                    map: map,
                    strokeColor: "#0000FF",
                    strokeOpacity: 0.8,
                    strokeWeight: 3,
                    clickable: false
                  });
                  polygonsZone.push(polyline);
                }
              } else if (z.geojson.type === "MultiLineString") {
                z.geojson.coordinates.forEach(line => {
                  const lineCoords = line.map(coord => ({ lat: coord[1], lng: coord[0] }));
                  const polyline = new google.maps.Polyline({
                    path: lineCoords,
                    map: map,
                    strokeColor: "#0000FF",
                    strokeOpacity: 0.8,
                    strokeWeight: 3,
                    clickable: false
                  });
                  polygonsZone.push(polyline);
                });
              }
            }
          });
        }
      } catch (err) {
        console.error("Erro ao buscar coordenadas da escola:", err);
      }
      if (latEscola && lngEscola) {
        escolaPos = new google.maps.LatLng(latEscola, lngEscola);
      } else {
        escolaPos = new google.maps.LatLng(-6.530066, -49.85163);
      }
      if (latAluno && lngAluno) {
        alunoPos = new google.maps.LatLng(parseFloat(latAluno), parseFloat(lngAluno));
        createOrMoveMarkers();
      } else {
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ address: endAluno }, (results, status) => {
          if (status === "OK") {
            alunoPos = results[0].geometry.location;
            campoLatitude.value = alunoPos.lat().toFixed(6);
            campoLongitude.value = alunoPos.lng().toFixed(6);
            createOrMoveMarkers();
          } else {
            showNotification("Não foi possível localizar o endereço do aluno via Geocoder.", "danger");
            map.setCenter(escolaPos);
          }
        });
      }
      google.maps.event.addListener(map, "click", (e) => {
        if (!markerAluno) {
          markerAluno = new google.maps.Marker({
            position: e.latLng,
            map: map,
            icon: {
              url: "https://maps.google.com/mapfiles/kml/shapes/man.png",
              scaledSize: new google.maps.Size(30, 30)
            },
            draggable: true
          });
          markerAluno.addListener("dragend", () => {
            const pos = markerAluno.getPosition();
            campoLatitude.value = pos.lat().toFixed(6);
            campoLongitude.value = pos.lng().toFixed(6);
            calcularRota(pos, escolaPos);
          });
        } else {
          markerAluno.setPosition(e.latLng);
        }
        campoLatitude.value = e.latLng.lat().toFixed(6);
        campoLongitude.value = e.latLng.lng().toFixed(6);
        calcularRota(e.latLng, escolaPos);
      });
    }

    function createOrMoveMarkers() {
      if (!markerAluno && alunoPos) {
        markerAluno = new google.maps.Marker({
          position: alunoPos,
          map: map,
          icon: {
            url: "https://maps.google.com/mapfiles/kml/shapes/man.png",
            scaledSize: new google.maps.Size(30, 30)
          },
          draggable: true
        });
        markerAluno.addListener("dragend", () => {
          const pos = markerAluno.getPosition();
          campoLatitude.value = pos.lat().toFixed(6);
          campoLongitude.value = pos.lng().toFixed(6);
          calcularRota(pos, escolaPos);
        });
      } else if (markerAluno && alunoPos) {
        markerAluno.setPosition(alunoPos);
      }
      if (!markerEscola) {
        markerEscola = new google.maps.Marker({
          position: escolaPos,
          map: map,
          icon: "https://maps.google.com/mapfiles/kml/pal3/icon56.png"
        });
      } else {
        markerEscola.setPosition(escolaPos);
      }
      if (alunoPos) {
        map.setCenter(alunoPos);
        calcularRota(alunoPos, escolaPos);
      } else {
        map.setCenter(escolaPos);
      }
    }

    function calcularRota(aPos, ePos) {
      const request = {
        origin: aPos,
        destination: ePos,
        travelMode: google.maps.TravelMode.WALKING,
        provideRouteAlternatives: true
      };
      directionsService.route(request, (result, status) => {
        if (status === "OK") {
          directionsRenderer.setDirections(result);
          const distanceMeters = result.routes[0].legs[0].distance.value;
          const distanceKm = (distanceMeters / 1000).toFixed(2);
          distanciaRota.textContent = distanceKm;
        } else {
          distanciaRota.textContent = "--";
        }
      });
    }
  </script>
</body>

</html>