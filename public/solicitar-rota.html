<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Consulta de Aluno</title>
  <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport" />
  <link rel="icon" href="../../assets/img/pydenadmin/favicon.png" type="image/x-icon" />

  <script src="../../assets/js/plugin/webfont/webfont.min.js"></script>
  <script>
    WebFont.load({
      google: { families: ["Public Sans:300,400,500,600,700"] },
      custom: {
        families: [
          "Font Awesome 5 Solid",
          "Font Awesome 5 Regular",
          "Font Awesome 5 Brands",
          "simple-line-icons"
        ],
        urls: ["../../assets/css/fonts.min.css"]
      },
      active: function () {
        sessionStorage.fonts = true;
      }
    });
  </script>

  <link rel="stylesheet" href="../../assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="../../assets/css/plugins.min.css" />
  <link rel="stylesheet" href="../../assets/css/pydenadmin.min.css" />
  <link rel="stylesheet" href="../../assets/css/demo.css" />

  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY"></script>
</head>

<body>
  <div class="container my-4">
    <div class="page-inner">
      <div class="page-header">
        <h3 class="fw-bold mb-12 center">Cadastro de Alunos</h3>
      </div>

      <div class="row">
        <div class="col-md-12">
          <div class="card">
            <div class="card-header">
              <div class="card-title">Consulta de Aluno</div>
            </div>
            <div class="card-body">
              <div class="row justify-content-center">
                <div class="col-md-6 text-center">
                  <label for="inputBusca" class="form-label">
                    CPF ou ID de Matrícula
                  </label>
                  <input type="text" class="form-control mx-auto" style="max-width: 300px;" id="inputBusca"
                    placeholder="Digite aqui..." />
                  <button id="btnBuscar" class="btn btn-primary mt-3">Buscar</button>
                </div>
              </div>

              <div class="row justify-content-center mt-4">
                <div class="col-md-8">
                  <div class="d-none" id="dadosAlunoContainer">
                    <label for="dadosAluno" class="form-label fw-semibold">
                      Dados do Aluno
                    </label>
                    <textarea class="form-control" id="dadosAluno" rows="8" readonly></textarea>
                    <button class="btn btn-secondary mt-3" id="verificarCriterios">
                      Verificar Critérios
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Modal -->
          <div class="modal fade" id="modalCriterios" tabindex="-1" aria-labelledby="modalCriteriosLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="modalCriteriosLabel">Mapa - Critérios</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-3" id="map" style="height: 500px; width: 100%;"></div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Fechar
                  </button>
                </div>
              </div>
            </div>
          </div>
          <!-- Fim Modal -->
        </div>
      </div>
    </div>
  </div>

  <script src="../../assets/js/core/jquery-3.7.1.min.js"></script>
  <script src="../../assets/js/core/popper.min.js"></script>
  <script src="../../assets/js/core/bootstrap.min.js"></script>
  <script src="../../assets/js/plugin/bootstrap-notify/bootstrap-notify.min.js"></script>
  <script src="../../assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
  <script src="../../assets/js/pydenadmin.min.js"></script>

  <script>
    let alunoData = null;
    let map;
    let markerAluno;
    let markerEscola;

    const btnBuscar = document.getElementById("btnBuscar");
    const inputBusca = document.getElementById("inputBusca");
    const dadosAlunoContainer = document.getElementById("dadosAlunoContainer");
    const dadosAluno = document.getElementById("dadosAluno");
    const verificarCriterios = document.getElementById("verificarCriterios");

    btnBuscar.addEventListener("click", async () => {
      const valorBusca = inputBusca.value.trim();
      if (!valorBusca) {
        alert("Por favor, informe o CPF ou o ID de Matrícula.");
        return;
      }

      try {
        const response = await fetch(`/api/alunos_ativos?search=${encodeURIComponent(valorBusca)}`);
        if (!response.ok) {
          throw new Error("Erro ao buscar dados do aluno.");
        }
        const data = await response.json();

        if (!data || !data.id_matricula) {
          alert("Nenhum aluno encontrado para o valor informado.");
          return;
        }

        alunoData = data;

        let textoExibicao = "";
        textoExibicao += `ID Matrícula: ${data.id_matricula || ""}\n`;
        textoExibicao += `Nome do Aluno: ${data.pessoa_nome || ""}\n`;
        textoExibicao += `Escola: ${data.escola_nome || ""}\n`;
        textoExibicao += `Turma: ${data.turma || ""}\n`;
        textoExibicao += `CPF: ${data.cpf || ""}\n`;
        textoExibicao += `CEP: ${data.cep || ""}\n`;
        textoExibicao += `Bairro: ${data.bairro || ""}\n`;
        textoExibicao += `Número Endereço: ${data.numero_pessoa_endereco || ""}\n`;
        textoExibicao += `Filiação 1: ${data.filiacao_1 || ""}\n`;
        textoExibicao += `Telefone: ${data.numero_telefone || ""}\n`;
        textoExibicao += `Filiação 2: ${data.filiacao_2 || ""}\n`;
        textoExibicao += `Responsável: ${data.responsavel || ""}\n`;
        textoExibicao += `Deficiência: ${data.deficiencia && data.deficiencia.length
            ? data.deficiencia.join(", ")
            : "Não informado"
          }\n`;

        dadosAluno.value = textoExibicao;
        dadosAlunoContainer.classList.remove("d-none");
      } catch (error) {
        console.error(error);
        alert("Ocorreu um erro ao buscar os dados do aluno.");
      }
    });

    verificarCriterios.addEventListener("click", async () => {
      if (!alunoData || !alunoData.id_matricula) {
        alert("Nenhum aluno selecionado.");
        return;
      }

      try {
        const escolaResponse = await fetch(`/api/escola_info?id=${alunoData.escola_id}`);
        if (!escolaResponse.ok) {
          throw new Error("Erro ao buscar dados da escola.");
        }
        const escolaData = await escolaResponse.json();

        $("#modalCriterios").modal("show");

        setTimeout(async () => {
          if (!map) {
            map = new google.maps.Map(document.getElementById("map"), {
              center: { lat: -6.530066, lng: -49.85163 },
              zoom: 14,
              mapTypeId: "roadmap"
            });
          }

          if (markerAluno) {
            markerAluno.setMap(null);
          }
          if (markerEscola) {
            markerEscola.setMap(null);
          }

          let alunoAddress = `${alunoData.cep || ""}, ${alunoData.numero_pessoa_endereco || ""}, Canaã dos Carajás, Pará, Brasil`;
          const geocoder = new google.maps.Geocoder();
          geocoder.geocode({ address: alunoAddress }, (results, status) => {
            if (status === "OK" && results[0]) {
              const alunoLatLng = results[0].geometry.location;
              markerAluno = new google.maps.Marker({
                position: alunoLatLng,
                map: map,
                icon: "../../assets/img/icones/boneco.png"
              });
              map.setCenter(alunoLatLng);
            }
          });

          if (escolaData && escolaData.latitude && escolaData.longitude) {
            const escolaLatLng = {
              lat: parseFloat(escolaData.latitude),
              lng: parseFloat(escolaData.longitude)
            };
            markerEscola = new google.maps.Marker({
              position: escolaLatLng,
              map: map,
              icon: "../../assets/img/icones/casinha.png"
            });
          }
        }, 500);
      } catch (error) {
        console.error(error);
        alert("Ocorreu um erro ao buscar dados para verificar os critérios.");
      }
    });
  </script>
</body>

</html>