<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Cadastro de Alunos - Wizard</title>
  <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport" />
  <link rel="icon" href="../../assets/img/pydenadmin/favicon.png" type="image/x-icon" />

  <script src="../../assets/js/plugin/webfont/webfont.min.js"></script>
  <script>
    WebFont.load({
      google: { families: ["Public Sans:300,400,500,600,700"] },
      custom: {
        families: ["Font Awesome 5 Solid", "Font Awesome 5 Regular", "Font Awesome 5 Brands", "simple-line-icons"],
        urls: ["../../assets/css/fonts.min.css"]
      },
      active: function () {
        sessionStorage.fonts = true;
      }
    });
  </script>

  <link rel="stylesheet" href="../../assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="../../assets/css/plugins.min.css" />
  <link rel="stylesheet" href="../../assets/css/pydenadmin.min.css" />
  <link rel="stylesheet" href="../../assets/css/demo.css" />

  <style>
    #mapCriterios {
      width: 100%;
      height: 400px;
    }

    #measureInfo {
      margin-top: 10px;
      font-weight: 600;
      font-size: 0.9rem;
      color: #444;
    }

    .wizard-step {
      display: none;
    }

    .wizard-step.active {
      display: block;
    }
  </style>
</head>

<body>
  <div class="container my-4">
    <div class="page-inner">
      <div class="page-header">
        <h3 class="fw-bold mb-12 text-center">Cadastro de Alunos - Wizard</h3>
      </div>

      <!-- SELEÇÃO DE FLUXO (ETAPA 0) -->
      <div class="card wizard-step active" id="etapaSelecaoFluxo">
        <div class="card-header">
          <div class="card-title">Selecione o tipo de cadastro</div>
        </div>
        <div class="card-body">
          <div class="form-check">
            <input class="form-check-input" type="radio" name="tipoFluxo" id="fluxoMunicipal" value="municipal" />
            <label class="form-check-label" for="fluxoMunicipal">
              Municipal
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="tipoFluxo" id="fluxoEstadual" value="estadual" />
            <label class="form-check-label" for="fluxoEstadual">
              Estadual
            </label>
          </div>
          <div class="mt-4">
            <button class="btn btn-primary" id="btnContinuarFluxo">Continuar</button>
          </div>
        </div>
      </div>

      <!-- FLUXO MUNICIPAL (ETAPA 1) -->
      <div class="card wizard-step" id="etapa1Municipal">
        <div class="card-header">
          <div class="card-title">Etapa 1 (Municipal): Dados do Aluno</div>
        </div>
        <div class="card-body">
          <div class="row justify-content-center">
            <div class="col-md-6 text-center">
              <label for="inputBusca" class="form-label">CPF ou ID de Matrícula</label>
              <input type="text" class="form-control mx-auto" style="max-width: 300px;" id="inputBusca"
                placeholder="Digite aqui..." />
              <button id="btnBuscar" class="btn btn-primary mt-3">Buscar</button>
            </div>
          </div>

          <div class="row justify-content-center mt-4">
            <div class="col-md-10">
              <div class="d-none" id="dadosAlunoContainerMunicipal">
                <div class="row">
                  <div class="col-md-4 mb-2">
                    <label class="form-label fw-semibold">ID Matrícula</label>
                    <input type="text" class="form-control" id="campoIdMatriculaMunicipal" readonly />
                  </div>
                  <div class="col-md-4 mb-2">
                    <label class="form-label fw-semibold">Nome do Aluno</label>
                    <input type="text" class="form-control" id="campoNomeAlunoMunicipal" readonly />
                  </div>
                  <div class="col-md-4 mb-2">
                    <label class="form-label fw-semibold">Data de Nascimento</label>
                    <input type="date" class="form-control" id="campoDataNascimentoMunicipal" />
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Escola</label>
                    <input type="text" class="form-control" id="campoEscolaMunicipal" readonly />
                  </div>
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Turma</label>
                    <input type="text" class="form-control" id="campoTurmaMunicipal" readonly />
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Nível de Ensino</label>
                    <select class="form-control" id="campoNivelEnsinoMunicipal">
                      <option value="">Selecione...</option>
                      <option value="infantil">Infantil</option>
                      <option value="fundamental">Fundamental</option>
                      <option value="medio">Médio</option>
                    </select>
                  </div>
                  <div class="col-md-6 mb-2" id="campoZonaEnsinoContainerMunicipal" style="display:none;">
                    <label class="form-label fw-semibold">Zona</label>
                    <select class="form-control" id="campoZonaMunicipal">
                      <option value="">Selecione...</option>
                      <option value="rural">Rural</option>
                      <option value="urbana">Urbana</option>
                    </select>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">CPF</label>
                    <input type="text" class="form-control" id="campoCpfMunicipal" readonly />
                  </div>
                  <div class="col-md-4 mb-2">
                    <label class="form-label fw-semibold">CEP</label>
                    <input type="text" class="form-control" id="campoCepMunicipal" />
                  </div>
                  <div class="col-md-2 d-flex align-items-end">
                    <button class="btn btn-info w-100" id="btnConverterCepMunicipal">Converter CEP</button>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Rua</label>
                    <input type="text" class="form-control" id="campoRuaMunicipal" />
                  </div>
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Bairro</label>
                    <input type="text" class="form-control" id="campoBairroMunicipal" />
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Número Endereço</label>
                    <input type="text" class="form-control" id="campoNumeroEnderecoMunicipal" />
                  </div>
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Telefone</label>
                    <input type="text" class="form-control" id="campoTelefoneMunicipal" />
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Filiação 1</label>
                    <input type="text" class="form-control" id="campoFiliacao1Municipal" readonly />
                  </div>
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Filiação 2</label>
                    <input type="text" class="form-control" id="campoFiliacao2Municipal" readonly />
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Responsável</label>
                    <input type="text" class="form-control" id="campoResponsavelMunicipal" readonly />
                  </div>
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Deficiência (use vírgulas se mais de uma)</label>
                    <input type="text" class="form-control" id="campoDeficienciaMunicipal" />
                  </div>
                </div>

                <div class="d-flex justify-content-between mt-3">
                  <div>
                    <button class="btn btn-info" id="btnImprimirConfirmacaoMunicipal">Imprimir Confirmação</button>
                  </div>
                  <div>
                    <button class="btn btn-primary" id="btnProximoMunicipal">Próximo</button>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- FLUXO ESTADUAL (ETAPA 1) -->
      <div class="card wizard-step" id="etapa1Estadual">
        <div class="card-header">
          <div class="card-title">Etapa 1 (Estadual): Dados do Aluno</div>
        </div>
        <div class="card-body">
          <div class="row justify-content-center mt-4">
            <div class="col-md-10">
              <div id="dadosAlunoContainerEstadual">
                <div class="row">
                  <div class="col-md-4 mb-2">
                    <label class="form-label fw-semibold">ID Matrícula</label>
                    <input type="text" class="form-control" id="campoIdMatriculaEstadual" />
                  </div>
                  <div class="col-md-4 mb-2">
                    <label class="form-label fw-semibold">Nome do Aluno</label>
                    <input type="text" class="form-control" id="campoNomeAlunoEstadual" />
                  </div>
                  <div class="col-md-4 mb-2">
                    <label class="form-label fw-semibold">Data de Nascimento</label>
                    <input type="date" class="form-control" id="campoDataNascimentoEstadual" />
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Escola</label>
                    <select class="form-control" id="campoEscolaEstadual">
                      <option value="">Selecione a Escola</option>
                    </select>
                  </div>
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Turma</label>
                    <input type="text" class="form-control" id="campoTurmaEstadual" />
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Turno</label>
                    <input type="text" class="form-control" id="campoTurnoEstadual" />
                  </div>
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">CPF</label>
                    <input type="text" class="form-control" id="campoCpfEstadual" />
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Nível de Ensino</label>
                    <select class="form-control" id="campoNivelEnsinoEstadual">
                      <option value="">Selecione...</option>
                      <option value="infantil">Infantil</option>
                      <option value="fundamental">Fundamental</option>
                      <option value="medio">Médio</option>
                    </select>
                  </div>
                  <div class="col-md-6 mb-2" id="campoZonaEnsinoContainerEstadual" style="display:none;">
                    <label class="form-label fw-semibold">Zona</label>
                    <select class="form-control" id="campoZonaEstadual">
                      <option value="">Selecione...</option>
                      <option value="rural">Rural</option>
                      <option value="urbana">Urbana</option>
                    </select>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-4 mb-2">
                    <label class="form-label fw-semibold">CEP</label>
                    <input type="text" class="form-control" id="campoCepEstadual" />
                  </div>
                  <div class="col-md-4 mb-2">
                    <label class="form-label fw-semibold">Rua</label>
                    <input type="text" class="form-control" id="campoRuaEstadual" />
                  </div>
                  <div class="col-md-4 mb-2">
                    <label class="form-label fw-semibold">Bairro</label>
                    <input type="text" class="form-control" id="campoBairroEstadual" />
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Número Endereço</label>
                    <input type="text" class="form-control" id="campoNumeroEnderecoEstadual" />
                  </div>
                  <div class="col-md-6 mb-2">
                    <label class="form-label fw-semibold">Telefone</label>
                    <input type="text" class="form-control" id="campoTelefoneEstadual" />
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-4 mb-2">
                    <label class="form-label fw-semibold">Filiação 1</label>
                    <input type="text" class="form-control" id="campoFiliacao1Estadual" />
                  </div>
                  <div class="col-md-4 mb-2">
                    <label class="form-label fw-semibold">Filiação 2</label>
                    <input type="text" class="form-control" id="campoFiliacao2Estadual" />
                  </div>
                  <div class="col-md-4 mb-2">
                    <label class="form-label fw-semibold">Responsável</label>
                    <input type="text" class="form-control" id="campoResponsavelEstadual" />
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-12 mb-2">
                    <label class="form-label fw-semibold">Deficiência (use vírgulas se mais de uma)</label>
                    <input type="text" class="form-control" id="campoDeficienciaEstadual" />
                  </div>
                </div>

                <div class="d-flex justify-content-end mt-3">
                  <button class="btn btn-info" id="btnConverterCepEstadual">Converter CEP</button>
                  <button class="btn btn-primary ms-2" id="btnProximoEstadual">Próximo</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ABA 2 (COMUM AOS DOIS FLUXOS) -->
      <div class="card wizard-step" id="etapa2">
        <div class="card-header">
          <div class="card-title">Etapa 2: Verificar Critérios (Mapa)</div>
        </div>
        <div class="card-body">
          <div class="mb-2">
            <strong>Endereço do Aluno:</strong>
            <span id="infoEndereco"></span>
          </div>
          <div id="mapCriterios"></div>
          <div class="mt-3">
            <strong>Distância (rota):</strong>
            <span id="distanciaRota">--</span>
            <span>km</span>
          </div>
          <div class="mt-2">
            <button id="btnMeasure" class="btn btn-sm btn-warning">Medir Distância Manual</button>
            <div id="measureInfo" class="d-none">
              <span>Medição manual: <span id="measureDistance">0</span> km</span>
              <button id="btnMeasureReset" class="btn btn-sm btn-outline-danger">Reset</button>
            </div>
          </div>
          <div class="row mt-4">
            <div class="col-md-6 mb-2">
              <label class="form-label fw-semibold">Latitude</label>
              <input type="text" class="form-control" id="campoLatitude" readonly />
            </div>
            <div class="col-md-6 mb-2">
              <label class="form-label fw-semibold">Longitude</label>
              <input type="text" class="form-control" id="campoLongitude" readonly />
            </div>
          </div>
          <hr />
          <div class="alert alert-secondary" id="divCritériosInfo">
            <p><strong>Situação do Aluno:</strong> <span id="avaliacaoAutomatica"></span></p>
          </div>
          <div class="d-flex justify-content-between mt-4">
            <button class="btn btn-secondary" id="btnVoltarEtapa1">Voltar</button>
            <button class="btn btn-primary" id="btnAvaliar">Avaliar Critérios</button>
          </div>
        </div>
      </div>

      <!-- ABA 3 (COMUM AOS DOIS FLUXOS) -->
      <div class="card wizard-step" id="etapa3">
        <div class="card-header">
          <div class="card-title">Etapa 3: Resultado</div>
        </div>
        <div class="card-body">
          <h4 class="text-center" id="resultadoTitulo"></h4>
          <p class="text-center" id="resultadoDescricao"></p>
          <div class="d-flex justify-content-center">
            <button class="btn btn-info" id="btnFinalizar">Concluir</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCAwvAt4l0Pkb1c52FLUE-ttVxm4YZ9J8M&libraries=places,geometry">
    </script>
  <script src="../../assets/js/core/jquery-3.7.1.min.js"></script>
  <script src="../../assets/js/core/popper.min.js"></script>
  <script src="../../assets/js/core/bootstrap.min.js"></script>
  <script src="../../assets/js/plugin/bootstrap-notify/bootstrap-notify.min.js"></script>
  <script src="../../assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
  <script src="../../assets/js/pydenadmin.min.js"></script>

  <script>
    let map, directionsService, directionsRenderer;
    let markerAluno = null, markerEscola = null;
    let escolaPos = null, alunoPos = null;
    let alunoIdMunicipal = null;
    let alunoIdEstadual = null;
    let tipoFluxoSelecionado = null;
    let originalData = null;
    let measureActive = false;
    let measurePoints = [];
    let measurePolyline = null;
    let mapClickListener = null;

    const etapaSelecaoFluxo = document.getElementById("etapaSelecaoFluxo");
    const etapa1Municipal = document.getElementById("etapa1Municipal");
    const etapa1Estadual = document.getElementById("etapa1Estadual");
    const etapa2 = document.getElementById("etapa2");
    const etapa3 = document.getElementById("etapa3");

    const fluxoMunicipal = document.getElementById("fluxoMunicipal");
    const fluxoEstadual = document.getElementById("fluxoEstadual");
    const btnContinuarFluxo = document.getElementById("btnContinuarFluxo");

    // MUNICIPAL
    const btnBuscar = document.getElementById("btnBuscar");
    const inputBusca = document.getElementById("inputBusca");
    const dadosAlunoContainerMunicipal = document.getElementById("dadosAlunoContainerMunicipal");
    const btnConverterCepMunicipal = document.getElementById("btnConverterCepMunicipal");
    const btnProximoMunicipal = document.getElementById("btnProximoMunicipal");
    const btnImprimirConfirmacaoMunicipal = document.getElementById("btnImprimirConfirmacaoMunicipal");

    const campoIdMatriculaMunicipal = document.getElementById("campoIdMatriculaMunicipal");
    const campoNomeAlunoMunicipal = document.getElementById("campoNomeAlunoMunicipal");
    const campoDataNascimentoMunicipal = document.getElementById("campoDataNascimentoMunicipal");
    const campoEscolaMunicipal = document.getElementById("campoEscolaMunicipal");
    const campoTurmaMunicipal = document.getElementById("campoTurmaMunicipal");
    const campoNivelEnsinoMunicipal = document.getElementById("campoNivelEnsinoMunicipal");
    const campoZonaEnsinoContainerMunicipal = document.getElementById("campoZonaEnsinoContainerMunicipal");
    const campoZonaMunicipal = document.getElementById("campoZonaMunicipal");
    const campoCpfMunicipal = document.getElementById("campoCpfMunicipal");
    const campoCepMunicipal = document.getElementById("campoCepMunicipal");
    const campoRuaMunicipal = document.getElementById("campoRuaMunicipal");
    const campoBairroMunicipal = document.getElementById("campoBairroMunicipal");
    const campoNumeroEnderecoMunicipal = document.getElementById("campoNumeroEnderecoMunicipal");
    const campoTelefoneMunicipal = document.getElementById("campoTelefoneMunicipal");
    const campoFiliacao1Municipal = document.getElementById("campoFiliacao1Municipal");
    const campoFiliacao2Municipal = document.getElementById("campoFiliacao2Municipal");
    const campoResponsavelMunicipal = document.getElementById("campoResponsavelMunicipal");
    const campoDeficienciaMunicipal = document.getElementById("campoDeficienciaMunicipal");

    // ESTADUAL
    const btnConverterCepEstadual = document.getElementById("btnConverterCepEstadual");
    const btnProximoEstadual = document.getElementById("btnProximoEstadual");

    const campoIdMatriculaEstadual = document.getElementById("campoIdMatriculaEstadual");
    const campoNomeAlunoEstadual = document.getElementById("campoNomeAlunoEstadual");
    const campoDataNascimentoEstadual = document.getElementById("campoDataNascimentoEstadual");
    const campoEscolaEstadual = document.getElementById("campoEscolaEstadual");
    const campoTurmaEstadual = document.getElementById("campoTurmaEstadual");
    const campoTurnoEstadual = document.getElementById("campoTurnoEstadual");
    const campoCpfEstadual = document.getElementById("campoCpfEstadual");
    const campoNivelEnsinoEstadual = document.getElementById("campoNivelEnsinoEstadual");
    const campoZonaEnsinoContainerEstadual = document.getElementById("campoZonaEnsinoContainerEstadual");
    const campoZonaEstadual = document.getElementById("campoZonaEstadual");
    const campoCepEstadual = document.getElementById("campoCepEstadual");
    const campoRuaEstadual = document.getElementById("campoRuaEstadual");
    const campoBairroEstadual = document.getElementById("campoBairroEstadual");
    const campoNumeroEnderecoEstadual = document.getElementById("campoNumeroEnderecoEstadual");
    const campoTelefoneEstadual = document.getElementById("campoTelefoneEstadual");
    const campoFiliacao1Estadual = document.getElementById("campoFiliacao1Estadual");
    const campoFiliacao2Estadual = document.getElementById("campoFiliacao2Estadual");
    const campoResponsavelEstadual = document.getElementById("campoResponsavelEstadual");
    const campoDeficienciaEstadual = document.getElementById("campoDeficienciaEstadual");

    // ETAPA 2 E 3
    const btnVoltarEtapa1 = document.getElementById("btnVoltarEtapa1");
    const btnAvaliar = document.getElementById("btnAvaliar");
    const btnFinalizar = document.getElementById("btnFinalizar");
    const distanciaRota = document.getElementById("distanciaRota");
    const infoEndereco = document.getElementById("infoEndereco");
    const btnMeasure = document.getElementById("btnMeasure");
    const measureInfoDiv = document.getElementById("measureInfo");
    const measureDistanceSpan = document.getElementById("measureDistance");
    const btnMeasureReset = document.getElementById("btnMeasureReset");
    const campoLatitude = document.getElementById("campoLatitude");
    const campoLongitude = document.getElementById("campoLongitude");
    const resultadoTitulo = document.getElementById("resultadoTitulo");
    const resultadoDescricao = document.getElementById("resultadoDescricao");
    const divCriteriosInfo = document.getElementById("divCritériosInfo");
    const avaliacaoAutomatica = document.getElementById("avaliacaoAutomatica");

    // Exibir/ocultar campo Zona quando Nível = Médio
    campoNivelEnsinoMunicipal.addEventListener("change", () => {
      if (campoNivelEnsinoMunicipal.value === "medio") {
        campoZonaEnsinoContainerMunicipal.style.display = "block";
      } else {
        campoZonaEnsinoContainerMunicipal.style.display = "none";
        campoZonaMunicipal.value = "";
      }
    });
    campoNivelEnsinoEstadual.addEventListener("change", () => {
      if (campoNivelEnsinoEstadual.value === "medio") {
        campoZonaEnsinoContainerEstadual.style.display = "block";
      } else {
        campoZonaEnsinoContainerEstadual.style.display = "none";
        campoZonaEstadual.value = "";
      }
    });

    btnContinuarFluxo.addEventListener("click", async () => {
      if (fluxoMunicipal.checked) {
        tipoFluxoSelecionado = "municipal";
        etapaSelecaoFluxo.classList.remove("active");
        etapa1Municipal.classList.add("active");
      } else if (fluxoEstadual.checked) {
        tipoFluxoSelecionado = "estadual";
        etapaSelecaoFluxo.classList.remove("active");
        etapa1Estadual.classList.add("active");
        await carregarEscolasEstaduais();
      } else {
        alert("Selecione o tipo de fluxo (Municipal ou Estadual).");
      }
    });

    async function carregarEscolasEstaduais() {
      try {
        const response = await fetch("/api/escolas");
        if (!response.ok) throw new Error("Erro ao carregar escolas.");
        const listaEscolas = await response.json();
        const selectEscolaEstadual = document.getElementById("campoEscolaEstadual");
        selectEscolaEstadual.innerHTML = '<option value="">Selecione a Escola</option>';
        listaEscolas.forEach(e => {
          const option = document.createElement("option");
          option.value = e.id;
          option.textContent = e.nome;
          selectEscolaEstadual.appendChild(option);
        });
      } catch (err) {
        console.error("Erro ao buscar escolas:", err);
        alert("Não foi possível carregar a lista de escolas.");
      }
    }

    // MUNICIPAL - BUSCAR
    btnBuscar.addEventListener("click", async () => {
      const valorBusca = inputBusca.value.trim();
      if (!valorBusca) {
        alert("Informe CPF ou ID de Matrícula.");
        return;
      }
      try {
        const resp = await fetch(`/api/alunos_ativos?search=${encodeURIComponent(valorBusca)}`);
        if (!resp.ok) throw new Error("Erro ao buscar aluno.");
        const data = await resp.json();
        if (!data || !data.id_matricula) {
          alert("Nenhum aluno encontrado.");
          return;
        }
        originalData = data;
        alunoIdMunicipal = data.id || null;

        campoIdMatriculaMunicipal.value = data.id_matricula || "";
        campoNomeAlunoMunicipal.value = data.pessoa_nome || "";
        campoEscolaMunicipal.value = data.escola_nome || "";
        campoTurmaMunicipal.value = data.turma || "";
        campoCpfMunicipal.value = data.cpf || "";
        campoCepMunicipal.value = data.cep || "";
        campoRuaMunicipal.value = data.rua || "";
        campoBairroMunicipal.value = data.bairro || "";
        campoNumeroEnderecoMunicipal.value = data.numero_pessoa_endereco || "";
        campoFiliacao1Municipal.value = data.filiacao_1 || "";
        campoTelefoneMunicipal.value = data.numero_telefone || "";
        campoFiliacao2Municipal.value = data.filiacao_2 || "";
        campoResponsavelMunicipal.value = data.responsavel || "";
        if (Array.isArray(data.deficiencia)) {
          campoDeficienciaMunicipal.value = data.deficiencia.join(", ");
        } else if (typeof data.deficiencia === "string") {
          campoDeficienciaMunicipal.value = data.deficiencia;
        } else {
          campoDeficienciaMunicipal.value = "";
        }

        dadosAlunoContainerMunicipal.classList.remove("d-none");
      } catch (err) {
        console.error(err);
        alert("Erro ao buscar aluno.");
      }
    });

    btnConverterCepMunicipal.addEventListener("click", async () => {
      const cepLimpo = campoCepMunicipal.value.replace(/\D/g, "");
      if (!cepLimpo) {
        alert("Informe um CEP válido.");
        return;
      }
      try {
        const r = await fetch(`https://viacep.com.br/ws/${cepLimpo}/json/`);
        if (r.ok) {
          const viacep = await r.json();
          if (!viacep.erro) {
            campoRuaMunicipal.value = viacep.logradouro || campoRuaMunicipal.value;
            campoBairroMunicipal.value = viacep.bairro || campoBairroMunicipal.value;
          } else {
            alert("CEP não encontrado.");
          }
        } else {
          alert("Erro ao consultar ViaCEP.");
        }
      } catch (e) {
        alert("Erro ao converter CEP.");
      }
    });

    btnConverterCepEstadual.addEventListener("click", async () => {
      const cepLimpo = campoCepEstadual.value.replace(/\D/g, "");
      if (!cepLimpo) {
        alert("Informe um CEP válido.");
        return;
      }
      try {
        const r = await fetch(`https://viacep.com.br/ws/${cepLimpo}/json/`);
        if (r.ok) {
          const viacep = await r.json();
          if (!viacep.erro) {
            campoRuaEstadual.value = viacep.logradouro || campoRuaEstadual.value;
            campoBairroEstadual.value = viacep.bairro || campoBairroEstadual.value;
          } else {
            alert("CEP não encontrado.");
          }
        } else {
          alert("Erro ao consultar ViaCEP.");
        }
      } catch (e) {
        alert("Erro ao converter CEP.");
      }
    });

    campoNivelEnsinoMunicipal.addEventListener("change", () => { });
    campoNivelEnsinoEstadual.addEventListener("change", () => { });

    btnProximoMunicipal.addEventListener("click", () => {
      if (!originalData) {
        alert("Nenhum aluno carregado.");
        return;
      }
      etapa1Municipal.classList.remove("active");
      etapa2.classList.add("active");
      setTimeout(() => initMap(), 300);
    });

    btnProximoEstadual.addEventListener("click", async () => {
      const defString = campoDeficienciaEstadual.value.trim();
      let defArray = [];
      if (defString) {
        defArray = defString.split(",").map(s => s.trim()).filter(Boolean);
      }

      const bodyAlunoEstadual = {
        id_matricula: campoIdMatriculaEstadual.value.trim(),
        pessoa_nome: campoNomeAlunoEstadual.value.trim(),
        escola_id: campoEscolaEstadual.value ? parseInt(campoEscolaEstadual.value) : null,
        turma: campoTurmaEstadual.value.trim(),
        turno: campoTurnoEstadual.value.trim(),
        cpf: campoCpfEstadual.value.trim(),
        cep: campoCepEstadual.value.trim(),
        rua: campoRuaEstadual.value.trim(),
        bairro: campoBairroEstadual.value.trim(),
        numero_pessoa_endereco: campoNumeroEnderecoEstadual.value.trim(),
        numero_telefone: campoTelefoneEstadual.value.trim(),
        filiacao_1: campoFiliacao1Estadual.value.trim(),
        filiacao_2: campoFiliacao2Estadual.value.trim(),
        responsavel: campoResponsavelEstadual.value.trim(),
        deficiencia: defArray.length ? defArray : null,
      };
      try {
        const resp = await fetch("/api/alunos-ativos-estadual", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(bodyAlunoEstadual)
        });
        if (!resp.ok) {
          const errorData = await resp.json();
          alert(errorData.message || "Erro ao salvar aluno estadual.");
          return;
        }
        const result = await resp.json();
        alunoIdEstadual = result.id;
        etapa1Estadual.classList.remove("active");
        etapa2.classList.add("active");
        originalData = bodyAlunoEstadual;
        setTimeout(() => initMap(), 300);
      } catch (err) {
        alert("Falha ao cadastrar aluno estadual.");
      }
    });

    btnImprimirConfirmacaoMunicipal.addEventListener("click", () => {
      if (!alunoIdMunicipal) {
        alert("Nenhum aluno carregado para gerar termo.");
        return;
      }
      window.open(`/api/termo-cadastro/${alunoIdMunicipal}/gerar-pdf`, "_blank");
    });

    btnVoltarEtapa1.addEventListener("click", () => {
      etapa2.classList.remove("active");
      if (tipoFluxoSelecionado === "municipal") {
        etapa1Municipal.classList.add("active");
      } else {
        etapa1Estadual.classList.add("active");
      }
    });

    btnAvaliar.addEventListener("click", async () => {
      const distancia = parseFloat(distanciaRota.textContent) || 0;
      let nivelEnsino = "";
      let zona = "";
      let dataNasc = null;
      let def = "";
      let fluxId = null;

      if (tipoFluxoSelecionado === "municipal") {
        nivelEnsino = campoNivelEnsinoMunicipal.value;
        zona = campoZonaMunicipal.value;
        dataNasc = campoDataNascimentoMunicipal.value;
        def = campoDeficienciaMunicipal.value.toLowerCase();
        fluxId = alunoIdMunicipal;
        await salvarAlteracoesMunicipal();
      } else {
        nivelEnsino = campoNivelEnsinoEstadual.value;
        zona = campoZonaEstadual.value;
        dataNasc = campoDataNascimentoEstadual.value;
        def = campoDeficienciaEstadual.value.toLowerCase();
        fluxId = alunoIdEstadual;
        await salvarAlteracoesEstadual(fluxId);
      }

      const resCrit = avaliarCriterios(distancia, nivelEnsino, zona, dataNasc, def);
      avaliacaoAutomatica.textContent = resCrit.motivo;
      setTimeout(async () => {
        etapa2.classList.remove("active");
        etapa3.classList.add("active");
        if (resCrit.aprovado) {
          resultadoTitulo.innerText = "Aluno Aprovado!";
          resultadoTitulo.className = "text-center text-success";
          resultadoDescricao.innerText = "O aluno atende aos critérios ou requer análise manual (deficiência).";
          await criarSolicitacaoTransporte(fluxId, "APROVADO", null, tipoFluxoSelecionado);
          if (tipoFluxoSelecionado === "municipal") {
            window.open(`/api/comprovante-aprovado/${fluxId}/gerar-pdf`, "_blank");
          } else {
            window.open(`/api/comprovante-aprovado-estadual/${fluxId}/gerar-pdf`, "_blank");
          }
        } else {
          resultadoTitulo.innerText = "Não Aprovado";
          resultadoTitulo.className = "text-center text-danger";
          resultadoDescricao.innerText = "O aluno não atende aos critérios estabelecidos.";
          await criarSolicitacaoTransporte(fluxId, "NAO_APROVADO", "Critérios não atendidos", tipoFluxoSelecionado);
          if (tipoFluxoSelecionado === "municipal") {
            window.open(`/api/comprovante-nao-aprovado/${fluxId}/gerar-pdf`, "_blank");
          } else {
            window.open(`/api/comprovante-nao-aprovado-estadual/${fluxId}/gerar-pdf`, "_blank");
          }
        }
      }, 800);
    });

    btnFinalizar.addEventListener("click", () => {
      alert("Atendimento finalizado!");
      location.reload();
    });

    async function salvarAlteracoesMunicipal() {
      if (!alunoIdMunicipal) return false;
      const defString = campoDeficienciaMunicipal.value.trim();
      let defArray = [];
      if (defString) {
        defArray = defString.split(",").map(s => s.trim()).filter(Boolean);
      }
      const mergeBody = {
        cep: campoCepMunicipal.value.trim(),
        bairro: campoBairroMunicipal.value.trim(),
        numero_pessoa_endereco: campoNumeroEnderecoMunicipal.value.trim(),
        numero_telefone: campoTelefoneMunicipal.value.trim(),
        deficiencia: defArray.length ? defArray : null,
        latitude: parseFloat(campoLatitude.value) || null,
        longitude: parseFloat(campoLongitude.value) || null,
        rua: campoRuaMunicipal.value.trim()
      };
      try {
        const resp = await fetch(`/api/alunos-recadastro/${alunoIdMunicipal}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(mergeBody)
        });
        return resp.ok;
      } catch (err) {
        return false;
      }
    }

    async function salvarAlteracoesEstadual(idEstadual) {
      if (!idEstadual) return false;
      const defString = campoDeficienciaEstadual.value.trim();
      let defArray = [];
      if (defString) {
        defArray = defString.split(",").map(s => s.trim()).filter(Boolean);
      }
      const mergeBody = {
        id_matricula: campoIdMatriculaEstadual.value.trim(),
        pessoa_nome: campoNomeAlunoEstadual.value.trim(),
        escola_id: campoEscolaEstadual.value ? parseInt(campoEscolaEstadual.value) : null,
        turma: campoTurmaEstadual.value.trim(),
        turno: campoTurnoEstadual.value.trim(),
        cpf: campoCpfEstadual.value.trim(),
        cep: campoCepEstadual.value.trim(),
        bairro: campoBairroEstadual.value.trim(),
        numero_pessoa_endereco: campoNumeroEnderecoEstadual.value.trim(),
        numero_telefone: campoTelefoneEstadual.value.trim(),
        filiacao_1: campoFiliacao1Estadual.value.trim(),
        filiacao_2: campoFiliacao2Estadual.value.trim(),
        responsavel: campoResponsavelEstadual.value.trim(),
        deficiencia: defArray.length ? defArray : null,
        latitude: parseFloat(campoLatitude.value) || null,
        longitude: parseFloat(campoLongitude.value) || null,
        rua: campoRuaEstadual.value.trim()
      };
      try {
        const resp = await fetch(`/api/alunos-ativos-estadual/${idEstadual}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(mergeBody)
        });
        return resp.ok;
      } catch (err) {
        return false;
      }
    }

    async function criarSolicitacaoTransporte(alunoId, status, motivo, fluxo) {
      try {
        const bodyReq = {
          aluno_id: alunoId,
          status: status,
          motivo: motivo,
          tipo_fluxo: fluxo
        };
        const resp = await fetch("/api/solicitacoes-transporte", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(bodyReq),
        });
        return resp.ok;
      } catch (error) {
        return false;
      }
    }

    function avaliarCriterios(distanciaKm, nivel, zona, dataNascimento, def) {
      if (!dataNascimento) {
        return { aprovado: false, motivo: "Data de nascimento não informada" };
      }
      // Verifica idade no dia 31/03 do ano corrente
      const hoje = new Date();
      const anoAtual = hoje.getFullYear();
      const dataLimite = new Date(anoAtual, 2, 31); // 31 de março
      const nascimento = new Date(dataNascimento);
      let idade = anoAtual - nascimento.getFullYear();
      const mesDiaNasc = `${nascimento.getMonth()}-${nascimento.getDate()}`;
      const mesDiaLimite = `${dataLimite.getMonth()}-${dataLimite.getDate()}`;
      if (mesDiaNasc > mesDiaLimite) {
        idade = idade - 1;
      }

      // Regra de 4 anos completos até 31/03
      if (idade < 4) {
        return { aprovado: false, motivo: `Aluno com ${idade} anos (não completou 4 até 31/03)` };
      }

      // Se deficiência física, passar para avaliação manual
      if (def.includes("física")) {
        return { aprovado: true, motivo: "Deficiência física => Avaliação manual, mas liberado provisoriamente" };
      }

      // Níveis
      // Infantil => min 1.6km
      // Fundamental => min 2.1km
      // Médio => somente se zona = rural, e usar 2.1km como base
      if (nivel === "infantil") {
        if (distanciaKm < 1.6) {
          return { aprovado: false, motivo: "Distância menor que 1.6km para Infantil" };
        }
        return { aprovado: true, motivo: "Distância atende (Infantil)" };
      } else if (nivel === "fundamental") {
        if (distanciaKm < 2.1) {
          return { aprovado: false, motivo: "Distância menor que 2.1km para Fundamental" };
        }
        return { aprovado: true, motivo: "Distância atende (Fundamental)" };
      } else if (nivel === "medio") {
        if (!zona) {
          return { aprovado: false, motivo: "Zona não informada para o Ensino Médio" };
        }
        if (zona === "urbana") {
          return { aprovado: false, motivo: "Ensino Médio somente para zona rural" };
        }
        // Se zona = rural, checar 2.1km
        if (distanciaKm < 2.1) {
          return { aprovado: false, motivo: "Distância menor que 2.1km (Médio - Rural)" };
        }
        return { aprovado: true, motivo: "Distância atende (Médio - Rural)" };
      } else {
        return { aprovado: false, motivo: "Nível de ensino não especificado corretamente" };
      }
    }

    async function initMap() {
      if (!map) {
        map = new google.maps.Map(document.getElementById("mapCriterios"), {
          center: { lat: -6.530066, lng: -49.85163 },
          zoom: 14,
          mapTypeId: google.maps.MapTypeId.HYBRID
        });
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
          map: map,
          suppressMarkers: true,
          polylineOptions: {
            strokeColor: "#0000FF",
            strokeOpacity: 0.7,
            strokeWeight: 5
          }
        });
      }

      distanciaRota.textContent = "--";
      let endAluno = "";
      let latAluno = null;
      let lngAluno = null;
      let escolaNome = "";
      let latEscola = null;
      let lngEscola = null;

      if (tipoFluxoSelecionado === "municipal") {
        latAluno = originalData?.latitude || null;
        lngAluno = originalData?.longitude || null;
        escolaNome = originalData?.escola_nome || "";
        if (campoRuaMunicipal.value.trim()) {
          endAluno = `${campoRuaMunicipal.value}, ${campoNumeroEnderecoMunicipal.value}, Canaã dos Carajás, Pará, Brasil`;
        } else {
          endAluno = `${campoCepMunicipal.value}, ${campoNumeroEnderecoMunicipal.value}, Canaã dos Carajás, Pará, Brasil`;
        }
      } else {
        const selectEscola = campoEscolaEstadual;
        const selectedOption = selectEscola.options[selectEscola.selectedIndex];
        escolaNome = selectedOption ? selectedOption.textContent : "";
        if (campoRuaEstadual.value.trim()) {
          endAluno = `${campoRuaEstadual.value}, ${campoNumeroEnderecoEstadual.value}, Canaã dos Carajás, Pará, Brasil`;
        } else {
          endAluno = `${campoCepEstadual.value}, ${campoNumeroEnderecoEstadual.value}, Canaã dos Carajás, Pará, Brasil`;
        }
      }
      infoEndereco.innerText = endAluno;

      try {
        const escolaResp = await fetch(`/api/escola-coordenadas?nome_escola=${encodeURIComponent(escolaNome)}`);
        const escolaJson = await escolaResp.json();
        if (escolaJson && escolaJson.latitude && escolaJson.longitude) {
          latEscola = parseFloat(escolaJson.latitude);
          lngEscola = parseFloat(escolaJson.longitude);
        } else {
          alert("Não foi possível localizar a escola pelo nome informado.");
        }
      } catch (err) {
        console.error("Erro ao buscar coordenadas da escola:", err);
      }
      if (latEscola && lngEscola) {
        escolaPos = new google.maps.LatLng(latEscola, lngEscola);
      } else {
        escolaPos = new google.maps.LatLng(-6.530066, -49.85163);
      }

      if (tipoFluxoSelecionado === "municipal") {
        if (latAluno && lngAluno) {
          alunoPos = new google.maps.LatLng(parseFloat(latAluno), parseFloat(lngAluno));
          createOrMoveMarkers();
        } else {
          geocodeAndCreateMarker(endAluno, escolaPos);
        }
      } else {
        geocodeAndCreateMarker(endAluno, escolaPos);
      }

      google.maps.event.addListener(map, "click", (e) => {
        if (!markerAluno) {
          markerAluno = new google.maps.Marker({
            position: e.latLng,
            map: map,
            icon: {
              url: "https://maps.google.com/mapfiles/kml/shapes/man.png",
              scaledSize: new google.maps.Size(30, 30)
            },
            draggable: true
          });
          markerAluno.addListener("dragend", () => {
            const pos = markerAluno.getPosition();
            campoLatitude.value = pos.lat().toFixed(6);
            campoLongitude.value = pos.lng().toFixed(6);
            calcularRota(pos, escolaPos);
          });
        } else {
          markerAluno.setPosition(e.latLng);
        }
        campoLatitude.value = e.latLng.lat().toFixed(6);
        campoLongitude.value = e.latLng.lng().toFixed(6);
        calcularRota(e.latLng, escolaPos);
      });
    }

    function geocodeAndCreateMarker(endereco, escolaPos) {
      const geocoder = new google.maps.Geocoder();
      geocoder.geocode({ address: endereco }, (results, status) => {
        if (status === "OK") {
          alunoPos = results[0].geometry.location;
          campoLatitude.value = alunoPos.lat().toFixed(6);
          campoLongitude.value = alunoPos.lng().toFixed(6);
          createOrMoveMarkers();
        } else {
          alert("Não foi possível localizar o endereço do aluno via Geocoder.");
          map.setCenter(escolaPos);
        }
      });
    }

    function createOrMoveMarkers() {
      if (!markerAluno) {
        markerAluno = new google.maps.Marker({
          position: alunoPos,
          map: map,
          icon: {
            url: "https://maps.google.com/mapfiles/kml/shapes/man.png",
            scaledSize: new google.maps.Size(30, 30)
          },
          draggable: true
        });
        markerAluno.addListener("dragend", () => {
          const pos = markerAluno.getPosition();
          campoLatitude.value = pos.lat().toFixed(6);
          campoLongitude.value = pos.lng().toFixed(6);
          calcularRota(pos, escolaPos);
        });
      } else {
        markerAluno.setPosition(alunoPos);
      }
      if (!markerEscola) {
        markerEscola = new google.maps.Marker({
          position: escolaPos,
          map: map,
          icon: "https://maps.google.com/mapfiles/kml/pal3/icon56.png"
        });
      } else {
        markerEscola.setPosition(escolaPos);
      }
      map.setCenter(alunoPos);
      calcularRota(alunoPos, escolaPos);
    }

    function calcularRota(aPos, ePos) {
      const request = {
        origin: aPos,
        destination: ePos,
        travelMode: google.maps.TravelMode.WALKING
      };
      directionsService.route(request, (result, status) => {
        if (status === "OK") {
          directionsRenderer.setDirections(result);
          const distanceMeters = result.routes[0].legs[0].distance.value;
          const distanceKm = (distanceMeters / 1000).toFixed(2);
          distanciaRota.textContent = distanceKm;
        } else {
          distanciaRota.textContent = "--";
        }
      });
    }

    btnMeasure.addEventListener("click", () => {
      measureActive = !measureActive;
      if (measureActive) {
        btnMeasure.textContent = "Desativar Medição";
        measureInfoDiv.classList.remove("d-none");
        startMeasureMode();
      } else {
        btnMeasure.textContent = "Medir Distância Manual";
        measureInfoDiv.classList.add("d-none");
        endMeasureMode();
      }
    });

    btnMeasureReset.addEventListener("click", () => {
      measurePoints = [];
      measureDistanceSpan.textContent = "0";
      if (measurePolyline) {
        measurePolyline.setMap(null);
        measurePolyline = null;
      }
    });

    function startMeasureMode() {
      if (!map) return;
      measurePoints = [];
      measureDistanceSpan.textContent = "0";
      measurePolyline = new google.maps.Polyline({
        map: map,
        path: measurePoints,
        strokeColor: "#FF0000",
        strokeOpacity: 1.0,
        strokeWeight: 3
      });
      mapClickListener = map.addListener("click", (e) => {
        measurePoints.push(e.latLng);
        measurePolyline.setPath(measurePoints);
        let totalDist = 0;
        for (let i = 0; i < measurePoints.length - 1; i++) {
          const segDist = google.maps.geometry.spherical.computeDistanceBetween(
            measurePoints[i],
            measurePoints[i + 1]
          );
          totalDist += segDist;
        }
        measureDistanceSpan.textContent = (totalDist / 1000).toFixed(3);
      });
    }

    function endMeasureMode() {
      if (mapClickListener) {
        google.maps.event.removeListener(mapClickListener);
        mapClickListener = null;
      }
      if (measurePolyline) {
        measurePolyline.setMap(null);
        measurePolyline = null;
      }
    }
  </script>
</body>

</html>