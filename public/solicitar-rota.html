<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Consulta de Aluno</title>
  <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport" />
  <link rel="icon" href="../../assets/img/pydenadmin/favicon.png" type="image/x-icon" />

  <script src="../../assets/js/plugin/webfont/webfont.min.js"></script>
  <script>
    WebFont.load({
      google: { families: ["Public Sans:300,400,500,600,700"] },
      custom: {
        families: ["Font Awesome 5 Solid", "Font Awesome 5 Regular", "Font Awesome 5 Brands", "simple-line-icons"],
        urls: ["../../assets/css/fonts.min.css"]
      },
      active: function () {
        sessionStorage.fonts = true;
      }
    });
  </script>

  <link rel="stylesheet" href="../../assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="../../assets/css/plugins.min.css" />
  <link rel="stylesheet" href="../../assets/css/pydenadmin.min.css" />
  <link rel="stylesheet" href="../../assets/css/demo.css" />

  <style>
    #mapCriterios {
      width: 100%;
      height: 400px;
    }

    #measureInfo {
      margin-top: 10px;
      font-weight: 600;
      font-size: 0.9rem;
      color: #444;
    }
  </style>
</head>

<body>
  <div class="container my-4">
    <div class="page-inner">
      <div class="page-header">
        <h3 class="fw-bold mb-12 center">Cadastro de Alunos</h3>
      </div>

      <div class="row">
        <div class="col-md-12">

          <div class="card">
            <div class="card-header">
              <div class="card-title">Consulta de Aluno</div>
            </div>
            <div class="card-body">
              <div class="row justify-content-center">
                <div class="col-md-6 text-center">
                  <label for="inputBusca" class="form-label">
                    CPF ou ID de Matrícula
                  </label>
                  <input type="text" class="form-control mx-auto" style="max-width: 300px;" id="inputBusca"
                    placeholder="Digite aqui..." />
                  <button id="btnBuscar" class="btn btn-primary mt-3">Buscar</button>
                </div>
              </div>
              <div class="row justify-content-center mt-4">
                <div class="col-md-10">
                  <div class="d-none" id="dadosAlunoContainer">

                    <div class="row">
                      <div class="col-md-6 mb-2">
                        <label class="form-label fw-semibold">ID Matrícula</label>
                        <input type="text" class="form-control" id="campoIdMatricula" />
                      </div>
                      <div class="col-md-6 mb-2">
                        <label class="form-label fw-semibold">Nome do Aluno</label>
                        <input type="text" class="form-control" id="campoNomeAluno" />
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-md-6 mb-2">
                        <label class="form-label fw-semibold">Escola</label>
                        <input type="text" class="form-control" id="campoEscola" readonly />
                      </div>
                      <div class="col-md-6 mb-2">
                        <label class="form-label fw-semibold">Turma</label>
                        <input type="text" class="form-control" id="campoTurma" />
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-md-6 mb-2">
                        <label class="form-label fw-semibold">CPF</label>
                        <input type="text" class="form-control" id="campoCpf" />
                      </div>
                      <div class="col-md-6 mb-2">
                        <label class="form-label fw-semibold">CEP</label>
                        <input type="text" class="form-control" id="campoCep" />
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-md-6 mb-2">
                        <label class="form-label fw-semibold">Rua</label>
                        <input type="text" class="form-control" id="campoRua" />
                      </div>
                      <div class="col-md-6 mb-2">
                        <label class="form-label fw-semibold">Bairro</label>
                        <input type="text" class="form-control" id="campoBairro" />
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-md-6 mb-2">
                        <label class="form-label fw-semibold">Número Endereço</label>
                        <input type="text" class="form-control" id="campoNumeroEndereco" />
                      </div>
                      <div class="col-md-6 mb-2">
                        <label class="form-label fw-semibold">Telefone</label>
                        <input type="text" class="form-control" id="campoTelefone" />
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-md-6 mb-2">
                        <label class="form-label fw-semibold">Filiação 1</label>
                        <input type="text" class="form-control" id="campoFiliacao1" />
                      </div>
                      <div class="col-md-6 mb-2">
                        <label class="form-label fw-semibold">Filiação 2</label>
                        <input type="text" class="form-control" id="campoFiliacao2" />
                      </div>
                    </div>

                    <div class="row">
                      <div class="col-md-6 mb-2">
                        <label class="form-label fw-semibold">Responsável</label>
                        <input type="text" class="form-control" id="campoResponsavel" />
                      </div>
                      <div class="col-md-6 mb-2">
                        <label class="form-label fw-semibold">Deficiência</label>
                        <input type="text" class="form-control" id="campoDeficiencia" />
                      </div>
                    </div>

                    <div class="d-flex justify-content-between mt-3">
                      <button class="btn btn-secondary" id="verificarCriterios">Verificar Critérios</button>
                      <button class="btn btn-success" id="btnSalvarAluno">Salvar Alterações</button>
                    </div>

                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Modal Mapa -->
          <div class="modal fade" id="modalMapaCriterios" tabindex="-1" aria-labelledby="modalMapaCriteriosLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="modalMapaCriteriosLabel">Mapa e Distância</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div id="infoEndereco" style="margin-bottom:10px; font-size:0.95rem; font-weight:600;"></div>
                  <div id="mapCriterios"></div>
                  <div class="mt-3">
                    <strong>Distância (rota):</strong>
                    <span id="distanciaRota">--</span>
                    <span>km</span>
                  </div>
                  <div class="mt-2">
                    <button id="btnMeasure" class="btn btn-sm btn-warning">Medir Distância Manual</button>
                    <div id="measureInfo" class="d-none">
                      <span>Medição manual: <span id="measureDistance">0</span> km</span>
                      <button id="btnMeasureReset" class="btn btn-sm btn-outline-danger">Reset</button>
                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    Fechar
                  </button>
                </div>
              </div>
            </div>
          </div>
          <!-- Fim Modal Mapa -->

        </div>
      </div>
    </div>
  </div>

  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCAwvAt4l0Pkb1c52FLUE-ttVxm4YZ9J8M&libraries=places,geometry"></script>
  <script src="../../assets/js/core/jquery-3.7.1.min.js"></script>
  <script src="../../assets/js/core/popper.min.js"></script>
  <script src="../../assets/js/core/bootstrap.min.js"></script>
  <script src="../../assets/js/plugin/bootstrap-notify/bootstrap-notify.min.js"></script>
  <script src="../../assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
  <script src="../../assets/js/pydenadmin.min.js"></script>

  <script>
    let alunoData = null;
    let map, directionsService, directionsRenderer;
    let markerAluno, markerEscola;
    let escolaPos, alunoPos;
    let measureActive = false;
    let measurePoints = [];
    let measurePolyline = null;

    const btnBuscar = document.getElementById("btnBuscar");
    const inputBusca = document.getElementById("inputBusca");
    const dadosAlunoContainer = document.getElementById("dadosAlunoContainer");
    const verificarCriterios = document.getElementById("verificarCriterios");
    const modalMapaCriterios = new bootstrap.Modal(document.getElementById("modalMapaCriterios"));
    const distanciaRota = document.getElementById("distanciaRota");
    const infoEndereco = document.getElementById("infoEndereco");
    const btnMeasure = document.getElementById("btnMeasure");
    const measureInfoDiv = document.getElementById("measureInfo");
    const measureDistanceSpan = document.getElementById("measureDistance");
    const btnMeasureReset = document.getElementById("btnMeasureReset");

    const campoIdMatricula = document.getElementById("campoIdMatricula");
    const campoNomeAluno = document.getElementById("campoNomeAluno");
    const campoEscola = document.getElementById("campoEscola");
    const campoTurma = document.getElementById("campoTurma");
    const campoCpf = document.getElementById("campoCpf");
    const campoCep = document.getElementById("campoCep");
    const campoRua = document.getElementById("campoRua");
    const campoBairro = document.getElementById("campoBairro");
    const campoNumeroEndereco = document.getElementById("campoNumeroEndereco");
    const campoFiliacao1 = document.getElementById("campoFiliacao1");
    const campoTelefone = document.getElementById("campoTelefone");
    const campoFiliacao2 = document.getElementById("campoFiliacao2");
    const campoResponsavel = document.getElementById("campoResponsavel");
    const campoDeficiencia = document.getElementById("campoDeficiencia");
    const btnSalvarAluno = document.getElementById("btnSalvarAluno");

    let alunoLatitude = null;
    let alunoLongitude = null;
    let alunoId = null;
    let oldAno = null;
    let oldModalidade = null;
    let oldFormatoLetivo = null;
    let oldTranspEscolar = null;
    let oldEscolaId = null;

    btnBuscar.addEventListener("click", async () => {
      const valorBusca = inputBusca.value.trim();
      if (!valorBusca) {
        alert("Por favor, informe o CPF ou o ID de Matrícula.");
        return;
      }
      try {
        const resp = await fetch(`/api/alunos_ativos?search=${encodeURIComponent(valorBusca)}`);
        if (!resp.ok) throw new Error("Erro ao buscar aluno");
        const data = await resp.json();
        if (!data || !data.id_matricula) {
          alert("Nenhum aluno encontrado para o valor informado.");
          return;
        }
        alunoData = data;
        alunoId = data.id;

        campoIdMatricula.value = data.id_matricula || "";
        campoNomeAluno.value = data.pessoa_nome || "";
        campoEscola.value = data.escola_nome || "";
        campoTurma.value = data.turma || "";
        campoCpf.value = data.cpf || "";
        campoCep.value = data.cep || "";
        campoBairro.value = data.bairro || "";
        campoNumeroEndereco.value = data.numero_pessoa_endereco || "";
        campoFiliacao1.value = data.filiacao_1 || "";
        campoTelefone.value = data.numero_telefone || "";
        campoFiliacao2.value = data.filiacao_2 || "";
        campoResponsavel.value = data.responsavel || "";
        campoDeficiencia.value = Array.isArray(data.deficiencia)
          ? data.deficiencia.join(", ")
          : data.deficiencia || "";

        alunoLatitude = data.latitude || null;
        alunoLongitude = data.longitude || null;
        campoRua.value = "";

        oldAno = data.ano || null;
        oldModalidade = data.modalidade || null;
        oldFormatoLetivo = data.formato_letivo || null;
        oldTranspEscolar = data.transporte_escolar_poder_publico || null;
        oldEscolaId = data.escola_id || null;

        dadosAlunoContainer.classList.remove("d-none");
      } catch (err) {
        console.error(err);
        alert("Ocorreu um erro ao buscar os dados do aluno.");
      }
    });

    verificarCriterios.addEventListener("click", async () => {
      if (!alunoData) return;
      if (campoCep.value.trim() && !campoRua.value.trim()) {
        try {
          const cepLimpo = campoCep.value.replace(/\D/g, "");
          if (cepLimpo) {
            const r = await fetch(`https://viacep.com.br/ws/${cepLimpo}/json/`);
            if (r.ok) {
              const viacep = await r.json();
              if (!viacep.erro) {
                campoRua.value = viacep.logradouro || "";
                campoBairro.value = viacep.bairro || "";
              }
            }
          }
        } catch { }
      }
      modalMapaCriterios.show();
      setTimeout(() => {
        initMap();
      }, 500);
    });

    async function initMap() {
      if (!map) {
        map = new google.maps.Map(document.getElementById("mapCriterios"), {
          center: { lat: -6.530066, lng: -49.85163 },
          zoom: 14,
          mapTypeId: google.maps.MapTypeId.HYBRID
        });
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
          map: map,
          suppressMarkers: true,
          polylineOptions: {
            strokeColor: "#0000FF",
            strokeOpacity: 0.7,
            strokeWeight: 5
          }
        });
      }
      distanciaRota.textContent = "--";

      const escolaResp = await fetch(`/api/escola-coordenadas?nome_escola=${encodeURIComponent(campoEscola.value)}`);
      const escolaJson = await escolaResp.json();
      if (!escolaJson || !escolaJson.longitude || !escolaJson.latitude) {
        alert("Não foi possível localizar a escola.");
        return;
      }
      escolaPos = new google.maps.LatLng(escolaJson.latitude, escolaJson.longitude);

      let enderecoCompleto;
      if (campoRua.value.trim()) {
        enderecoCompleto = `${campoRua.value}, ${campoBairro.value}, ${campoNumeroEndereco.value}, Canaã dos Carajás, Pará, Brasil`;
      } else {
        enderecoCompleto = `${campoCep.value}, ${campoBairro.value}, ${campoNumeroEndereco.value}, Canaã dos Carajás, Pará, Brasil`;
      }
      infoEndereco.innerText = `Endereço do Aluno: ${enderecoCompleto}`;

      const geocoder = new google.maps.Geocoder();
      if (alunoLatitude && alunoLongitude) {
        alunoPos = new google.maps.LatLng(parseFloat(alunoLatitude), parseFloat(alunoLongitude));
        createOrMoveMarkers();
      } else {
        geocoder.geocode({ address: enderecoCompleto }, (results, status) => {
          if (status === "OK") {
            alunoPos = results[0].geometry.location;
            createOrMoveMarkers();
          } else {
            alert("Não foi possível localizar o endereço do aluno via Geocoder.");
          }
        });
      }
    }

    function createOrMoveMarkers() {
      if (!markerAluno) {
        markerAluno = new google.maps.Marker({
          position: alunoPos,
          map: map,
          icon: {
            url: "https://maps.google.com/mapfiles/kml/shapes/man.png",
            scaledSize: new google.maps.Size(30, 30)
          },
          draggable: true
        });
        markerAluno.addListener("dragend", () => {
          alunoPos = markerAluno.getPosition();
          alunoLatitude = alunoPos.lat();
          alunoLongitude = alunoPos.lng();
          calcularRota(alunoPos, escolaPos);
        });
      } else {
        markerAluno.setPosition(alunoPos);
      }
      if (!markerEscola) {
        markerEscola = new google.maps.Marker({
          position: escolaPos,
          map: map,
          icon: "https://maps.google.com/mapfiles/kml/pal3/icon56.png"
        });
      } else {
        markerEscola.setPosition(escolaPos);
      }
      map.setCenter(alunoPos);
      calcularRota(alunoPos, escolaPos);
    }

    function calcularRota(aPos, ePos) {
      const request = {
        origin: aPos,
        destination: ePos,
        travelMode: google.maps.TravelMode.WALKING
      };
      directionsService.route(request, (result, status) => {
        if (status === "OK") {
          directionsRenderer.setDirections(result);
          const distanceMeters = result.routes[0].legs[0].distance.value;
          const distanceKm = (distanceMeters / 1000).toFixed(2);
          distanciaRota.textContent = distanceKm;
        } else {
          distanciaRota.textContent = "--";
        }
      });
    }

    btnMeasure.addEventListener("click", () => {
      measureActive = !measureActive;
      if (measureActive) {
        btnMeasure.textContent = "Desativar Medição";
        measureInfoDiv.classList.remove("d-none");
        startMeasureMode();
      } else {
        btnMeasure.textContent = "Medir Distância Manual";
        measureInfoDiv.classList.add("d-none");
        endMeasureMode();
      }
    });

    btnMeasureReset.addEventListener("click", () => {
      measurePoints = [];
      measureDistanceSpan.textContent = "0";
      if (measurePolyline) {
        measurePolyline.setMap(null);
        measurePolyline = null;
      }
    });

    let mapClickListener = null;
    function startMeasureMode() {
      if (!map) return;
      measurePoints = [];
      measureDistanceSpan.textContent = "0";
      measurePolyline = new google.maps.Polyline({
        map: map,
        path: measurePoints,
        strokeColor: "#FF0000",
        strokeOpacity: 1.0,
        strokeWeight: 3
      });
      mapClickListener = map.addListener("click", (e) => {
        measurePoints.push(e.latLng);
        measurePolyline.setPath(measurePoints);
        let totalDist = 0;
        for (let i = 0; i < measurePoints.length - 1; i++) {
          const segDist = google.maps.geometry.spherical.computeDistanceBetween(
            measurePoints[i],
            measurePoints[i + 1]
          );
          totalDist += segDist;
        }
        const kmDist = (totalDist / 1000).toFixed(3);
        measureDistanceSpan.textContent = kmDist;
      });
    }
    function endMeasureMode() {
      if (mapClickListener) {
        google.maps.event.removeListener(mapClickListener);
        mapClickListener = null;
      }
    }

    btnSalvarAluno.addEventListener("click", async () => {
      if (!alunoId) {
        alert("Nenhum aluno carregado.");
        return;
      }
      const defString = campoDeficiencia.value.trim();
      let defArray = [];
      if (defString) {
        defArray = defString.split(",").map(s => s.trim()).filter(Boolean);
      }
      const body = {
        id_matricula: campoIdMatricula.value.trim() || null,
        escola_id: oldEscolaId || null,
        ano: oldAno || null,
        modalidade: oldModalidade || null,
        formato_letivo: oldFormatoLetivo || null,
        turma: campoTurma.value.trim() || null,
        pessoa_nome: campoNomeAluno.value.trim() || null,
        cpf: campoCpf.value.trim() || null,
        transporte_escolar_poder_publico: oldTranspEscolar || null,
        cep: campoCep.value.trim() || null,
        bairro: campoBairro.value.trim() || null,
        numero_pessoa_endereco: campoNumeroEndereco.value.trim() || null,
        filiacao_1: campoFiliacao1.value.trim() || null,
        numero_telefone: campoTelefone.value.trim() || null,
        filiacao_2: campoFiliacao2.value.trim() || null,
        responsavel: campoResponsavel.value.trim() || null,
        deficiencia: defArray,
        latitude: alunoLatitude || null,
        longitude: alunoLongitude || null,
        rua: campoRua.value.trim() || null
      };
      try {
        const resp = await fetch(`/api/alunos-ativos/${alunoId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
        const result = await resp.json();
        if (!resp.ok) {
          alert(result.message || "Falha ao salvar alterações.");
          return;
        }
        alert("Dados do aluno atualizados com sucesso!");
      } catch (err) {
        console.error(err);
        alert("Erro ao atualizar dados do aluno.");
      }
    });
  </script>
</body>

</html>