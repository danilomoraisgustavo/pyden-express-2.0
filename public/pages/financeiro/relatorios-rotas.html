<!-- FRONTEND COMPLETO (ATUALIZADO) -->
<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Listar Relatórios de Rotas - pydenadmin Bootstrap 5 Admin Dashboard</title>
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport" />
    <link rel="icon" href="../../assets/img/pydenadmin/favicon.png" type="image/x-icon" />
    <script src="../../assets/js/plugin/webfont/webfont.min.js"></script>
    <script>
        WebFont.load({
            google: { families: ["Public Sans:300,400,500,600,700"] },
            custom: {
                families: [
                    "Font Awesome 5 Solid",
                    "Font Awesome 5 Regular",
                    "Font Awesome 5 Brands",
                    "simple-line-icons",
                ],
                urls: ["../../assets/css/fonts.min.css"],
            },
            active: function () {
                sessionStorage.fonts = true;
            },
        });
    </script>
    <link rel="stylesheet" href="../../assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="../../assets/css/plugins.min.css" />
    <link rel="stylesheet" href="../../assets/css/pydenadmin.min.css" />
    <link rel="stylesheet" href="../../assets/css/demo.css" />
    <style>
        .required-label::after {
            content: " *";
            color: red;
        }

        .modal-lg {
            max-width: 90% !important;
        }
    </style>
</head>

<body>
    <div class="wrapper">
        <!-- SIDEBAR -->
        <!-- ... (omitir código da sidebar, se necessário) ... -->
        <!-- END SIDEBAR -->

        <div class="main-panel">
            <!-- ... (omitir código de cabeçalho, se necessário) ... -->
            <div class="container">
                <div class="page-inner">
                    <div class="page-header">
                        <h3 class="fw-bold mb-3">Listar Relatórios de Rotas</h3>
                        <ul class="breadcrumbs mb-3">
                            <li class="nav-home">
                                <a href="../../">
                                    <i class="icon-home"></i>
                                </a>
                            </li>
                            <li class="separator">
                                <i class="icon-arrow-right"></i>
                            </li>
                            <li class="nav-item">
                                <a href="#">Relatórios</a>
                            </li>
                            <li class="separator">
                                <i class="icon-arrow-right"></i>
                            </li>
                            <li class="nav-item">
                                <a href="#">Listar Relatórios de Rotas</a>
                            </li>
                        </ul>
                    </div>

                    <!-- Tabela de Relatórios de Rotas -->
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between">
                                    <h4 class="card-title">Lista de Relatórios de Rotas</h4>
                                    <button class="btn btn-primary" data-bs-toggle="modal"
                                        data-bs-target="#modalNovoRelatorio">
                                        <i class="fa fa-plus"></i> Criar Novo Relatório
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table id="relatorios-rotas-table"
                                            class="display table table-striped table-hover">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Rota</th>
                                                    <th>Empresa Responsável</th>
                                                    <th>Data</th>
                                                    <th>Ações</th>
                                                </tr>
                                            </thead>
                                            <tfoot>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Rota</th>
                                                    <th>Empresa Responsável</th>
                                                    <th>Data</th>
                                                    <th>Ações</th>
                                                </tr>
                                            </tfoot>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Modal Novo Relatório -->
                    <div class="modal fade" id="modalNovoRelatorio" tabindex="-1"
                        aria-labelledby="modalNovoRelatorioLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg modal-dialog-scrollable">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="modalNovoRelatorioLabel">Criar Novo Relatório</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Fechar"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="relatorio-rotas-form" enctype="multipart/form-data">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="rota" class="form-label required-label">Rota</label>
                                                <input type="text" id="rota" name="rota" class="form-control"
                                                    required />
                                            </div>
                                            <div class="col-md-6">
                                                <label for="empresa_responsavel"
                                                    class="form-label required-label">Empresa Responsável</label>
                                                <input type="text" id="empresa_responsavel" name="empresa_responsavel"
                                                    class="form-control" required />
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-12">
                                                <label for="corpo_relatorio" class="form-label required-label">Corpo do
                                                    Relatório</label>
                                                <textarea id="corpo_relatorio" name="corpo_relatorio"
                                                    class="form-control" rows="4" required></textarea>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="imagens" class="form-label">Imagens (opcional)</label>
                                                <input type="file" id="imagens" name="imagens[]" class="form-control"
                                                    multiple accept="image/*" />
                                            </div>
                                            <div class="col-md-6">
                                                <label for="videos" class="form-label">Vídeos (opcional)</label>
                                                <input type="file" id="videos" name="videos[]" class="form-control"
                                                    multiple accept="video/*" />
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-12">
                                                <label for="pdfs" class="form-label">PDFs (opcional)</label>
                                                <input type="file" id="pdfs" name="pdfs[]" class="form-control" multiple
                                                    accept="application/pdf" />
                                            </div>
                                        </div>
                                        <div class="mt-4">
                                            <button type="submit" class="btn btn-success">Gerar Relatório</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Fim Modal Novo Relatório -->

                    <!-- Modal Editar Relatório -->
                    <div class="modal fade" id="modalEditarRelatório" tabindex="-1"
                        aria-labelledby="modalEditarRelatorioLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg modal-dialog-scrollable">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="modalEditarRelatorioLabel">Editar Relatório</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                        aria-label="Fechar"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="editar-relatorio-rotas-form" enctype="multipart/form-data">
                                        <input type="hidden" id="editar_relatorio_id" name="editar_relatorio_id" />

                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="editar_rota" class="form-label required-label">Rota</label>
                                                <input type="text" id="editar_rota" name="editar_rota"
                                                    class="form-control" required />
                                            </div>
                                            <div class="col-md-6">
                                                <label for="editar_empresa_responsavel"
                                                    class="form-label required-label">Empresa Responsável</label>
                                                <input type="text" id="editar_empresa_responsavel"
                                                    name="editar_empresa_responsavel" class="form-control" required />
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-12">
                                                <label for="editar_corpo_relatorio"
                                                    class="form-label required-label">Corpo do Relatório</label>
                                                <textarea id="editar_corpo_relatorio" name="editar_corpo_relatorio"
                                                    class="form-control" rows="4" required></textarea>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="editar_imagens" class="form-label">Adicionar/Alterar Imagens
                                                    (opcional)</label>
                                                <input type="file" id="editar_imagens" name="editar_imagens[]"
                                                    class="form-control" multiple accept="image/*" />
                                            </div>
                                            <div class="col-md-6">
                                                <label for="editar_videos" class="form-label">Adicionar/Alterar Vídeos
                                                    (opcional)</label>
                                                <input type="file" id="editar_videos" name="editar_videos[]"
                                                    class="form-control" multiple accept="video/*" />
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-12">
                                                <label for="editar_pdfs" class="form-label">Adicionar/Alterar PDFs
                                                    (opcional)</label>
                                                <input type="file" id="editar_pdfs" name="editar_pdfs[]"
                                                    class="form-control" multiple accept="application/pdf" />
                                            </div>
                                        </div>
                                        <div class="mt-4">
                                            <button type="submit" class="btn btn-success">Salvar Alterações</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Fim Modal Editar Relatório -->
                </div>
            </div>

            <!-- FOOTER -->
            <!-- ... (omitir código do footer, se necessário) ... -->
        </div>
    </div>

    <script src="../../assets/js/core/jquery-3.7.1.min.js"></script>
    <script src="../../assets/js/core/popper.min.js"></script>
    <script src="../../assets/js/core/bootstrap.min.js"></script>
    <script src="../../assets/js/usuario.js"></script>
    <script src="../../assets/js/plugin/bootstrap-notify/bootstrap-notify.min.js"></script>
    <script src="../../assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
    <script src="../../assets/js/plugin/datatables/datatables.min.js"></script>
    <script src="../../assets/js/pydenadmin.min.js"></script>
    <script src="../../assets/js/setting-demo2.js"></script>
    <script>
        let relatoriosRotas = [];

        function showNotification(type, message, title = "") {
            $.notify({
                title: title ? title + ' ' : '',
                message: message,
                icon:
                    type === 'success' ? 'fa fa-check-circle' :
                        type === 'danger' ? 'fa fa-exclamation-circle' :
                            type === 'warning' ? 'fa fa-exclamation-triangle' :
                                type === 'info' ? 'fa fa-info-circle' : ''
            }, {
                type: type,
                placement: { from: "top", align: "right" },
                offset: 20, spacing: 10, z_index: 1031, delay: 3000, timer: 1000,
                animate: { enter: 'animated fadeInDown', exit: 'animated fadeOutUp' }
            });
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const d = new Date(dateStr);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear();
            const hours = String(d.getHours()).padStart(2, '0');
            const minutes = String(d.getMinutes()).padStart(2, '0');
            return `${day}-${month}-${year} ${hours}:${minutes}`;
        }

        function loadRelatoriosRotas() {
            fetch('/api/relatorios-rotas')
                .then(res => {
                    if (!res.ok) {
                        throw new Error('Erro ao carregar relatórios de rotas');
                    }
                    return res.json();
                })
                .then(data => {
                    relatoriosRotas = data;
                    populateTable();
                })
                .catch(() => {
                    showNotification('danger', 'Não foi possível carregar os relatórios de rotas.');
                });
        }

        function populateTable() {
            const tableBody = $('#relatorios-rotas-table tbody');
            tableBody.empty();

            relatoriosRotas.forEach(r => {
                const dataFormatada = formatDate(r.data_criacao);
                const row = `
                    <tr>
                        <td>${r.id}</td>
                        <td>${r.rota}</td>
                        <td>${r.empresa_responsavel}</td>
                        <td>${dataFormatada}</td>
                        <td>
                            <div class="form-button-action">
                                <button type="button" class="btn btn-link btn-dark btn-lg"
                                    onclick="visualizarRelatorioPdf('${r.id}')"
                                    data-bs-toggle="tooltip" title="Visualizar PDF">
                                    <i class="fa fa-eye"></i>
                                </button>
                                <button type="button" class="btn btn-link btn-secondary btn-lg"
                                    onclick="gerarPdf('${r.id}')"
                                    data-bs-toggle="tooltip" title="Baixar PDF">
                                    <i class="fa fa-file-pdf"></i>
                                </button>
                                <button type="button" class="btn btn-link btn-info btn-lg"
                                    onclick="gerarDocx('${r.id}')"
                                    data-bs-toggle="tooltip" title="Baixar .docx">
                                    <i class="fa fa-file-word"></i>
                                </button>
                                <button type="button" class="btn btn-link btn-warning btn-lg"
                                    onclick="abrirModalEditarRelatorio('${r.id}')"
                                    data-bs-toggle="tooltip" title="Editar Relatório">
                                    <i class="fa fa-edit"></i>
                                </button>
                                <button type="button" class="btn btn-link btn-danger btn-lg"
                                    onclick="excluirRelatorio('${r.id}')"
                                    data-bs-toggle="tooltip" title="Excluir">
                                    <i class="fa fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tableBody.append(row);
            });

            if ($.fn.DataTable.isDataTable('#relatorios-rotas-table')) {
                $('#relatorios-rotas-table').DataTable().clear().destroy();
            }

            $('#relatorios-rotas-table').DataTable({
                pageLength: 10,
                language: {
                    decimal: ",",
                    thousands: ".",
                    info: "Mostrando _START_ até _END_ de _TOTAL_ registros",
                    infoEmpty: "Mostrando 0 até 0 de 0 registros",
                    infoFiltered: "(filtrado de _MAX_ registros no total)",
                    lengthMenu: "Mostrar _MENU_ registros",
                    loadingRecords: "Carregando...",
                    processing: "Processando...",
                    search: "Pesquisar:",
                    zeroRecords: "Nenhum registro encontrado",
                    paginate: {
                        first: "Primeiro",
                        last: "Último",
                        next: "Próximo",
                        previous: "Anterior"
                    },
                    emptyTable: "Nenhum dado disponível na tabela"
                }
            });
        }

        function visualizarRelatorioPdf(id) {
            window.open(`/api/relatorios-rotas/${id}/pdf`, '_blank');
        }

        function gerarPdf(id) {
            fetch(`/api/relatorios-rotas/${id}/pdf`)
                .then(res => {
                    if (!res.ok) throw new Error();
                    return res.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `relatorio_rota_${id}.pdf`;
                    document.body.appendChild(link);
                    link.click();
                    link.remove();
                    window.URL.revokeObjectURL(url);
                })
                .catch(() => {
                    showNotification('danger', 'Erro ao gerar PDF. Tente novamente.');
                });
        }

        function gerarDocx(id) {
            fetch(`/api/relatorios-rotas/${id}/docx`)
                .then(res => {
                    if (!res.ok) throw new Error();
                    return res.blob();
                })
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = `relatorio_rota_${id}.docx`;
                    document.body.appendChild(link);
                    link.click();
                    link.remove();
                    window.URL.revokeObjectURL(url);
                })
                .catch(() => {
                    showNotification('danger', 'Erro ao gerar documento. Tente novamente.');
                });
        }

        function abrirModalEditarRelatorio(id) {
            const relatorio = relatoriosRotas.find(item => item.id == id);
            if (!relatorio) {
                showNotification('danger', 'Relatório não encontrado.');
                return;
            }
            document.getElementById('editar_relatorio_id').value = relatorio.id;
            document.getElementById('editar_rota').value = relatorio.rota;
            document.getElementById('editar_empresa_responsavel').value = relatorio.empresa_responsavel;
            document.getElementById('editar_corpo_relatorio').value = relatorio.corpo_relatorio || '';
            $('#modalEditarRelatório').modal('show');
        }

        function excluirRelatorio(id) {
            fetch(`/api/relatorios-rotas/${id}`, { method: 'DELETE' })
                .then(res => {
                    if (!res.ok) throw new Error();
                    return res.json();
                })
                .then(data => {
                    if (data.success) {
                        showNotification('success', 'Relatório excluído com sucesso!');
                        loadRelatoriosRotas();
                    } else {
                        showNotification('danger', 'Erro ao excluir relatório: ' + data.message);
                    }
                })
                .catch(() => {
                    showNotification('danger', 'Erro ao excluir relatório. Tente novamente.');
                });
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadRelatoriosRotas();

            document.getElementById('relatorio-rotas-form').addEventListener('submit', e => {
                e.preventDefault();
                const formData = new FormData(e.target);
                fetch('/api/relatorios-rotas/cadastrar', {
                    method: 'POST',
                    body: formData
                })
                    .then(res => {
                        if (!res.ok) throw new Error();
                        return res.json();
                    })
                    .then(data => {
                        if (data.success) {
                            showNotification('success', 'Relatório criado com sucesso!');
                            e.target.reset();
                            $('#modalNovoRelatorio').modal('hide');
                            loadRelatoriosRotas();
                        } else {
                            showNotification('danger', 'Erro ao criar relatório: ' + data.message);
                        }
                    })
                    .catch(() => {
                        showNotification('danger', 'Erro ao criar relatório. Tente novamente.');
                    });
            });

            document.getElementById('editar-relatorio-rotas-form').addEventListener('submit', e => {
                e.preventDefault();
                const relatorioId = document.getElementById('editar_relatorio_id').value;
                const formData = new FormData(e.target);
                fetch(`/api/relatorios-rotas/${relatorioId}`, {
                    method: 'PUT',
                    body: formData
                })
                    .then(res => {
                        if (!res.ok) throw new Error();
                        return res.json();
                    })
                    .then(data => {
                        if (data.success) {
                            showNotification('success', 'Relatório atualizado com sucesso!');
                            $('#modalEditarRelatório').modal('hide');
                            loadRelatoriosRotas();
                        } else {
                            showNotification('danger', 'Erro ao atualizar relatório: ' + data.message);
                        }
                    })
                    .catch(() => {
                        showNotification('danger', 'Erro ao atualizar relatório. Tente novamente.');
                    });
            });
        });
    </script>
</body>

</html>