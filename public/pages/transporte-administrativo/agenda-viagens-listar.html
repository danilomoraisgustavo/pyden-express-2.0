<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Agenda de Viagens – Listar</title>
  <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport" />
  <link rel="icon" href="../../assets/img/pydenadmin/favicon.png" type="image/x-icon" />
  <!-- Fonts e ícones -->
  <script src="../../assets/js/plugin/webfont/webfont.min.js"></script>
  <script>
    WebFont.load({
      google: { families: ["Public Sans:300,400,500,600,700"] },
      custom: {
        families: ["Font Awesome 5 Solid", "Font Awesome 5 Regular", "Font Awesome 5 Brands", "simple-line-icons"],
        urls: ["../../assets/css/fonts.min.css"]
      },
      active: function () {
        sessionStorage.fonts = true;
      }
    });
  </script>
  <!-- CSS principais -->
  <link rel="stylesheet" href="../../assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="../../assets/css/plugins.min.css" />
  <link rel="stylesheet" href="../../assets/css/pydenadmin.min.css" />
  <link rel="stylesheet" href="../../assets/css/demo.css" />
  <!-- CSS do FullCalendar -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.css" />
  <!-- Google Maps API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCAwvAt4l0Pkb1c52FLUE-ttVxm4YZ9J8M"></script>
  <style>
    /* Altura dos mapas nos modais de rotas */
    #mapNovaViagem, #mapEditarViagem, #mapVisualizarViagem {
      height: 400px;
      width: 100%;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <!-- SIDEBAR -->
    <div class="sidebar" data-background-color="dark">
      <div class="sidebar-logo">
        <div class="logo-header" data-background-color="dark">
          <a href="../../pages/transporte-escolar/dashboard-escolar.html" class="logo">
            <img src="../../assets/img/pydenadmin/logo_light.png" alt="navbar brand" class="navbar-brand" height="20" />
          </a>
          <div class="nav-toggle">
            <button class="btn btn-toggle toggle-sidebar"><i class="gg-menu-right"></i></button>
            <button class="btn btn-toggle sidenav-toggler"><i class="gg-menu-left"></i></button>
          </div>
          <button class="topbar-toggler more"><i class="gg-more-vertical-alt"></i></button>
        </div>
      </div>
      <div class="sidebar-wrapper scrollbar scrollbar-inner">
        <div class="sidebar-content">
          <ul class="nav nav-secondary">
            <!-- =========================================================
            =                  TRANSPORTE ESCOLAR                   =
            =======================================================-->
            <li class="nav-section">
              <span class="sidebar-mini-icon"><i class="fa fa-ellipsis-h"></i></span>
              <h4 class="text-section">Transporte Escolar</h4>
            </li>
            <li class="nav-item">
              <a href="../../pages/transporte-escolar/dashboard-escolar.html">
                <i class="fas fa-tachometer-alt"></i>
                <p>Dashboard Escolar</p>
              </a>
            </li>
            <!-- Alunos -->
            <li class="nav-item">
              <a data-bs-toggle="collapse" href="#teAlunos" aria-expanded="false">
                <i class="fas fa-user-graduate"></i>
                <p>Alunos</p><span class="caret"></span>
              </a>
              <div class="collapse" id="teAlunos">
                <ul class="nav nav-collapse">
                  <li><a href="../../pages/transporte-escolar/alunos-solicitacoes-listar.html"><span class="sub-item">Listar Solicitações de Transporte</span></a></li>
                  <li><a href="../../pages/transporte-escolar/alunos-listar.html"><span class="sub-item">Listar Alunos</span></a></li>
                </ul>
              </div>
            </li>
            <!-- Motoristas -->
            <li class="nav-item">
              <a data-bs-toggle="collapse" href="#teMotoristas" aria-expanded="false">
                <i class="fas fa-id-card"></i>
                <p>Motoristas</p><span class="caret"></span>
              </a>
              <div class="collapse" id="teMotoristas">
                <ul class="nav nav-collapse">
                  <li><a href="../../pages/transporte-escolar/motoristas-listar.html"><span class="sub-item">Listar Motoristas</span></a></li>
                  <li><a href="../../pages/transporte-escolar/motoristas-licencas.html"><span class="sub-item">Licenças e Certificações</span></a></li>
                </ul>
              </div>
            </li>
            <!-- Monitores -->
            <li class="nav-item">
              <a data-bs-toggle="collapse" href="#teMonitores" aria-expanded="false">
                <i class="fas fa-user-check"></i>
                <p>Monitores</p><span class="caret"></span>
              </a>
              <div class="collapse" id="teMonitores">
                <ul class="nav nav-collapse">
                  <li><a href="../../pages/transporte-escolar/monitores-listar.html"><span class="sub-item">Listar Monitores</span></a></li>
                </ul>
              </div>
            </li>
            <!-- Veículos -->
            <li class="nav-item">
              <a data-bs-toggle="collapse" href="#teVeiculos" aria-expanded="false">
                <i class="fas fa-bus"></i>
                <p>Veículos</p><span class="caret"></span>
              </a>
              <div class="collapse" id="teVeiculos">
                <ul class="nav nav-collapse">
                  <li><a href="../../pages/transporte-escolar/veiculos-listar.html"><span class="sub-item">Listar Veículos</span></a></li>
                  <li><a href="../../pages/transporte-escolar/veiculos-manutencao.html"><span class="sub-item">Manutenção</span></a></li>
                </ul>
              </div>
            </li>
            <!-- Fornecedores Escolares -->
            <li class="nav-item">
              <a data-bs-toggle="collapse" href="#teFornecedores" aria-expanded="false">
                <i class="fas fa-truck-loading"></i>
                <p>Fornecedores</p><span class="caret"></span>
              </a>
              <div class="collapse" id="teFornecedores">
                <ul class="nav nav-collapse">
                  <li><a href="../../pages/transporte-escolar/fornecedores-listar.html"><span class="sub-item">Listar Fornecedores</span></a></li>
                </ul>
              </div>
            </li>
            <!-- =========================================================
            =               TRANSPORTE ADMINISTRATIVO               =
            =======================================================-->
            <li class="nav-section">
              <span class="sidebar-mini-icon"><i class="fa fa-ellipsis-h"></i></span>
              <h4 class="text-section">Transporte Administrativo</h4>
            </li>
            <li class="nav-item">
              <a href="../../pages/transporte-administrativo/dashboard-administrativo.html">
                <i class="fas fa-tachometer-alt"></i>
                <p>Dashboard Administrativo</p>
              </a>
            </li>
            <!-- Motoristas ADM -->
            <li class="nav-item">
              <a data-bs-toggle="collapse" href="#taMotoristas" aria-expanded="false">
                <i class="fas fa-id-card"></i>
                <p>Motoristas</p><span class="caret"></span>
              </a>
              <div class="collapse" id="taMotoristas">
                <ul class="nav nav-collapse">
                  <li><a href="../../pages/transporte-administrativo/motoristas-listar.html"><span class="sub-item">Listar Motoristas</span></a></li>
                  <li><a href="../../pages/transporte-administrativo/motoristas-cadastrar.html"><span class="sub-item">Cadastrar Motorista</span></a></li>
                  <li><a href="../../pages/transporte-administrativo/motoristas-licencas.html"><span class="sub-item">Licenças e Certificações</span></a></li>
                </ul>
              </div>
            </li>
            <!-- Frota ADM -->
            <li class="nav-item">
              <a data-bs-toggle="collapse" href="#taFrota" aria-expanded="false">
                <i class="fas fa-warehouse"></i>
                <p>Frota Administrativa</p><span class="caret"></span>
              </a>
              <div class="collapse" id="taFrota">
                <ul class="nav nav-collapse">
                  <li><a href="../../pages/transporte-administrativo/frota-listar.html"><span class="sub-item">Listar Frota</span></a></li>
                  <li><a href="../../pages/transporte-administrativo/frota-manutencao.html"><span class="sub-item">Manutenção</span></a></li>
                  <li><a href="../../pages/transporte-administrativo/frota-rotas.html"><span class="sub-item">Rotas Internas</span></a></li>
                </ul>
              </div>
            </li>
            <!-- Fornecedores ADM -->
            <li class="nav-item">
              <a data-bs-toggle="collapse" href="#adminFornecedores" aria-expanded="false">
                <i class="fas fa-truck-loading"></i>
                <p>Fornecedores</p><span class="caret"></span>
              </a>
              <div class="collapse" id="adminFornecedores">
                <ul class="nav nav-collapse">
                  <li><a href="../../pages/transporte-administrativo/fornecedores-listar.html"><span class="sub-item">Listar Fornecedores</span></a></li>
                </ul>
              </div>
            </li>
            <!-- Agenda -->
            <li class="nav-item">
              <a data-bs-toggle="collapse" href="#taAgenda" aria-expanded="true">
                <i class="far fa-calendar-alt"></i>
                <p>Agenda de Viagens</p><span class="caret"></span>
              </a>
              <div class="collapse show" id="taAgenda">
                <ul class="nav nav-collapse">
                  <li class="active"><a href="agenda-viagens-listar.html"><span class="sub-item">Listar Viagens</span></a></li>
                </ul>
              </div>
            </li>
            
            <!-- =========================================================
            =                       FINANCEIRO                      =
            =======================================================-->
            <li class="nav-section">
              <span class="sidebar-mini-icon"><i class="fa fa-ellipsis-h"></i></span>
              <h4 class="text-section">Financeiro</h4>
            </li>
            <!-- Relatórios Financeiros -->
            <li class="nav-item">
              <a data-bs-toggle="collapse" href="#finRelatorios" aria-expanded="false">
                <i class="far fa-chart-bar"></i>
                <p>Relatórios Financeiros</p><span class="caret"></span>
              </a>
              <div class="collapse" id="finRelatorios">
                <ul class="nav nav-collapse">
                  <li><a href="../../pages/financeiro/relatorios-mensal.html"><span class="sub-item">Relatório Mensal</span></a></li>
                  <li><a href="../../pages/financeiro/relatorios-custos-setor.html"><span class="sub-item">Custos por Setor</span></a></li>
                  <li><a href="../../pages/financeiro/relatorios-comparativos.html"><span class="sub-item">Comparativos</span></a></li>
                </ul>
              </div>
            </li>
            <!-- Outros Relatórios -->
            <li class="nav-item">
              <a data-bs-toggle="collapse" href="#finOutrosRelatorios" aria-expanded="false">
                <i class="fas fa-chart-line"></i>
                <p>Relatórios</p><span class="caret"></span>
              </a>
              <div class="collapse" id="finOutrosRelatorios">
                <ul class="nav nav-collapse">
                  <li><a href="../../pages/financeiro/gerar-memorando.html"><span class="sub-item">Memorandos</span></a></li>
                  <li><a href="../../pages/financeiro/relatorios-rotas.html"><span class="sub-item">Por Rota</span></a></li>
                  <li><a href="../../pages/financeiro/relatorios-geral.html"><span class="sub-item">Geral</span></a></li>
                </ul>
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <!-- END SIDEBAR -->
    <div class="main-panel">
      <!-- HEADER -->
      <div class="main-header" style="top: 0;">
        <div class="main-header-logo">
          <div class="logo-header" data-background-color="dark">
            <a href="../../pages/transporte-escolar/dashboard-escolar.html" class="logo">
              <img src="../../assets/img/pydenadmin/logo_light.png" alt="navbar brand" class="navbar-brand" height="20" />
            </a>
            <div class="nav-toggle">
              <button class="btn btn-toggle toggle-sidebar"><i class="gg-menu-right"></i></button>
              <button class="btn btn-toggle sidenav-toggler"><i class="gg-menu-left"></i></button>
            </div>
            <button class="topbar-toggler more"><i class="gg-more-vertical-alt"></i></button>
          </div>
        </div>
        <nav class="navbar navbar-header navbar-header-transparent navbar-expand-lg border-bottom">
          <div class="container-fluid">
            <ul class="navbar-nav topbar-nav ms-md-auto align-items-center">
              <!-- Mensagens -->
              <li class="nav-item topbar-icon dropdown hidden-caret">
                <a class="nav-link dropdown-toggle" href="#" id="messageDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="fa fa-envelope"></i>
                </a>
                <ul class="dropdown-menu messages-notif-box animated fadeIn" aria-labelledby="messageDropdown">
                  <li>
                    <div class="dropdown-title d-flex justify-content-between align-items-center">
                      Mensagens
                      <a href="#" class="small">Marcar todas como lidas</a>
                    </div>
                  </li>
                  <li>
                    <div class="message-notif-scroll scrollbar-outer">
                      <div class="notif-center">
                        <!-- Exemplo de mensagem -->
                        <a href="#">
                          <div class="notif-img">
                            <img src="../../assets/img/jm_denis.jpg" alt="Img Profile" />
                          </div>
                          <div class="notif-content">
                            <span class="subject">Jimmy Denis</span>
                            <span class="block">Como você está?</span>
                            <span class="time">Há 5 minutos</span>
                          </div>
                        </a>
                        <!-- ... outras mensagens ... -->
                      </div>
                    </div>
                  </li>
                  <li>
                    <a class="see-all" href="javascript:void(0);">
                      Ver todas as mensagens
                      <i class="fa fa-angle-right"></i>
                    </a>
                  </li>
                </ul>
              </li>
              <!-- Notificações -->
              <li class="nav-item topbar-icon dropdown hidden-caret">
                <a class="nav-link dropdown-toggle" href="#" id="notifDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="fa fa-bell"></i>
                  <span class="notification" id="notifCount">0</span>
                </a>
                <ul class="dropdown-menu notif-box animated fadeIn" aria-labelledby="notifDropdown">
                  <li>
                    <div class="dropdown-title" id="notifTitle">Você não tem novas notificações</div>
                  </li>
                  <li>
                    <div class="notif-scroll scrollbar-outer">
                      <div class="notif-center" id="notifList">
                        <!-- Lista de notificações inserida via JS -->
                      </div>
                    </div>
                  </li>
                  <li>
                    <a class="see-all" href="javascript:void(0);" id="notifSeeAll">
                      Ver todas as notificações
                      <i class="fa fa-angle-right"></i>
                    </a>
                  </li>
                </ul>
              </li>
              <!-- Ações Rápidas -->
              <li class="nav-item topbar-icon dropdown hidden-caret">
                <a class="nav-link dropdown-toggle" href="#" id="quickActionsDropdown" role="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  <i class="fas fa-layer-group"></i>
                </a>
                <div class="dropdown-menu quick-actions animated fadeIn" aria-labelledby="quickActionsDropdown">
                  <div class="quick-actions-header">
                    <span class="title mb-1">Ações Rápidas</span>
                    <span class="subtitle op-7">Atalhos</span>
                  </div>
                  <div class="quick-actions-scroll scrollbar-outer">
                    <div class="quick-actions-items">
                      <div class="row m-0">
                        <a class="col-6 col-md-4 p-0" href="../../pages/transporte-escolar/escolas-cadastrar.html">
                          <div class="quick-actions-item">
                            <div class="avatar-item bg-primary rounded-circle">
                              <i class="fas fa-school"></i>
                            </div>
                            <span class="text">Cad. Escola</span>
                          </div>
                        </a>
                        <a class="col-6 col-md-4 p-0" href="../../pages/transporte-escolar/monitores-cadastrar.html">
                          <div class="quick-actions-item">
                            <div class="avatar-item bg-success rounded-circle">
                              <i class="fas fa-user-check"></i>
                            </div>
                            <span class="text">Cad. Monitor</span>
                          </div>
                        </a>
                        <a class="col-6 col-md-4 p-0" href="../../pages/transporte-escolar/rotas-listar.html">
                          <div class="quick-actions-item">
                            <div class="avatar-item bg-warning rounded-circle">
                              <i class="fas fa-route"></i>
                            </div>
                            <span class="text">Listar Rotas</span>
                          </div>
                        </a>
                        <a class="col-6 col-md-4 p-0" href="../../pages/transporte-administrativo/frota-listar.html">
                          <div class="quick-actions-item">
                            <div class="avatar-item bg-info rounded-circle">
                              <i class="fas fa-warehouse"></i>
                            </div>
                            <span class="text">Listar Frota</span>
                          </div>
                        </a>
                        <!-- ... outros atalhos ... -->
                      </div>
                    </div>
                  </div>
                </div>
              </li>
              <!-- Dropdown Usuário -->
              <li class="nav-item topbar-user dropdown hidden-caret">
                <a class="dropdown-toggle profile-pic" data-bs-toggle="dropdown" href="#" aria-expanded="false">
                  <div class="avatar-sm">
                    <img src="../../assets/img/profile.jpg" alt="Avatar" class="avatar-img rounded-circle" />
                  </div>
                  <span class="profile-username"><span class="op-7">Olá,</span> <span class="fw-bold" id="dropdownUserName">Carregando...</span></span>
                </a>
                <ul class="dropdown-menu dropdown-user animated fadeIn">
                  <div class="dropdown-user-scroll scrollbar-outer">
                    <li>
                      <div class="user-box">
                        <div class="avatar-lg"><img src="../../assets/img/profile.jpg" alt="image profile" class="avatar-img rounded" /></div>
                        <div class="u-text">
                          <h4 id="dropdownUserBoxName">Nome do Usuário</h4>
                          <p class="text-muted" id="dropdownUserEmail">email@exemplo.com</p>
                          <a href="../../pages/usuarios/meu-perfil.html" class="btn btn-xs btn-secondary btn-sm">Meu Perfil</a>
                        </div>
                      </div>
                    </li>
                    <li>
                      <div class="dropdown-divider"></div>
                      <a class="dropdown-item" href="#" id="btnLogout">Sair</a>
                    </li>
                  </div>
                </ul>
              </li>
            </ul>
          </div>
        </nav>
      </div>
      <!-- MAIN CONTENT -->
      <div class="content">
        <div class="container">
          <div class="page-inner">
            <div class="page-header">
              <h3 class="fw-bold mb-3">Listar Viagens</h3>
              <ul class="breadcrumbs mb-3">
                <li class="nav-home">
                  <a href="../../"><i class="icon-home"></i></a>
                </li>
                <li class="separator"><i class="icon-arrow-right"></i></li>
                <li class="nav-item">
                  <a href="#">Agenda de Viagens</a>
                </li>
                <li class="separator"><i class="icon-arrow-right"></i></li>
                <li class="nav-item active">
                  <a href="#">Listar Viagens</a>
                </li>
              </ul>
            </div>
            <div class="row mt-4">
              <div class="col-md-12">
                <div class="card">
                  <div class="card-header">
                    <h4 class="card-title">Lista de Viagens</h4>
                  </div>
                  <br>
                  <div class="text-end px-3 pb-2">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalNovaViagem">
                      Nova Viagem
                    </button>
                    <button type="button" class="btn btn-secondary ms-2" data-bs-toggle="modal" data-bs-target="#modalCalendario">
                      Visualizar Calendário
                    </button>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive">
                      <table id="viagens-table" class="display table table-striped table-hover">
                        <thead>
                          <tr>
                            <th>Motorista</th>
                            <th>Data/Hora</th>
                            <th>Origem</th>
                            <th>Destino</th>
                            <th>Tipo de Viagem</th>
                            <th>Status</th>
                            <th>Ações</th>
                          </tr>
                        </thead>
                        <tfoot>
                          <tr>
                            <th>Motorista</th>
                            <th>Data/Hora</th>
                            <th>Origem</th>
                            <th>Destino</th>
                            <th>Tipo de Viagem</th>
                            <th>Status</th>
                            <th>Ações</th>
                          </tr>
                        </tfoot>
                        <tbody>
                          <!-- Linhas preenchidas dinamicamente -->
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div> <!-- page-inner -->
        </div>
        </div> <!-- container -->
        <!-- Modal Nova Viagem -->
        <div class="modal fade" id="modalNovaViagem" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title fw-bold">Agendar Nova Viagem</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
              </div>
              <div class="modal-body">
                <form id="nova-viagem-form">
                  <!-- Motorista e Tipo -->
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label required">Motorista</label>
                      <select id="motoristaNova" name="motorista_id" class="form-select motorista-select" required>
                        <option value="">Selecione o motorista</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label required">Tipo de Viagem</label>
                      <select id="tipoNova" name="tipo" class="form-select" required>
                        <option value="">Selecione</option>
                        <option value="Pessoas">Pessoas</option>
                        <option value="Materiais">Materiais</option>
                        <option value="Ambos">Ambos</option>
                      </select>
                    </div>
                  </div>
                  <!-- Datas -->
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label required">Data/Hora de Saída</label>
                      <input type="datetime-local" id="dataSaidaNova" name="data_saida" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Data/Hora Retorno Previsto</label>
                      <input type="datetime-local" id="dataRetornoNova" name="data_retorno" class="form-control" disabled>
                    </div>
                  </div>
                  <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="vaiEsperarNova" name="vai_esperar">
                    <label class="form-check-label" for="vaiEsperarNova">
                      Motorista vai esperar?
                    </label>
                  </div>
                  <!-- Labels de Origem/Destino -->
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label class="form-label required">Nome do Ponto de Partida</label>
                      <input type="text" id="origemLabel" name="origem" class="form-control" placeholder="Ex: SEMED" required>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label required">Nome do Ponto de Chegada</label>
                      <input type="text" id="destinoLabel" name="destino" class="form-control" placeholder="Ex: Escola A" required>
                    </div>
                  </div>
                  <!-- Botões de Marcação no Mapa -->
                  <div class="mb-3">
                    <button type="button" id="btnAddOrigem" class="btn btn-outline-success me-2">
                      <i class="fa fa-map-marker-alt"></i> Marcar Origem
                    </button>
                    <button type="button" id="btnAddIntermediario" class="btn btn-outline-warning me-2">
                      <i class="fa fa-map-marker-alt"></i> Marcar Ponto
                    </button>
                    <button type="button" id="btnAddDestino" class="btn btn-outline-danger">
                      <i class="fa fa-map-marker-alt"></i> Marcar Destino
                    </button>
                  </div>
                  <!-- Lista de Pontos Intermediários (Nova Viagem) -->
                  <div class="mb-3">
                    <label class="form-label">Pontos Intermediários:</label>
                    <div id="pontosIntermedContainerNova"></div>
                  </div>
                  <!-- Mapa -->
                  <div id="mapNovaViagem" style="height:400px;"></div>
                  <!-- Ocultos para enviar as coordenadas -->
                  <input type="hidden" id="origemLat" name="origem_lat">
                  <input type="hidden" id="origemLng" name="origem_lng">
                  <input type="hidden" id="destinoLat" name="destino_lat">
                  <input type="hidden" id="destinoLng" name="destino_lng">
                  <input type="hidden" id="pontosIntermediariosNova" name="pontos_intermediarios">
                  <!-- Botões de Ação -->
                  <div class="text-end mt-3">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Viagem</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
        <!-- Modal Editar Viagem -->
        <div class="modal fade" id="modalEditarViagem" tabindex="-1" aria-labelledby="modalEditarViagemLabel" aria-hidden="true">
          <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title fw-bold" id="modalEditarViagemLabel">Editar Viagem</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
              </div>
              <div class="modal-body">
                <form id="editar-viagem-form">
                  <input type="hidden" id="editarViagemId">
                  <div class="mb-3">
                    <label for="motoristaEditar" class="form-label">Motorista:</label>
                    <select id="motoristaEditar" name="motorista_id" class="form-control motorista-select" required>
                      <option value="">Selecione o motorista</option>
                    </select>
                  </div>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="dataSaidaEditar" class="form-label">Data/Hora de saída:</label>
                      <input type="datetime-local" id="dataSaidaEditar" name="data_saida" class="form-control" required>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="dataRetornoEditar" class="form-label">Data/Hora de retorno:</label>
                      <input type="datetime-local" id="dataRetornoEditar" name="data_retorno" class="form-control">
                    </div>
                  </div>
                  <div class="mb-3">
                    <label for="origemEditar" class="form-label">Origem:</label>
                    <input type="text" id="origemEditar" name="origem" class="form-control" required>
                  </div>
                  <div class="mb-3">
                    <label for="destinoEditar" class="form-label">Destino:</label>
                    <input type="text" id="destinoEditar" name="destino" class="form-control" required>
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Pontos Intermediários:</label>
                    <div id="pontosIntermedContainerEditar">
                      <input type="text" name="ponto_intermediario" class="form-control ponto-intermediario mb-2" placeholder="Ponto intermediário (opcional)">
                    </div>
                    <button type="button" id="addPontoEditarBtn" class="btn btn-sm btn-outline-primary">Adicionar Ponto</button>
                  </div>
                  <div class="mb-3">
                    <label for="tipoEditar" class="form-label">Tipo de viagem:</label>
                    <select id="tipoEditar" name="tipo" class="form-control" required>
                      <option value="">Selecione</option>
                      <option value="Pessoas">Pessoas</option>
                      <option value="Materiais">Materiais</option>
                      <option value="Ambos">Ambos</option>
                    </select>
                  </div>
                  <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="retornaEditar" name="retorna_origem">
                    <label class="form-check-label" for="retornaEditar">
                      Motorista retorna à origem
                    </label>
                  </div>
                  <div class="mb-3">
                    <label for="obsEditar" class="form-label">Observações:</label>
                    <textarea id="obsEditar" name="observacoes" class="form-control" rows="3"></textarea>
                  </div>
                  <input type="hidden" name="pontos_intermediarios" id="pontosIntermediariosEditar">
                  <button type="button" id="calcRouteEditarBtn" class="btn btn-info mb-3">Traçar Rota</button>
                  <div id="mapEditarViagem"></div>
                  <div class="text-end">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
        <!-- Modal Visualizar Viagem -->
        <div class="modal fade" id="modalVisualizarViagem" tabindex="-1" aria-labelledby="modalVisualizarViagemLabel" aria-hidden="true">
          <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title fw-bold" id="modalVisualizarViagemLabel">Detalhes da Viagem</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
              </div>
              <div class="modal-body">
                <p><strong>Motorista:</strong> <span id="viewMotorista"></span></p>
                <p><strong>Data/Hora de saída:</strong> <span id="viewDataSaida"></span></p>
                <p><strong>Data/Hora de retorno:</strong> <span id="viewDataRetorno"></span></p>
                <p><strong>Origem:</strong> <span id="viewOrigem"></span></p>
                <p><strong>Destino:</strong> <span id="viewDestino"></span></p>
                <p><strong>Pontos intermediários:</strong> <span id="viewPontos"></span></p>
                <p><strong>Tipo de viagem:</strong> <span id="viewTipo"></span></p>
                <p><strong>Retorna à origem:</strong> <span id="viewRetorna"></span></p>
                <p><strong>Observações:</strong> <span id="viewObs"></span></p>
                <div id="mapVisualizarViagem"></div>
                <div class="text-end">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Modal Calendário -->
        <div class="modal fade" id="modalCalendario" tabindex="-1" aria-labelledby="modalCalendarioLabel" aria-hidden="true">
          <div class="modal-dialog modal-xl">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title fw-bold" id="modalCalendarioLabel">Calendário de Viagens</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
              </div>
              <div class="modal-body">
                <div id="calendar"></div>
              </div>
            </div>
          </div>
        </div>
      </div> <!-- .content -->
      <footer class="footer">
        <div class="container-fluid d-flex justify-content-between">
          <nav class="pull-left">
            <ul class="nav">
              <li class="nav-item"><a class="nav-link" target="_blank" href="https://pydenexpress.com/">PyDen Express</a></li>
              <li class="nav-item"><a class="nav-link" href="#">Ajuda</a></li>
              <li class="nav-item"><a class="nav-link" href="#">Termos de Uso</a></li>
            </ul>
          </nav>
          <div class="copyright">2025 &copy; Todos os direitos reservados</div>
          <div>Desenvolvido por <a target="_blank" href="http://www.pyden.tech">PyDen Technologies</a>&reg;.</div>
        </div>
      </footer>
    </div> <!-- main-panel -->
  </div> <!-- wrapper -->
  <!-- JS, Popper.js, Bootstrap JS e plugins -->
  <script src="../../assets/js/core/jquery-3.7.1.min.js"></script>
  <script src="../../assets/js/core/popper.min.js"></script>
  <script src="../../assets/js/core/bootstrap.min.js"></script>
  <script src="../../assets/js/usuario.js"></script>
  <script src="../../assets/js/plugin/bootstrap-notify/bootstrap-notify.min.js"></script>
  <script src="../../assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
  <script src="../../assets/js/plugin/datatables/datatables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/main.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.0/locales-all.min.js"></script>
  <script src="../../assets/js/pydenadmin.min.js"></script>
  <script src="../../assets/js/setting-demo2.js"></script>
  <!-- Script da página Agenda de Viagens -->
  <script>
    // Variáveis globais e mapas
    let viagens = [];
    let motoristas = [];
    let mapNovaViagem, directionsServiceNova, directionsRendererNova;
    let mapEditarViagem, directionsServiceEditar, directionsRendererEditar;
    let mapVisualizarViagem, directionsServiceVisualizar, directionsRendererVisualizar;
    let currentViagemVisualizar = null;
    let calendar, calendarInitialized = false;
    let markingOrigin = false, markingDestination = false, markingIntermediary = false;
    
    // Variáveis para marcação no mapa
    let geocoder;
    let markerOrigemNova, markerDestinoNova;
    let markersIntermedNova = [];
    // Event listeners para os botões
    function initMarkButtons() {
      document.getElementById('btnAddOrigem').addEventListener('click', () => {
        markingOrigin = true;
        markingIntermediary = markingDestination = false;
        // opcional: dar feedback visual no botão
      });
      document.getElementById('btnAddIntermediario').addEventListener('click', () => {
        markingIntermediary = true;
        markingOrigin = markingDestination = false;
      });
      document.getElementById('btnAddDestino').addEventListener('click', () => {
        markingDestination = true;
        markingOrigin = markingIntermediary = false;
      });
    }
    // Mapa de Nova Viagem
    function initMapNovaViagem() {
      mapNovaViagem = new google.maps.Map(document.getElementById('mapNovaViagem'), {
        center: { lat: -6.530066, lng: -49.851630 },
        zoom: 13
      });
      if (!geocoder) geocoder = new google.maps.Geocoder();
      directionsServiceNova = new google.maps.DirectionsService();
      directionsRendererNova = new google.maps.DirectionsRenderer();
      directionsRendererNova.setMap(mapNovaViagem);
      
      // clique no mapa só marca o ponto ativo
      mapNovaViagem.addListener('click', (e) => {
        const pos = e.latLng;
        if (markingOrigin) {
          if (markerOrigemNova) markerOrigemNova.setMap(null);
          markerOrigemNova = new google.maps.Marker({
            position: pos, map: mapNovaViagem,
            icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
          });
          markingOrigin = false;
          geocoder.geocode({ location: pos }, (res, st) => {
            if (st === 'OK' && res[0]) {
              document.getElementById('origemLabel').value = res[0].formatted_address;
              document.getElementById('origemLat').value = pos.lat();
              document.getElementById('origemLng').value = pos.lng();
            }
          });
        }
        else if (markingIntermediary) {
          const m = new google.maps.Marker({
            position: pos, map: mapNovaViagem,
            icon: 'http://maps.google.com/mapfiles/ms/icons/yellow-dot.png'
          });
          markersIntermedNova.push(m);
          markingIntermediary = false; // se quiser só um por clique
          geocoder.geocode({ location: pos }, (res, st) => {
            if (st === 'OK' && res[0]) {
              const container = document.getElementById('pontosIntermedContainerNova');
              const inp = document.createElement('input');
              inp.type = 'text'; inp.name = 'ponto_intermediario';
              inp.className = 'form-control ponto-intermediario mb-2';
              inp.value = res[0].formatted_address;
              container.appendChild(inp);
            }
          });
        }
        else if (markingDestination) {
          if (markerDestinoNova) markerDestinoNova.setMap(null);
          markerDestinoNova = new google.maps.Marker({
            position: pos, map: mapNovaViagem,
            icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
          });
          markingDestination = false;
          geocoder.geocode({ location: pos }, (res, st) => {
            if (st === 'OK' && res[0]) {
              document.getElementById('destinoLabel').value = res[0].formatted_address;
              document.getElementById('destinoLat').value = pos.lat();
              document.getElementById('destinoLng').value = pos.lng();
            }
          });
        }
      });
    }
    
    function initMapEditarViagem() {
      mapEditarViagem = new google.maps.Map(document.getElementById('mapEditarViagem'), {
        center: { lat: -6.530066, lng: -49.851630 },
        zoom: 13
      });
      directionsServiceEditar = new google.maps.DirectionsService();
      directionsRendererEditar = new google.maps.DirectionsRenderer();
      directionsRendererEditar.setMap(mapEditarViagem);
    }
    function initMapVisualizarViagem() {
      mapVisualizarViagem = new google.maps.Map(document.getElementById('mapVisualizarViagem'), {
        center: { lat: -6.530066, lng: -49.851630 },
        zoom: 13
      });
      directionsServiceVisualizar = new google.maps.DirectionsService();
      directionsRendererVisualizar = new google.maps.DirectionsRenderer();
      directionsRendererVisualizar.setMap(mapVisualizarViagem);
    }
    
    // Funções para traçar rota no mapa usando Google Directions API
    function calculateRouteNova() {
      const origin = document.getElementById('origemLabel').value;
      const destination = document.getElementById('destinoLabel').value;
      if (!origin || !destination) {
        console.warn('Origem e destino precisam ser preenchidos para traçar a rota.');
        return;
      }
      // Coleta waypoints dos campos de pontos intermediários (não vazios)
      const waypoints = [];
      document.querySelectorAll('#modalNovaViagem .ponto-intermediario').forEach(input => {
        if (input.value) {
          waypoints.push({ location: input.value, stopover: true });
        }
      });
      directionsServiceNova.route({
        origin: origin,
        destination: destination,
        waypoints: waypoints,
        travelMode: 'DRIVING'
      }, (response, status) => {
        if (status === 'OK') {
          directionsRendererNova.setDirections(response);
          // Adiciona marcadores manualmente se não foram marcados no mapa
          if (!markerOrigemNova) {
            const startLoc = response.routes[0].legs[0].start_location;
            markerOrigemNova = new google.maps.Marker({ position: startLoc, map: mapNovaViagem, icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png' });
            document.getElementById('origemLat').value = startLoc.lat();
            document.getElementById('origemLng').value = startLoc.lng();
          }
          if (!markerDestinoNova) {
            const lastLeg = response.routes[0].legs[response.routes[0].legs.length - 1];
            const endLoc = lastLeg.end_location;
            markerDestinoNova = new google.maps.Marker({ position: endLoc, map: mapNovaViagem, icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png' });
            document.getElementById('destinoLat').value = endLoc.lat();
            document.getElementById('destinoLng').value = endLoc.lng();
          }
        } else {
          console.error('Erro ao traçar rota (Nova): ' + status);
        }
      });
    }
    function calculateRouteEditar() {
      const origin = document.getElementById('origemEditar').value;
      const destination = document.getElementById('destinoEditar').value;
      if (!origin || !destination) return;
      const waypoints = [];
      document.querySelectorAll('#modalEditarViagem .ponto-intermediario').forEach(input => {
        if (input.value) {
          waypoints.push({ location: input.value, stopover: true });
        }
      });
      directionsServiceEditar.route({
        origin: origin,
        destination: destination,
        waypoints: waypoints,
        travelMode: 'DRIVING'
      }, (response, status) => {
        if (status === 'OK') {
          directionsRendererEditar.setDirections(response);
        } else {
          console.error('Erro ao traçar rota (Editar): ' + status);
        }
      });
    }
    function calculateRouteVisualizar() {
      if (!currentViagemVisualizar) return;
      const origin = currentViagemVisualizar.origem;
      const destination = currentViagemVisualizar.destino;
      const waypoints = (currentViagemVisualizar.pontos_intermediarios || []).map(pt => ({ location: pt, stopover: true }));
      directionsServiceVisualizar.route({
        origin: origin,
        destination: destination,
        waypoints: waypoints,
        travelMode: 'DRIVING'
      }, (response, status) => {
        if (status === 'OK') {
          directionsRendererVisualizar.setDirections(response);
        } else {
          console.error('Erro ao traçar rota (Visualizar): ' + status);
        }
      });
    }
    
    // Formatação de data/hora para exibição (dd/mm/yyyy HH:MM)
    function formatDatetime(datetimeStr) {
      if (!datetimeStr) return '';
      const options = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' };
      return new Date(datetimeStr).toLocaleString('pt-BR', options);
    }
    
    // Carrega lista de motoristas para popular os selects
    function loadMotoristas() {
      fetch('/api/motoristas_administrativos')
        .then(res => res.json())
        .then(data => {
          motoristas = data;
          document.querySelectorAll('.motorista-select').forEach(select => {
            select.innerHTML = '<option value="">Selecione o motorista</option>';
            motoristas.forEach(m => {
              const option = document.createElement('option');
              option.value = m.id;
              option.textContent = m.nome_motorista;
              select.appendChild(option);
            });
          });
        })
        .catch(err => console.error('Erro ao carregar motoristas:', err));
    }
    
    // Carrega lista de viagens da API e popula tabela
      function loadViagens() {
        fetch('/api/viagens')
          .then(res => {
            if (!res.ok) throw new Error('Erro ao carregar viagens');
            return res.json();
          })
          .then(data => {
            viagens = data;
            populateTable();
          })
          .catch(err => {
            console.error(err);
            notify('danger', 'Não foi possível carregar as viagens agendadas.');
          });
      }
    
    // Preenche a tabela de viagens e inicializa DataTable
    function populateTable() {
      const tableBody = $('#viagens-table tbody');
      tableBody.empty();
      viagens.forEach(v => {
        const saida = formatDatetime(v.data_saida);
        const status = v.status || 'Agendada';
        const row = `
          <tr>
            <td>${v.motorista_nome || '(Indefinido)'}</td>
            <td>${saida}</td>
            <td>${v.origem}</td>
            <td>${v.destino}</td>
            <td>${v.tipo}</td>
            <td>${status}</td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-link btn-primary" onclick="openEditarViagemModal(${v.id})" data-bs-toggle="tooltip" title="Editar Viagem">
                  <i class="fa fa-edit"></i>
                </button>
                <button type="button" class="btn btn-link btn-info" onclick="openVisualizarViagemModal(${v.id})" data-bs-toggle="tooltip" title="Visualizar Viagem">
                  <i class="fa fa-eye"></i>
                </button>
                <button type="button" class="btn btn-link btn-danger" onclick="excluirViagem(${v.id})" data-bs-toggle="tooltip" title="Excluir Viagem">
                  <i class="fa fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `;
        tableBody.append(row);
      });
      // Re-inicializa DataTable com idioma PT-BR
      if ($.fn.DataTable.isDataTable('#viagens-table')) {
        $('#viagens-table').DataTable().clear().destroy();
      }
      $('#viagens-table').DataTable({
        pageLength: 10,
        language: {
          decimal: ",",
          thousands: ".",
          info: "Mostrando _START_ até _END_ de _TOTAL_ registros",
          infoEmpty: "Mostrando 0 até 0 de 0 registros",
          infoFiltered: "(filtrado de _MAX_ registros no total)",
          lengthMenu: "Mostrar _MENU_ registros",
          loadingRecords: "Carregando...",
          processing: "Processando...",
          search: "Pesquisar:",
          zeroRecords: "Nenhum registro encontrado",
          paginate: {
            first: "Primeiro",
            last: "Último",
            next: "Próximo",
            previous: "Anterior"
          },
          emptyTable: "Nenhum dado disponível na tabela"
        }
      });
    }
    
    // Abre o modal de edição preenchendo campos com os dados da viagem selecionada
    function openEditarViagemModal(id) {
      const viagem = viagens.find(v => v.id === id);
      if (!viagem) return;
      // Preenche campos do formulário de edição
      document.getElementById('editarViagemId').value = viagem.id;
      document.getElementById('motoristaEditar').value = viagem.motorista_id || '';
      document.getElementById('dataSaidaEditar').value = viagem.data_saida ? viagem.data_saida.substring(0,16) : '';
      document.getElementById('dataRetornoEditar').value = viagem.data_retorno ? viagem.data_retorno.substring(0,16) : '';
      document.getElementById('origemEditar').value = viagem.origem || '';
      document.getElementById('destinoEditar').value = viagem.destino || '';
      document.getElementById('tipoEditar').value = viagem.tipo || '';
      document.getElementById('obsEditar').value = viagem.observacoes || '';
      // Pontos intermediários - limpa e adiciona campos conforme a lista
      const container = document.getElementById('pontosIntermedContainerEditar');
      container.innerHTML = '';
      (viagem.pontos_intermediarios || []).forEach(pt => {
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.name = 'ponto_intermediario';
        inp.className = 'form-control ponto-intermediario mb-2';
        inp.placeholder = 'Ponto intermediário (opcional)';
        inp.value = pt;
        container.appendChild(inp);
      });
      // Sempre pelo menos um campo (vazio se não havia pontos)
      if (container.children.length === 0) {
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.name = 'ponto_intermediario';
        inp.className = 'form-control ponto-intermediario mb-2';
        inp.placeholder = 'Ponto intermediário (opcional)';
        container.appendChild(inp);
      }
      // Checkbox retorna à origem e campo retorno habilitado/desabilitado
      const cbRetorna = document.getElementById('retornaEditar');
      const inputRetorno = document.getElementById('dataRetornoEditar');
      cbRetorna.checked = !!viagem.retorna_origem;
      if (viagem.retorna_origem) {
        inputRetorno.removeAttribute('disabled');
        inputRetorno.required = true;
      } else {
        inputRetorno.setAttribute('disabled', 'disabled');
        inputRetorno.required = false;
      }
      // Exibe modal de edição
      $('#modalEditarViagem').modal('show');
    }
    
    // Abre o modal de visualização preenchendo os detalhes da viagem
    function openVisualizarViagemModal(id) {
      const viagem = viagens.find(v => v.id === id);
      if (!viagem) return;
      currentViagemVisualizar = viagem;
      // Preenche textos dos detalhes
      document.getElementById('viewMotorista').textContent = viagem.motorista_nome || '';
      document.getElementById('viewDataSaida').textContent = formatDatetime(viagem.data_saida);
      document.getElementById('viewDataRetorno').textContent = viagem.data_retorno ? formatDatetime(viagem.data_retorno) : '—';
      document.getElementById('viewOrigem').textContent = viagem.origem;
      document.getElementById('viewDestino').textContent = viagem.destino;
      const pts = viagem.pontos_intermediarios && viagem.pontos_intermediarios.length ? viagem.pontos_intermediarios.join(', ') : 'Nenhum';
      document.getElementById('viewPontos').textContent = pts;
      document.getElementById('viewTipo').textContent = viagem.tipo;
      document.getElementById('viewRetorna').textContent = viagem.retorna_origem ? 'Sim' : 'Não';
      document.getElementById('viewObs').textContent = viagem.observacoes || 'Nenhuma';
      // Exibe modal de visualização
      $('#modalVisualizarViagem').modal('show');
    }
    
    // Função para excluir viagem (solicita confirmação)
      function excluirViagem(id) {
        if (!confirm('Tem certeza que deseja excluir esta viagem?')) return;
        fetch(`/api/viagens/${id}`, { method: 'DELETE' })
          .then(res => res.json())
          .then(result => {
            if (result.success) {
              notify('success', 'Viagem excluída com sucesso.');
              loadViagens();
            } else {
              notify('danger', result.message || 'Não foi possível excluir a viagem.');
            }
          })
          .catch(err => {
            console.error(err);
            notify('danger', 'Erro ao excluir a viagem.');
          });
      }
    
    // Document ready: inicializa eventos e carrega dados iniciais
    document.addEventListener('DOMContentLoaded', function () {
      loadMotoristas();
      loadViagens();
      initMarkButtons();
      // Evento de adicionar novo campo de ponto intermediário (Editar Viagem)
      document.getElementById('addPontoEditarBtn').addEventListener('click', function () {
        const container = document.getElementById('pontosIntermedContainerEditar');
        const newInput = document.createElement('input');
        newInput.type = 'text';
        newInput.name = 'ponto_intermediario';
        newInput.className = 'form-control ponto-intermediario mb-2';
        newInput.placeholder = 'Ponto intermediário (opcional)';
        container.appendChild(newInput);
      });
      // Toggle do campo de retorno em Editar Viagem (similar, mas controlado também em openEditar)
      document.getElementById('retornaEditar').addEventListener('change', function () {
        const retornoInput = document.getElementById('dataRetornoEditar');
        if (this.checked) {
          retornoInput.removeAttribute('disabled');
          retornoInput.required = true;
        } else {
          retornoInput.value = '';
          retornoInput.setAttribute('disabled', 'disabled');
          retornoInput.required = false;
        }
      });
      // Toggle do campo de retorno em Nova Viagem
      document.getElementById('vaiEsperarNova').addEventListener('change', function () {
        const retornoInput = document.getElementById('dataRetornoNova');
        if (this.checked) {
          retornoInput.removeAttribute('disabled');
          retornoInput.required = true;
        } else {
          retornoInput.value = '';
          retornoInput.setAttribute('disabled', 'disabled');
          retornoInput.required = false;
        }
      });
      // Submit do formulário Nova Viagem
      $('#nova-viagem-form').on('submit', function (e) {
        e.preventDefault();
        // prepara os pontos intermediários
        const intermediarios = Array.from(
          document.querySelectorAll('#modalNovaViagem .ponto-intermediario')
        ).map(input => input.value).filter(v => v);
        document.getElementById('pontosIntermediariosNova').value = JSON.stringify(intermediarios);

        const formData = $(this).serialize();
        fetch('/api/viagens', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: formData
        })
          .then(res => res.json())
          .then(result => {
            if (result.id) {
              $('#modalNovaViagem').modal('hide');
              loadViagens();
              notify('success', 'Viagem agendada com sucesso!');
            } else {
              notify('danger', 'Erro ao agendar viagem: ' + (result.message || ''));
            }
          })
          .catch(err => {
            console.error(err);
            notify('danger', 'Erro ao agendar a viagem. Tente novamente.');
          });
      });
      // Submit do formulário Editar Viagem
      $('#editar-viagem-form').on('submit', function (e) {
        e.preventDefault();
        const id = document.getElementById('editarViagemId').value;
        const intermediarios = Array.from(
          document.querySelectorAll('#modalEditarViagem .ponto-intermediario')
        ).map(input => input.value).filter(v => v);
        document.getElementById('pontosIntermediariosEditar').value = JSON.stringify(intermediarios);

        const formData = $(this).serialize();
        fetch(`/api/viagens/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: formData
        })
          .then(res => res.json())
          .then(result => {
            if (result.id) {
              $('#modalEditarViagem').modal('hide');
              loadViagens();
              notify('success', 'Viagem atualizada com sucesso!');
            } else {
              notify('danger', 'Erro ao atualizar viagem: ' + (result.message || ''));
            }
          })
          .catch(err => {
            console.error(err);
            notify('danger', 'Erro ao salvar alterações da viagem.');
          });
      });
      // Inicializa FullCalendar ao abrir modal de calendário
      $('#modalCalendario').on('shown.bs.modal', function () {
        if (!calendarInitialized) {
          const calendarEl = document.getElementById('calendar');
          calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'pt-br',
            headerToolbar: { left: 'title', right: 'prev,next today' },
            events: function (fetchInfo, successCallback, failureCallback) {
              const start = fetchInfo.startStr;
              const end = fetchInfo.endStr;
              fetch(`/api/viagens?data_inicio=${start}&data_fim=${end}`)
                .then(res => res.json())
                .then(data => {
                  const events = data.map(v => ({
                    id: v.id,
                    title: (v.motorista_nome ? v.motorista_nome : 'Viagem') + ' (' + v.tipo + ')',
                    start: v.data_saida,
                    end: v.data_retorno ? v.data_retorno : undefined
                  }));
                  successCallback(events);
                })
                .catch(err => {
                  console.error('Erro ao carregar eventos do calendário:', err);
                  failureCallback(err);
                });
            },
            dateClick: function (info) {
              // Poderíamos filtrar/mostrar viagens do dia clicado se desejado
            },
            eventClick: function (info) {
              // Ao clicar em um evento, abre modal de visualização da viagem correspondente
              const viagemId = info.event.id;
              openVisualizarViagemModal(parseInt(viagemId));
            }
          });
          calendar.render();
          calendarInitialized = true;
        }
      });
      // Ao abrir modais, inicializa mapas e rotas conforme necessário
      $('#modalNovaViagem').on('shown.bs.modal', function () {
        initMapNovaViagem();
      }).on('hidden.bs.modal', function () {
        document.getElementById('nova-viagem-form').reset();
        directionsRendererNova && directionsRendererNova.set('directions', null);
        document.getElementById('dataRetornoNova').setAttribute('disabled', 'disabled');
        document.getElementById('dataRetornoNova').required = false;
      });
      $('#modalEditarViagem').on('shown.bs.modal', function () {
        initMapEditarViagem();
        calculateRouteEditar(); // traça rota inicial com dados atuais
      }).on('hidden.bs.modal', function () {
        document.getElementById('editar-viagem-form').reset();
        directionsRendererEditar && directionsRendererEditar.set('directions', null);
      });
      $('#modalVisualizarViagem').on('shown.bs.modal', function () {
        initMapVisualizarViagem();
        calculateRouteVisualizar();
      }).on('hidden.bs.modal', function () {
        currentViagemVisualizar = null;
        directionsRendererVisualizar && directionsRendererVisualizar.set('directions', null);
      });
      // Botões "Traçar Rota" nos modais de Editar
      document.getElementById('calcRouteEditarBtn').addEventListener('click', calculateRouteEditar);
    });
  </script>
</body>
</html>
