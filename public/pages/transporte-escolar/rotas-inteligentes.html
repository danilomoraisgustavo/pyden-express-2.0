<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Rotas Inteligentes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
    <link rel="icon" href="/assets/img/pydenadmin/favicon.png" type="image/x-icon" />

    <!-- Webfont -->
    <script src="/assets/js/plugin/webfont/webfont.min.js"></script>
    <script>
        WebFont.load({
            google: { families: ["Public Sans:300,400,500,600,700"] },
            custom: {
                families: [
                    "Font Awesome 5 Solid",
                    "Font Awesome 5 Regular",
                    "Font Awesome 5 Brands",
                    "simple-line-icons"
                ],
                urls: ["/assets/css/fonts.min.css"]
            },
            active: function () {
                sessionStorage.fonts = true;
            }
        });
    </script>

    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/assets/css/plugins.min.css" />
    <link rel="stylesheet" href="/assets/css/pydenadmin.min.css" />
    <link rel="stylesheet" href="/assets/css/demo.css" />

    <!-- Google Maps JS Key -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCAwvAt4l0Pkb1c52FLUE-ttVxm4YZ9J8M"></script>

    <style>
        #mapInteligente {
            width: 100%;
            height: 500px;
        }
    </style>
</head>

<body>
    <div class="wrapper">
        <div class="sidebar" data-background-color="dark">
            <!-- ... sidebar content ... -->
        </div>

        <div class="main-panel">
            <div class="main-header" style="top: 0">
                <!-- ... top bar content ... -->
            </div>

            <div class="container">
                <div class="page-inner">

                    <div class="page-header">
                        <h3 class="fw-bold mb-3">Rotas Inteligentes</h3>
                        <ul class="breadcrumbs mb-3">
                            <li class="nav-home"><a href="../../"><i class="icon-home"></i></a></li>
                            <li class="separator"><i class="icon-arrow-right"></i></li>
                            <li class="nav-item"><a href="#">Rotas</a></li>
                            <li class="separator"><i class="icon-arrow-right"></i></li>
                            <li class="nav-item"><a href="#">Inteligentes</a></li>
                        </ul>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-5">
                            <label class="form-label">Selecione Escolas</label>
                            <select id="selectEscolas" class="form-select" multiple></select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Turno</label>
                            <select id="selectTurno" class="form-select">
                                <option value="manha">Manhã</option>
                                <option value="tarde">Tarde</option>
                                <option value="noite">Noite</option>
                            </select>
                        </div>
                        <div class="col-md-4 d-grid align-self-end">
                            <button id="btnGerarRota" class="btn btn-success">Gerar Rota Inteligente</button>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-body p-0">
                            <div id="mapInteligente"></div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title mb-0">Rotas Inteligentes Cadastradas</h4>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="tabelaRotasInteligentes" class="display table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Descrição</th>
                                            <th>Turno</th>
                                            <th>Veículo</th>
                                            <th>Alunos</th>
                                            <th>Capacidade</th>
                                            <th>Duração (min)</th>
                                            <th>Distância (km)</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <footer class="footer">
                <!-- ... footer ... -->
            </footer>
        </div>
    </div>

    <!-- Scripts JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
    <script src="/assets/js/pydenadmin.min.js"></script>
    <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>

    <script>
        let map;
        let selectedZoneamentos = [];
        let selectedPoints = [];
        let markers = [];
        let rotaPolyline;
        const schoolsLayerIds = [];

        function initMap() {
            map = new google.maps.Map(document.getElementById('mapInteligente'), {
                center: { lat: -3.7437, lng: -38.5267 },
                zoom: 12
            });
            map.data.setStyle({ fillColor: '#FFCC00', strokeColor: '#FF9900', clickable: true });
            map.data.addListener('click', event => {
                const zoneId = event.feature.getProperty('id');
                toggleZoneamentoSelection(zoneId, event.feature);
            });
        }

        function carregarEscolas() {
            fetch('/api/escolas')
                .then(res => res.json())
                .then(escolas => {
                    const sel = $('#selectEscolas').empty();
                    escolas.forEach(e => sel.append(`<option value="${e.id}">${e.nome}</option>`));
                });
        }

        function carregarZoneamentosParaEscolas(ids) {
            map.data.forEach(feature => map.data.remove(feature));
            selectedZoneamentos = [];
            selectedPoints = [];
            clearMarkers();

            ids.forEach(id => {
                fetch(`/api/zoneamentos?escolaId=${id}`)
                    .then(res => res.json())
                    .then(geojson => map.data.addGeoJson(geojson));
            });
        }

        function toggleZoneamentoSelection(zoneId, feature) {
            const idx = selectedZoneamentos.indexOf(zoneId);
            if (idx === -1) {
                selectedZoneamentos.push(zoneId);
                feature.setProperty('fillColor', '#00CC66');
                fetch(`/api/pontos/zoneamento/${zoneId}?status=ativo`)
                    .then(res => res.json())
                    .then(pontos => {
                        pontos.forEach(p => {
                            const m = new google.maps.Marker({
                                position: { lat: p.latitude, lng: p.longitude },
                                map,
                                label: ''
                            });
                            markers.push(m);
                            selectedPoints.push(p.id);
                        });
                    });
            } else {
                selectedZoneamentos.splice(idx, 1);
                feature.setProperty('fillColor', '#FFCC00');
                clearMarkers();
                selectedPoints = [];
                selectedZoneamentos.forEach(z => {
                    fetch(`/api/pontos/zoneamento/${z}?status=ativo`)
                        .then(res => res.json())
                        .then(pontos => {
                            pontos.forEach(p => {
                                const m = new google.maps.Marker({
                                    position: { lat: p.latitude, lng: p.longitude },
                                    map,
                                    label: ''
                                });
                                markers.push(m);
                                selectedPoints.push(p.id);
                            });
                        });
                });
            }
        }

        function clearMarkers() {
            markers.forEach(m => m.setMap(null));
            markers = [];
        }

        function buscarRotas() {
            fetch('/api/rotas-inteligentes')
                .then(res => res.json())
                .then(rotas => {
                    const table = $('#tabelaRotasInteligentes').DataTable();
                    table.clear();
                    rotas.forEach(r => {
                        table.row.add([
                            r.id,
                            r.descricao,
                            r.turno,
                            r.veiculo_tipo,
                            r.total_alunos,
                            r.capacidade,
                            r.duracao_min,
                            r.distancia_km.toFixed(2),
                            `
                              <button class="btn btn-sm btn-primary ver-rota" data-id="${r.id}">Ver</button>
                              <button class="btn btn-sm btn-danger excluir-rota" data-id="${r.id}">Excluir</button>
                            `
                        ]);
                    });
                    table.draw();
                });
        }

        function mostrarRotaNoMapa(id) {
            if (rotaPolyline) rotaPolyline.setMap(null);
            clearMarkers();
            fetch(`/api/rotas-inteligentes/${id}`)
                .then(res => res.json())
                .then(r => {
                    const path = r.pontos.map(p => ({ lat: p.lat, lng: p.lng }));
                    rotaPolyline = new google.maps.Polyline({ path, map });
                    r.pontos.forEach(p => {
                        const m = new google.maps.Marker({
                            position: { lat: p.lat, lng: p.lng },
                            map,
                            label: `${p.ordem}`
                        });
                        markers.push(m);
                    });
                });
        }

        function excluirRota(id) {
            if (!confirm('Confirma exclusão da rota?')) return;
            fetch(`/api/rotas-inteligentes/${id}`, { method: 'DELETE' })
                .then(() => socket.emit('rotasInvalidar'));
        }

        $(document).ready(() => {
            $('#tabelaRotasInteligentes').DataTable({ columnDefs: [{ orderable: false, targets: 8 }] });
            initMap();
            carregarEscolas();
            buscarRotas();

            socket = io();
            socket.on('rotasAtualizadas', buscarRotas);

            $('#selectEscolas').change(function () {
                const ids = $(this).val() || [];
                carregarZoneamentosParaEscolas(ids);
            });

            $('#btnGerarRota').click(() => {
                if (!selectedPoints.length) return alert('Selecione pelo menos um zoneamento e ponto ativo.');
                const escolaIds = $('#selectEscolas').val();
                const turno = $('#selectTurno').val();
                fetch('/api/rotas-inteligentes/criar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ escolaIds, pointIds: selectedPoints, turno })
                })
                    .then(res => res.json())
                    .then(r => {
                        if (r.success) {
                            alert(`Rota criada: ID ${r.rota.id}`);
                            socket.emit('rotasInvalidar');
                        } else {
                            alert('Erro: ' + r.error);
                        }
                    });
            });

            $('#tabelaRotasInteligentes tbody')
                .on('click', '.ver-rota', function () { mostrarRotaNoMapa($(this).data('id')); })
                .on('click', '.excluir-rota', function () { excluirRota($(this).data('id')); });
        });
    </script>
</body>

</html>