<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Rotas Inteligentes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
    <link rel="icon" href="/assets/img/pydenadmin/favicon.png" type="image/x-icon" />

    <!-- Webfont -->
    <script src="/assets/js/plugin/webfont/webfont.min.js"></script>
    <script>
        WebFont.load({
            google: { families: ["Public Sans:300,400,500,600,700"] },
            custom: {
                families: [
                    "Font Awesome 5 Solid",
                    "Font Awesome 5 Regular",
                    "Font Awesome 5 Brands",
                    "simple-line-icons"
                ],
                urls: ["/assets/css/fonts.min.css"]
            },
            active: function () {
                sessionStorage.fonts = true;
            }
        });
    </script>

    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/assets/css/plugins.min.css" />
    <link rel="stylesheet" href="/assets/css/pydenadmin.min.css" />
    <link rel="stylesheet" href="/assets/css/demo.css" />

    <!-- Google Maps JS Key -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCAwvAt4l0Pkb1c52FLUE-ttVxm4YZ9J8M"></script>

    <style>
        #mapInteligente {
            width: 100%;
            height: 500px;
        }
    </style>
</head>

<body>
    <div class="wrapper">
        <!-- ... sidebar e top bar inalterados ... -->

        <div class="main-panel">
            <!-- ... todo o conteúdo interno ... -->

            <!-- FOOTER ... -->
        </div>
    </div>

    <!-- ===== SCRIPTS ===== -->
    <!-- 1) jQuery primeiro -->
    <script src="/assets/js/core/jquery.min.js"></script>
    <!-- 2) Popper e Bootstrap -->
    <script src="/assets/js/core/popper.min.js"></script>
    <script src="/assets/js/core/bootstrap.min.js"></script>
    <!-- 3) DataTables (depende de jQuery e Bootstrap) -->
    <script src="/assets/js/plugin/datatables/datatables.min.js"></script>
    <script src="/assets/js/plugin/datatables/dataTables.bootstrap4.min.js"></script>
    <!-- 4) PyDenAdmin (depende de jQuery) -->
    <script src="/assets/js/pydenadmin.min.js"></script>
    <!-- 5) Socket.IO -->
    <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>

    <!-- 6) Seu script de inicialização -->
    <script>
        let map, socket, rotaPolyline;
        const markers = [];

        function initMap() {
            map = new google.maps.Map(document.getElementById('mapInteligente'), {
                center: { lat: -3.7437, lng: -38.5267 },
                zoom: 12
            });
        }

        function carregarZoneamentos() {
            fetch('/api/zoneamentos')
                .then(res => res.json())
                .then(data => {
                    const sel = $('#selectZoneamento').empty();
                    sel.append('<option value="">Selecione...</option>');
                    data.forEach(z => sel.append(`<option value="${z.id}">${z.nome}</option>`));
                });
        }

        function buscarRotas() {
            fetch('/api/rotas-inteligentes')
                .then(res => res.json())
                .then(rotas => {
                    const table = $('#tabelaRotasInteligentes').DataTable();
                    table.clear();
                    rotas.forEach(r => {
                        const m = (r.duracao_estimativa.match(/PT(\d+)M/) || [])[1] || 0;
                        table.row.add([
                            r.id, r.tipo, r.turno, r.veiculo_tipo, r.capacidade,
                            +m, r.distancia_total.toFixed(2),
                            r.escolas_ids.join(','), `
                <button class="btn btn-sm btn-primary ver-rota" data-id="${r.id}">Ver</button>
                <button class="btn btn-sm btn-danger excluir-rota" data-id="${r.id}">Excluir</button>
              `
                        ]);
                    });
                    table.draw();
                });
        }

        function mostrarRotaNoMapa(id) {
            if (rotaPolyline) rotaPolyline.setMap(null);
            markers.forEach(m => m.setMap(null));
            markers.length = 0;

            fetch(`/api/rotas-inteligentes/${id}`)
                .then(res => res.json())
                .then(obj => {
                    const path = obj.pontos.map(p => ({ lat: p.lat, lng: p.lng }));
                    rotaPolyline = new google.maps.Polyline({ path, map });
                    obj.pontos.forEach(p => {
                        const m = new google.maps.Marker({
                            position: { lat: p.lat, lng: p.lng },
                            map,
                            label: `${p.ordem}`
                        });
                        markers.push(m);
                    });
                    const bounds = new google.maps.LatLngBounds();
                    path.forEach(pt => bounds.extend(pt));
                    map.fitBounds(bounds);
                });
        }

        function excluirRota(id) {
            if (!confirm('Confirma exclusão da rota?')) return;
            fetch(`/api/rotas-inteligentes/${id}`, { method: 'DELETE' })
                .then(() => socket.emit('rotasInvalidar'));
        }

        $(document).ready(function () {
            $('#tabelaRotasInteligentes').DataTable({ columnDefs: [{ orderable: false, targets: 8 }] });

            initMap();
            carregarZoneamentos();
            buscarRotas();

            socket = io();
            socket.on('rotasAtualizadas', buscarRotas);

            $('#btnGerarRota').click(function () {
                const zoneId = +$('#selectZoneamento').val(), turno = $('#selectTurno').val();
                if (!zoneId) return alert('Selecione um zoneamento');
                $(this).prop('disabled', true).text('Gerando...');
                fetch('/api/rotas-inteligentes/criar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ zoneamentoId: zoneId, turno })
                })
                    .then(r => r.json())
                    .then(res => {
                        if (res.success) {
                            alert(`Rota criada: ID ${res.rota.id}`);
                            socket.emit('rotasInvalidar');
                        } else alert('Erro: ' + res.error);
                    })
                    .finally(() => {
                        $('#btnGerarRota').prop('disabled', false).text('Gerar Rota Inteligente');
                    });
            });

            $('#tabelaRotasInteligentes tbody')
                .on('click', '.ver-rota', function () { mostrarRotaNoMapa($(this).data('id')); })
                .on('click', '.excluir-rota', function () { excluirRota($(this).data('id')); });
        });
    </script>
</body>

</html>