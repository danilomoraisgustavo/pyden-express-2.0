<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Rotas Inteligentes</title>
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport" />
    <link rel="icon" href="../../assets/img/pydenadmin/favicon.png" type="image/x-icon" />

    <!-- Webfont -->
    <script src="../../assets/js/plugin/webfont/webfont.min.js"></script>
    <script>
        WebFont.load({
            google: { families: ["Public Sans:300,400,500,600,700"] },
            custom: {
                families: [
                    "Font Awesome 5 Solid",
                    "Font Awesome 5 Regular",
                    "Font Awesome 5 Brands",
                    "simple-line-icons",
                ],
                urls: ["../../assets/css/fonts.min.css"],
            },
            active: function () {
                sessionStorage.fonts = true;
            },
        });
    </script>

    <!-- CSS -->
    <link rel="stylesheet" href="../../assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="../../assets/css/plugins.min.css" />
    <link rel="stylesheet" href="../../assets/css/pydenadmin.min.css" />
    <link rel="stylesheet" href="../../assets/css/demo.css" />

    <style>
        .dataTables_wrapper .row>div:nth-child(2) {
            display: flex !important;
            justify-content: flex-end;
            align-items: center;
        }

        .dataTables_filter {
            margin: 0 !important;
        }

        .dataTables_filter label {
            display: flex;
            align-items: center;
            margin-bottom: 0;
        }

        .dataTables_filter input {
            margin-left: 0.5rem;
        }
    </style>
</head>

<body>
    <div class="wrapper">
        <!-- SIDEBAR (inalterado) -->
        <div class="sidebar" data-background-color="dark">
            <!-- ... todo o seu menu lateral permanece igual ... -->
        </div>
        <!-- END SIDEBAR -->

        <div class="main-panel">
            <div class="main-header" style="top: 0">
                <!-- ... header inalterado ... -->
            </div>

            <div class="container">
                <div class="page-inner">
                    <div class="page-header">
                        <h3 class="fw-bold mb-3">Rotas Inteligentes</h3>
                        <ul class="breadcrumbs mb-3">
                            <li class="nav-home"><a href="../../"><i class="icon-home"></i></a></li>
                            <li class="separator"><i class="icon-arrow-right"></i></li>
                            <li class="nav-item"><a href="#">Rotas</a></li>
                            <li class="separator"><i class="icon-arrow-right"></i></li>
                            <li class="nav-item"><a href="#">Inteligentes</a></li>
                        </ul>
                    </div>

                    <div class="row mb-3">
                        <div class="col text-end">
                            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalGerarRota">
                                <i class="fa fa-plus"></i> Nova Rota Inteligente
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="card-title mb-0">Rotas Geradas</h4>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table id="rotas-inteligentes-table"
                                            class="display table table-striped table-hover" style="width:100%">
                                            <thead>
                                                <tr>
                                                    <th>ID</th>
                                                    <th>Tipo</th>
                                                    <th>Turno</th>
                                                    <th>Veículo</th>
                                                    <th>Capacidade</th>
                                                    <th>Duração (min)</th>
                                                    <th>Distância (km)</th>
                                                    <th>Criada Em</th>
                                                    <th>Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- container -->

            <footer class="footer">
                <div class="container-fluid d-flex justify-content-between">
                    <nav class="pull-left">
                        <ul class="nav">
                            <li class="nav-item"><a class="nav-link" target="_blank"
                                    href="https://pydenexpress.com/">PyDen Express</a></li>
                            <li class="nav-item"><a class="nav-link" href="#">Ajuda</a></li>
                            <li class="nav-item"><a class="nav-link" href="#">Termos de Uso</a></li>
                        </ul>
                    </nav>
                    <div class="copyright">2025 &copy; Todos os direitos reservados</div>
                    <div>Desenvolvido por <a target="_blank" href="http://www.pyden.tech">PyDen Technologies</a>&reg;.
                    </div>
                </div>
            </footer>
        </div><!-- main-panel -->
    </div><!-- wrapper -->

    <!-- MODAL: Gerar Rota Inteligente -->
    <div class="modal fade" id="modalGerarRota" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Gerar Rota Inteligente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formGerarRota">
                        <div class="mb-3">
                            <label for="zoneamentoSelect" class="form-label">Zoneamento</label>
                            <select id="zoneamentoSelect" class="form-control" required></select>
                        </div>
                        <div class="mb-3">
                            <label for="turnoSelect" class="form-label">Turno</label>
                            <select id="turnoSelect" class="form-control" required>
                                <option value="manha">Manhã</option>
                                <option value="tarde">Tarde</option>
                                <option value="noite">Noite</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success">Gerar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: Visualizar Resumo da Rota -->
    <div class="modal fade" id="modalViewRota" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Resumo da Rota</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong>ID:</strong> <span id="view-id"></span></p>
                    <p><strong>Tipo:</strong> <span id="view-tipo"></span></p>
                    <p><strong>Turno:</strong> <span id="view-turno"></span></p>
                    <p><strong>Veículo:</strong> <span id="view-veiculo"></span></p>
                    <p><strong>Capacidade:</strong> <span id="view-capacidade"></span></p>
                    <p><strong>Duração:</strong> <span id="view-duracao"></span> min</p>
                    <p><strong>Distância:</strong> <span id="view-distancia"></span> km</p>
                </div>
            </div>
        </div>
    </div>

    <!-- JS CORE / PLUGINS -->
    <script src="../../assets/js/core/jquery-3.7.1.min.js"></script>
    <script src="../../assets/js/core/popper.min.js"></script>
    <script src="../../assets/js/core/bootstrap.min.js"></script>
    <script src="../../assets/js/plugin/bootstrap-notify/bootstrap-notify.min.js"></script>
    <script src="../../assets/js/plugin/datatables/datatables.min.js"></script>
    <script src="../../assets/js/pydenadmin.min.js"></script>

    <script>
        function showNotification(type, message) {
            const icon = { success: 'fa fa-check-circle', danger: 'fa fa-exclamation-circle' }[type] || 'fa fa-bell';
            $.notify({ icon, message }, { type, placement: { from: 'top', align: 'right' } });
        }

        // Carrega zoneamentos no select
        function loadZoneamentos() {
            fetch('/api/zoneamentos')
                .then(r => r.json())
                .then(zs => {
                    const sel = $('#zoneamentoSelect').empty();
                    zs.forEach(z => sel.append(`<option value="${z.id}">${z.nome}</option>`));
                })
                .catch(() => showNotification('danger', 'Erro ao carregar zoneamentos'));
        }

        // Gera nova rota inteligente
        $('#formGerarRota').on('submit', e => {
            e.preventDefault();
            const zoneamentoId = +$('#zoneamentoSelect').val();
            const turno = $('#turnoSelect').val();
            fetch('/api/rotas-inteligentes/criar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ zoneamentoId, turno })
            })
                .then(r => r.json())
                .then(d => {
                    if (d.success) {
                        showNotification('success', 'Rota gerada (ID ' + d.rota.id + ')');
                        $('#modalGerarRota').modal('hide');
                        loadRotasInteligentes();
                    } else showNotification('danger', d.error || 'Erro');
                })
                .catch(() => showNotification('danger', 'Erro ao gerar rota'));
        });

        // Lista todas as rotas inteligentes
        let rotasTable;
        function loadRotasInteligentes() {
            fetch('/api/rotas-inteligentes')
                .then(r => r.json())
                .then(rs => {
                    const tbody = $('#rotas-inteligentes-table tbody').empty();
                    rs.forEach(rt => {
                        tbody.append(`
              <tr>
                <td>${rt.id}</td>
                <td>${rt.tipo}</td>
                <td>${rt.turno}</td>
                <td>${rt.veiculo_tipo}</td>
                <td>${rt.capacidade}</td>
                <td>${rt.duracao_estimativa.match(/PT(\d+)M/)[1]}</td>
                <td>${rt.distancia_total.toFixed(2)}</td>
                <td>${new Date(rt.created_at).toLocaleString()}</td>
                <td>
                  <button class="btn btn-link btn-primary" onclick="viewRota(${rt.id})">
                    <i class="fa fa-eye"></i>
                  </button>
                  <button class="btn btn-link btn-danger" onclick="deleteRota(${rt.id})">
                    <i class="fa fa-trash"></i>
                  </button>
                </td>
              </tr>
            `);
                    });
                    if (rotasTable) rotasTable.destroy();
                    rotasTable = $('#rotas-inteligentes-table').DataTable({
                        pageLength: 10,
                        language: {
                            decimal: ',', thousands: '.',
                            info: "_START_–_END_ de _TOTAL_",
                            lengthMenu: "Mostrar _MENU_",
                            search: "Pesquisar:",
                            paginate: { first: "Primeiro", last: "Último", next: "Próximo", previous: "Anterior" },
                            emptyTable: "Nenhuma rota"
                        }
                    });
                })
                .catch(() => showNotification('danger', 'Erro ao carregar rotas'));
        }

        // Exclui uma rota
        function deleteRota(id) {
            if (!confirm('Confirmar exclusão?')) return;
            fetch('/api/rotas-inteligentes/' + id, { method: 'DELETE' })
                .then(r => r.json())
                .then(d => {
                    if (d.success) { showNotification('success', 'Rota excluída'); loadRotasInteligentes(); }
                    else showNotification('danger', d.error || 'Erro');
                })
                .catch(() => showNotification('danger', 'Erro ao excluir'));
        }

        // Mostra modal de visualização
        function viewRota(id) {
            fetch('/api/rotas-inteligentes')
                .then(r => r.json())
                .then(rs => {
                    const rt = rs.find(x => x.id === id);
                    if (!rt) return showNotification('warning', 'Rota não encontrada');
                    $('#view-id').text(rt.id);
                    $('#view-tipo').text(rt.tipo);
                    $('#view-turno').text(rt.turno);
                    $('#view-veiculo').text(rt.veiculo_tipo);
                    $('#view-capacidade').text(rt.capacidade);
                    $('#view-duracao').text(rt.duracao_estimativa.match(/PT(\d+)M/)[1]);
                    $('#view-distancia').text(rt.distancia_total.toFixed(2));
                    $('#modalViewRota').modal('show');
                });
        }

        $(document).ready(() => {
            loadZoneamentos();
            loadRotasInteligentes();
        });
    </script>
</body>

</html>