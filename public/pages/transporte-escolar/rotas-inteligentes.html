<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Rotas Inteligentes</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
    <link rel="icon" href="/assets/img/pydenadmin/favicon.png" type="image/x-icon" />

    <!-- Webfont -->
    <script src="/assets/js/plugin/webfont/webfont.min.js"></script>
    <script>
        WebFont.load({
            google: { families: ["Public Sans:300,400,500,600,700"] },
            custom: {
                families: [
                    "Font Awesome 5 Solid",
                    "Font Awesome 5 Regular",
                    "Font Awesome 5 Brands",
                    "simple-line-icons"
                ],
                urls: ["/assets/css/fonts.min.css"]
            },
            active: function () {
                sessionStorage.fonts = true;
            }
        });
    </script>

    <!-- CSS -->
    <link rel="stylesheet" href="/assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/assets/css/plugins.min.css" />
    <link rel="stylesheet" href="/assets/css/pydenadmin.min.css" />
    <link rel="stylesheet" href="/assets/css/demo.css" />

    <!-- Google Maps JS Key -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCAwvAt4l0Pkb1c52FLUE-ttVxm4YZ9J8M"></script>

    <style>
        /* Ajuste de legenda ou estilos específicos, se necessário */
        #mapInteligente {
            width: 100%;
            height: 500px;
        }
    </style>
</head>

<body>
    <div class="wrapper">
        <!-- SIDEBAR (mesmo do rotas-listar.html) -->
        <div class="sidebar" data-background-color="dark">
            <!-- ... todo o conteúdo da sidebar ... -->
        </div>
        <!-- END SIDEBAR -->

        <div class="main-panel">
            <!-- TOP BAR (mesmo do rotas-listar.html) -->
            <div class="main-header" style="top: 0">
                <!-- logo, toggles, notificações, user menu ... -->
            </div>

            <div class="container">
                <div class="page-inner">

                    <!-- Cabeçalho da página -->
                    <div class="page-header">
                        <h3 class="fw-bold mb-3">Rotas Inteligentes</h3>
                        <ul class="breadcrumbs mb-3">
                            <li class="nav-home"><a href="../../"><i class="icon-home"></i></a></li>
                            <li class="separator"><i class="icon-arrow-right"></i></li>
                            <li class="nav-item"><a href="#">Rotas</a></li>
                            <li class="separator"><i class="icon-arrow-right"></i></li>
                            <li class="nav-item"><a href="#">Inteligentes</a></li>
                        </ul>
                    </div>

                    <!-- Seletor de parâmetros -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Zoneamento</label>
                            <select id="selectZoneamento" class="form-select"></select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Turno</label>
                            <select id="selectTurno" class="form-select">
                                <option value="manha">Manhã</option>
                                <option value="tarde">Tarde</option>
                                <option value="noite">Noite</option>
                            </select>
                        </div>
                        <div class="col-md-4 d-grid align-self-end">
                            <button id="btnGerarRota" class="btn btn-success">Gerar Rota Inteligente</button>
                        </div>
                    </div>

                    <!-- Mapa -->
                    <div class="card mb-4">
                        <div class="card-body p-0">
                            <div id="mapInteligente"></div>
                        </div>
                    </div>

                    <!-- Tabela de rotas -->
                    <div class="card">
                        <div class="card-header">
                            <h4 class="card-title mb-0">Rotas Inteligentes Cadastradas</h4>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table id="tabelaRotasInteligentes" class="display table table-striped table-hover">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Tipo</th>
                                            <th>Turno</th>
                                            <th>Veículo</th>
                                            <th>Capacidade</th>
                                            <th>Duração (min)</th>
                                            <th>Distância (km)</th>
                                            <th>Escolas</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- FOOTER (mesmo do rotas-listar.html) -->
            <footer class="footer">
                <!-- ... rodapé ... -->
            </footer>
        </div>
    </div>

    <!-- Scripts JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
    <script src="/assets/js/pydenadmin.min.js"></script>
    <script src="https://cdn.socket.io/4.5.1/socket.io.min.js"></script>

    <script>
        let map, socket, rotaPolyline;
        const markers = [];

        // Inicializa o mapa
        function initMap() {
            map = new google.maps.Map(document.getElementById('mapInteligente'), {
                center: { lat: -3.7437, lng: -38.5267 },
                zoom: 12
            });
        }

        // Carrega zoneamentos no dropdown
        function carregarZoneamentos() {
            fetch('/api/zoneamentos')
                .then(res => res.json())
                .then(data => {
                    const sel = $('#selectZoneamento').empty();
                    sel.append('<option value="">Selecione...</option>');
                    data.forEach(z => {
                        sel.append(`<option value="${z.id}">${z.nome}</option>`);
                    });
                });
        }

        // Busca e renderiza a tabela de rotas
        function buscarRotas() {
            fetch('/api/rotas-inteligentes')
                .then(res => res.json())
                .then(rotas => {
                    const table = $('#tabelaRotasInteligentes').DataTable();
                    table.clear();
                    rotas.forEach(r => {
                        // Extrai minutos de PTxxM
                        const match = (r.duracao_estimativa || '').match(/PT(\d+)M/);
                        const mins = match ? +match[1] : 0;
                        table.row.add([
                            r.id,
                            r.tipo,
                            r.turno,
                            r.veiculo_tipo,
                            r.capacidade,
                            mins,
                            r.distancia_total.toFixed(2),
                            r.escolas_ids.join(','),
                            `
                <button class="btn btn-sm btn-primary ver-rota" data-id="${r.id}">Ver</button>
                <button class="btn btn-sm btn-danger excluir-rota" data-id="${r.id}">Excluir</button>
              `
                        ]);
                    });
                    table.draw();
                });
        }

        // Mostra a rota no mapa
        function mostrarRotaNoMapa(id) {
            if (rotaPolyline) rotaPolyline.setMap(null);
            markers.forEach(m => m.setMap(null));
            markers.length = 0;

            fetch(`/api/rotas-inteligentes/${id}`)
                .then(res => res.json())
                .then(obj => {
                    const path = obj.pontos.map(p => ({ lat: p.lat, lng: p.lng }));
                    rotaPolyline = new google.maps.Polyline({ path, map });
                    obj.pontos.forEach(p => {
                        const m = new google.maps.Marker({
                            position: { lat: p.lat, lng: p.lng },
                            map,
                            label: `${p.ordem}`
                        });
                        markers.push(m);
                    });
                    const bounds = new google.maps.LatLngBounds();
                    path.forEach(pt => bounds.extend(pt));
                    map.fitBounds(bounds);
                });
        }

        // Exclui rota via API
        function excluirRota(id) {
            if (!confirm('Confirma exclusão da rota?')) return;
            fetch(`/api/rotas-inteligentes/${id}`, { method: 'DELETE' })
                .then(() => {
                    socket.emit('rotasInvalidar');
                });
        }

        $(document).ready(function () {
            $('#tabelaRotasInteligentes').DataTable({
                columnDefs: [{ orderable: false, targets: 8 }]
            });

            initMap();
            carregarZoneamentos();
            buscarRotas();

            socket = io();
            socket.on('rotasAtualizadas', buscarRotas);

            $('#btnGerarRota').click(function () {
                const zoneId = +$('#selectZoneamento').val();
                const turno = $('#selectTurno').val();
                if (!zoneId) { alert('Selecione um zoneamento'); return; }
                $(this).prop('disabled', true).text('Gerando...');
                fetch('/api/rotas-inteligentes/criar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ zoneamentoId: zoneId, turno })
                })
                    .then(res => res.json())
                    .then(res => {
                        if (res.success) {
                            alert(`Rota criada: ID ${res.rota.id}`);
                            socket.emit('rotasInvalidar');
                        } else {
                            alert('Erro: ' + res.error);
                        }
                    })
                    .finally(() => {
                        $('#btnGerarRota').prop('disabled', false).text('Gerar Rota Inteligente');
                    });
            });

            $('#tabelaRotasInteligentes tbody')
                .on('click', 'button.ver-rota', function () {
                    mostrarRotaNoMapa($(this).data('id'));
                })
                .on('click', 'button.excluir-rota', function () {
                    excluirRota($(this).data('id'));
                });
        });
    </script>
</body>

</html>