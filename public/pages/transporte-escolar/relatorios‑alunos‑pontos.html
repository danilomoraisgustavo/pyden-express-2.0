<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Relatório Alunos x Pontos</title>
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport">
    <link rel="icon" href="../../assets/img/pydenadmin/favicon.png" type="image/x-icon">
    <script src="../../assets/js/plugin/webfont/webfont.min.js"></script>
    <script>
        WebFont.load({
            google: { families: ["Public Sans:300,400,500,600,700"] },
            custom: {
                families: ["Font Awesome 5 Solid", "Font Awesome 5 Regular",
                    "Font Awesome 5 Brands", "simple-line-icons"],
                urls: ["../../assets/css/fonts.min.css"]
            },
            active: function () { sessionStorage.fonts = true; }
        });
    </script>
    <link rel="stylesheet" href="../../assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="../../assets/css/plugins.min.css">
    <link rel="stylesheet" href="../../assets/css/pydenadmin.min.css">
    <link rel="stylesheet" href="../../assets/css/demo.css">
</head>

<body>
    <div class="wrapper">
        <!-- === Sidebar & header: copie exatamente como nas outras páginas === -->
        <!-- (para economizar espaço aqui, basta duplicar o markup que você já usa) -->

        <div class="main-panel">
            <div class="main-header" style="top:0;">
                <!-- logo + togglers: igual às demais páginas -->
            </div>

            <div class="container">
                <div class="page-inner">
                    <div class="page-header">
                        <h3 class="fw-bold mb-3">Relatório – Alunos x Pontos de Parada</h3>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex flex-wrap gap-2 mb-3">
                                <button id="btnExportCsv" class="btn btn-success">Exportar CSV</button>
                                <button id="btnExportExcel" class="btn btn-primary">Exportar Excel</button>
                            </div>

                            <div class="table-responsive">
                                <table id="relatorio-table" class="display table table-striped table-hover"
                                    style="width:100%">
                                    <thead>
                                        <tr>
                                            <th>Nome do Aluno</th>
                                            <th>ID Pessoa</th>
                                            <th>ID Matrícula</th>
                                            <th>Escola</th>
                                            <th>ID Ponto</th>
                                            <th>Residência (lat,lng)</th>
                                            <th>Ponto (lat,lng)</th>
                                        </tr>
                                    </thead>
                                    <tfoot>
                                        <tr>
                                            <th>Nome do Aluno</th>
                                            <th>ID Pessoa</th>
                                            <th>ID Matrícula</th>
                                            <th>Escola</th>
                                            <th>ID Ponto</th>
                                            <th>Residência (lat,lng)</th>
                                            <th>Ponto (lat,lng)</th>
                                        </tr>
                                    </tfoot>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <footer class="footer">
                <div class="container-fluid d-flex justify-content-between">
                    <nav class="pull-left">
                        <ul class="nav">
                            <li class="nav-item"><a class="nav-link" href="#">PyDen Express</a></li>
                        </ul>
                    </nav>
                    <div class="copyright">2025 © PyDen Technologies</div>
                </div>
            </footer>
        </div>
    </div>

    <script src="../../assets/js/core/jquery-3.7.1.min.js"></script>
    <script src="../../assets/js/core/bootstrap.min.js"></script>
    <script src="../../assets/js/plugin/datatables/datatables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

    <script>
        let relatorioData = [];

        function loadRelatorio() {
            fetch('/api/relatorios/alunos-pontos')
                .then(r => r.json())
                .then(data => {
                    relatorioData = data;
                    const tbody = $('#relatorio-table tbody'); tbody.empty();
                    data.forEach(r => {
                        tbody.append(`<tr>
            <td>${r.nome_aluno || ''}</td>
            <td>${r.id_pessoa || ''}</td>
            <td>${r.id_matricula || ''}</td>
            <td>${r.escola_nome || ''}</td>
            <td>${r.ponto_id || ''}</td>
            <td>${r.residencia_coords || ''}</td>
            <td>${r.ponto_coords || ''}</td>
          </tr>`);
                    });
                    if ($.fn.DataTable.isDataTable('#relatorio-table'))
                        $('#relatorio-table').DataTable().destroy();
                    $('#relatorio-table').DataTable({
                        pageLength: 25,
                        language: {
                            decimal: ",", thousands: ".",
                            info: "Mostrando _START_ até _END_ de _TOTAL_ registros",
                            infoEmpty: "Mostrando 0 até 0 de 0 registros",
                            infoFiltered: "(filtrado de _MAX_ registros no total)",
                            lengthMenu: "Mostrar _MENU_ registros",
                            loadingRecords: "Carregando...",
                            processing: "Processando...",
                            search: "Pesquisar:",
                            zeroRecords: "Nenhum registro encontrado",
                            paginate: { first: "Primeiro", last: "Último", next: "Próximo", previous: "Anterior" },
                            emptyTable: "Nenhum dado disponível na tabela"
                        }
                    });
                })
                .catch(() => alert('Erro ao carregar relatório'));
        }

        function exportCsv() {
            window.location = '/api/relatorios/alunos-pontos?format=csv';
        }

        function exportExcel() {
            const ws = XLSX.utils.json_to_sheet(relatorioData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Relatorio');
            XLSX.writeFile(wb, 'relatorio_alunos_pontos.xlsx');
        }

        $(document).ready(function () {
            loadRelatorio();
            $('#btnExportCsv').on('click', exportCsv);
            $('#btnExportExcel').on('click', exportExcel);
        });
    </script>
</body>

</html>