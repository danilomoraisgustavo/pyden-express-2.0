<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Definir Rota</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no" />
  <link rel="icon" href="../../assets/img/pydenadmin/favicon.png" type="image/x-icon" />

  <!-- Webfont -->
  <script src="../../assets/js/plugin/webfont/webfont.min.js"></script>
  <script>
    WebFont.load({
      google: { families: ["Public Sans:300,400,500,600,700"] },
      custom: {
        families: [
          "Font Awesome 5 Solid",
          "Font Awesome 5 Regular",
          "Font Awesome 5 Brands",
          "simple-line-icons"
        ],
        urls: ["../../assets/css/fonts.min.css"]
      },
      active: () => sessionStorage.fonts = true
    });
  </script>

  <!-- CSS -->
  <link rel="stylesheet" href="../../assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="../../assets/css/plugins.min.css" />
  <link rel="stylesheet" href="../../assets/css/pydenadmin.min.css" />
  <link rel="stylesheet" href="../../assets/css/demo.css" />

  <!-- Google Maps JS Key (se for usar mapa mais tarde) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY"></script>

  <style>
    /* Pequenos ajustes de layout */
    #itinerariosTable th,
    #itinerariosTable td {
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="wrapper">
    <!-- SIDEBAR (usando seu template) -->
    <div class="sidebar" data-background-color="dark">
      <div class="sidebar-logo">
        <div class="logo-header" data-background-color="dark">
          <a href="../../pages/transporte-escolar/dashboard-escolar.html" class="logo">
            <img src="../../assets/img/pydenadmin/logo_light.png" alt="navbar brand" height="20" />
          </a>
          <div class="nav-toggle">
            <button class="btn btn-toggle toggle-sidebar"><i class="gg-menu-right"></i></button>
            <button class="btn btn-toggle sidenav-toggler"><i class="gg-menu-left"></i></button>
          </div>
          <button class="topbar-toggler more"><i class="gg-more-vertical-alt"></i></button>
        </div>
      </div>
      <div class="sidebar-wrapper scrollbar-inner">
        <div class="sidebar-content">
          <ul class="nav nav-secondary">
            <li class="nav-section">
              <span class="sidebar-mini-icon"><i class="fa fa-ellipsis-h"></i></span>
              <h4 class="text-section">Transporte Escolar</h4>
            </li>
            <!-- ... copiar demais itens do menu conforme modelo ... -->
            <li class="nav-item active">
              <a href="#">
                <i class="fas fa-route"></i>
                <p>Definir Rotas</p>
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <!-- END SIDEBAR -->

    <div class="main-panel">
      <!-- HEADER -->
      <div class="main-header" style="top: 0;">
        <nav class="navbar navbar-header navbar-header-transparent navbar-expand-lg border-bottom">
          <div class="container-fluid">
            <!-- Ícones de mensagens, notificações, usuário ... (copiar conforme modelo) -->
          </div>
        </nav>
      </div>

      <!-- CONTEÚDO PRINCIPAL -->
      <div class="container">
        <div class="page-inner">
          <div class="page-header">
            <h3 class="fw-bold mb-3">Definir Rotas</h3>
            <ul class="breadcrumbs mb-3">
              <li class="nav-home"><a href="../../"><i class="icon-home"></i></a></li>
              <li class="separator"><i class="icon-arrow-right"></i></li>
              <li class="nav-item"><a href="#">Rotas</a></li>
              <li class="separator"><i class="icon-arrow-right"></i></li>
              <li class="nav-item"><a href="#">Definir</a></li>
            </ul>
          </div>

          <div class="row">
            <div class="col-md-12">
              <div class="card">
                <div class="card-body">
                  <!-- FORMULÁRIO UNIFICADO -->
                  <form id="rotaForm" class="row g-3">
                    <div class="col-md-4">
                      <label for="escolaSelect" class="form-label">Escola</label>
                      <select id="escolaSelect" class="form-select" required>
                        <option value="">Selecione...</option>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label for="zoneamentoSelect" class="form-label">Zoneamentos</label>
                      <select id="zoneamentoSelect" class="form-select" multiple required>
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label for="pontoSelect" class="form-label">Pontos de Parada</label>
                      <select id="pontoSelect" class="form-select" multiple required>
                      </select>
                    </div>
                    <div class="col-12 text-end">
                      <button type="button" id="addItinerario" class="btn btn-secondary">
                        <i class="fa fa-plus"></i> Adicionar Itinerário
                      </button>
                    </div>
                  </form>

                  <!-- TABELA DE ITINERÁRIOS -->
                  <div class="table-responsive mt-4">
                    <table id="itinerariosTable" class="table table-striped table-hover">
                      <thead class="thead-light">
                        <tr>
                          <th>Linha</th>
                          <th>Zoneamento</th>
                          <th>Pontos</th>
                          <th>Manhã</th>
                          <th>Tarde</th>
                          <th>Noite</th>
                          <th>Integral</th>
                          <th>Veículo</th>
                        </tr>
                      </thead>
                      <tbody></tbody>
                    </table>
                  </div>

                  <div class="text-end mt-3">
                    <button id="saveRota" class="btn btn-primary">
                      <i class="fa fa-save"></i> Salvar Rota
                    </button>
                  </div>
                  <!-- FIM DO FORMULÁRIO -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div><!-- fim container -->

      <!-- FOOTER -->
      <footer class="footer">
        <div class="container-fluid d-flex justify-content-between">
          <nav class="pull-left">
            <ul class="nav">
              <li class="nav-item"><a class="nav-link" href="https://pydenexpress.com/">PyDen Express</a></li>
              <li class="nav-item"><a class="nav-link" href="#">Ajuda</a></li>
              <li class="nav-item"><a class="nav-link" href="#">Termos de Uso</a></li>
            </ul>
          </nav>
          <div class="copyright">2025 &copy; Todos os direitos reservados</div>
          <div>Desenvolvido por <a href="http://www.pyden.tech" target="_blank">PyDen Technologies</a>&reg;</div>
        </div>
      </footer>
    </div><!-- fim main-panel -->
  </div><!-- fim wrapper -->

  <!-- JS CORE / PLUGINS -->
  <script src="../../assets/js/core/jquery-3.7.1.min.js"></script>
  <script src="../../assets/js/core/popper.min.js"></script>
  <script src="../../assets/js/core/bootstrap.min.js"></script>
  <script src="../../assets/js/plugin/bootstrap-notify/bootstrap-notify.min.js"></script>

  <script>
    // Função para notificações iguais ao template
    function showNotification(type, message) {
      const icons = {
        success: "fa fa-check-circle",
        danger: "fa fa-exclamation-circle",
        warning: "fa fa-exclamation-triangle",
        info: "fa fa-info-circle"
      };
      $.notify({ icon: icons[type], message }, {
        type, placement: { from: "top", align: "right" },
        delay: 2500, animate: { enter: "animated fadeInDown", exit: "animated fadeOutUp" }
      });
    }

    // Lógica principal
    document.addEventListener("DOMContentLoaded", () => {
      const escolaSelect = $("#escolaSelect");
      const zoneSelect = $("#zoneamentoSelect");
      const pontoSelect = $("#pontoSelect");
      const itinerarios = [];
      const tbody = $("#itinerariosTable tbody");

      // Carregar escolas e seus zoneamentos
      fetch("/api/escolas")
        .then(r => r.json())
        .then(data => {
          data.forEach(e => escolaSelect.append(`<option value="${e.id}">${e.nome}</option>`));
          // guardar zoneamentos dentro de cada opção
          escolaSelect.data("escolas", data);
        })
        .catch(() => showNotification("danger", "Erro ao carregar escolas."));

      // Ao mudar escola
      escolaSelect.on("change", () => {
        zoneSelect.empty();
        pontoSelect.empty();
        const id = +escolaSelect.val();
        if (!id) return;
        const escola = escolaSelect.data("escolas").find(e => e.id === id);
        escola.zoneamentos.forEach(z =>
          zoneSelect.append(`<option value="${z.id}">${z.nome}</option>`));
      });

      // Ao mudar zoneamentos
      zoneSelect.on("change", async () => {
        pontoSelect.empty();
        const vals = zoneSelect.val() || [];
        let pontos = [];
        for (let zid of vals) {
          const resp = await fetch(`/api/zoneamentos/${zid}/pontos`);
          pontos = pontos.concat(await resp.json());
        }
        // eliminar duplicados
        const seen = new Set();
        pontos.forEach(p => {
          if (!seen.has(p.id)) {
            seen.add(p.id);
            pontoSelect.append(`<option value="${p.id}">${p.nome_ponto}</option>`);
          }
        });
      });

      // Adicionar itinerário
      $("#addItinerario").click(async () => {
        const zid = +zoneSelect.val();
        const ztxt = zoneSelect.find(":selected").text();
        const pids = pontoSelect.val().map(v => +v);
        const ptxt = pontoSelect.find(":selected").map((i, o) => o.text).get().join(", ");

        // calcular alunos por turno
        const counts = { manha: 0, tarde: 0, noite: 0, integral: 0 };
        for (let pid of pids) {
          const { manha, tarde, noite, integral } = await fetch(`/api/pontos/${pid}/alunos-count`).then(r => r.json());
          counts.manha += manha;
          counts.tarde += tarde;
          counts.noite += noite;
          counts.integral += integral;
        }

        const cap = prompt("Capacidade do veículo?", "50");
        const linha = prompt("Identificador da linha (ex: A)?", "A");

        itinerarios.push({ zoneamentoId: zid, pontoIds: pids, alunosCount: counts, veiculoCapacidade: +cap, linha });
        tbody.append(`
          <tr>
            <td>${linha}</td><td>${ztxt}</td><td>${ptxt}</td>
            <td>${counts.manha}</td><td>${counts.tarde}</td>
            <td>${counts.noite}</td><td>${counts.integral}</td>
            <td>${cap}</td>
          </tr>`);
      });

      // Salvar rota
      $("#saveRota").click(() => {
        const escolaId = +escolaSelect.val();
        if (!escolaId || itinerarios.length === 0) {
          showNotification("warning", "Selecione escola e adicione pelo menos um itinerário.");
          return;
        }
        fetch("/api/rotas-criar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ escolaId, itinerarios })
        })
          .then(r => r.ok ? showNotification("success", "Rota criada!") : showNotification("danger", "Falha ao criar rota."))
          .catch(() => showNotification("danger", "Erro de comunicação."));
      });
    });
  </script>
</body>

</html>