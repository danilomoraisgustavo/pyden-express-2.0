<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>Cadastro de Aluno</title>
</head>

<body>
    <h1>Cadastro de Aluno</h1>
    <form id="formAluno">
        <label for="nome">Nome:</label>
        <input type="text" id="nome" name="nome" required />

        <label for="cpf">CPF:</label>
        <input type="text" id="cpf" name="cpf" />

        <label for="escola_id">Escola (ID):</label>
        <input type="number" id="escola_id" name="escola_id" required />

        <label for="cep">CEP:</label>
        <input type="text" id="cep" name="cep" required />

        <label for="numero">Número da residência:</label>
        <input type="text" id="numero" name="numero" required />

        <label for="cidade">Cidade:</label>
        <input type="text" id="cidade" name="cidade" value="Canaã dos Carajás" required />

        <label for="estado">Estado:</label>
        <input type="text" id="estado" name="estado" value="Pará" required />

        <label for="pais">País:</label>
        <input type="text" id="pais" name="pais" value="Brasil" required />

        <button type="button" onclick="handleSubmit()">Salvar</button>
    </form>

    <script>
        async function handleSubmit() {
            const form = document.getElementById('formAluno');

            // Coleta dados do formulário
            const nome = form.nome.value;
            const cpf = form.cpf.value;
            const escola_id = form.escola_id.value;
            const cep = form.cep.value;
            const numero = form.numero.value;
            const cidade = form.cidade.value;
            const estado = form.estado.value;
            const pais = form.pais.value;

            // Monta o endereço completo
            const enderecoCompleto = `${cep}, ${numero}, ${cidade}, ${estado}, ${pais}`;

            try {
                // 1) Obter latitude e longitude via Geocoding (Google Maps)
                const geocodeUrl = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(enderecoCompleto)}&key=AIzaSyCAwvAt4l0Pkb1c52FLUE-ttVxm4YZ9J8M`;

                const response = await fetch(geocodeUrl);
                const data = await response.json();

                if (data.status !== 'OK') {
                    alert('Erro ao obter coordenadas. Verifique o endereço ou a chave da API.');
                    return;
                }

                // Pega o primeiro resultado
                const result = data.results[0];
                const { lat, lng } = result.geometry.location;

                // 2) Enviar dados para o servidor (Node.js) via fetch POST
                const payload = {
                    nome,
                    cpf,
                    escola_id,
                    cep,
                    numero,
                    cidade,
                    estado,
                    pais,
                    latitude: lat,
                    longitude: lng
                };

                const backendResponse = await fetch('/alunos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const resultServer = await backendResponse.json();
                if (backendResponse.ok) {
                    alert(`Aluno salvo com sucesso! ID do aluno: ${resultServer.alunoId}`);
                } else {
                    alert(`Erro ao salvar aluno: ${resultServer.message}`);
                }
            } catch (error) {
                console.error(error);
                alert('Ocorreu um erro ao processar o cadastro.');
            }
        }

    </script>
</body>

</html>