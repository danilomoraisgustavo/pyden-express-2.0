<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Atribuição de Alunos a Rotas</title>
</head>

<body>
    <h1>Atribuição de Alunos a Rotas</h1>

    <label for="escolaSelect">Selecione a Escola:</label>
    <select id="escolaSelect"></select>
    <button id="buscaAlunosBtn">Buscar Alunos</button>

    <h2>Alunos</h2>
    <div id="alunosContainer"></div>

    <script>
        // Carregar combo de Escolas
        const escolaSelect = document.getElementById("escolaSelect");
        const alunosContainer = document.getElementById("alunosContainer");
        const buscaAlunosBtn = document.getElementById("buscaAlunosBtn");

        // Assim que a página carrega, buscar as escolas
        window.addEventListener("load", () => {
            fetch("/api/escolas")
                .then((res) => res.json())
                .then((escolas) => {
                    escolas.forEach((escola) => {
                        const option = document.createElement("option");
                        option.value = escola.id;
                        option.textContent = escola.nome;
                        escolaSelect.appendChild(option);
                    });
                })
                .catch((error) => {
                    console.error("Erro ao carregar escolas:", error);
                });
        });

        // Buscar alunos da escola selecionada
        buscaAlunosBtn.addEventListener("click", () => {
            const escolaId = escolaSelect.value;
            if (!escolaId) {
                alert("Selecione uma escola!");
                return;
            }

            fetch(`/api/alunos?escolaId=${escolaId}`)
                .then((res) => res.json())
                .then((alunos) => {
                    // Limpa container
                    alunosContainer.innerHTML = "";

                    if (alunos.length === 0) {
                        alunosContainer.innerHTML = "<p>Nenhum aluno encontrado.</p>";
                        return;
                    }

                    alunos.forEach((aluno) => {
                        const divAluno = document.createElement("div");
                        divAluno.style.border = "1px solid #ccc";
                        divAluno.style.margin = "5px";
                        divAluno.style.padding = "5px";

                        divAluno.innerHTML = `
                <p><strong>Nome:</strong> ${aluno.pessoa_nome}</p>
                <p><strong>CPF:</strong> ${aluno.cpf}</p>
                <p><strong>CEP:</strong> ${aluno.cep}</p>
                <p><strong>Endereço (número):</strong> ${aluno.numero_pessoa_endereco}</p>
              `;

                        const btnAtribuir = document.createElement("button");
                        btnAtribuir.textContent = "Atribuir Rota";
                        btnAtribuir.addEventListener("click", () => {
                            atribuirRotaParaAluno(aluno.id);
                        });

                        divAluno.appendChild(btnAtribuir);
                        alunosContainer.appendChild(divAluno);
                    });
                })
                .catch((error) => {
                    console.error("Erro ao buscar alunos:", error);
                });
        });

        // Chama o endpoint para atribuir rota ao aluno
        function atribuirRotaParaAluno(alunoId) {
            fetch("/api/atribuir", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ alunoId }),
            })
                .then((res) => res.json())
                .then((data) => {
                    if (data.success) {
                        alert("Rota atribuída com sucesso! Distância aproximada: " + data.data.distanciaKm + " km");
                    } else {
                        alert("Erro ao atribuir rota: " + (data.message || ""));
                    }
                })
                .catch((error) => {
                    console.error("Erro ao atribuir rota:", error);
                });
        }
    </script>
</body>

</html>