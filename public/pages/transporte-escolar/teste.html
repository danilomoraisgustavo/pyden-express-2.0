<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <title>Atribuir Alunos às Rotas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        select,
        button {
            margin: 5px 0;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 15px;
        }

        table,
        th,
        td {
            border: 1px solid #ccc;
        }

        th,
        td {
            padding: 8px;
        }
    </style>
</head>

<body>
    <h1>Atribuição de Alunos a Rotas</h1>

    <label for="selectEscola">Escolha a escola:</label>
    <select id="selectEscola">
        <option value="">-- Selecione --</option>
    </select>

    <div id="alunosContainer" style="margin-top:20px;">
        <h3>Alunos que usam transporte</h3>
        <table id="tabelaAlunos">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Transporte Público</th>
                    <th>Atribuir Rota</th>
                </tr>
            </thead>
            <tbody>
                <!-- Preenchido dinamicamente -->
            </tbody>
        </table>
    </div>

    <label for="selectRota">Selecione a Rota:</label>
    <select id="selectRota">
        <option value="">-- Selecione --</option>
    </select>

    <!-- Exemplo: um botão de "Atribuir" global para o que estiver marcado -->
    <button id="btnAtribuirRota">Atribuir Rota Selecionada aos Alunos Marcados</button>

    <script>
        const API_URL = "http://localhost:3000"; // ou outro endpoint

        const selectEscola = document.getElementById("selectEscola");
        const selectRota = document.getElementById("selectRota");
        const tabelaAlunosBody = document.querySelector("#tabelaAlunos tbody");
        const btnAtribuirRota = document.getElementById("btnAtribuirRota");

        let alunosFiltrados = []; // Guardar em memória (exemplo)
        let rotasDisponiveis = [];

        async function carregarEscolas() {
            try {
                const resp = await fetch(`/api/escolas`);
                const data = await resp.json();
                data.forEach(escola => {
                    const opt = document.createElement("option");
                    opt.value = escola.id;
                    opt.textContent = escola.nome;
                    selectEscola.appendChild(opt);
                });
            } catch (err) {
                console.error("Erro ao carregar escolas", err);
            }
        }

        async function carregarRotas() {
            try {
                const resp = await fetch(`/api/rotas_simples`);
                const data = await resp.json();
                rotasDisponiveis = data;
                rotasDisponiveis.forEach(rota => {
                    const opt = document.createElement("option");
                    opt.value = rota.id;
                    opt.textContent = rota.identificador + " - " + (rota.descricao || "");
                    selectRota.appendChild(opt);
                });
            } catch (err) {
                console.error("Erro ao carregar rotas", err);
            }
        }

        async function carregarAlunosPorEscola(escolaId) {
            // Exemplo usando endpoint customizado:
            // Supondo que /api/alunos-mapa?escola_id=XX retorne todos os alunos dessa escola
            // que usam transporte
            try {
                const resp = await fetch(`/api/alunos-mapa?escola_id=${escolaId}`);
                const json = await resp.json();
                if (!json.success) {
                    console.error("Erro ao buscar alunos:", json.message);
                    return;
                }
                alunosFiltrados = json.data || [];
                renderAlunosTabela(alunosFiltrados);
            } catch (err) {
                console.error("Erro:", err);
            }
        }

        function renderAlunosTabela(alunos) {
            tabelaAlunosBody.innerHTML = "";
            alunos.forEach(al => {
                const tr = document.createElement("tr");

                const tdId = document.createElement("td");
                tdId.textContent = al.id;

                const tdNome = document.createElement("td");
                tdNome.textContent = al.pessoa_nome;

                const tdTransporte = document.createElement("td");
                tdTransporte.textContent = al.transporte_escolar_poder_publico || "";

                // Checkbox para marcar quem quero atribuir
                const tdCheck = document.createElement("td");
                const inputChk = document.createElement("input");
                inputChk.type = "checkbox";
                inputChk.value = al.id;
                tdCheck.appendChild(inputChk);

                tr.appendChild(tdId);
                tr.appendChild(tdNome);
                tr.appendChild(tdTransporte);
                tr.appendChild(tdCheck);

                tabelaAlunosBody.appendChild(tr);
            });
        }

        // Ao trocar a escola no select
        selectEscola.addEventListener("change", (e) => {
            const escolaId = e.target.value;
            if (!escolaId) return;
            carregarAlunosPorEscola(escolaId);
        });

        // Lógica do botão "Atribuir Rota"
        btnAtribuirRota.addEventListener("click", async () => {
            const rotaSelecionada = selectRota.value;
            if (!rotaSelecionada) {
                alert("Selecione uma Rota primeiro!");
                return;
            }

            // Pegar quais alunos foram marcados:
            const checkboxes = document.querySelectorAll("#tabelaAlunos tbody input[type='checkbox']:checked");
            if (checkboxes.length === 0) {
                alert("Selecione pelo menos um aluno na tabela!");
                return;
            }

            // Para cada aluno marcado, chamamos o endpoint
            for (let chk of checkboxes) {
                const alunoId = chk.value;

                // Neste exemplo, não estamos calculando automaticamente
                // ponto de parada ou zoneamento.
                // Mas, se quisesse automatizar, você poderia:
                // 1) Obter lat/lng do aluno (geocodificar CEP + número, ou se já tiver salvo no DB)
                // 2) Consultar o zoneamento via ST_Contains
                // 3) Encontrar o ponto mais próximo
                // 4) Enviar ponto_id no body

                const body = {
                    aluno_id: alunoId,
                    rota_id: rotaSelecionada,
                    //ponto_id: 123  <- se você já tiver calculado
                };

                try {
                    const resp = await fetch(`/api/alunos_rotas/atribuir`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(body),
                    });
                    const json = await resp.json();
                    if (!json.success) {
                        console.warn("Falhou para aluno", alunoId, json.message);
                    } else {
                        console.log("Atribuído com sucesso ->", json);
                    }
                } catch (err) {
                    console.error("Erro fetch atribuição:", err);
                }
            }

            alert("Processo de atribuição finalizado (ver logs)!");
        });

        // Ao carregar a página, puxa escolas e rotas
        window.addEventListener("DOMContentLoaded", () => {
            carregarEscolas();
            carregarRotas();
        });
    </script>
</body>

</html>