<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Importar Alunos Ativos - pydenadmin Bootstrap 5 Admin Dashboard</title>
  <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport" />
  <link rel="icon" href="public/assets/img/pydenadmin/favicon.png" type="image/x-icon" />
  <script src="../../assets/js/plugin/webfont/webfont.min.js"></script>
  <script>
    WebFont.load({
      google: { families: ["Public Sans:300,400,500,600,700"] },
      custom: {
        families: [
          "Font Awesome 5 Solid",
          "Font Awesome 5 Regular",
          "Font Awesome 5 Brands",
          "simple-line-icons",
        ],
        urls: ["../../assets/css/fonts.min.css"],
      },
      active: function () {
        sessionStorage.fonts = true;
      },
    });
  </script>
  <link rel="stylesheet" href="../../assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="../../assets/css/plugins.min.css" />
  <link rel="stylesheet" href="../../assets/css/pydenadmin.min.css" />
  <link rel="stylesheet" href="../../assets/css/demo.css" />

  <style>
    .required-label::after {
      content: " *";
      color: red;
    }

    .modal-lg {
      max-width: 90% !important;
    }

    #map {
      width: 100%;
      height: 500px;
    }

    #mapAluno {
      width: 100%;
      height: 500px;
    }

    .spinner-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      justify-content: center;
      align-items: center;
      background-color: rgba(0, 0, 0, 0.4);
      z-index: 9999;
    }

    .spinner {
      background-image: linear-gradient(rgb(186, 66, 255) 35%, rgb(0, 225, 255));
      width: 100px;
      height: 100px;
      animation: spinning82341 1.7s linear infinite;
      text-align: center;
      border-radius: 50px;
      filter: blur(1px);
      box-shadow: 0px -5px 20px 0px rgb(186, 66, 255),
        0px 5px 20px 0px rgb(0, 225, 255);
    }

    .spinner1 {
      background-color: rgb(36, 36, 36);
      width: 100px;
      height: 100px;
      border-radius: 50px;
      filter: blur(10px);
    }

    @keyframes spinning82341 {
      to {
        transform: rotate(360deg);
      }
    }
  </style>
</head>

<body>
  <div class="wrapper">
    <!-- SIDEBAR -->
    <div class="sidebar" data-background-color="dark">
      <div class="sidebar-logo">
        <div class="logo-header" data-background-color="dark">
          <a href="../../pages/transporte-escolar/dashboard-escolar.html" class="logo">
            <img src="../../assets/img/pydenadmin/logo_light.png" alt="navbar brand" class="navbar-brand" height="20" />
          </a>
          <div class="nav-toggle">
            <button class="btn btn-toggle toggle-sidebar">
              <i class="gg-menu-right"></i>
            </button>
            <button class="btn btn-toggle sidenav-toggler">
              <i class="gg-menu-left"></i>
            </button>
          </div>
          <button class="topbar-toggler more">
            <i class="gg-more-vertical-alt"></i>
          </button>
        </div>
      </div>

      <div class="sidebar-wrapper scrollbar scrollbar-inner">
        <div class="sidebar-content">
          <ul class="nav nav-secondary">
            <li class="nav-section">
              <span class="sidebar-mini-icon"><i class="fa fa-ellipsis-h"></i></span>
              <h4 class="text-section">Transporte Escolar</h4>
            </li>
            <li class="nav-item">
              <a href="../../pages/transporte-escolar/dashboard-escolar.html">
                <i class="fas fa-tachometer-alt"></i>
                <p>Dashboard Escolar</p>
              </a>
            </li>
            <li class="nav-item">
              <a data-bs-toggle="collapse" href="#teAlunos" aria-expanded="false">
                <i class="fas fa-user-graduate"></i>
                <p>Alunos</p>
                <span class="caret"></span>
              </a>
              <div class="collapse" id="teAlunos">
                <ul class="nav nav-collapse">
                  <li>
                    <a href="../../pages/transporte-escolar/alunos-solicitacoes-listar.html">
                      <span class="sub-item">Listar Solicitações de Transporte</span>
                    </a>
                  </li>
                  <li>
                    <a href="../../pages/transporte-escolar/alunos-listar.html">
                      <span class="sub-item">Listar ALunos</span>
                    </a>
                  </li>
                </ul>
              </div>
            </li>
            <!-- Menus restantes... -->
          </ul>
        </div>
      </div>
    </div>
    <!-- END SIDEBAR -->

    <div class="main-panel">
      <!-- HEADER -->
      <div class="main-header" style="top: 0">
        <div class="main-header-logo">
          <div class="logo-header" data-background-color="dark">
            <a href="../../pages/transporte-escolar/dashboard-escolar.html" class="logo">
              <img src="../../assets/img/pydenadmin/logo_light.png" alt="navbar brand" class="navbar-brand"
                height="20" />
            </a>
            <div class="nav-toggle">
              <button class="btn btn-toggle toggle-sidebar">
                <i class="gg-menu-right"></i>
              </button>
              <button class="btn btn-toggle sidenav-toggler">
                <i class="gg-menu-left"></i>
              </button>
            </div>
            <button class="topbar-toggler more">
              <i class="gg-more-vertical-alt"></i>
            </button>
          </div>
        </div>

        <nav class="navbar navbar-header navbar-header-transparent navbar-expand-lg border-bottom">
          <div class="container-fluid">
            <ul class="navbar-nav topbar-nav ms-md-auto align-items-center">
              <!-- Ícones e notificações omitidas para brevidade... -->
              <li class="nav-item topbar-user dropdown hidden-caret">
                <a class="dropdown-toggle profile-pic" data-bs-toggle="dropdown" href="#" aria-expanded="false">
                  <div class="avatar-sm">
                    <img src="../../assets/img/profile.jpg" alt="..." class="avatar-img rounded-circle" />
                  </div>
                  <span class="profile-username">
                    <span class="op-7">Olá,</span>
                    <span class="fw-bold" id="dropdownUserName">Carregando...</span>
                  </span>
                </a>
                <ul class="dropdown-menu dropdown-user animated fadeIn">
                  <div class="dropdown-user-scroll scrollbar-outer">
                    <li>
                      <div class="user-box">
                        <div class="avatar-lg">
                          <img src="../../assets/img/profile.jpg" alt="image profile" class="avatar-img rounded" />
                        </div>
                        <div class="u-text">
                          <h4 id="dropdownUserBoxName">Nome do Usuário</h4>
                          <p class="text-muted" id="dropdownUserEmail">email@exemplo.com</p>
                          <a href="/pages/usuarios/meu-perfil.html" class="btn btn-xs btn-secondary btn-sm">
                            Ver Perfil
                          </a>
                        </div>
                      </div>
                    </li>
                    <li>
                      <div class="dropdown-divider"></div>
                      <a class="dropdown-item" href="/pages/usuarios/meu-perfil.html">Meu Perfil</a>
                      <a class="dropdown-item" href="/pages/usuarios/caixa-entrada.html">Caixa de Entrada</a>
                      <div class="dropdown-divider"></div>
                      <a class="dropdown-item" href="/pages/usuarios/configuracoes.html">Configurações</a>
                      <div class="dropdown-divider"></div>
                      <a class="dropdown-item" href="#" id="logoutLink">Sair</a>
                    </li>
                  </div>
                </ul>
              </li>
            </ul>
          </div>
        </nav>
      </div>
      <!-- END HEADER -->

      <div class="container">
        <div class="page-inner">
          <div class="page-header">
            <h3 class="fw-bold mb-3">Importar Alunos Ativos</h3>
            <ul class="breadcrumbs mb-3">
              <li class="nav-home">
                <a href="../../">
                  <i class="icon-home"></i>
                </a>
              </li>
              <li class="separator"><i class="icon-arrow-right"></i></li>
              <li class="nav-item"><a href="#">Alunos</a></li>
              <li class="separator"><i class="icon-arrow-right"></i></li>
              <li class="nav-item"><a href="#">Importar Alunos</a></li>
            </ul>
          </div>

          <div class="mb-3 d-flex gap-2 flex-wrap">
            <div>
              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalImportar">
                Importar Alunos
              </button>
            </div>
            <div>
              <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#modalMapear">
                Mapear Alunos
              </button>
            </div>
            <div>
              <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalCompletarLocalizacao">
                Completar Localização Municipal/Estadual
              </button>
            </div>
          </div>

          <!-- MODAL Importar -->
          <div class="modal fade" id="modalImportar" tabindex="-1" aria-labelledby="modalImportarLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="modalImportarLabel">Importar Arquivo XLSX</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <p>1. Selecione a escola referente a todos os alunos que serão importados.</p>
                  <div class="mb-3">
                    <label for="escolaSelect" class="form-label required-label">Escola</label>
                    <select class="form-select" id="escolaSelect">
                      <option value="">Selecione a Escola</option>
                    </select>
                  </div>
                  <p>2. Selecione o arquivo XLSX conforme o formato especificado.</p>
                  <input type="file" id="fileInput" accept=".xlsx, .xls" class="form-control mb-3" />
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                  <button id="importarBtn" type="button" class="btn btn-primary">Importar</button>
                </div>
              </div>
            </div>
          </div>

          <!-- MODAL Mapear -->
          <div class="modal fade" id="modalMapear" tabindex="-1" aria-labelledby="modalMapearLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="modalMapearLabel">Mapa de Alunos</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="selectEscolaMap" class="form-label">Filtrar por Escola</label>
                      <select class="form-select" id="selectEscolaMap">
                        <option value="">Todas as Escolas</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label for="buscarAlunoInput" class="form-label">Buscar por ID, Nome ou CPF</label>
                      <input type="text" class="form-control" id="buscarAlunoInput"
                        placeholder="Ex: 12345 ou João ou 000.000.000-00" />
                    </div>
                  </div>
                  <div class="mb-3">
                    <button id="btnFiltrarMapa" class="btn btn-primary">Buscar/Filtrar</button>
                  </div>
                  <div id="map"></div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
              </div>
            </div>
          </div>

          <!-- MODAL Completar Localização -->
          <div class="modal fade" id="modalCompletarLocalizacao" tabindex="-1"
            aria-labelledby="modalCompletarLocalizacaoLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="modalCompletarLocalizacaoLabel">Completar Localização Municipal/Estadual
                  </h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div class="mb-3">
                    <label for="selectEscolaCompletarLocalizacao" class="form-label">Selecione a Escola</label>
                    <select class="form-select" id="selectEscolaCompletarLocalizacao">
                      <option value="">Todas as Escolas</option>
                    </select>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                  <button type="button" class="btn btn-success" id="btnConfirmarCompletarLocalizacao">
                    Completar Localização
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- Card de filtros e tabela -->
          <div class="card mb-4">
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-3">
                  <label for="filtroEscola" class="form-label">Filtrar por Escola</label>
                  <select id="filtroEscola" class="form-select">
                    <option value="">Todas</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label for="filtroBairro" class="form-label">Filtrar por Bairro</label>
                  <select id="filtroBairro" class="form-select">
                    <option value="">Todos</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label for="filtroCep" class="form-label">Filtrar por CEP</label>
                  <select id="filtroCep" class="form-select">
                    <option value="">Todos</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <label for="searchInput" class="form-label">Pesquisa Geral</label>
                  <input type="text" id="searchInput" class="form-control" placeholder="Digite para pesquisar..." />
                </div>
              </div>

              <!-- Botão para acionar a busca no servidor -->
              <div class="mt-3">
                <button id="btnBuscarAlunos" class="btn btn-primary">
                  Buscar Alunos
                </button>
              </div>
            </div>
          </div>

          <!-- Tabela de Alunos -->
          <div class="row mt-4">
            <div class="col-md-12">
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h4 class="card-title">Alunos Cadastrados</h4>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table id="alunos-table" class="display table table-striped table-hover">
                      <thead>
                        <tr>
                          <th>ID Matrícula</th>
                          <th>Escola (Nome)</th>
                          <th>Ano</th>
                          <th>Modalidade</th>
                          <th>Form. Letivo</th>
                          <th>Turma</th>
                          <th>Nome Aluno</th>
                          <th>CPF</th>
                          <th>Transp. Escolar</th>
                          <th>CEP</th>
                          <th>Bairro</th>
                          <th>Número Endereço</th>
                          <th>Filiação 1</th>
                          <th>Telefone</th>
                          <th>Filiação 2</th>
                          <th>Responsável</th>
                          <th>Deficiência</th>
                          <th>Latitude</th>
                          <th>Longitude</th>
                          <th>Ações</th>
                        </tr>
                      </thead>
                      <tfoot>
                        <tr>
                          <th>ID Matrícula</th>
                          <th>Escola (Nome)</th>
                          <th>Ano</th>
                          <th>Modalidade</th>
                          <th>Form. Letivo</th>
                          <th>Turma</th>
                          <th>Nome Aluno</th>
                          <th>CPF</th>
                          <th>Transp. Escolar</th>
                          <th>CEP</th>
                          <th>Bairro</th>
                          <th>Número Endereço</th>
                          <th>Filiação 1</th>
                          <th>Telefone</th>
                          <th>Filiação 2</th>
                          <th>Responsável</th>
                          <th>Deficiência</th>
                          <th>Latitude</th>
                          <th>Longitude</th>
                          <th>Ações</th>
                        </tr>
                      </tfoot>
                      <tbody></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div><!-- .page-inner -->
      </div><!-- .container -->

      <footer class="footer">
        <div class="container-fluid d-flex justify-content-between">
          <nav class="pull-left">
            <ul class="nav">
              <li class="nav-item">
                <a class="nav-link" href="#">ThemeKita</a>
              </li>
              <li class="nav-item"><a class="nav-link" href="#">Help</a></li>
              <li class="nav-item"><a class="nav-link" href="#">Licenses</a></li>
            </ul>
          </nav>
          <div class="copyright">
            2024, made with <i class="fa fa-heart heart text-danger"></i> by
            <a href="http://www.themekita.com">ThemeKita</a>
          </div>
          <div>
            Distributed by
            <a target="_blank" href="https://themewagon.com/">ThemeWagon</a>.
          </div>
        </div>
      </footer>
    </div><!-- .main-panel -->
  </div><!-- .wrapper -->

  <!-- LOADER Global -->
  <div id="globalLoader" class="spinner-container">
    <div class="spinner">
      <div class="spinner1"></div>
    </div>
  </div>

  <!-- MODAL Editar Aluno -->
  <div class="modal fade" id="modalEditarAluno" tabindex="-1" aria-labelledby="modalEditarAlunoLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalEditarAlunoLabel">Editar Aluno</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="formEditarAluno">
            <input type="hidden" id="editarAlunoId" />
            <div class="mb-3">
              <label for="editarIdMatricula" class="form-label">ID Matrícula</label>
              <input type="text" class="form-control" id="editarIdMatricula" />
            </div>
            <div class="mb-3">
              <label for="editarEscolaId" class="form-label">Escola (ID)</label>
              <input type="text" class="form-control" id="editarEscolaId" />
            </div>
            <div class="mb-3">
              <label for="editarAno" class="form-label">Ano</label>
              <input type="text" class="form-control" id="editarAno" />
            </div>
            <div class="mb-3">
              <label for="editarModalidade" class="form-label">Modalidade</label>
              <input type="text" class="form-control" id="editarModalidade" />
            </div>
            <div class="mb-3">
              <label for="editarFormatoLetivo" class="form-label">Formato Letivo</label>
              <input type="text" class="form-control" id="editarFormatoLetivo" />
            </div>
            <div class="mb-3">
              <label for="editarTurma" class="form-label">Turma</label>
              <input type="text" class="form-control" id="editarTurma" />
            </div>
            <div class="mb-3">
              <label for="editarNomeAluno" class="form-label">Nome Aluno</label>
              <input type="text" class="form-control" id="editarNomeAluno" />
            </div>
            <div class="mb-3">
              <label for="editarCpf" class="form-label">CPF</label>
              <input type="text" class="form-control" id="editarCpf" />
            </div>
            <div class="mb-3">
              <label for="editarTransporte" class="form-label">Transp. Escolar</label>
              <input type="text" class="form-control" id="editarTransporte" />
            </div>
            <div class="mb-3">
              <label for="editarCep" class="form-label">CEP</label>
              <input type="text" class="form-control" id="editarCep" />
            </div>
            <div class="mb-3">
              <label for="editarBairro" class="form-label">Bairro</label>
              <input type="text" class="form-control" id="editarBairro" />
            </div>
            <div class="mb-3">
              <label for="editarNumeroEndereco" class="form-label">Número Endereço</label>
              <input type="text" class="form-control" id="editarNumeroEndereco" />
            </div>
            <div class="mb-3">
              <label for="editarFiliacao1" class="form-label">Filiação 1</label>
              <input type="text" class="form-control" id="editarFiliacao1" />
            </div>
            <div class="mb-3">
              <label for="editarTelefone" class="form-label">Telefone</label>
              <input type="text" class="form-control" id="editarTelefone" />
            </div>
            <div class="mb-3">
              <label for="editarFiliacao2" class="form-label">Filiação 2</label>
              <input type="text" class="form-control" id="editarFiliacao2" />
            </div>
            <div class="mb-3">
              <label for="editarResponsavel" class="form-label">Responsável</label>
              <input type="text" class="form-control" id="editarResponsavel" />
            </div>
            <div class="mb-3">
              <label for="editarDeficiencia" class="form-label">Deficiência (JSON)</label>
              <input type="text" class="form-control" id="editarDeficiencia" />
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Fechar
          </button>
          <button type="button" class="btn btn-primary" id="btnSalvarEdicao">
            Salvar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL Localizar Aluno -->
  <div class="modal fade" id="modalLocalizarAluno" tabindex="-1" aria-labelledby="modalLocalizarAlunoLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalLocalizarAlunoLabel">Localizar Aluno</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>Clique no mapa para alterar a Latitude/Longitude do aluno.</p>
          <div class="row g-2 mb-3">
            <div class="col">
              <label for="localizarAlunoLat" class="form-label">Latitude</label>
              <input type="text" id="localizarAlunoLat" class="form-control" readonly />
            </div>
            <div class="col">
              <label for="localizarAlunoLng" class="form-label">Longitude</label>
              <input type="text" id="localizarAlunoLng" class="form-control" readonly />
            </div>
          </div>
          <div id="mapAluno" style="width: 100%; height: 500px; border: 1px solid #ccc;"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            Fechar
          </button>
          <button type="button" class="btn btn-success" id="btnSalvarLocalizacao">
            Salvar Localização
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="../../assets/js/core/jquery-3.7.1.min.js"></script>
  <script src="../../assets/js/core/popper.min.js"></script>
  <script src="../../assets/js/core/bootstrap.min.js"></script>
  <script src="../../assets/js/usuario.js"></script>
  <script src="../../assets/js/plugin/bootstrap-notify/bootstrap-notify.min.js"></script>
  <script src="../../assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
  <script src="../../assets/js/plugin/datatables/datatables.min.js"></script>
  <script src="../../assets/js/pydenadmin.min.js"></script>
  <script src="../../assets/js/setting-demo2.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCAwvAt4l0Pkb1c52FLUE-ttVxm4YZ9J8M&v=beta"></script>

  <script>
    let dadosXLSX = [];
    let escolasLista = [];
    let dataTable = null;
    let alunosData = [];
    let map = null;
    let mapAluno = null;
    let alunoAtual = null;
    let currentAlunoMarker = null;
    let currentAlunoPosition = null;

    /********************************************
     * EXIBIR / ESCONDER LOADER
     ********************************************/
    function showLoader() {
      document.getElementById("globalLoader").style.display = "flex";
    }
    function hideLoader() {
      document.getElementById("globalLoader").style.display = "none";
    }

    /********************************************
     * NOTIFICAÇÃO
     ********************************************/
    function showNotification(type, message) {
      $.notify(
        {
          message: message,
          icon:
            type === "success"
              ? "fa fa-check-circle"
              : type === "danger"
                ? "fa fa-exclamation-circle"
                : "fa fa-info-circle",
        },
        {
          type: type,
          placement: { from: "top", align: "right" },
          offset: 20,
          spacing: 10,
          z_index: 1031,
          delay: 3000,
          timer: 1000,
          animate: {
            enter: "animated fadeInDown",
            exit: "animated fadeOutUp",
          },
        }
      );
    }

    /********************************************
     * CARREGAR ESCOLAS
     ********************************************/
    function carregarEscolas() {
      showLoader();
      fetch("/api/escolas")
        .then((res) => res.json())
        .then((data) => {
          escolasLista = data;
          popularSelectEscolas();
          popularSelectEscolasMap();
          popularSelectEscolasCompletarLocalizacao();
        })
        .catch(() => {
          showNotification("danger", "Erro ao carregar lista de escolas.");
        })
        .finally(() => hideLoader());
    }

    function popularSelectEscolas() {
      const select = document.getElementById("escolaSelect");
      select.innerHTML = '<option value="">Selecione a Escola</option>';
      escolasLista.forEach((escola) => {
        const option = document.createElement("option");
        option.value = escola.id;
        option.textContent = `${escola.nome} (ID: ${escola.id})`;
        select.appendChild(option);
      });
    }

    function popularSelectEscolasMap() {
      const selectMap = document.getElementById("selectEscolaMap");
      selectMap.innerHTML = '<option value="">Todas as Escolas</option>';
      escolasLista.forEach((escola) => {
        const option = document.createElement("option");
        option.value = escola.id;
        option.textContent = `${escola.nome} (ID: ${escola.id})`;
        selectMap.appendChild(option);
      });
    }

    function popularSelectEscolasCompletarLocalizacao() {
      const select = document.getElementById("selectEscolaCompletarLocalizacao");
      select.innerHTML = '<option value="">Todas as Escolas</option>';
      escolasLista.forEach((escola) => {
        const option = document.createElement("option");
        option.value = escola.id;
        option.textContent = `${escola.nome} (ID: ${escola.id})`;
        select.appendChild(option);
      });
    }

    /********************************************
     * BUSCAR ALUNOS FILTRADOS NO SERVIDOR
     ********************************************/
    function buscarAlunosFiltrados() {
      // Pega os valores dos filtros
      const escolaVal = $("#filtroEscola").val();
      const bairroVal = $("#filtroBairro").val();
      const cepVal = $("#filtroCep").val();
      const searchVal = $("#searchInput").val();

      // Monta a query string
      const params = new URLSearchParams();
      if (escolaVal) params.append("escola", escolaVal);
      if (bairroVal) params.append("bairro", bairroVal);
      if (cepVal) params.append("cep", cepVal);
      if (searchVal) params.append("search", searchVal);

      showLoader();
      fetch("/api/alunos-ativos?" + params.toString())
        .then((res) => res.json())
        .then((data) => {
          alunosData = data; // deve ser um array com resultados filtrados
          popularTabela(alunosData);
        })
        .catch((err) => {
          console.error(err);
          showNotification("danger", "Erro ao buscar alunos filtrados.");
        })
        .finally(() => hideLoader());
    }

    /********************************************
     * POPULAR TABELA
     ********************************************/
    function popularTabela(alunos) {
      const tbody = $("#alunos-table tbody");
      tbody.empty();

      // Limpa selects de filtro local
      const distinctEscolas = new Set();
      const distinctBairros = new Set();
      const distinctCeps = new Set();

      alunos.forEach((item) => {
        const defString =
          item.deficiencia && Array.isArray(item.deficiencia)
            ? JSON.stringify(item.deficiencia)
            : item.deficiencia || "";

        const row = `
          <tr data-id="${item.id}" data-obj='${JSON.stringify(item)}'>
            <td>${item.id_matricula || ""}</td>
            <td>${item.escola_nome || ""}</td>
            <td>${item.ano || ""}</td>
            <td>${item.modalidade || ""}</td>
            <td>${item.formato_letivo || ""}</td>
            <td>${item.turma || ""}</td>
            <td>${item.pessoa_nome || ""}</td>
            <td>${item.cpf || ""}</td>
            <td>${item.transporte_escolar_poder_publico || ""}</td>
            <td>${item.cep || ""}</td>
            <td>${item.bairro || ""}</td>
            <td>${item.numero_pessoa_endereco || ""}</td>
            <td>${item.filiacao_1 || ""}</td>
            <td>${item.numero_telefone || ""}</td>
            <td>${item.filiacao_2 || ""}</td>
            <td>${item.responsavel || ""}</td>
            <td>${defString}</td>
            <td>${item.latitude || ""}</td>
            <td>${item.longitude || ""}</td>
            <td>
              <button class="btn btn-sm btn-warning btn-editar" title="Editar">
                <i class="fa fa-edit"></i>
              </button>
              <button class="btn btn-sm btn-info btn-localizar" title="Localizar">
                <i class="fa fa-map-marker-alt"></i>
              </button>
              <button class="btn btn-sm btn-danger btn-excluir" title="Excluir">
                <i class="fa fa-trash"></i>
              </button>
            </td>
          </tr>
        `;
        tbody.append(row);

        // Caso você queira reusar em outro lugar, set's aqui
        if (item.escola_nome) distinctEscolas.add(item.escola_nome);
        if (item.bairro) distinctBairros.add(item.bairro);
        if (item.cep) distinctCeps.add(item.cep);
      });

      // Destrói o DataTable anterior (se houver) e recria
      if (dataTable) {
        dataTable.clear().destroy();
      }
      dataTable = $("#alunos-table").DataTable({
        pageLength: 10,
        language: {
          decimal: ",",
          thousands: ".",
          info: "Mostrando _START_ até _END_ de _TOTAL_ registros",
          infoEmpty: "Mostrando 0 até 0 de 0 registros",
          infoFiltered: "(filtrado de _MAX_ registros no total)",
          lengthMenu: "Mostrar _MENU_ registros",
          loadingRecords: "Carregando...",
          processing: "Processando...",
          search: "Pesquisar:",
          zeroRecords: "Nenhum registro encontrado",
          paginate: {
            first: "Primeiro",
            last: "Último",
            next: "Próximo",
            previous: "Anterior",
          },
          emptyTable: "Nenhum dado disponível na tabela",
        },
      });
    }

    /********************************************
     * IMPORTAR XLSX
     ********************************************/
    function handleFileImport(evt) {
      const file = evt.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        const data = e.target.result;
        const workbook = XLSX.read(data, { type: "binary" });
        const firstSheet = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheet];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
        dadosXLSX = jsonData;
      };
      reader.readAsBinaryString(file);
    }

    function enviarImportacao() {
      const escolaIdSelecionada = document.getElementById("escolaSelect").value;
      if (!escolaIdSelecionada) {
        showNotification("danger", "Selecione uma escola antes de importar.");
        return;
      }
      if (!dadosXLSX.length) {
        showNotification("danger", "Nenhum arquivo importado ainda.");
        return;
      }
      showLoader();
      const body = {
        escolaId: escolaIdSelecionada,
        alunos: dadosXLSX,
      };
      fetch("/api/import-alunos-ativos", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      })
        .then((res) => res.json())
        .then((resp) => {
          if (resp.success) {
            showNotification("success", resp.message || "Importação realizada com sucesso!");
            $("#modalImportar").modal("hide");
            // Opcionalmente, já podemos chamar buscarAlunosFiltrados para atualizar a tabela 
            // se a escola do import foi selecionada no filtro
          } else {
            showNotification("danger", resp.message || "Ocorreu um erro na importação.");
          }
        })
        .catch(() => {
          showNotification("danger", "Erro ao enviar os dados ao servidor.");
        })
        .finally(() => hideLoader());
    }

    /********************************************
     * MAPA DE ALUNOS (Modal Mapear)
     ********************************************/
    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: -3.135366, lng: -60.023207 },
        zoom: 4,
        mapId: "ca7a0e55f44be727",
      });
    }

    $("#modalMapear").on("shown.bs.modal", function () {
      if (!map) {
        initMap();
      }
    });

    $(document).on("click", "#btnFiltrarMapa", function () {
      const escolaSelecionada = $("#selectEscolaMap").val();
      const busca = $("#buscarAlunoInput").val().trim();
      const queryParams = new URLSearchParams();
      if (escolaSelecionada) {
        queryParams.append("escola_id", escolaSelecionada);
      }
      if (busca) {
        queryParams.append("busca", busca);
      }
      showLoader();
      fetch("/api/alunos-mapa?" + queryParams.toString())
        .then((res) => res.json())
        .then((resp) => {
          if (resp.success && Array.isArray(resp.data)) {
            plotarMapa(resp.data, resp.escola);
          } else {
            showNotification("info", "Nenhum aluno encontrado.");
          }
        })
        .catch(() => {
          showNotification("danger", "Erro ao filtrar alunos no mapa.");
        })
        .finally(() => hideLoader());
    });

    function plotarMapa(alunos, escolaData) {
      if (!map) {
        initMap();
      }
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: -3.135366, lng: -60.023207 },
        zoom: 4,
        mapId: "ca7a0e55f44be727",
      });
      const bounds = new google.maps.LatLngBounds();

      if (escolaData && escolaData.latitude && escolaData.longitude) {
        const escPos = new google.maps.LatLng(
          parseFloat(escolaData.latitude),
          parseFloat(escolaData.longitude)
        );
        new google.maps.Marker({
          map,
          position: escPos,
          title: escolaData.nome,
          icon: {
            url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png",
          },
        });
        bounds.extend(escPos);
      }

      alunos.forEach((al) => {
        if (al.latitude && al.longitude) {
          const pos = new google.maps.LatLng(
            parseFloat(al.latitude),
            parseFloat(al.longitude)
          );
          const marker = new google.maps.Marker({
            map,
            position: pos,
            title: al.pessoa_nome || "Aluno",
          });
          const infowindow = new google.maps.InfoWindow({
            content: `<strong>${al.pessoa_nome || ""}</strong><br>
              CPF: ${al.cpf || ""}<br>
              Matrícula: ${al.id_matricula || ""}<br>
              Lat: ${al.latitude} / Lng: ${al.longitude}
            `,
          });
          marker.addListener("click", () => {
            infowindow.open(map, marker);
          });
          bounds.extend(pos);
        }
      });

      if (!bounds.isEmpty()) {
        map.fitBounds(bounds);
      }
    }

    /********************************************
     * COMPLETAR LOCALIZAÇÃO (EXEMPLO)
     ********************************************/
    $(document).on("click", "#btnConfirmarCompletarLocalizacao", function () {
      showNotification("info", "Processo de localização completado (exemplo).");
      $("#modalCompletarLocalizacao").modal("hide");
    });

    /********************************************
     * EDIÇÃO / EXCLUSÃO / LOCALIZAÇÃO DE ALUNO
     ********************************************/
    $(document).on("click", ".btn-editar", function () {
      const tr = $(this).closest("tr");
      const dataObj = JSON.parse(tr.attr("data-obj") || "{}");
      alunoAtual = dataObj.id;
      $("#editarAlunoId").val(dataObj.id);
      $("#editarIdMatricula").val(dataObj.id_matricula || "");
      $("#editarEscolaId").val(dataObj.escola_id || "");
      $("#editarAno").val(dataObj.ano || "");
      $("#editarModalidade").val(dataObj.modalidade || "");
      $("#editarFormatoLetivo").val(dataObj.formato_letivo || "");
      $("#editarTurma").val(dataObj.turma || "");
      $("#editarNomeAluno").val(dataObj.pessoa_nome || "");
      $("#editarCpf").val(dataObj.cpf || "");
      $("#editarTransporte").val(dataObj.transporte_escolar_poder_publico || "");
      $("#editarCep").val(dataObj.cep || "");
      $("#editarBairro").val(dataObj.bairro || "");
      $("#editarNumeroEndereco").val(dataObj.numero_pessoa_endereco || "");
      $("#editarFiliacao1").val(dataObj.filiacao_1 || "");
      $("#editarTelefone").val(dataObj.numero_telefone || "");
      $("#editarFiliacao2").val(dataObj.filiacao_2 || "");
      $("#editarResponsavel").val(dataObj.responsavel || "");
      if (dataObj.deficiencia && Array.isArray(dataObj.deficiencia)) {
        $("#editarDeficiencia").val(JSON.stringify(dataObj.deficiencia));
      } else {
        $("#editarDeficiencia").val(dataObj.deficiencia || "");
      }
      $("#modalEditarAluno").modal("show");
    });

    $("#btnSalvarEdicao").on("click", function () {
      const body = {
        id: $("#editarAlunoId").val(),
        id_matricula: $("#editarIdMatricula").val(),
        escola_id: $("#editarEscolaId").val(),
        ano: $("#editarAno").val(),
        modalidade: $("#editarModalidade").val(),
        formato_letivo: $("#editarFormatoLetivo").val(),
        turma: $("#editarTurma").val(),
        pessoa_nome: $("#editarNomeAluno").val(),
        cpf: $("#editarCpf").val(),
        transporte_escolar_poder_publico: $("#editarTransporte").val(),
        cep: $("#editarCep").val(),
        bairro: $("#editarBairro").val(),
        numero_pessoa_endereco: $("#editarNumeroEndereco").val(),
        filiacao_1: $("#editarFiliacao1").val(),
        numero_telefone: $("#editarTelefone").val(),
        filiacao_2: $("#editarFiliacao2").val(),
        responsavel: $("#editarResponsavel").val(),
        deficiencia: $("#editarDeficiencia").val(),
      };
      showLoader();
      fetch("/api/alunos-ativos/" + body.id, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      })
        .then((res) => res.json())
        .then((resp) => {
          if (resp.success) {
            showNotification("success", "Aluno atualizado com sucesso!");
            $("#modalEditarAluno").modal("hide");
            // Atualiza tabela
            buscarAlunosFiltrados();
          } else {
            showNotification("danger", resp.message || "Erro ao atualizar.");
          }
        })
        .catch(() => {
          showNotification("danger", "Erro ao atualizar aluno.");
        })
        .finally(() => hideLoader());
    });

    $(document).on("click", ".btn-localizar", function () {
      const tr = $(this).closest("tr");
      const dataObj = JSON.parse(tr.attr("data-obj") || "{}");
      alunoAtual = dataObj.id;
      $("#localizarAlunoLat").val(dataObj.latitude || "");
      $("#localizarAlunoLng").val(dataObj.longitude || "");
      $("#modalLocalizarAluno").modal("show");

      setTimeout(() => {
        initMapAluno(dataObj);
      }, 500);
    });

    $(document).on("click", ".btn-excluir", function () {
      if (!confirm("Deseja realmente excluir este aluno?")) return;
      const tr = $(this).closest("tr");
      const dataObj = JSON.parse(tr.attr("data-obj") || "{}");
      const alunoId = dataObj.id;
      showLoader();
      fetch("/api/alunos-ativos/" + alunoId, {
        method: "DELETE",
      })
        .then((res) => res.json())
        .then((resp) => {
          if (resp.success) {
            showNotification("success", "Aluno excluído com sucesso!");
            buscarAlunosFiltrados();
          } else {
            showNotification("danger", resp.message || "Erro ao excluir.");
          }
        })
        .catch(() => {
          showNotification("danger", "Erro ao excluir aluno.");
        })
        .finally(() => hideLoader());
    });

    /********************************************
     * SALVAR LOCALIZAÇÃO NO MAPA (Modal Localizar Aluno)
     ********************************************/
    function initMapAluno(aluno) {
      mapAluno = new google.maps.Map(document.getElementById("mapAluno"), {
        center: {
          lat: aluno.latitude ? parseFloat(aluno.latitude) : -3.135366,
          lng: aluno.longitude ? parseFloat(aluno.longitude) : -60.023207,
        },
        zoom: aluno.latitude && aluno.longitude ? 15 : 4,
        mapId: "ca7a0e55f44be727",
      });

      if (aluno.latitude && aluno.longitude) {
        currentAlunoPosition = new google.maps.LatLng(
          parseFloat(aluno.latitude),
          parseFloat(aluno.longitude)
        );
        currentAlunoMarker = new google.maps.Marker({
          position: currentAlunoPosition,
          map: mapAluno,
          title: "Aluno",
        });
      }

      mapAluno.addListener("click", (e) => {
        if (currentAlunoMarker) {
          currentAlunoMarker.setMap(null);
        }
        currentAlunoPosition = e.latLng;
        currentAlunoMarker = new google.maps.Marker({
          position: e.latLng,
          map: mapAluno,
          title: "Aluno",
        });
        $("#localizarAlunoLat").val(e.latLng.lat());
        $("#localizarAlunoLng").val(e.latLng.lng());
      });
    }

    $("#btnSalvarLocalizacao").on("click", function () {
      if (!alunoAtual || !currentAlunoPosition) {
        showNotification("danger", "Não há posição definida no mapa.");
        return;
      }
      const body = {
        id: alunoAtual,
        latitude: currentAlunoPosition.lat(),
        longitude: currentAlunoPosition.lng(),
      };
      showLoader();
      fetch("/api/alunos-ativos/" + alunoAtual, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      })
        .then((res) => res.json())
        .then((resp) => {
          if (resp.success) {
            showNotification("success", "Localização salva com sucesso!");
            $("#modalLocalizarAluno").modal("hide");
            buscarAlunosFiltrados(); // Recarrega tabela filtrada
          } else {
            showNotification("danger", resp.message || "Erro ao salvar localização.");
          }
        })
        .catch(() => {
          showNotification("danger", "Erro ao salvar localização.");
        })
        .finally(() => hideLoader());
    });

    /********************************************
     * DOCUMENT READY
     ********************************************/
    $(document).ready(function () {
      // Carrega apenas as escolas inicialmente
      carregarEscolas();

      // Não chamamos mais uma função que carregue todos os alunos
      // ao iniciar (para evitar lentidão).

      // Handler do input de arquivo XLSX
      $("#fileInput").on("change", handleFileImport);

      // Botão "Importar"
      $("#importarBtn").on("click", enviarImportacao);

      // Botão "BuscarAlunos" -> chama a função que faz a query no servidor
      $("#btnBuscarAlunos").on("click", buscarAlunosFiltrados);

      // Se desejar, pode disparar a busca sempre que trocar os filtros:
      // $("#filtroEscola, #filtroBairro, #filtroCep").on("change", buscarAlunosFiltrados);
      // $("#searchInput").on("keyup", buscarAlunosFiltrados);
    });
  </script>
</body>

</html>