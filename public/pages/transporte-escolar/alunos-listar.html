<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Importar Alunos Ativos - pydenadmin Bootstrap 5 Admin Dashboard</title>
  <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport" />
  <link rel="icon" href="public/assets/img/pydenadmin/favicon.png" type="image/x-icon" />

  <script src="../../assets/js/plugin/webfont/webfont.min.js"></script>
  <script>
    WebFont.load({
      google: { families: ["Public Sans:300,400,500,600,700"] },
      custom: {
        families: [
          "Font Awesome 5 Solid",
          "Font Awesome 5 Regular",
          "Font Awesome 5 Brands",
          "simple-line-icons",
        ],
        urls: ["../../assets/css/fonts.min.css"],
      },
      active: function () {
        sessionStorage.fonts = true;
      },
    });
  </script>

  <link rel="stylesheet" href="../../assets/css/bootstrap.min.css" />
  <link rel="stylesheet" href="../../assets/css/plugins.min.css" />
  <link rel="stylesheet" href="../../assets/css/pydenadmin.min.css" />
  <link rel="stylesheet" href="../../assets/css/demo.css" />

  <style>
    .required-label::after {
      content: " *";
      color: red;
    }

    .modal-lg {
      max-width: 90% !important;
    }

    /* Altura mínima para o mapa no modal */
    #map {
      width: 100%;
      height: 500px;
    }
  </style>
</head>

<body>
  <div class="wrapper">
    <!-- ... (SIDEBAR, HEADER, etc.) ... -->

    <div class="main-panel">
      <!-- ... (MAIN-HEADER, etc.) ... -->

      <div class="container">
        <div class="page-inner">
          <div class="page-header">
            <h3 class="fw-bold mb-3">Importar Alunos Ativos</h3>
            <ul class="breadcrumbs mb-3">
              <li class="nav-home">
                <a href="../../">
                  <i class="icon-home"></i>
                </a>
              </li>
              <li class="separator"><i class="icon-arrow-right"></i></li>
              <li class="nav-item"><a href="#">Alunos</a></li>
              <li class="separator"><i class="icon-arrow-right"></i></li>
              <li class="nav-item"><a href="#">Importar Alunos</a></li>
            </ul>
          </div>

          <!-- BOTÕES -->
          <div class="mb-3">
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalImportar">
              Importar Alunos
            </button>

            <!-- NOVO BOTÃO DE MAPEAMENTO -->
            <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#modalMapear">
              Mapear Alunos
            </button>
          </div>

          <!-- MODAL DE IMPORTAÇÃO -->
          <div class="modal fade" id="modalImportar" tabindex="-1" aria-labelledby="modalImportarLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="modalImportarLabel">Importar Arquivo XLSX</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <p>1. Selecione a escola referente a todos os alunos que serão importados.</p>
                  <div class="mb-3">
                    <label for="escolaSelect" class="form-label required-label">Escola</label>
                    <select class="form-select" id="escolaSelect">
                      <option value="">Selecione a Escola</option>
                    </select>
                  </div>
                  <p>2. Selecione o arquivo XLSX conforme o formato especificado.</p>
                  <input type="file" id="fileInput" accept=".xlsx, .xls" class="form-control mb-3" />
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Fechar
                  </button>
                  <button id="importarBtn" type="button" class="btn btn-primary">
                    Importar
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- MODAL PARA MAPEAR ALUNOS -->
          <div class="modal fade" id="modalMapear" tabindex="-1" aria-labelledby="modalMapearLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="modalMapearLabel">Mapa de Alunos (Estadual/Municipal)</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <div id="map"></div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Fechar
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- TABELA DE ALUNOS -->
          <div class="row mt-4">
            <div class="col-md-12">
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h4 class="card-title">Alunos Cadastrados</h4>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table id="alunos-table" class="display table table-striped table-hover">
                      <thead>
                        <tr>
                          <th>ID Matrícula</th>
                          <th>Escola (Nome)</th>
                          <th>Ano</th>
                          <th>Modalidade</th>
                          <th>Form. Letivo</th>
                          <th>Turma</th>
                          <th>Nome Aluno</th>
                          <th>CPF</th>
                          <th>Transp. Escolar</th>
                          <th>CEP</th>
                          <th>Bairro</th>
                          <th>Filiação 1</th>
                          <th>Telefone</th>
                          <th>Filiação 2</th>
                          <th>Responsável</th>
                          <th>Deficiência</th>
                        </tr>
                      </thead>
                      <tfoot>
                        <tr>
                          <th>ID Matrícula</th>
                          <th>Escola (Nome)</th>
                          <th>Ano</th>
                          <th>Modalidade</th>
                          <th>Form. Letivo</th>
                          <th>Turma</th>
                          <th>Nome Aluno</th>
                          <th>CPF</th>
                          <th>Transp. Escolar</th>
                          <th>CEP</th>
                          <th>Bairro</th>
                          <th>Filiação 1</th>
                          <th>Telefone</th>
                          <th>Filiação 2</th>
                          <th>Responsável</th>
                          <th>Deficiência</th>
                        </tr>
                      </tfoot>
                      <tbody></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- ... (FOOTER) ... -->
    </div>
  </div>

  <!-- Dependências JS -->
  <script src="../../assets/js/core/jquery-3.7.1.min.js"></script>
  <script src="../../assets/js/core/popper.min.js"></script>
  <script src="../../assets/js/core/bootstrap.min.js"></script>
  <script src="../../assets/js/usuario.js"></script>
  <script src="../../assets/js/plugin/bootstrap-notify/bootstrap-notify.min.js"></script>
  <script src="../../assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
  <script src="../../assets/js/plugin/datatables/datatables.min.js"></script>
  <script src="../../assets/js/pydenadmin.min.js"></script>
  <script src="../../assets/js/setting-demo2.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <!-- GOOGLE MAPS API (coloque sua própria key se necessário) -->
  <script src="https://maps.googleapis.com/maps/api/js?key=SUA_GOOGLE_KEY&libraries=places"></script>

  <script>
    let dadosXLSX = [];
    let escolasLista = [];
    let dataTable = null;
    let alunosData = [];

    let map = null;
    let bounds = null;
    let geocoder = null;

    function showNotification(type, message) {
      $.notify({
        message: message,
        icon:
          type === 'success' ? 'fa fa-check-circle' :
            type === 'danger' ? 'fa fa-exclamation-circle' :
              type === 'info' ? 'fa fa-info-circle' :
                'fa fa-check'
      }, {
        type: type,
        placement: { from: "top", align: "right" },
        offset: 20,
        spacing: 10,
        z_index: 1031,
        delay: 3000,
        timer: 1000,
        animate: {
          enter: 'animated fadeInDown',
          exit: 'animated fadeOutUp'
        }
      });
    }

    function carregarEscolas() {
      fetch('/api/escolas')
        .then(res => res.json())
        .then(data => {
          escolasLista = data;
          popularSelectEscolas();
        })
        .catch(err => {
          console.error(err);
          showNotification('danger', 'Erro ao carregar lista de escolas.');
        });
    }

    function popularSelectEscolas() {
      const select = document.getElementById('escolaSelect');
      select.innerHTML = '<option value="">Selecione a Escola</option>';
      escolasLista.forEach(escola => {
        const option = document.createElement('option');
        option.value = escola.id;
        option.textContent = `${escola.nome} (ID: ${escola.id})`;
        select.appendChild(option);
      });
    }

    function handleFileImport(evt) {
      const file = evt.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (e) {
        const data = e.target.result;
        const workbook = XLSX.read(data, { type: 'binary' });
        const firstSheet = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheet];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
        dadosXLSX = jsonData;
      };
      reader.readAsBinaryString(file);
    }

    function enviarImportacao() {
      const escolaIdSelecionada = document.getElementById('escolaSelect').value;
      if (!escolaIdSelecionada) {
        showNotification('danger', 'Selecione uma escola antes de importar.');
        return;
      }
      if (!dadosXLSX.length) {
        showNotification('danger', 'Nenhum arquivo importado ainda.');
        return;
      }

      const body = {
        escolaId: escolaIdSelecionada,
        alunos: dadosXLSX
      };

      fetch('/api/import-alunos-ativos', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      })
        .then(res => res.json())
        .then(resp => {
          if (resp.success) {
            showNotification('success', resp.message || 'Importação realizada com sucesso!');
            $('#modalImportar').modal('hide');
            carregarAlunosBD();
          } else {
            showNotification('danger', resp.message || 'Ocorreu um erro na importação.');
          }
        })
        .catch(err => {
          console.error(err);
          showNotification('danger', 'Erro ao enviar os dados ao servidor.');
        });
    }

    function carregarAlunosBD() {
      fetch('/api/alunos-ativos')
        .then(res => res.json())
        .then(data => {
          alunosData = data;
          popularTabela(alunosData);
        })
        .catch(err => {
          console.error(err);
          showNotification('danger', 'Erro ao carregar dados do banco.');
        });
    }

    function popularTabela(alunos) {
      const tbody = $("#alunos-table tbody");
      tbody.empty();
      alunos.forEach(item => {
        const defString = item.deficiencia && Array.isArray(item.deficiencia)
          ? JSON.stringify(item.deficiencia)
          : item.deficiencia || '';
        const row = `
          <tr>
            <td>${item.id_matricula || ''}</td>
            <td>${item.escola_nome || ''}</td>
            <td>${item.ano || ''}</td>
            <td>${item.modalidade || ''}</td>
            <td>${item.formato_letivo || ''}</td>
            <td>${item.turma || ''}</td>
            <td>${item.pessoa_nome || ''}</td>
            <td>${item.cpf || ''}</td>
            <td>${item.transporte_escolar_poder_publico || ''}</td>
            <td>${item.cep || ''}</td>
            <td>${item.bairro || ''}</td>
            <td>${item.filiacao_1 || ''}</td>
            <td>${item.numero_telefone || ''}</td>
            <td>${item.filiacao_2 || ''}</td>
            <td>${item.responsavel || ''}</td>
            <td>${defString}</td>
          </tr>
        `;
        tbody.append(row);
      });

      if (dataTable) {
        dataTable.clear().destroy();
      }
      dataTable = $('#alunos-table').DataTable({
        pageLength: 10,
        language: {
          decimal: ",",
          thousands: ".",
          info: "Mostrando _START_ até _END_ de _TOTAL_ registros",
          infoEmpty: "Mostrando 0 até 0 de 0 registros",
          infoFiltered: "(filtrado de _MAX_ registros no total)",
          lengthMenu: "Mostrar _MENU_ registros",
          loadingRecords: "Carregando...",
          processing: "Processando...",
          search: "Pesquisar:",
          zeroRecords: "Nenhum registro encontrado",
          paginate: {
            first: "Primeiro",
            last: "Último",
            next: "Próximo",
            previous: "Anterior"
          },
          emptyTable: "Nenhum dado disponível na tabela"
        }
      });
    }

    // ======= MAPA DE ALUNOS COM BUSCA VIACEP + GOOGLE =======
    function initMap() {
      const centroInicial = { lat: -6.5200, lng: -49.8555 }; // Ajuste conforme sua cidade
      map = new google.maps.Map(document.getElementById('map'), {
        center: centroInicial,
        zoom: 6,
      });
      geocoder = new google.maps.Geocoder();
      bounds = new google.maps.LatLngBounds();
    }

    // Quando abrir o modal, inicializa o mapa e faz a busca
    $('#modalMapear').on('shown.bs.modal', function () {
      initMap();
      // Buscar via endpoint custom, que retorna apenas alunos municipais/estaduais
      fetch('/api/alunos-transporte-publico')
        .then(res => res.json())
        .then(resp => {
          if (resp.success && resp.data) {
            plotarAlunosMapa(resp.data);
          } else {
            showNotification('danger', 'Não há alunos para mapear ou ocorreu um erro.');
          }
        })
        .catch(err => {
          console.error(err);
          showNotification('danger', 'Erro ao buscar alunos para mapear.');
        });
    });

    async function plotarAlunosMapa(alunos) {
      // Vamos plotar cada aluno
      // Para cada CEP, faz viaCep => monta endereço => geocoder => plota
      for (const aluno of alunos) {
        const cepLimpo = (aluno.cep || "").replace(/\D/g, "");
        if (!cepLimpo || cepLimpo.length !== 8) {
          continue; // pula
        }

        try {
          // 1) Busca viaCep
          const viaCepResp = await fetch(`https://viacep.com.br/ws/${cepLimpo}/json/`);
          const viaCepData = await viaCepResp.json();
          if (viaCepData.erro) {
            // CEP não encontrado
            continue;
          }

          // Monta address exato (ex.: "Rua X, Bairro, Cidade - UF")
          // Se no DB existisse "numero", pode concatenar: "... , {numero} ..."
          // Caso você tenha "aluno.bairro", atente para duplicidades.
          const address = `${viaCepData.logradouro}, ${viaCepData.bairro}, ${viaCepData.localidade} - ${viaCepData.uf}`;

          // 2) Faz geocode no Google
          const results = await geocodeAddress(address);
          if (!results) continue;

          // Cria Marker
          const marker = new google.maps.Marker({
            position: results.geometry.location,
            title: aluno.pessoa_nome + ' | ' + (aluno.transporte_escolar_poder_publico || ''),
            map: map
          });
          bounds.extend(results.geometry.location);
        } catch (error) {
          console.log('Erro na plotagem do aluno:', error);
        }
      }
      // Ajusta o zoom para abranger todos
      map.fitBounds(bounds);
    }

    function geocodeAddress(address) {
      return new Promise((resolve, reject) => {
        geocoder.geocode({ address: address }, (results, status) => {
          if (status === 'OK' && results && results.length > 0) {
            resolve(results[0]);
          } else {
            resolve(null);
          }
        });
      });
    }

    $(document).ready(function () {
      carregarEscolas();
      carregarAlunosBD();
      $("#fileInput").on("change", handleFileImport);
      $("#importarBtn").on("click", enviarImportacao);
    });
  </script>
</body>

</html>