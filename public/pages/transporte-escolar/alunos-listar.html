<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>
      Importar Alunos Ativos - pydenadmin Bootstrap 5 Admin Dashboard
    </title>
    <meta content="width=device-width, initial-scale=1.0, shrink-to-fit=no" name="viewport" />
    <link rel="icon" href="public/assets/img/pydenadmin/favicon.png" type="image/x-icon" />
    <script src="../../assets/js/plugin/webfont/webfont.min.js"></script>
    <script>
      WebFont.load({
        google: { families: ["Public Sans:300,400,500,600,700"] },
        custom: {
          families: [
            "Font Awesome 5 Solid",
            "Font Awesome 5 Regular",
            "Font Awesome 5 Brands",
            "simple-line-icons",
          ],
          urls: ["../../assets/css/fonts.min.css"],
        },
        active: function () {
          sessionStorage.fonts = true;
        },
      });
    </script>
    <link rel="stylesheet" href="../../assets/css/bootstrap.min.css" />
    <link rel="stylesheet" href="../../assets/css/plugins.min.css" />
    <link rel="stylesheet" href="../../assets/css/pydenadmin.min.css" />
    <link rel="stylesheet" href="../../assets/css/demo.css" />
    <style>
      .required-label::after {
        content: " *";
        color: red;
      }

      .modal-lg {
        max-width: 90% !important;
      }

      #map {
        width: 100%;
        height: 500px;
      }

      #mapAluno {
        width: 100%;
        height: 500px;
      }

      .spinner-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: none;
        justify-content: center;
        align-items: center;
        background-color: rgba(0, 0, 0, 0.4);
        z-index: 9999;
      }

      .spinner {
        background-image: linear-gradient(rgb(186, 66, 255) 35%, rgb(0, 225, 255));
        width: 100px;
        height: 100px;
        animation: spinning82341 1.7s linear infinite;
        text-align: center;
        border-radius: 50px;
        filter: blur(1px);
        box-shadow: 0px -5px 20px 0px rgb(186, 66, 255),
          0px 5px 20px 0px rgb(0, 225, 255);
      }

      .spinner1 {
        background-color: rgb(36, 36, 36);
        width: 100px;
        height: 100px;
        border-radius: 50px;
        filter: blur(10px);
      }

      @keyframes spinning82341 {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>

  <body>
    <div class="wrapper">
      <!-- SIDEBAR (omisso por brevidade, permanece igual ao seu) -->

      <div class="main-panel">
        <!-- HEADER (omisso por brevidade, permanece igual ao seu) -->

        <div class="container">
          <div class="page-inner">
            <div class="page-header">
              <h3 class="fw-bold mb-3">Importar Alunos Ativos</h3>
              <ul class="breadcrumbs mb-3">
                <li class="nav-home">
                  <a href="../../">
                    <i class="icon-home"></i>
                  </a>
                </li>
                <li class="separator"><i class="icon-arrow-right"></i></li>
                <li class="nav-item"><a href="#">Alunos</a></li>
                <li class="separator"><i class="icon-arrow-right"></i></li>
                <li class="nav-item"><a href="#">Importar Alunos</a></li>
              </ul>
            </div>
            <div class="mb-3 d-flex gap-2 flex-wrap">
              <div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#modalImportar">
                  Importar Alunos
                </button>
              </div>
              <div>
                <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#modalMapear">
                  Mapear Alunos
                </button>
              </div>
              <div>
                <button class="btn btn-success" id="btnCompletarMunicipalEstadual">
                  Completar Localização Municipal/Estadual
                </button>
              </div>
            </div>

            <!-- Modal Importar XLSX -->
            <div class="modal fade" id="modalImportar" tabindex="-1" aria-labelledby="modalImportarLabel" aria-hidden="true">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="modalImportarLabel">Importar Arquivo XLSX</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <p>1. Selecione a escola referente a todos os alunos que serão importados.</p>
                    <div class="mb-3">
                      <label for="escolaSelect" class="form-label required-label">Escola</label>
                      <select class="form-select" id="escolaSelect">
                        <option value="">Selecione a Escola</option>
                      </select>
                    </div>
                    <p>2. Selecione o arquivo XLSX conforme o formato especificado.</p>
                    <input type="file" id="fileInput" accept=".xlsx, .xls" class="form-control mb-3" />
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button id="importarBtn" type="button" class="btn btn-primary">Importar</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Modal Mapear Alunos -->
            <div class="modal fade" id="modalMapear" tabindex="-1" aria-labelledby="modalMapearLabel" aria-hidden="true">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="modalMapearLabel">Mapa de Alunos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <div class="row mb-3">
                      <div class="col-md-6">
                        <label for="selectEscolaMap" class="form-label">Filtrar por Escola</label>
                        <select class="form-select" id="selectEscolaMap">
                          <option value="">Todas as Escolas</option>
                        </select>
                      </div>
                      <div class="col-md-6">
                        <label for="buscarAlunoInput" class="form-label">Buscar por ID, Nome ou CPF</label>
                        <input
                          type="text"
                          class="form-control"
                          id="buscarAlunoInput"
                          placeholder="Ex: 12345 ou João ou 000.000.000-00"
                        />
                      </div>
                    </div>
                    <div class="mb-3">
                      <button id="btnFiltrarMapa" class="btn btn-primary">
                        Buscar/Filtrar
                      </button>
                    </div>
                    <div id="map"></div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Filtros -->
            <div class="card mb-4">
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-3">
                    <label for="filtroEscola" class="form-label">Filtrar por Escola</label>
                    <select id="filtroEscola" class="form-select">
                      <option value="">Todas</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label for="filtroBairro" class="form-label">Filtrar por Bairro</label>
                    <select id="filtroBairro" class="form-select">
                      <option value="">Todos</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label for="filtroCep" class="form-label">Filtrar por CEP</label>
                    <select id="filtroCep" class="form-select">
                      <option value="">Todos</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <label for="searchInput" class="form-label">Pesquisa Geral</label>
                    <input type="text" id="searchInput" class="form-control" placeholder="Digite para pesquisar..." />
                  </div>
                </div>
              </div>
            </div>

            <!-- Tabela Alunos -->
            <div class="row mt-4">
              <div class="col-md-12">
                <div class="card">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="card-title">Alunos Cadastrados</h4>
                  </div>
                  <div class="card-body">
                    <div class="table-responsive">
                      <table id="alunos-table" class="display table table-striped table-hover">
                        <thead>
                          <tr>
                            <th>ID Matrícula</th>
                            <th>Escola (Nome)</th>
                            <th>Ano</th>
                            <th>Modalidade</th>
                            <th>Form. Letivo</th>
                            <th>Turma</th>
                            <th>Nome Aluno</th>
                            <th>CPF</th>
                            <th>Transp. Escolar</th>
                            <th>CEP</th>
                            <th>Bairro</th>
                            <th>Número Endereço</th>
                            <th>Filiação 1</th>
                            <th>Telefone</th>
                            <th>Filiação 2</th>
                            <th>Responsável</th>
                            <th>Deficiência</th>
                            <th>Latitude</th>
                            <th>Longitude</th>
                            <th>Ações</th>
                          </tr>
                        </thead>
                        <tfoot>
                          <tr>
                            <th>ID Matrícula</th>
                            <th>Escola (Nome)</th>
                            <th>Ano</th>
                            <th>Modalidade</th>
                            <th>Form. Letivo</th>
                            <th>Turma</th>
                            <th>Nome Aluno</th>
                            <th>CPF</th>
                            <th>Transp. Escolar</th>
                            <th>CEP</th>
                            <th>Bairro</th>
                            <th>Número Endereço</th>
                            <th>Filiação 1</th>
                            <th>Telefone</th>
                            <th>Filiação 2</th>
                            <th>Responsável</th>
                            <th>Deficiência</th>
                            <th>Latitude</th>
                            <th>Longitude</th>
                            <th>Ações</th>
                          </tr>
                        </tfoot>
                        <tbody></tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- FOOTER (omisso por brevidade, permanece igual ao seu) -->
      </div>
    </div>

    <div id="globalLoader" class="spinner-container">
      <div class="spinner">
        <div class="spinner1"></div>
      </div>
    </div>

    <!-- Modal Editar Aluno -->
    <div class="modal fade" id="modalEditarAluno" tabindex="-1" aria-labelledby="modalEditarAlunoLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalEditarAlunoLabel">Editar Aluno</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="formEditarAluno">
              <input type="hidden" id="editarAlunoId" />
              <div class="mb-3">
                <label for="editarIdMatricula" class="form-label">ID Matrícula</label>
                <input type="text" class="form-control" id="editarIdMatricula" />
              </div>
              <div class="mb-3">
                <label for="editarEscolaId" class="form-label">Escola (ID)</label>
                <input type="text" class="form-control" id="editarEscolaId" />
              </div>
              <div class="mb-3">
                <label for="editarAno" class="form-label">Ano</label>
                <input type="text" class="form-control" id="editarAno" />
              </div>
              <div class="mb-3">
                <label for="editarModalidade" class="form-label">Modalidade</label>
                <input type="text" class="form-control" id="editarModalidade" />
              </div>
              <div class="mb-3">
                <label for="editarFormatoLetivo" class="form-label">Formato Letivo</label>
                <input type="text" class="form-control" id="editarFormatoLetivo" />
              </div>
              <div class="mb-3">
                <label for="editarTurma" class="form-label">Turma</label>
                <input type="text" class="form-control" id="editarTurma" />
              </div>
              <div class="mb-3">
                <label for="editarNomeAluno" class="form-label">Nome Aluno</label>
                <input type="text" class="form-control" id="editarNomeAluno" />
              </div>
              <div class="mb-3">
                <label for="editarCpf" class="form-label">CPF</label>
                <input type="text" class="form-control" id="editarCpf" />
              </div>
              <div class="mb-3">
                <label for="editarTransporte" class="form-label">Transp. Escolar</label>
                <input type="text" class="form-control" id="editarTransporte" />
              </div>
              <div class="mb-3">
                <label for="editarCep" class="form-label">CEP</label>
                <input type="text" class="form-control" id="editarCep" />
              </div>
              <div class="mb-3">
                <label for="editarBairro" class="form-label">Bairro</label>
                <input type="text" class="form-control" id="editarBairro" />
              </div>
              <div class="mb-3">
                <label for="editarNumeroEndereco" class="form-label">Número Endereço</label>
                <input type="text" class="form-control" id="editarNumeroEndereco" />
              </div>
              <div class="mb-3">
                <label for="editarFiliacao1" class="form-label">Filiação 1</label>
                <input type="text" class="form-control" id="editarFiliacao1" />
              </div>
              <div class="mb-3">
                <label for="editarTelefone" class="form-label">Telefone</label>
                <input type="text" class="form-control" id="editarTelefone" />
              </div>
              <div class="mb-3">
                <label for="editarFiliacao2" class="form-label">Filiação 2</label>
                <input type="text" class="form-control" id="editarFiliacao2" />
              </div>
              <div class="mb-3">
                <label for="editarResponsavel" class="form-label">Responsável</label>
                <input type="text" class="form-control" id="editarResponsavel" />
              </div>
              <div class="mb-3">
                <label for="editarDeficiencia" class="form-label">Deficiência (JSON)</label>
                <input type="text" class="form-control" id="editarDeficiencia" />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Fechar
            </button>
            <button type="button" class="btn btn-primary" id="btnSalvarEdicao">
              Salvar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Localizar Aluno -->
    <div class="modal fade" id="modalLocalizarAluno" tabindex="-1" aria-labelledby="modalLocalizarAlunoLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalLocalizarAlunoLabel">Localizar Aluno</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="localizarAlunoEnderecoCompleto" class="form-label">Endereço Completo</label>
              <input type="text" id="localizarAlunoEnderecoCompleto" class="form-control" />
            </div>
            <div class="d-flex gap-2 mb-3">
              <button type="button" class="btn btn-info" id="btnRefinarPesquisa">
                Refinar Pesquisa
              </button>
              <button type="button" class="btn btn-success" id="btnSalvarLocalizacao">
                Salvar Localização
              </button>
            </div>
            <div id="mapAluno" style="width: 100%; height: 500px;"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              Fechar
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="../../assets/js/core/jquery-3.7.1.min.js"></script>
    <script src="../../assets/js/core/popper.min.js"></script>
    <script src="../../assets/js/core/bootstrap.min.js"></script>
    <script src="../../assets/js/usuario.js"></script>
    <script src="../../assets/js/plugin/bootstrap-notify/bootstrap-notify.min.js"></script>
    <script src="../../assets/js/plugin/jquery-scrollbar/jquery.scrollbar.min.js"></script>
    <script src="../../assets/js/plugin/datatables/datatables.min.js"></script>
    <script src="../../assets/js/pydenadmin.min.js"></script>
    <script src="../../assets/js/setting-demo2.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCAwvAt4l0Pkb1c52FLUE-ttVxm4YZ9J8M&v=beta&libraries=marker"
    ></script>
    <script>
      let dadosXLSX = [];
      let escolasLista = [];
      let dataTable = null;
      let alunosData = [];
      let map = null;
      let geocoder = null;
      let escolaLocalizacao = null;
      let mapAluno = null;
      let geocoderAluno = null;
      let alunoAtual = null;
      let escolaLocAluno = null;
      let currentAlunoMarker = null;
      let currentAlunoPosition = null;

      function showLoader() {
        document.getElementById("globalLoader").style.display = "flex";
      }
      function hideLoader() {
        document.getElementById("globalLoader").style.display = "none";
      }

      function carregarEscolas() {
        showLoader();
        fetch("/api/escolas")
          .then((res) => res.json())
          .then((data) => {
            escolasLista = data;
            popularSelectEscolas();
            popularSelectEscolasMap();
          })
          .catch((err) => {
            console.error(err);
            showNotification("danger", "Erro ao carregar lista de escolas.");
          })
          .finally(() => {
            hideLoader();
          });
      }

      function popularSelectEscolas() {
        const select = document.getElementById("escolaSelect");
        select.innerHTML = '<option value="">Selecione a Escola</option>';
        escolasLista.forEach((escola) => {
          const option = document.createElement("option");
          option.value = escola.id;
          option.textContent = `${escola.nome} (ID: ${escola.id})`;
          select.appendChild(option);
        });
      }

      function popularSelectEscolasMap() {
        const selectMap = document.getElementById("selectEscolaMap");
        selectMap.innerHTML = '<option value="">Todas as Escolas</option>';
        escolasLista.forEach((escola) => {
          const option = document.createElement("option");
          option.value = escola.id;
          option.textContent = `${escola.nome} (ID: ${escola.id})`;
          selectMap.appendChild(option);
        });
      }

      function carregarAlunosBD() {
        showLoader();
        fetch("/api/alunos-ativos")
          .then((res) => res.json())
          .then((data) => {
            alunosData = data;
            popularTabela(alunosData);
          })
          .catch((err) => {
            console.error(err);
            showNotification("danger", "Erro ao carregar dados do banco.");
          })
          .finally(() => {
            hideLoader();
          });
      }

      function popularTabela(alunos) {
        const tbody = $("#alunos-table tbody");
        tbody.empty();

        const distinctEscolas = new Set();
        const distinctBairros = new Set();
        const distinctCeps = new Set();

        alunos.forEach((item) => {
          const defString =
            item.deficiencia && Array.isArray(item.deficiencia)
              ? JSON.stringify(item.deficiencia)
              : item.deficiencia || "";

          const row = `
            <tr data-id="${item.id}" data-obj='${JSON.stringify(item)}'>
              <td>${item.id_matricula || ""}</td>
              <td>${item.escola_nome || ""}</td>
              <td>${item.ano || ""}</td>
              <td>${item.modalidade || ""}</td>
              <td>${item.formato_letivo || ""}</td>
              <td>${item.turma || ""}</td>
              <td>${item.pessoa_nome || ""}</td>
              <td>${item.cpf || ""}</td>
              <td>${item.transporte_escolar_poder_publico || ""}</td>
              <td>${item.cep || ""}</td>
              <td>${item.bairro || ""}</td>
              <td>${item.numero_pessoa_endereco || ""}</td>
              <td>${item.filiacao_1 || ""}</td>
              <td>${item.numero_telefone || ""}</td>
              <td>${item.filiacao_2 || ""}</td>
              <td>${item.responsavel || ""}</td>
              <td>${defString}</td>
              <td>${item.latitude || ""}</td>
              <td>${item.longitude || ""}</td>
              <td>
                <button class="btn btn-sm btn-warning btn-editar" title="Editar">
                  <i class="fa fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-info btn-localizar" title="Localizar">
                  <i class="fa fa-map-marker-alt"></i>
                </button>
                <button class="btn btn-sm btn-danger btn-excluir" title="Excluir">
                  <i class="fa fa-trash"></i>
                </button>
              </td>
            </tr>
          `;
          tbody.append(row);

          if (item.escola_nome) distinctEscolas.add(item.escola_nome);
          if (item.bairro) distinctBairros.add(item.bairro);
          if (item.cep) distinctCeps.add(item.cep);
        });

        if (dataTable) {
          dataTable.clear().destroy();
        }

        dataTable = $("#alunos-table").DataTable({
          pageLength: 10,
          language: {
            decimal: ",",
            thousands: ".",
            info: "Mostrando _START_ até _END_ de _TOTAL_ registros",
            infoEmpty: "Mostrando 0 até 0 de 0 registros",
            infoFiltered: "(filtrado de _MAX_ registros no total)",
            lengthMenu: "Mostrar _MENU_ registros",
            loadingRecords: "Carregando...",
            processing: "Processando...",
            search: "Pesquisar:",
            zeroRecords: "Nenhum registro encontrado",
            paginate: {
              first: "Primeiro",
              last: "Último",
              next: "Próximo",
              previous: "Anterior",
            },
            emptyTable: "Nenhum dado disponível na tabela",
          },
        });

        const filtroEscola = document.getElementById("filtroEscola");
        const filtroBairro = document.getElementById("filtroBairro");
        const filtroCep = document.getElementById("filtroCep");

        filtroEscola.innerHTML = '<option value="">Todas</option>';
        filtroBairro.innerHTML = '<option value="">Todos</option>';
        filtroCep.innerHTML = '<option value="">Todos</option>';

        distinctEscolas.forEach((e) => {
          const opt = document.createElement("option");
          opt.value = e;
          opt.textContent = e;
          filtroEscola.appendChild(opt);
        });

        distinctBairros.forEach((b) => {
          const opt = document.createElement("option");
          opt.value = b;
          opt.textContent = b;
          filtroBairro.appendChild(opt);
        });

        distinctCeps.forEach((c) => {
          const opt = document.createElement("option");
          opt.value = c;
          opt.textContent = c;
          filtroCep.appendChild(opt);
        });
      }

      $(document).on("change", "#filtroEscola", function () {
        const val = this.value;
        dataTable.column(1).search(val).draw();
      });

      $(document).on("change", "#filtroBairro", function () {
        const val = this.value;
        dataTable.column(10).search(val).draw();
      });

      $(document).on("change", "#filtroCep", function () {
        const val = this.value;
        dataTable.column(9).search(val).draw();
      });

      $(document).on("keyup", "#searchInput", function () {
        dataTable.search(this.value).draw();
      });

      function handleFileImport(evt) {
        const file = evt.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (e) {
          const data = e.target.result;
          const workbook = XLSX.read(data, { type: "binary" });
          const firstSheet = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheet];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { defval: "" });
          dadosXLSX = jsonData;
        };
        reader.readAsBinaryString(file);
      }

      function enviarImportacao() {
        const escolaIdSelecionada = document.getElementById("escolaSelect").value;
        if (!escolaIdSelecionada) {
          showNotification("danger", "Selecione uma escola antes de importar.");
          return;
        }
        if (!dadosXLSX.length) {
          showNotification("danger", "Nenhum arquivo importado ainda.");
          return;
        }
        showLoader();
        const body = {
          escolaId: escolaIdSelecionada,
          alunos: dadosXLSX,
        };
        fetch("/api/import-alunos-ativos", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        })
          .then((res) => res.json())
          .then((resp) => {
            if (resp.success) {
              showNotification("success", resp.message || "Importação realizada com sucesso!");
              $("#modalImportar").modal("hide");
              carregarAlunosBD();
            } else {
              showNotification("danger", resp.message || "Ocorreu um erro na importação.");
            }
          })
          .catch((err) => {
            console.error(err);
            showNotification("danger", "Erro ao enviar os dados ao servidor.");
          })
          .finally(() => {
            hideLoader();
          });
      }

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: -3.135366, lng: -60.023207 },
          zoom: 5,
          mapId: "ca7a0e55f44be727",
        });
        geocoder = new google.maps.Geocoder();
      }

      $("#modalMapear").on("shown.bs.modal", function () {
        if (!map) {
          initMap();
        }
      });

      $(document).on("click", "#btnFiltrarMapa", function () {
        const escolaSelecionada = $("#selectEscolaMap").val();
        const busca = $("#buscarAlunoInput").val().trim();
        const queryParams = new URLSearchParams();
        if (escolaSelecionada) queryParams.append("escola_id", escolaSelecionada);
        if (busca) queryParams.append("busca", busca);

        showLoader();
        fetch("/api/alunos-mapa?" + queryParams.toString())
          .then((res) => res.json())
          .then((resp) => {
            if (resp.success && Array.isArray(resp.data)) {
              plotarEscola(resp.escola || null);
              plotarAlunosMapa(resp.data);
            } else {
              showNotification("info", "Nenhum aluno encontrado com esses filtros.");
            }
          })
          .catch((err) => {
            console.error(err);
            showNotification("danger", "Erro ao filtrar alunos no mapa.");
          })
          .finally(() => {
            hideLoader();
          });
      });

      function plotarEscola(e) {
        if (!map) return;
        if (!geocoder) {
          geocoder = new google.maps.Geocoder();
        }
        if (!e) return;
        escolaLocalizacao = null;

        if (e.latitude && e.longitude) {
          escolaLocalizacao = new google.maps.LatLng(e.latitude, e.longitude);
          new google.maps.Marker({
            map,
            position: escolaLocalizacao,
            title: e.nome,
          });
          map.setCenter(escolaLocalizacao);
          map.setZoom(14);
          new google.maps.Circle({
            strokeColor: "#FF0000",
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: "#FF0000",
            fillOpacity: 0.35,
            map,
            center: escolaLocalizacao,
            radius: 2000,
          });
        } else {
          let addr = "";
          if (e.logradouro) addr += e.logradouro;
          if (e.numero) addr += ", " + e.numero;
          if (e.bairro) addr += ", " + e.bairro;
          if (e.cep) addr += ", " + e.cep;
          geocoder.geocode({ address: addr }, function (results, status) {
            if (status === "OK" && results[0]) {
              escolaLocalizacao = results[0].geometry.location;
              new google.maps.Marker({
                map,
                position: escolaLocalizacao,
                title: e.nome,
              });
              map.setCenter(escolaLocalizacao);
              map.setZoom(14);
              new google.maps.Circle({
                strokeColor: "#FF0000",
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: "#FF0000",
                fillOpacity: 0.35,
                map,
                center: escolaLocalizacao,
                radius: 2000,
              });
            }
          });
        }
      }

      function plotarAlunosMapa(alunos) {
        if (!map) return;
        if (!geocoder) {
          geocoder = new google.maps.Geocoder();
        }
        const bounds = new google.maps.LatLngBounds();
        let contagem = 0;

        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: -3.135366, lng: -60.023207 },
          zoom: 5,
          mapId: "ca7a0e55f44be727",
        });

        if (escolaLocalizacao) {
          map.setCenter(escolaLocalizacao);
          map.setZoom(14);
          new google.maps.Circle({
            strokeColor: "#FF0000",
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: "#FF0000",
            fillOpacity: 0.35,
            map,
            center: escolaLocalizacao,
            radius: 2000,
          });
          new google.maps.Marker({
            map,
            position: escolaLocalizacao,
            title: "Escola",
          });
          bounds.extend(escolaLocalizacao);
        }

        alunos.forEach((al) => {
          const cepLimpo = (al.cep || "").replace(/\D/g, "");
          let numeroEnd = (al.numero_pessoa_endereco || "").trim();
          let numeroTratado = numeroEnd.toLowerCase();
          if (
            numeroTratado.includes("s/n") ||
            numeroTratado === "sn" ||
            numeroTratado.includes("sem numero") ||
            numeroTratado.includes("sem número")
          ) {
            numeroEnd = "S/N";
          }

          if (cepLimpo.length !== 8) {
            contagem++;
            if (contagem === alunos.length) map.fitBounds(bounds);
            return;
          }
          fetch(`https://viacep.com.br/ws/${cepLimpo}/json/`)
            .then((res) => res.json())
            .then((dataViaCep) => {
              if (dataViaCep.erro) {
                contagem++;
                if (contagem === alunos.length) map.fitBounds(bounds);
                return;
              }
              const logradouro = dataViaCep.logradouro || "";
              const bairro = dataViaCep.bairro || "";
              const localidade = dataViaCep.localidade || "";
              const uf = dataViaCep.uf || "";

              const endCompleto = `${logradouro}, ${numeroEnd}, ${bairro}, ${localidade} - ${uf}, Brasil`.trim();
              geocoder.geocode({ address: endCompleto }, function (results, status) {
                if (status === "OK" && results[0]) {
                  const loc = results[0].geometry.location;
                  const marker = new google.maps.Marker({
                    map,
                    position: loc,
                    title: al.pessoa_nome || "Aluno",
                  });
                  const infowindow = new google.maps.InfoWindow({
                    content: `<strong>${al.pessoa_nome || ""}</strong><br>CPF: ${al.cpf || ""}<br>Matrícula: ${
                      al.id_matricula || ""
                    }`,
                  });
                  marker.addListener("click", () => {
                    infowindow.open(map, marker);
                  });
                  bounds.extend(loc);
                }
                contagem++;
                if (contagem === alunos.length) {
                  map.fitBounds(bounds);
                }
              });
            })
            .catch(() => {
              contagem++;
              if (contagem === alunos.length) map.fitBounds(bounds);
            });
        });
      }

      function showNotification(type, message) {
        $.notify(
          {
            message: message,
            icon:
              type === "success"
                ? "fa fa-check-circle"
                : type === "danger"
                ? "fa fa-exclamation-circle"
                : "fa fa-info-circle",
          },
          {
            type: type,
            placement: { from: "top", align: "right" },
            offset: 20,
            spacing: 10,
            z_index: 1031,
            delay: 3000,
            timer: 1000,
            animate: {
              enter: "animated fadeInDown",
              exit: "animated fadeOutUp",
            },
          }
        );
      }

      $(document).ready(function () {
        carregarEscolas();
        carregarAlunosBD();
        $("#fileInput").on("change", handleFileImport);
        $("#importarBtn").on("click", enviarImportacao);

        $(document).on("click", ".btn-editar", function () {
          const tr = $(this).closest("tr");
          const dataObj = JSON.parse(tr.attr("data-obj") || "{}");
          alunoAtual = dataObj.id;
          $("#editarAlunoId").val(dataObj.id);
          $("#editarIdMatricula").val(dataObj.id_matricula || "");
          $("#editarEscolaId").val(dataObj.escola_id || "");
          $("#editarAno").val(dataObj.ano || "");
          $("#editarModalidade").val(dataObj.modalidade || "");
          $("#editarFormatoLetivo").val(dataObj.formato_letivo || "");
          $("#editarTurma").val(dataObj.turma || "");
          $("#editarNomeAluno").val(dataObj.pessoa_nome || "");
          $("#editarCpf").val(dataObj.cpf || "");
          $("#editarTransporte").val(dataObj.transporte_escolar_poder_publico || "");
          $("#editarCep").val(dataObj.cep || "");
          $("#editarBairro").val(dataObj.bairro || "");
          $("#editarNumeroEndereco").val(dataObj.numero_pessoa_endereco || "");
          $("#editarFiliacao1").val(dataObj.filiacao_1 || "");
          $("#editarTelefone").val(dataObj.numero_telefone || "");
          $("#editarFiliacao2").val(dataObj.filiacao_2 || "");
          $("#editarResponsavel").val(dataObj.responsavel || "");
          if (dataObj.deficiencia && Array.isArray(dataObj.deficiencia)) {
            $("#editarDeficiencia").val(JSON.stringify(dataObj.deficiencia));
          } else {
            $("#editarDeficiencia").val(dataObj.deficiencia || "");
          }
          $("#modalEditarAluno").modal("show");
        });

        $("#btnSalvarEdicao").on("click", function () {
          const body = {
            id: $("#editarAlunoId").val(),
            id_matricula: $("#editarIdMatricula").val(),
            escola_id: $("#editarEscolaId").val(),
            ano: $("#editarAno").val(),
            modalidade: $("#editarModalidade").val(),
            formato_letivo: $("#editarFormatoLetivo").val(),
            turma: $("#editarTurma").val(),
            pessoa_nome: $("#editarNomeAluno").val(),
            cpf: $("#editarCpf").val(),
            transporte_escolar_poder_publico: $("#editarTransporte").val(),
            cep: $("#editarCep").val(),
            bairro: $("#editarBairro").val(),
            numero_pessoa_endereco: $("#editarNumeroEndereco").val(),
            filiacao_1: $("#editarFiliacao1").val(),
            numero_telefone: $("#editarTelefone").val(),
            filiacao_2: $("#editarFiliacao2").val(),
            responsavel: $("#editarResponsavel").val(),
            deficiencia: $("#editarDeficiencia").val(),
          };
          showLoader();
          fetch("/api/alunos-ativos/" + body.id, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          })
            .then((res) => res.json())
            .then((resp) => {
              if (resp.success) {
                showNotification("success", "Aluno atualizado com sucesso!");
                $("#modalEditarAluno").modal("hide");
                carregarAlunosBD();
              } else {
                showNotification("danger", resp.message || "Erro ao atualizar.");
              }
            })
            .catch((err) => {
              console.error(err);
              showNotification("danger", "Erro ao atualizar aluno.");
            })
            .finally(() => {
              hideLoader();
            });
        });

        $(document).on("click", ".btn-localizar", function () {
          const tr = $(this).closest("tr");
          const dataObj = JSON.parse(tr.attr("data-obj") || "{}");
          alunoAtual = dataObj.id;
          escolaLocAluno = dataObj.escola_id || null;
          $("#modalLocalizarAluno").modal("show");
          setTimeout(() => {
            initMapAluno(dataObj);
          }, 500);
        });

        $(document).on("click", ".btn-excluir", function () {
          if (!confirm("Deseja realmente excluir este aluno?")) return;
          const tr = $(this).closest("tr");
          const dataObj = JSON.parse(tr.attr("data-obj") || "{}");
          const alunoId = dataObj.id;
          showLoader();
          fetch("/api/alunos-ativos/" + alunoId, {
            method: "DELETE",
          })
            .then((res) => res.json())
            .then((resp) => {
              if (resp.success) {
                showNotification("success", "Aluno excluído com sucesso!");
                carregarAlunosBD();
              } else {
                showNotification("danger", resp.message || "Erro ao excluir.");
              }
            })
            .catch((err) => {
              console.error(err);
              showNotification("danger", "Erro ao excluir aluno.");
            })
            .finally(() => {
              hideLoader();
            });
        });

        $("#btnRefinarPesquisa").on("click", function () {
          const address = $("#localizarAlunoEnderecoCompleto").val().trim();
          if (!address) return;
          // Certifique-se de criar o geocoderAluno se não existir
          if (!mapAluno) return;
          if (!geocoderAluno) {
            geocoderAluno = new google.maps.Geocoder();
          }
          showLoader();
          geocoderAluno.geocode({ address }, function (results, status) {
            if (status === "OK" && results[0]) {
              placeAlunoMarker(results[0].geometry.location, true);
              mapAluno.setCenter(results[0].geometry.location);
              mapAluno.setZoom(14);
            } else {
              showNotification("danger", "Endereço não encontrado.");
            }
            hideLoader();
          });
        });

        $("#btnSalvarLocalizacao").on("click", function () {
          if (!alunoAtual || !currentAlunoPosition) {
            showNotification("danger", "Não há aluno ou posição para salvar.");
            return;
          }
          const body = {
            id: alunoAtual,
            latitude: currentAlunoPosition.lat(),
            longitude: currentAlunoPosition.lng(),
          };
          showLoader();
          fetch("/api/alunos-ativos/" + alunoAtual, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          })
            .then((res) => res.json())
            .then((resp) => {
              if (resp.success) {
                showNotification("success", "Localização salva com sucesso!");
                $("#modalLocalizarAluno").modal("hide");
                carregarAlunosBD();
              } else {
                showNotification("danger", resp.message || "Erro ao salvar localização.");
              }
            })
            .catch((err) => {
              console.error(err);
              showNotification("danger", "Erro ao salvar localização.");
            })
            .finally(() => {
              hideLoader();
            });
        });

        // BOTÃO PARA COMPLETAR LOCALIZAÇÃO DE ALUNOS COM TRANSPORTE 'MUNICIPAL' OU 'ESTADUAL'
        $("#btnCompletarMunicipalEstadual").on("click", async function () {
          showLoader();
          let promises = [];
          const alunosFiltrados = alunosData.filter(
            (aluno) =>
              aluno.transporte_escolar_poder_publico &&
              (aluno.transporte_escolar_poder_publico.toLowerCase().includes("municipal") ||
                aluno.transporte_escolar_poder_publico.toLowerCase().includes("estadual")) &&
              !aluno.latitude &&
              !aluno.longitude
          );

          if (!alunosFiltrados.length) {
            showNotification(
              "info",
              "Nenhum aluno com transporte 'Municipal' ou 'Estadual' sem lat/long."
            );
            hideLoader();
            return;
          }

          try {
            // Se geocoder não existir, criamos
            if (!geocoder) {
              geocoder = new google.maps.Geocoder();
            }

            for (const al of alunosFiltrados) {
              const cepLimpo = (al.cep || "").replace(/\D/g, "");
              if (cepLimpo.length !== 8) {
                continue;
              }
              const numeroEnd = tratarNumero(al.numero_pessoa_endereco || "");
              const viaData = await fetch(
                `https://viacep.com.br/ws/${cepLimpo}/json/`
              ).then((res) => res.json());

              if (viaData.erro) {
                continue;
              }

              const logradouro = viaData.logradouro || "";
              const bairro = viaData.bairro || "";
              const localidade = viaData.localidade || "";
              const uf = viaData.uf || "";
              const endCompleto = `${logradouro}, ${numeroEnd}, ${bairro}, ${localidade} - ${uf}, Brasil`.trim();

              const geoResult = await geocodeAddress(endCompleto);
              if (geoResult) {
                const { lat, lng } = geoResult;
                const body = {
                  id: al.id,
                  latitude: lat,
                  longitude: lng,
                };
                // PUT em cada um
                const p = fetch("/api/alunos-ativos/" + al.id, {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(body),
                })
                  .then((r) => r.json())
                  .then((resp) => {
                    if (!resp.success) {
                      console.warn(
                        "Falha ao atualizar aluno ID:",
                        al.id,
                        resp.message
                      );
                    }
                  })
                  .catch((err) => {
                    console.error("Erro ao atualizar ID:", al.id, err);
                  });
                promises.push(p);
              }
            }
            await Promise.all(promises);
            showNotification("success", "Processo de localização concluído. Atualizando lista...");
            carregarAlunosBD();
          } catch (err) {
            console.error(err);
            showNotification("danger", "Ocorreu um erro durante a atualização em massa.");
          } finally {
            hideLoader();
          }
        });
      });

      function initMapAluno(aluno) {
        if (!mapAluno) {
          mapAluno = new google.maps.Map(document.getElementById("mapAluno"), {
            center: { lat: -3.135366, lng: -60.023207 },
            zoom: 5,
            mapId: "ca7a0e55f44be727",
          });
          geocoderAluno = new google.maps.Geocoder();
        } else {
          mapAluno = new google.maps.Map(document.getElementById("mapAluno"), {
            center: { lat: -3.135366, lng: -60.023207 },
            zoom: 5,
            mapId: "ca7a0e55f44be727",
          });
          if (!geocoderAluno) {
            geocoderAluno = new google.maps.Geocoder();
          }
        }

        currentAlunoMarker = null;
        currentAlunoPosition = null;

        mapAluno.addListener("click", (e) => {
          showLoader();
          geocoderAluno.geocode({ location: e.latLng }, function (results, status) {
            if (status === "OK" && results[0]) {
              placeAlunoMarker(e.latLng, true);
            } else {
              placeAlunoMarker(e.latLng, false);
            }
            hideLoader();
          });
        });

        let centerEscola = null;
        fetch("/api/escolas/" + (aluno.escola_id || 0))
          .then((res) => res.json())
          .then((infoEscola) => {
            if (infoEscola && infoEscola.id) {
              if (infoEscola.latitude && infoEscola.longitude) {
                centerEscola = new google.maps.LatLng(infoEscola.latitude, infoEscola.longitude);
                new google.maps.Marker({
                  map: mapAluno,
                  position: centerEscola,
                  title: infoEscola.nome || "Escola",
                });
                mapAluno.setCenter(centerEscola);
                mapAluno.setZoom(14);
                new google.maps.Circle({
                  strokeColor: "#FF0000",
                  strokeOpacity: 0.8,
                  strokeWeight: 2,
                  fillColor: "#FF0000",
                  fillOpacity: 0.35,
                  map: mapAluno,
                  center: centerEscola,
                  radius: 2000,
                });
                localizarAlunoEndereco(aluno, centerEscola);
              } else {
                const addr = `${infoEscola.logradouro || ""}, ${infoEscola.numero || ""}, ${
                  infoEscola.bairro || ""
                }, ${infoEscola.cep || ""}`;
                geocoderAluno.geocode({ address: addr }, function (results, status) {
                  if (status === "OK" && results[0]) {
                    centerEscola = results[0].geometry.location;
                    new google.maps.Marker({
                      map: mapAluno,
                      position: centerEscola,
                      title: infoEscola.nome || "Escola",
                    });
                    mapAluno.setCenter(centerEscola);
                    mapAluno.setZoom(14);
                    new google.maps.Circle({
                      strokeColor: "#FF0000",
                      strokeOpacity: 0.8,
                      strokeWeight: 2,
                      fillColor: "#FF0000",
                      fillOpacity: 0.35,
                      map: mapAluno,
                      center: centerEscola,
                      radius: 2000,
                    });
                  }
                  localizarAlunoEndereco(aluno, centerEscola);
                });
              }
            } else {
              localizarAlunoEndereco(aluno, null);
            }
          })
          .catch(() => {
            localizarAlunoEndereco(aluno, null);
          });
      }

      function localizarAlunoEndereco(aluno, centerEscola) {
        const cepFormatado = (aluno.cep || "").replace(/\D/g, "");
        let numero = (aluno.numero_pessoa_endereco || "").trim().toLowerCase();

        if (
          numero.includes("s/n") ||
          numero === "sn" ||
          numero.includes("sem numero") ||
          numero.includes("sem número")
        ) {
          numero = "S/N";
        }

        if (cepFormatado.length === 8) {
          if (!geocoderAluno) {
            geocoderAluno = new google.maps.Geocoder();
          }
          fetch(`https://viacep.com.br/ws/${cepFormatado}/json/`)
            .then((res) => res.json())
            .then((viaData) => {
              if (!viaData.erro) {
                const end = `${viaData.logradouro || ""}, ${numero}, ${viaData.bairro || ""}, ${
                  viaData.localidade || ""
                } - ${viaData.uf || ""}, Brasil`.trim();
                geocoderAluno.geocode({ address: end }, function (results, status) {
                  if (status === "OK" && results[0]) {
                    placeAlunoMarker(results[0].geometry.location, true);
                    if (!centerEscola) {
                      mapAluno.setCenter(results[0].geometry.location);
                      mapAluno.setZoom(14);
                    }
                  }
                });
              }
            })
            .catch(() => {});
        }
      }

      function placeAlunoMarker(latLng, hasAddress) {
        if (currentAlunoMarker) {
          currentAlunoMarker.setMap(null);
        }
        currentAlunoMarker = new google.maps.Marker({
          map: mapAluno,
          position: latLng,
          title: "Aluno",
        });
        currentAlunoPosition = latLng;
        if (hasAddress && geocoderAluno) {
          geocoderAluno.geocode({ location: latLng }, function (results, status) {
            if (status === "OK" && results[0]) {
              $("#localizarAlunoEnderecoCompleto").val(results[0].formatted_address);
            }
          });
        } else {
          $("#localizarAlunoEnderecoCompleto").val("");
        }
      }

      async function geocodeAddress(address) {
        // Caso geocoder não exista, criamos
        if (!geocoder) {
          geocoder = new google.maps.Geocoder();
        }
        return new Promise((resolve) => {
          geocoder.geocode({ address }, (results, status) => {
            if (status === "OK" && results[0]) {
              const location = results[0].geometry.location;
              resolve({ lat: location.lat(), lng: location.lng() });
            } else {
              resolve(null);
            }
          });
        });
      }

      function tratarNumero(numStr) {
        let numeroTratado = (numStr || "").trim().toLowerCase();
        if (
          numeroTratado.includes("s/n") ||
          numeroTratado === "sn" ||
          numeroTratado.includes("sem numero") ||
          numeroTratado.includes("sem número")
        ) {
          return "S/N";
        }
        return numeroTratado;
      }
    </script>
  </body>
</html>
